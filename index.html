<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Блокнот Машиниста · Lite v2025.29A-PWA</title>
<meta name="theme-color" content="#d32f2f">
<link rel="manifest" href="manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<!-- iOS иконки -->
<link rel="apple-touch-icon" href="apple-touch-icon.png?v=202529A">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180x180.png?v=202529A">
<link rel="apple-touch-icon" sizes="167x167" href="apple-touch-icon-167x167.png?v=202529A">
<link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon-152x152.png?v=202529A">

<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0}
:root{
  --red:#d32f2f;--bg:#0f1420;--card:#161d2a;--line:#243246;--mut:#8aa0b6;--txt:#e9eef5;
  --ink:#0e1622;--ok:#1b2738;--green:#2e7d32;--amber:#ffb300
}
body.theme-light{ --bg:#ffffff; --card:#ffffff; --line:#e6ecf3; --mut:#5b6b7a; --txt:#101622; --ink:#f5f7fb; --ok:#e8eef7; }
body{background:var(--bg);color:var(--txt);font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
a{color:inherit}
header{position:sticky;top:0;background:var(--red);color:#fff;padding:12px 14px;display:flex;gap:10px;justify-content:space-between;align-items:center;z-index:10;flex-wrap:wrap}
h1{margin:0;font-size:18px}
.badge{font-size:12px;padding:2px 8px;border:1px solid rgba(255,255,255,.4);border-radius:999px;white-space:nowrap}
.container{padding:12px 12px 84px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:10px}
.row{display:flex;gap:8px;align-items:center;margin:8px 0}
.row label{width:48%;color:var(--mut);font-size:14px}
.row input,.row select,.row textarea{flex:1;background:var(--ink);border:1px solid var(--line);color:var(--txt);padding:10px;border-radius:10px;font-size:16px}
.row textarea{min-height:90px;resize:vertical}
.btn{background:var(--ok);color:#fff;border:1px solid var(--line);padding:10px 14px;border-radius:10px;font-size:15px;cursor:pointer}
.btn.primary{background:#fff;color:#d32f2f;border-color:#fff}
.small{font-size:12px}
.view{display:none}
.view.active{display:block}
.tabbar{position:fixed;left:0;right:0;bottom:0;height:70px;background:#121828;border-top:1px solid var(--line);display:flex}
body.theme-light .tabbar{background:#f6f8fb;border-top-color:#e6ecf3}
.tabbar button{flex:1;background:transparent;border:none;color:#8aa0b6;font-size:12px;padding:6px 0}
.tabbar button.active{color:#fff}
body.theme-light .tabbar button.active{color:#d32f2f}
.tabbar .ico{display:block;font-size:18px;margin-bottom:4px}
.progress{height:10px;border:1px solid var(--line);border-radius:999px;overflow:hidden;background:#0f2035}
body.theme-light .progress{background:#ffe6e6}
.progress>div{height:100%;background:#d32f2f;width:0%}
.trip{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid var(--line)}
.trip:last-child{border-bottom:0}
.actions{display:flex;gap:6px}
.tap{cursor:pointer}
.money{white-space:nowrap}
.legend{color:#a9bacd;font-size:12px;margin:-2px 0 6px}
table{width:100%;border-collapse:collapse}
th,td{padding:6px 4px;border-bottom:1px solid var(--line);text-align:left}
th{color:#a9bacd}
.badge-live{display:inline-block;background:rgba(46,125,50,.12);border:1px solid rgba(46,125,50,.6);color:#2e7d32;padding:2px 6px;border-radius:999px;font-size:12px;margin-left:6px;white-space:nowrap}
.badge-two{display:inline-block;background:rgba(211,47,47,.15);border:1px solid rgba(211,47,47,.6);color:#ff8a80;padding:2px 6px;border-radius:999px;font-size:12px;margin-left:6px;white-space:nowrap}
.net-pill{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.5);padding:4px 8px;border-radius:999px;font-size:12px}
.net-pill.off{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.3);color:#ffe082}
.net-pill.on{background:rgba(255,255,255,.2);border-color:rgba(255,255,255,.7);color:#c8e6c9}
.update-pill{background:#fff;color:#d32f2f;border:1px solid #fff;padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer;display:none}
</style>
</head>
<body>
<header>
  <h1>Блокнот Машиниста</h1>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <span id="netStatus" class="net-pill off">Оффлайн</span>
    <div class="badge">Lite v2025.29A-PWA</div>
    <button id="appRefresh" class="update-pill" onclick="appUpdate()">Обновить</button>
  </div>
</header>

<main class="container">
  <!-- Главная -->
  <section id="v-dashboard" class="view active">
    <div class="card">
      <div style="display:flex;justify-content:space-between"><b>Месячная норма</b><b id="mwNorm">—</b></div>
      <div class="progress" style="margin-top:6px"><div id="mwBar"></div></div>
      <div class="row"><label>Норма, ч/мес</label><input id="tar_norm" type="number" inputmode="decimal" placeholder="176" oninput="tarSave()"></div>
      <div class="row"><label>Отработано</label><div id="mwWorked" class="small">—</div></div>
      <div class="row"><label>Выполнено</label><div id="mwPercent" class="small">—</div></div>
      <div class="row"><label>Осталось/переработка</label><div id="mwRemain" class="small">—</div></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>Поездки</b>
        <div>
          <button class="btn primary" onclick="addTripOpen()">+ Добавить</button>
          <button class="btn" onclick="exportTripsCsv()">CSV</button>
        </div>
      </div>

      <!-- Форма поездки -->
      <div id="tripForm" class="card" style="display:none;margin-top:10px">
        <div class="legend" style="margin-bottom:6px"><b>Туда</b></div>
        <div class="row"><label>Дата (туда)</label><input id="t_date" type="date"></div>
        <div class="row"><label>Маршрут (туда)</label><input id="t_route1" list="routeList"></div>
        <datalist id="routeList"></datalist>
        <div class="row"><label>Явка (туда)</label><input id="t_start1" type="time" oninput="recalcDuration()"></div>
        <div class="row"><label>Номер поезда</label><input id="t_trainNo1" placeholder="2105"></div>
        <div class="row"><label>Вид поезда</label><button class="btn" onclick="chooseTrainType('t')">Выбрать</button><span id="trainType_t"></span></div>
        <div class="row"><label>Конец работы (туда)</label><input id="t_end1" type="time" oninput="recalcDuration()"></div>        <div class="legend" style="margin-top:14px;margin-bottom:6px"><b>Обратно</b></div>
        <div class="row"><label>Дата (обратно)</label><input id="t_date2" type="date" oninput="recalcDuration()"></div>
        <div class="row"><label>Маршрут (обратно)</label><input id="t_route2" list="routeList"></div>
        <div class="row"><label>Явка (обратно)</label><input id="t_start2" type="time" oninput="recalcDuration()"></div>
        <div class="row"><label>Номер поезда</label><input id="t_trainNo2" placeholder="2106"></div>
        <div class="row"><label>Вид поезда</label><button class="btn" onclick="chooseTrainType('r')">Выбрать</button><span id="trainType_r"></span></div>
        <div class="row"><label>Конец работы (обратно)</label><input id="t_end2" type="time" oninput="recalcDuration()"></div>

        <div class="legend" style="margin-top:14px;margin-bottom:6px"><b>Следование пассажиром</b></div>
        <div class="row"><button class="btn" onclick="addPassengerFollow()">+ Добавить следование пассажиром</button></div>
        <div id="passengerList"></div>

        <div class="legend" style="margin-top:14px;margin-bottom:6px"><b>Результаты</b></div>
        <div class="row"><label>Отдых</label><input id="t_rest_view" type="text" readonly></div>
        <div class="row"><label>Ночные</label><input id="t_night_view" type="text" readonly></div>
        <div class="row"><label>Часы (итог, без отдыха)</label><input id="t_hours_view" type="text" readonly></div>

        <div class="row"><label>Заметки</label><textarea id="t_notes" placeholder="Простои, особенности…"></textarea></div>

        <div class="row" id="tripButtonsNew">
          <button class="btn primary" onclick="tripSaveNew()">Сохранить</button>
          <button class="btn" onclick="tripCancel()">Отмена</button>
        </div>
        <div class="row" id="tripButtonsEdit" style="display:none">
          <button class="btn primary" onclick="tripSaveEdit()">Сохранить изменения</button>
          <button class="btn" onclick="tripCancel()">Закрыть</button>
        </div>
      </div>

      <div id="daysList" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- Участки -->
  <section id="v-sections" class="view">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>Участки</b><div class="actions"><button class="btn" onclick="sectionOpen()">Новый участок</button></div>
      </div>
      <div id="sectionForm" class="card" style="display:none;margin-top:10px">
        <div class="row"><label>Название</label><input id="s_name" placeholder="Напр.: Малошуйка — Обозерская"></div>
        <div class="row"><label>Отправление</label><input id="s_from"></div>
        <div class="row"><label>Прибытие</label><input id="s_to"></div>
        <div class="row"><label>Длина (км)</label><input id="s_len" type="number" inputmode="decimal" placeholder="0"></div>
        <div class="row">
          <button id="s_save_btn" class="btn primary" onclick="sectionSave()">Сохранить</button>
          <button class="btn" onclick="sectionCancel()">Отмена</button>
        </div>
        <div class="small" id="s_hint" style="opacity:.7"></div>
      </div>
      <div id="sectionList"></div>
    </div>
  </section>

  <!-- Дополнительно -->
  <section id="v-more" class="view">
    <div class="card">
      <b>Полный отдых по последней поездке</b>
      <div id="restResult" style="margin-top:8px"></div>
      <div class="row" style="gap:8px;margin-top:10px">
        <button class="btn primary" onclick="calcFullRest()">Посчитать</button>
        <button class="btn" onclick="closeFullRest()">Закрыть</button>
      </div>
    </div>

    <div class="card">
      <b>РЖД зарплата</b>
      <div id="salaryBox" style="margin-top:8px"></div>
      <div class="row" style="gap:8px;margin-top:10px">
        <button class="btn primary" onclick="renderSalary()">Показать</button>
        <button class="btn" onclick="hideSalary()">Закрыть</button>
      </div>
    </div>

    <div class="card">
      <b>Календарь поездок</b>
      <div id="calendarBox" style="margin-top:8px"></div>
      <div class="row" style="gap:8px;margin-top:10px">
        <button class="btn primary" onclick="showCalendar()">Открыть</button>
        <button class="btn" onclick="hideCalendar()">Закрыть</button>
      </div>
    </div>

    <div class="card">
      <b>Тариф и надбавки</b>
      <div class="row"><label>₽/час (ставка)</label><input id="tar_base" type="number" inputmode="decimal" placeholder="358.46"></div>
      <div class="row"><label>Районный коэффициент, %</label><input id="tar_rc" type="number" inputmode="decimal" placeholder="20"></div>
      <div class="row"><label>Северный коэффициент, %</label><input id="tar_north" type="number" inputmode="decimal" placeholder="50"></div>
      <div class="row"><label>Ком. расходы, ₽</label><input id="tar_fee" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><button class="btn primary" onclick="tarSave(true)">Сохранить тариф</button></div>
    </div>
  </section>  <!-- Настройки -->
  <section id="v-settings" class="view">
    <div class="card">
      <b>Обновление приложения</b>
      <div class="row"><button class="btn" onclick="appUpdate()">Обновить до последней версии</button></div>
      <div class="small" style="opacity:.8">Нажмите после выхода новой версии. Данные не затрагиваются.</div>
    </div>

    <div class="card">
      <b>Часовой пояс</b>
      <div class="row">
        <label>Пояс</label>
        <select id="tz_select" onchange="tzSave()"></select>
      </div>
      <div class="small" style="opacity:.8">Используется для «в пути», ночных и расчёта отдыха.</div>
    </div>

    <div class="card">
      <b>Код-доступ к зарплате</b>
      <div class="row"><input id="pin_code" type="password" placeholder="PIN"></div>
      <div class="row"><button class="btn primary" onclick="savePin()">Сохранить PIN</button></div>
    </div>

    <div class="card">
      <b>Тема</b>
      <div class="row">
        <select id="theme_select" onchange="setTheme(this.value)">
          <option value="dark">Тёмная</option>
          <option value="light">Светлая</option>
        </select>
      </div>
      <div class="small" style="opacity:.8">Переключение режима отображения</div>
    </div>

    <div class="card small" style="opacity:.8">Версия Lite 2025.29A-PWA</div>
    <div class="small" style="opacity:.8;text-align:center">
      <a href="https://t.me/nikitagrigorev99" target="_blank" style="color:#e9eef5;text-decoration:underline">by Nikita Grigorev</a>
    </div>
  </section>

  <!-- Профиль -->
  <section id="v-profile" class="view">
    <div class="card">
      <b>Мой профиль</b>
      <div class="row" style="align-items:flex-start">
        <label>Фото</label>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <img id="pfAvatarBig" class="avatar big">
          <input id="pf_photo" type="file" accept="image/*" onchange="profilePhotoChanged(event)">
        </div>
      </div>
      <div class="row"><label>Имя</label><input id="pf_first" placeholder="Иван"></div>
      <div class="row"><label>Фамилия</label><input id="pf_last" placeholder="Иванов"></div>
      <div class="row"><label>Возраст</label><input id="pf_age" type="number" inputmode="numeric" placeholder="30"></div>
      <div class="row"><label>Должность</label><input id="pf_role" placeholder="Машинист"></div>
      <div class="row"><label>Место работы</label><input id="pf_place" placeholder="Депо ..."></div>
      <div class="row"><label>Дата устройства</label><input id="pf_start" type="date" onchange="renderTenure()"></div>
      <div class="row"><label>Стаж</label><input id="pf_tenure" type="text" readonly></div>

      <div class="hr"></div>
      <b>Заметки</b>
      <div class="row"><textarea id="pf_notes" placeholder="Личные заметки по работе..."></textarea></div>

      <div class="hr"></div>
      <b>Файлы</b>
      <div class="row">
        <input id="fileInput" type="file" multiple onchange="addFilesToFolder(event)">
      </div>
      <div id="filesList"></div>

      <div class="row" style="gap:8px">
        <button class="btn primary" onclick="profileSave()">Сохранить</button>
        <button class="btn" onclick="goSettings()">Назад</button>
      </div>
    </div>
  </section>
</main>

<nav class="tabbar">
  <button class="active" data-tab="dashboard" onclick="nav(this)"><span class="ico">🏠</span>Главная</button>
  <button data-tab="sections" onclick="nav(this)"><span class="ico">🗺️</span>Участки</button>
  <button data-tab="more" onclick="nav(this)"><span class="ico">➕</span>Дополнительно</button>
  <button data-tab="settings" onclick="nav(this)"><span class="ico">⚙️</span>Настройки</button>
  <button data-tab="profile" onclick="nav(this)"><span class="ico">👤</span>Профиль</button>
</nav>

<script>
/* ========= helpers ========= */
function $(s){return document.querySelector(s)}
function $all(s){return Array.from(document.querySelectorAll(s))}
function S(k,v){if(arguments.length===2){localStorage.setItem(k,JSON.stringify(v));return v}try{let r=localStorage.getItem(k);return r?JSON.parse(r):null}catch(e){return null}}
function toNum(v){let n=Number(v);return isNaN(n)?0:n}
function plural(n, one, few, many){ n=Math.abs(n)%100; let n1=n%10; if(n>10 && n<20) return many; if(n1>1 && n1<5) return few; if(n1==1) return one; return many; }
function fmtM(min){if(min==null)return '—';let h=Math.floor(min/60),m=min%60;return h+'ч '+String(m).padStart(2,'0')+'м'}
function fmtHMWords(min){
  if(min==null || min===0) return '0 минут';
  const h=Math.floor(min/60), m=min%60;
  const hs = h>0 ? (h+' '+plural(h,'час','часа','часов')) : '';
  const ms = m>0 ? (m+' '+plural(m,'минута','минуты','минут')) : '';
  return (hs+' '+ms).trim();
}/* ========= Network pill ========= */
function updateNetPill(){
  const el = $('#netStatus');
  if(!el) return;
  const on = navigator.onLine;
  el.textContent = on ? 'Онлайн' : 'Оффлайн';
  el.classList.toggle('on', on);
  el.classList.toggle('off', !on);
}
window.addEventListener('online', updateNetPill);
window.addEventListener('offline', updateNetPill);

/* ========= Theme ========= */
function setTheme(val){
  S('theme', val);
  document.body.classList.toggle('theme-light', val==='light');
  const sel=$('#theme_select'); if(sel) sel.value=val;
}

/* ========= PIN for Salary ========= */
function savePin(){
  const pin = ($('#pin_code').value||'').trim();
  S('pin', pin);
  alert('PIN сохранён');
}
function checkPinBefore(action){
  const need = (S('pin')||'').trim();
  if(!need){ action(); return; }
  const inp = prompt('Введите PIN для доступа:');
  if(inp===need) action();
  else alert('Неверный PIN');
}

/* ========= Timezone ========= */
function tzList(){
  const vals=['AUTO','UTC-12:00','UTC-11:00','UTC-10:00','UTC-09:30','UTC-09:00','UTC-08:00','UTC-07:00','UTC-06:00',
    'UTC-05:00','UTC-04:30','UTC-04:00','UTC-03:30','UTC-03:00','UTC-02:00','UTC-01:00','UTC+00:00',
    'UTC+1:00','UTC+02:00','UTC+03:00','UTC+03:30','UTC+04:00','UTC+04:30','UTC+05:00','UTC+05:30',
    'UTC+05:45','UTC+06:00','UTC+06:30','UTC+07:00','UTC+08:00','UTC+08:45','UTC+09:00','UTC+09:30',
    'UTC+10:00','UTC+10:30','UTC+11:00','UTC+12:00','UTC+12:45','UTC+13:00','UTC+14:00'];
  return vals;
}
function parseUtcLabelToOffsetMin(label){
  if(label==='AUTO') return null;
  const m = label.match(/UTC([+-])(\d{1,2}):(\d{2})/);
  if(!m) return 0;
  const sign = m[1]==='-'?-1:1;
  const hh = Number(m[2])||0, mm = Number(m[3])||0;
  return sign*(hh*60+mm);
}
function getSelectedTzOffsetMin(){ const pref=S('tz_pref'); if(!pref || pref.mode==='AUTO'){ return -new Date().getTimezoneOffset(); } return pref.offsetMin||0; }
function tzPopulateSelect(){
  const sel=$('#tz_select'); if(!sel) return;
  sel.innerHTML='';
  tzList().forEach(lb=>{ const opt=document.createElement('option'); opt.value=lb; opt.textContent = lb==='AUTO'?'Авто (системный)':lb; sel.appendChild(opt); });
  const pref=S('tz_pref'); sel.value = pref? (pref.mode==='AUTO'?'AUTO':(pref.label||'AUTO')) : 'AUTO';
}
function tzSave(){ const label=$('#tz_select').value; if(label==='AUTO'){ S('tz_pref',{mode:'AUTO'}); } else { S('tz_pref',{mode:'FIX',label,offsetMin:parseUtcLabelToOffsetMin(label)}); } updateLiveTimers(true); }

/* ========= Navigation ========= */
function nav(btn){
  $all('.tabbar button').forEach(x=>x.classList.remove('active'));
  btn.classList.add('active');
  let v=btn.getAttribute('data-tab');
  $all('.view').forEach(x=>x.classList.remove('active'));
  $('#v-'+v).classList.add('active');
}
function goSettings(){ $all('.tabbar button').forEach(b=>b.classList.remove('active')); document.querySelector('.tabbar button[data-tab="settings"]').classList.add('active'); $all('.view').forEach(v=>v.classList.remove('active')); $('#v-settings').classList.add('active'); }

/* ========= Tariffs (в «Дополнительно») ========= */
function getTar(){return S('tar')||{base:358.46,rc:20,north:50,fee:0,norm:176}}
function tarSave(goHome){
  let t=getTar();
  t.base=toNum($('#tar_base').value)||t.base;
  t.rc=toNum($('#tar_rc').value)||0;
  t.north=toNum($('#tar_north').value)||0;
  t.fee=toNum($('#tar_fee').value)||0;
  t.norm=toNum($('#tar_norm')?.value)||t.norm;
  S('tar',t); updateDash(); renderTrips();
  if(goHome){ $all('.tabbar button').forEach(b=>b.classList.remove('active')); document.querySelector('.tabbar button[data-tab="dashboard"]').classList.add('active'); $all('.view').forEach(v=>v.classList.remove('active')); $('#v-dashboard').classList.add('active'); }
}
function loadTar(){
  let t=getTar();
  if($('#tar_base')) $('#tar_base').value=t.base;
  if($('#tar_rc')) $('#tar_rc').value=t.rc;
  if($('#tar_north')) $('#tar_north').value=t.north;
  if($('#tar_fee')) $('#tar_fee').value=t.fee;
  if($('#tar_norm')) $('#tar_norm').value=t.norm;
}

/* ========= Sections ========= */
function getSecs(){return S('secs')||[]} function setSecs(a){S('secs',a)}
let editingSectionId=null;
function titleForSection(s){ let t=(s.name&&s.name.trim())?s.name.trim():((s.frm||'').trim()+' — '+(s.to||'').trim()); t=t.replace(/\s+/g,' ').trim(); return t||'—'; }
function sectionOpen(){ editingSectionId=null; $('#sectionForm').style.display='block'; $('#s_name').value=''; $('#s_from').value=''; $('#s_to').value=''; $('#s_len').value=''; $('#s_save_btn').textContent='Сохранить'; $('#s_hint').textContent='Новый участок'; }
function sectionCancel(){ $('#sectionForm').style.display='none'; editingSectionId=null; }
function sectionEdit(id){ let s=(getSecs()||[]).find(x=>x.id===id); if(!s) return; editingSectionId=id; $('#sectionForm').style.display='block'; $('#s_name').value=s.name||''; $('#s_from').value=s.frm||''; $('#s_to').value=s.to||''; $('#s_len').value=(s.len!=null?s.len:''); $('#s_save_btn').textContent='Обновить'; $('#s_hint').textContent='Редактирование участка'; }
function sectionSave(){ let name=($('#s_name').value||'').trim(), frm=($('#s_from').value||'').trim(), to=($('#s_to').value||'').trim(), len=toNum($('#s_len').value); let arr=getSecs();
  if(editingSectionId){ let ix=arr.findIndex(x=>x.id===editingSectionId); if(ix>=0){ arr[ix]={id:editingSectionId,name,frm,to,len}; setSecs(arr);} editingSectionId=null; }
  else{ arr.push({id:Date.now(),name,frm,to,len}); setSecs(arr); }
  $('#sectionForm').style.display='none'; renderSecs(); buildRouteOptions(); }
function sectionDel(id, ev){ if(ev) ev.stopPropagation(); if(!confirm('Удалить участок?')) return; setSecs(getSecs().filter(x=>x.id!==id)); renderSecs(); buildRouteOptions(); }
function renderSecs(){ let box=$('#sectionList'); if(!box) return; box.innerHTML=''; let a=getSecs();
  if(!a.length){ let d=document.createElement('div'); d.className='small'; d.style.opacity=.7; d.textContent='Нет участков'; box.appendChild(d); }
  a.forEach(s=>{ let title=titleForSection(s), info=(s.frm||'—')+' → '+(s.to||'—')+(s.len?(' • '+s.len+' км'):'');
    let r=document.createElement('div'); r.className='row tap'; r.setAttribute('onclick','sectionEdit('+s.id+')');
    r.innerHTML='<div style="flex:1"><b>'+title+'</b><div class="small" style="opacity:.7">'+info+'</div></div>'
               +'<div class="actions"><button class="btn" onclick="event.stopPropagation(); sectionEdit('+s.id+')">✎</button>'
               +'<button class="btn" onclick="sectionDel('+s.id+', event)">🗑</button></div>';
    box.appendChild(r);
  });
}

/* ========= Routes datalist & helpers ========= */
function getRoutesCache(){return S('routes_cache')||[]} function setRoutesCache(a){S('routes_cache',a)}
function buildRouteOptions(){
  let dl=$('#routeList'); if(!dl) return; dl.innerHTML=''; let seen=new Set();
  getSecs().forEach(s=>{let title=titleForSection(s); if(title && !seen.has(title)){ seen.add(title); let o=document.createElement('option'); o.value=title; dl.appendChild(o); }});
  (getRoutesCache()).forEach(r=>{let t=(r||'').trim(); if(t && !seen.has(t)){ seen.add(t); let o=document.createElement('option'); o.value=t; dl.appendChild(o); }});
  (getTrips()).forEach(t=>{ [t.route1,t.route2,t.route].forEach(r=>{ let rr=(r||'').trim(); if(rr && !seen.has(rr)){ seen.add(rr); let o=document.createElement('option'); o.value=rr; dl.appendChild(o); }}) });
}
function invertRoute(r){
  if(!r) return '';
  const parts = r.split('—').map(x=>x.trim());
  if(parts.length===2) return parts[1]+' — '+parts[0];
  const dash = r.indexOf('-')>=0 ? '-' : '—';
  const alt = r.split(dash).map(x=>x.trim());
  if(alt.length===2) return alt[1]+' — '+alt[0];
  return r;
}

/* ========= Trips storage ========= */
function getTrips(){return S('trips')||[]} function setTrips(a){S('trips',a)}

/* ========= Passenger following (вклинивается) =========
  Элемент массива passenger:
  { id, dir:'t'|'r', dateStart, route, waitMin, dep, arr, dateEnd }
*/
function ensurePassengers(t){ if(!t.passenger) t.passenger=[]; return t.passenger; }
function addPassengerFollow(){
  // добавляем редактор одну «карточку»
  const c = document.createElement('div');
  const id = Date.now()+Math.random();
  c.className='card';
  c.style.background='var(--ink)';
  c.style.border='1px dashed var(--line)';
  c.style.margin='8px 0';
  c.innerHTML = `
    <div class="row"><label>Направление</label>
      <select data-f="dir">
        <option value="t">Туда</option>
        <option value="r">Обратно</option>
      </select>
    </div>
    <div class="row"><label>Дата (начало)</label><input data-f="dateStart" type="date"></div>
    <div class="row"><label>Маршрут</label><input data-f="route" list="routeList" placeholder="станция А — станция Б"></div>
    <div class="row"><label>Ожидание (мин)</label><input data-f="waitMin" type="number" inputmode="numeric" placeholder="0"></div>
    <div class="row"><label>Отправление</label><input data-f="dep" type="time"></div>
    <div class="row"><label>Прибытие</label><input data-f="arr" type="time"></div>
    <div class="row"><label>Дата (конец)</label><input data-f="dateEnd" type="date"></div>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button class="btn" onclick="this.closest('.card').remove(); recalcDuration();">Удалить</button>
    </div>`;
  $('#passengerList').appendChild(c);
}

/* ========= Form state ========= */
let currentTripId = null;  // null = new
let trainType_t='', trainType_r='';

function chooseTrainType(which){ // 't' or 'r'
  const v = prompt('Выберите вид поезда:\n1 — грузовой\n2 — порожний\n3 — длинносоставный\n4 — резерв\n5 — сплотка\n6 — сдвоенный\n7 — следование пассажиром');
  const map = {1:'грузовой',2:'порожний',3:'длинносоставный',4:'резерв',5:'сплотка',6:'сдвоенный',7:'следование пассажиром'};
  const pick = map[(v||'').trim()];
  if(!pick) return;
  if(which==='t'){ trainType_t=pick; $('#trainType_t').textContent=' · '+pick; }
  else { trainType_r=pick; $('#trainType_r').textContent=' · '+pick; }
}

function clearTripForm(){
  const today = new Date().toISOString().slice(0,10);
  $('#t_date').value = today;
  $('#t_date2').value = ''; // пользователь выставит, если нужно
  $('#t_route1').value=''; $('#t_route2').value='';
  $('#t_start1').value=''; $('#t_end1').value='';
  $('#t_start2').value=''; $('#t_end2').value='';
  $('#t_trainNo1').value=''; $('#t_trainNo2').value='';
  trainType_t=''; trainType_r=''; $('#trainType_t').textContent=''; $('#trainType_r').textContent='';
  $('#t_rest_view').value='0 минут'; $('#t_night_view').value='0 минут'; $('#t_hours_view').value='0 минут';
  $('#t_notes').value='';
  $('#passengerList').innerHTML='';
}

function addTripOpen(){
  currentTripId = null;
  clearTripForm(); buildRouteOptions();
  $('#tripButtonsNew').style.display='';
  $('#tripButtonsEdit').style.display='none';
  $('#tripForm').style.display='block';
}

/* ========= Time helpers & calculations ========= */
function toMin(hhmm){ if(!hhmm) return null; const p=hhmm.split(':'); if(p.length<2) return null; const H=Number(p[0]),M=Number(p[1]); if(isNaN(H)||isNaN(M)) return null; return H*60+M; }
function diffMinutes(a,b){ let x=toMin(a),y=toMin(b); if(x==null||y==null) return null; let d=y-x; if(d<0) d+=24*60; return d; }
function dateAddDays(dateStr, days){ const d=new Date(dateStr+'T00:00:00Z'); d.setUTCDate(d.getUTCDate()+days); return d.toISOString().slice(0,10); }
function epochFromDateTimeTz(dateStr, timeStr, tzOffsetMin){
  if(!dateStr || !timeStr) return null;
  const [Y,M,D]=dateStr.split('-').map(Number); const [h,m]=timeStr.split(':').map(Number);
  if([Y,M,D,h,m].some(isNaN)) return null;
  return Date.UTC(Y,M-1,D,h,m) - tzOffsetMin*60000;
}
function overlap(a1,a2,b1,b2){ const s=Math.max(a1,b1), e=Math.min(a2,b2); return Math.max(0, e-s); }
function legNightMinutes(dateStr, startHHMM, endHHMM, tzMin){
  if(!startHHMM || !endHHMM || !dateStr) return 0;
  let start = epochFromDateTimeTz(dateStr, startHHMM, tzMin);
  let end   = epochFromDateTimeTz(dateStr, endHHMM, tzMin);
  if(start==null || end==null) return 0;
  if(end < start) end += 24*60*60000; // перешли через полночь
  const day0 = epochFromDateTimeTz(dateStr, '00:00', tzMin);
  let night = 0;
  const blocks = [
    [day0 + 22*60*60000, day0 + 24*60*60000],
    [day0 + 24*60*60000, day0 + 30*60*60000]
  ];
  for(const [b1,b2] of blocks){ night += overlap(start,end,b1,b2); }
  return Math.round(night/60000);
}
function countNightWindows0005(startEpoch,endEpoch, tzMin){
  if(startEpoch==null || endEpoch==null) return 0;
  if(endEpoch<=startEpoch) return 0;
  const startLocal = new Date(startEpoch + tzMin*60000);
  const endLocal   = new Date(endEpoch   + tzMin*60000);
  let day = Date.UTC(startLocal.getUTCFullYear(), startLocal.getUTCMonth(), startLocal.getUTCDate());
  const endDay = Date.UTC(endLocal.getUTCFullYear(), endLocal.getUTCMonth(), endLocal.getUTCDate());
  let cnt=0;
  while(day <= endDay + 24*60*60000){
    const wStart = day - tzMin*60000;
    const wEnd   = wStart + 5*60*60000;
    const inter = overlap(startEpoch, endEpoch, wStart, wEnd);
    if(inter > 0) cnt++;
    day += 24*60*60000;
  }
  return cnt;
}
function fmtLocalFull(d, tzOffsetMin){
  if(!d) return '—';
  const localMs = d.getTime() + tzOffsetMin*60000;
  const x = new Date(localMs);
  const yyyy = x.getUTCFullYear();
  const mm = String(x.getUTCMonth()+1).padStart(2,'0');
  const dd = String(x.getUTCDate()).padStart(2,'0');
  const hh = String(x.getUTCHours()).padStart(2,'0');
  const mi = String(x.getUTCMinutes()).padStart(2,'0');
  return dd+'.'+mm+'.'+yyyy+' '+hh+':'+mi;
}

/* ========= Recalc form ========= */
function effectiveReturnDate(){
  const d2 = ($('#t_date2').value||'').trim();
  if(d2) return d2;
  const d1 = $('#t_date').value || new Date().toISOString().slice(0,10);
  const st2=$('#t_start2').value, e1=$('#t_end1').value;
  if(toMin(st2)!=null && toMin(e1)!=null && toMin(st2)<toMin(e1)) return dateAddDays(d1,1);
  return d1;
}
function recalcDuration(){
  const tzMin = getSelectedTzOffsetMin();
  const date = $('#t_date').value;
  const date2 = effectiveReturnDate();

  const l1 = diffMinutes($('#t_start1').value, $('#t_end1').value) || 0;
  const l2 = diffMinutes($('#t_start2').value, $('#t_end2').value) || 0;
  const rest = diffMinutes($('#t_end1').value, $('#t_start2').value) || 0;

  // passenger blocks
  let passMin = 0;
  let passNight = 0;
  $all('#passengerList .card').forEach(card=>{
    const dir = card.querySelector('[data-f="dir"]').value;
    const dS  = (card.querySelector('[data-f="dateStart"]').value||'').trim() || (dir==='r'?date2:date);
    const r   = (card.querySelector('[data-f="route"]').value||'').trim();
    const wait= toNum(card.querySelector('[data-f="waitMin"]').value||'0');
    const dep = (card.querySelector('[data-f="dep"]').value||'').trim();
    const arr = (card.querySelector('[data-f="arr"]').value||'').trim();
    const dE  = (card.querySelector('[data-f="dateEnd"]').value||'').trim() || dS;

    const tripMin = (diffMinutes(dep, arr)||0);
    passMin += wait + tripMin;
    passNight += legNightMinutes(dS, dep, arr, tzMin);
  });

  const totalMin = l1 + l2 + passMin; // без отдыха
  const n1 = legNightMinutes(date,  $('#t_start1').value, $('#t_end1').value, tzMin);
  const n2 = legNightMinutes(date2, $('#t_start2').value, $('#t_end2').value, tzMin);
  const nightTotal = n1 + n2 + passNight;

  $('#t_rest_view').value = rest ? fmtHMWords(rest) : '0 минут';
  $('#t_night_view').value = nightTotal ? fmtHMWords(nightTotal) : '0 минут';
  $('#t_hours_view').value = fmtHMWords(totalMin);
}

/* ========= Build & Save ========= */
function tripSkeletonFromForm(){
  const tzMin = getSelectedTzOffsetMin();
  const date = $('#t_date').value || new Date().toISOString().slice(0,10);
  const date2 = effectiveReturnDate();

  const l1 = diffMinutes($('#t_start1').value, $('#t_end1').value) || 0;
  const l2 = diffMinutes($('#t_start2').value, $('#t_end2').value) || 0;
  const rest = diffMinutes($('#t_end1').value, $('#t_start2').value) || 0;

  let pass=[];
  let passMin=0, passNight=0;
  $all('#passengerList .card').forEach(card=>{
    const dir = card.querySelector('[data-f="dir"]').value;
    const dS  = (card.querySelector('[data-f="dateStart"]').value||'').trim() || (dir==='r'?date2:date);
    const r   = (card.querySelector('[data-f="route"]').value||'').trim();
    const wait= toNum(card.querySelector('[data-f="waitMin"]').value||'0');
    const dep = (card.querySelector('[data-f="dep"]').value||'').trim();
    const arr = (card.querySelector('[data-f="arr"]').value||'').trim();
    const dE  = (card.querySelector('[data-f="dateEnd"]').value||'').trim() || dS;
    pass.push({id:Date.now()+Math.random(), dir, dateStart:dS, route:r, waitMin:wait, dep, arr, dateEnd:dE});
    const tripMin = (diffMinutes(dep, arr)||0);
    passMin += wait + tripMin;
    passNight += legNightMinutes(dS, dep, arr, tzMin);
  });

  const night = legNightMinutes(date,$('#t_start1').value,$('#t_end1').value,tzMin) +
                legNightMinutes(date2,$('#t_start2').value,$('#t_end2').value,tzMin) +
                passNight;

  const totalHours = (l1 + l2 + passMin)/60;

  return {
    date, date2,
    route1: ($('#t_route1').value||'').trim(),
    route2: ($('#t_route2').value||'').trim(),
    trainNo1: ($('#t_trainNo1').value||'').trim(),
    trainNo2: ($('#t_trainNo2').value||'').trim(),
    trainType1: trainType_t || '',
    trainType2: trainType_r || '',
    start1: $('#t_start1').value || '', end1: $('#t_end1').value || '',
    start2: $('#t_start2').value || '', end2: $('#t_end2').value || '',
    rest, hours: totalHours, night,
    notes: ($('#t_notes').value||'').trim(),
    passenger: pass
  };
}

function tripMoney(hours){
  let t=getTar();
  let pct=(t.rc+t.north)/100;
  let gross=hours*t.base*(1+pct);
  let net=gross-(t.fee||0);
  return Math.max(0, Math.round(net));
}

function tripSaveNew(){
  const t = tripSkeletonFromForm();
  t.id = Date.now();
  [t.route1,t.route2].forEach(r=>{if(r){let cache=getRoutesCache();if(!cache.includes(r)){cache.unshift(r); if(cache.length>50) cache.pop(); setRoutesCache(cache);}}});
  const arr=getTrips(); arr.push(t);
  arr.sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id));
  setTrips(arr);
  $('#tripForm').style.display='none';
  renderTrips(); updateDash();
}
function tripOpen(id){
  const t = getTrips().find(x=>x.id===id); if(!t) return;
  currentTripId = id;
  clearTripForm();
  $('#t_date').value = t.date || '';
  $('#t_date2').value = t.date2 || '';
  $('#t_route1').value = t.route1 || '';
  $('#t_route2').value = t.route2 || '';
  $('#t_start1').value = t.start1 || '';
  $('#t_end1').value = t.end1 || '';
  $('#t_start2').value = t.start2 || '';
  $('#t_end2').value = t.end2 || '';
  $('#t_trainNo1').value = t.trainNo1 || '';
  $('#t_trainNo2').value = t.trainNo2 || '';
  trainType_t = t.trainType1||''; trainType_r = t.trainType2||'';
  if(trainType_t) $('#trainType_t').textContent=' · '+trainType_t;
  if(trainType_r) $('#trainType_r').textContent=' · '+trainType_r;
  // passenger
  $('#passengerList').innerHTML='';
  (t.passenger||[]).forEach(p=>{
    addPassengerFollow();
    const last = $('#passengerList .card:last-child');
    last.querySelector('[data-f="dir"]').value = p.dir||'t';
    last.querySelector('[data-f="dateStart"]').value = p.dateStart||'';
    last.querySelector('[data-f="route"]').value = p.route||'';
    last.querySelector('[data-f="waitMin"]').value = p.waitMin||0;
    last.querySelector('[data-f="dep"]').value = p.dep||'';
    last.querySelector('[data-f="arr"]').value = p.arr||'';
    last.querySelector('[data-f="dateEnd"]').value = p.dateEnd||'';
  });
  $('#t_notes').value = t.notes || '';
  recalcDuration();
  $('#tripButtonsNew').style.display='none';
  $('#tripButtonsEdit').style.display='';
  $('#tripForm').style.display='block';
}
function tripSaveEdit(){
  if(currentTripId==null) return;
  let arr=getTrips();
  const ix = arr.findIndex(x=>x.id===currentTripId);
  if(ix<0) return;
  const updated = { ...arr[ix], ...tripSkeletonFromForm() };
  arr[ix] = updated;
  arr.sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id));
  setTrips(arr);
  $('#tripForm').style.display='none';
  renderTrips(); updateDash();
}
function tripCancel(){ $('#tripForm').style.display='none'; currentTripId=null; }

/* ========= Live & Two nights ========= */
function shouldBeLive(t){
  if(t.start1 && !t.end1) return 'leg1';
  if(t.start2 && !t.end2) return 'leg2';
  return '';
}
function humanSince(ms){ if(ms==null || ms<0) return '—'; const min = Math.floor(ms/60000); const h = Math.floor(min/60), m=min%60; return h+'ч '+String(m).padStart(2,'0')+'м'; }
function effectiveReturnDateForTrip(t){
  if(t.date2 && t.date2.trim()) return t.date2.trim();
  if(t.start2 && t.end1 && toMin(t.start2)!=null && toMin(t.end1)!=null && toMin(t.start2) < toMin(t.end1)) return dateAddDays(t.date,1);
  return t.date;
}
function isTwoNightsTrip(t){
  const tzMin = getSelectedTzOffsetMin();
  const date = t.date;
  if(!date) return false;
  const startEpoch = epochFromDateTimeTz(date, t.start1 || t.start2, tzMin);
  const date2 = effectiveReturnDateForTrip(t);
  const endEpoch = epochFromDateTimeTz(date2, t.end2 || t.end1 || t.start2 || t.start1, tzMin);
  const cnt = countNightWindows0005(startEpoch, endEpoch, tzMin);
  return cnt >= 2;
}
function updateLiveTimers(){
  const tzMin = getSelectedTzOffsetMin(); const now = Date.now();
  $all('[data-live-trip]').forEach(el=>{
    const id = Number(el.getAttribute('data-live-trip'));
    const t = (getTrips()||[]).find(x=>x.id===id);
    if(!t){ el.textContent=''; return; }
    const mode = shouldBeLive(t);
    if(!mode){ el.textContent=''; return; }
    const date = t.date || new Date().toISOString().slice(0,10);
    const date2 = effectiveReturnDateForTrip(t);
    let startEpoch = (mode==='leg1')
      ? epochFromDateTimeTz(date, t.start1, tzMin)
      : epochFromDateTimeTz(date2, t.start2, tzMin);
    if(startEpoch==null){ el.textContent=''; return; }
    el.textContent = 'в пути · '+humanSince(now - startEpoch);
  });
}

/* ========= Render trips (карточки-аккордеоны, компакт) ========= */
function tripMoneySafe(t){ return tripMoney(toNum(t.hours)); }
function renderTrips(){
  let box=$('#daysList');box.innerHTML='';
  let arr=getTrips().slice();
  arr.sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id));
  if(!arr.length){let d=document.createElement('div');d.className='small';d.style.opacity=.7;d.textContent='Нет поездок';box.appendChild(d)}
  let totalMoney=0;
  arr.forEach(t=>{
    const money = tripMoneySafe(t); totalMoney+=money;
    const live = shouldBeLive(t) ? '<span class="badge-live" data-live-trip="'+t.id+'"></span>' : '';
    const twoN = isTwoNightsTrip(t) ? '<span class="badge-two">две ночи</span>' : '';
    const hmin = Math.round(toNum(t.hours)*60);
    const short = `
      <div><b>${t.date||'—'}</b> • ${t.route1||'—'} ${live} ${twoN}
      </div>
      <div>${(t.hours?toNum(t.hours).toFixed(1):'—')} ч</div>
      <div class="money">${(t.hours?RUR.format(money):'—')}</div>
      <div class="actions">
        <button class="btn" onclick="tripOpen(${t.id})">🔍</button>
        <button class="btn" onclick="tripDel(${t.id})">🗑</button>
      </div>`;
    const meta = `
      <div class="small" style="opacity:.8; margin-top:6px; line-height:1.4">
        №${t.trainNo1||'—'} ${t.trainType1||''} • явка ${t.start1||'—'} — конец ${t.end1||'—'}<br>
        ${t.date2?('['+t.date2+'] '):''}${t.route2?(''+t.route2):''} №${t.trainNo2||'—'} ${t.trainType2||''} • явка ${t.start2||'—'} — конец ${t.end2||'—'}<br>
        отдых: ${t.rest?fmtHMWords(toNum(t.rest)):'—'} • ночные: ${t.night?fmtHMWords(toNum(t.night)):'—'}
      </div>`;
    const wrap=document.createElement('div'); wrap.className='trip tap';
    wrap.innerHTML=short;
    wrap.addEventListener('click', function(e){
      // аккордеон: разворачиваем/сворачиваем детали
      if(this.querySelector('.more')){ this.querySelector('.more').remove(); }
      else { const dd=document.createElement('div'); dd.className='more'; dd.innerHTML=meta; dd.style.gridColumn='1 / -1'; this.appendChild(dd); }
      e.stopPropagation();
    });
    box.appendChild(wrap);
  });
  if(arr.length){
    let sum=document.createElement('div'); sum.className='small'; sum.style.textAlign='right'; sum.style.marginTop='6px'; sum.style.opacity='.9';
    sum.textContent='Итого за месяц: '+RUR.format(totalMoney);
    box.appendChild(sum);
  }
  updateLiveTimers();
}

/* ========= Dashboard ========= */
function updateDash(){
  let t=getTar();
  let trips=getTrips().slice().sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id));
  let minsTotal = Math.round((trips.reduce((a,x)=>a+toNum(x.hours),0))*60);
  let nightTotal = trips.reduce((a,x)=>a+toNum(x.night),0);
  let norm=t.norm*60; let pct=norm?Math.round(minsTotal/norm*100):0; let rem=norm-minsTotal;
  $('#mwNorm').textContent=t.norm+' ч';
  $('#mwWorked').textContent=fmtM(minsTotal)+' (ночные: '+fmtHMWords(nightTotal)+')';
  $('#mwPercent').textContent=pct+'%';
  $('#mwRemain').textContent=rem>=0?('Осталось: '+fmtM(rem)):('Переработка: '+fmtM(-rem));
  $('#mwBar').style.width=Math.min(pct,100)+'%';
}

/* ========= Salary (PIN-guarded) ========= */
function hideSalary(){ const b=$('#salaryBox'); if(b) b.innerHTML=''; }
function renderSalary(){
  checkPinBefore(()=> {
    const box = $('#salaryBox'); box.innerHTML='';
    const trips = getTrips().slice().sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id));
    if(!trips.length){ box.textContent='Нет данных'; return; }

    const now = new Date(); const y=now.getFullYear(); const m=String(now.getMonth()+1).padStart(2,'0');
    const curMonth = `${y}-${m}`;
    const R = (hh)=>tripMoney(hh);

    let curMoney=0, curNight=0, curHours=0;
    trips.forEach(t=>{ if((t.date||'').slice(0,7)===curMonth){ curHours+=toNum(t.hours); curNight+=toNum(t.night); curMoney+=R(toNum(t.hours)); } });

    const top=document.createElement('div'); top.className='card';
    top.innerHTML = `<b>Текущий месяц (${curMonth})</b>
      <div class="kv" style="margin-top:6px">
        <div>Всего денег</div><div>${RUR.format(Math.round(curMoney))}</div>
        <div>Ночных</div><div>${fmtHMWords(Math.round(curNight))}</div>
        <div>Часы</div><div>${(curHours||0).toFixed(1)} ч</div>
      </div>`;
    box.appendChild(top);

    const tbl=document.createElement('div'); tbl.className='card';
    let html='<b>Поездки (месяц)</b><table style="margin-top:6px"><thead><tr><th>Дата</th><th>Маршрут</th><th>Часы</th><th>Ночные</th><th>₽</th></tr></thead><tbody>';
    trips.filter(t=> (t.date||'').slice(0,7)===curMonth).forEach(t=>{
      html+=`<tr><td>${t.date||''}</td><td>${t.route1||''}</td><td>${(toNum(t.hours)||0).toFixed(1)}</td><td>${fmtHMWords(toNum(t.night)||0)}</td><td>${RUR.format(tripMoneySafe(t))}</td></tr>`;
    });
    html+='</tbody></table>';
    tbl.innerHTML=html;
    box.appendChild(tbl);
  });
}

/* ========= Calendar (list / simple month grid) ========= */
function hideCalendar(){ const b=$('#calendarBox'); if(b) b.innerHTML=''; }
function showCalendar(){
  const box=$('#calendarBox'); box.innerHTML='';
  const trips=getTrips().slice();
  if(!trips.length){ box.textContent='Нет поездок'; return; }
  // минимальный календарь: список по датам
  const byDate={};
  trips.forEach(t=>{ const d=t.date||''; if(!byDate[d]) byDate[d]=[]; byDate[d].push(t); });
  const days = Object.keys(byDate).sort();
  let html='<div class="card"><b>Список по датам</b><div style="margin-top:6px">';
  days.forEach(d=>{
    const sum = byDate[d].reduce((a,x)=>a+toNum(x.hours),0);
    html+=`<div style="padding:6px 0;border-bottom:1px solid var(--line)"><b>${d}</b> • ${(sum||0).toFixed(1)} ч</div>`;
  });
  html+='</div></div>';
  box.innerHTML=html;
}

/* ========= Full Rest (красиво) ========= */
function closeFullRest(){ const box=$('#restResult'); if(box){ box.innerHTML=''; } }
function calcFullRest(){
  const arr=getTrips(); if(!arr.length){ alert('Нет поездок'); return; }
  const t = arr.slice().sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id)).pop();

  const d1 = diffMinutes(t.start1, t.end1) || 0;
  const date2 = effectiveReturnDateForTrip(t);
  const d2 = diffMinutes(t.start2, t.end2) || 0;

  const totalWorkMin = d1 + d2 + (t.passenger||[]).reduce((a,p)=> a + toNum(p.waitMin||0) + (diffMinutes(p.dep,p.arr)||0), 0);
  const restMin = toNum(t.rest) || diffMinutes(t.end1, t.start2) || 0;

  const tzMin = getSelectedTzOffsetMin();
  const startEpoch = epochFromDateTimeTz(t.date, t.start1 || t.start2, tzMin);
  const endEpoch   = epochFromDateTimeTz(date2, t.end2 || t.end1 || t.start2 || t.start1, tzMin);
  const night0005Count = countNightWindows0005(startEpoch, endEpoch, tzMin);
  const twoNights = night0005Count >= 2;

  const fullRestMin = Math.max(0, Math.round(totalWorkMin * 2.6 - (twoNights ? 0 : restMin)));
  const fullRestWithDayMin = fullRestMin + 24*60;

  const endBackEpoch = epochFromDateTimeTz(date2, t.end2 || t.start2 || t.end1 || t.start1, tzMin);
  let endRest=null, endRestW=null;
  if(endBackEpoch!=null){
    endRest  = new Date(endBackEpoch + fullRestMin*60000);
    endRestW = new Date(endBackEpoch + fullRestWithDayMin*60000);
  }

  const box = $('#restResult'); box.innerHTML='';
  const panel = document.createElement('div'); panel.className='card';
  panel.innerHTML = `
    <div class="kv">
      <div>Маршрут</div><div><b>${t.route1||'—'}</b></div>
      <div>На работе</div><div>${fmtHMWords(totalWorkMin)}</div>
      <div>Отдых между плечами</div><div>${restMin?fmtHMWords(restMin):'—'}</div>
      <div>Две ночи (00–05)</div><div>${twoNights?'Да':'Нет'}</div>
      <div>Полный отдых</div><div><b>${fmtHMWords(fullRestMin)}</b></div>
      <div>Окончание полного отдыха</div><div>${endRest?fmtLocalFull(endRest,tzMin):'—'}</div>
      <div>Полный отдых + выходной</div><div>${fmtHMWords(fullRestWithDayMin)}</div>
      <div>Окончание с выходным</div><div>${endRestW?fmtLocalFull(endRestW,tzMin):'—'}</div>
    </div>`;
  box.appendChild(panel);
}

/* ========= Auto-invert route2 on focus ========= */
function setupAutoInvert(){
  const r1 = $('#t_route1'), r2 = $('#t_route2');
  if(r1 && r2){
    r2.addEventListener('focus', ()=>{
      const base = (r1.value||'').trim();
      if(base && !r2.value){ r2.value = invertRoute(base); }
    });
  }
}/* ========= INIT & wiring ========= */
function init(){
  // Тема
  const theme = S('theme') || 'dark';
  setTheme(theme);

  // Сеть
  updateNetPill();

  // Тарифы (если поля существуют на текущем экране)
  try{ loadTar(); }catch(e){}

  // TZ
  tzPopulateSelect();

  // Маршруты/участки
  try{ renderSecs(); buildRouteOptions(); }catch(e){}

  // Поездки/дашборд
  try{ renderTrips(); updateDash(); }catch(e){}

  // Таймеры «в пути»
  setInterval(updateLiveTimers, 30000);

  // Авто-инверсия маршрута2 при фокусе
  setupAutoInvert();

  // Ре-калькуляции формы
  ['t_date','t_date2','t_start1','t_end1','t_start2','t_end2'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('input', recalcDuration);
  });

  // Если есть кнопка «добавить следование пассажиром»
  const btnP = document.getElementById('btnAddPassenger');
  if(btnP) btnP.addEventListener('click', ()=>{ addPassengerFollow(); });

  // Кнопки выбора вида поезда (туда/обратно)
  const btnTypeT = document.getElementById('btnType_t');
  const btnTypeR = document.getElementById('btnType_r');
  if(btnTypeT) btnTypeT.addEventListener('click', ()=>chooseTrainType('t'));
  if(btnTypeR) btnTypeR.addEventListener('click', ()=>chooseTrainType('r'));
}
document.addEventListener('DOMContentLoaded', init);

/* ========= PWA: SW + кнопка «Обновить» ========= */
(function(){
  const usp = new URLSearchParams(location.search);
  if (usp.get('no-sw') === '1') {
    if ('serviceWorker' in navigator) { navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister())); }
    if (window.caches) caches.keys().then(ks => ks.forEach(k => caches.delete(k)));
    console.log('SW disabled by ?no-sw=1');
    return;
  }

  window.appUpdate = async function(){
    try{
      if (!('serviceWorker' in navigator)) { location.reload(); return; }
      const reg = await navigator.serviceWorker.getRegistration();
      if (!reg) { location.reload(); return; }
      if (reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'}); else await reg.update();
      let reloaded=false;
      navigator.serviceWorker.addEventListener('controllerchange', ()=>{ if(!reloaded){reloaded=true; location.replace(location.pathname+'?cb='+Date.now());}});
      setTimeout(()=>{ if(!reloaded) location.replace(location.pathname+'?cb='+Date.now()); }, 1000);
    }catch(e){ location.reload(); }
  };

  window.addEventListener('load', function(){
    updateNetPill();
    if (!('serviceWorker' in navigator)) return;
    const scope = location.pathname.replace(/\/[^\/]*$/, '/') || '/';
    navigator.serviceWorker.register('sw.js', { scope }).then(reg => {
      const btn = document.getElementById('appRefresh');
      function showRefresh(){ if(btn) btn.style.display=''; }
      if (reg.waiting) showRefresh();
      reg.addEventListener('updatefound', ()=>{
        const nw = reg.installing; if(!nw) return;
        nw.addEventListener('statechange', ()=>{ if (nw.state==='installed' && navigator.serviceWorker.controller) showRefresh(); });
      });
      navigator.serviceWorker.addEventListener('controllerchange', ()=>{ if(btn) btn.style.display='none'; });
    }).catch(err => console.warn('SW register failed', err));
  });
})();
