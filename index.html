<!-- PART 1/7 START -->
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>–ë–ª–æ–∫–Ω–æ—Ç –ú–∞—à–∏–Ω–∏—Å—Ç–∞ ¬∑ Lite v2025.32-PWA</title>
<meta name="theme-color" content="#d32f2f">

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<!-- iOS –∏–∫–æ–Ω–∫–∏ -->
<link rel="apple-touch-icon" href="apple-touch-icon.png?v=202532">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180x180.png?v=202532">
<link rel="apple-touch-icon" sizes="167x167" href="apple-touch-icon-167x167.png?v=202532">
<link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon-152x152.png?v=202532">

<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0}
:root{
  --red:#d32f2f;--bg:#0f1420;--card:#161d2a;--line:#243246;--mut:#8aa0b6;--txt:#e9eef5;
  --ink:#0e1622;--ok:#1b2738;--green:#2e7d32;--amber:#ffb300
}
body.theme-light{ --bg:#ffffff; --card:#ffffff; --line:#e6ecf3; --mut:#5b6b7a; --txt:#101622; --ink:#f5f7fb; --ok:#e8eef7; }
body{background:var(--bg);color:var(--txt);font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
a{color:inherit}

header{position:sticky;top:0;background:var(--red);color:#fff;padding:12px 14px;display:flex;gap:10px;justify-content:space-between;align-items:center;z-index:10;flex-wrap:wrap}
h1{margin:0;font-size:18px}
.badge{font-size:12px;padding:2px 8px;border:1px solid rgba(255,255,255,.4);border-radius:999px;white-space:nowrap}

.container{padding:12px 12px 90px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:10px}
.row{display:flex;gap:8px;align-items:center;margin:8px 0}
.row label{width:48%;color:var(--mut);font-size:14px}
.row input,.row select,.row textarea{flex:1;background:var(--ink);border:1px solid var(--line);color:var(--txt);padding:10px;border-radius:10px;font-size:16px}
.row textarea{min-height:90px;resize:vertical}

.btn{background:var(--ok);color:#fff;border:1px solid var(--line);padding:10px 14px;border-radius:10px;font-size:15px;cursor:pointer}
.btn.primary{background:#fff;color:#d32f2f;border-color:#fff}
.small{font-size:12px}

.view{display:none}
.view.active{display:block}

.tabbar{position:fixed;left:0;right:0;bottom:0;height:70px;background:#121828;border-top:1px solid var(--line);display:flex}
body.theme-light .tabbar{background:#f6f8fb;border-top-color:#e6ecf3}
.tabbar button{flex:1;background:transparent;border:none;color:#8aa0b6;font-size:12px;padding:6px 0}
.tabbar button.active{color:#fff}
body.theme-light .tabbar button.active{color:#d32f2f}
.tabbar .ico{display:block;font-size:18px;margin-bottom:4px}

.progress{height:10px;border:1px solid var(--line);border-radius:999px;overflow:hidden;background:#0f2035}
body.theme-light .progress{background:#ffe6e6}
.progress>div{height:100%;background:#d32f2f;width:0%}

.trip{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid var(--line)}
.trip:last-child{border-bottom:0}
.actions{display:flex;gap:6px}
.tap{cursor:pointer}
.money{white-space:nowrap}
.legend{color:#a9bacd;font-size:12px;margin:-2px 0 6px}
table{width:100%;border-collapse:collapse}
th,td{padding:6px 4px;border-bottom:1px solid var(--line);text-align:left}
th{color:#a9bacd}

/* –±–µ–π–¥–∂–∏ */
.badge-live{display:inline-block;background:rgba(46,125,50,.12);border:1px solid rgba(46,125,50,.6);color:#2e7d32;padding:2px 6px;border-radius:999px;font-size:12px;margin-left:6px;white-space:nowrap}
.badge-two{display:inline-block;background:rgba(211,47,47,.15);border:1px solid rgba(211,47,47,.6);color:#ff8a80;padding:2px 6px;border-radius:999px;font-size:12px;margin-left:6px;white-space:nowrap}

/* —Å–µ—Ç—å/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è */
.net-pill{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.5);padding:4px 8px;border-radius:999px;font-size:12px}
.net-pill.off{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.3);color:#ffe082}
.net-pill.on{background:rgba(255,255,255,.2);border-color:rgba(255,255,255,.7);color:#c8e6c9}
.update-pill{background:#fff;color:#d32f2f;border:1px solid #fff;padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer;display:none}

/* –ø—Ä–æ—Ñ–∏–ª—å */
.avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,.3)}
.avatar.big{width:64px;height:64px}

/* —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ / —Å–µ—Ç–∫–∞ */
.hr{height:1px;background:var(--line);margin:8px 0}
.kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px}

/* –ø–æ–∏—Å–∫–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ + –∫–Ω–æ–ø–∫–∞ ¬´–ú–µ—Å—è—Ü¬ª */
.searchbar{display:flex;gap:8px;align-items:center;margin:10px 0}
.searchbar input{flex:1;min-width:0;padding:8px 10px;border-radius:999px;background:var(--ink);border:1px solid var(--line);font-size:14px}
.searchbar .btn{padding:8px 12px;font-size:13px;border-radius:999px}

/* –≤—ã–ø–∞–¥–∞—é—â–∏–π –ø–∏–∫–µ—Ä –º–µ—Å—è—Ü–∞ */
.month-pop{position:relative;display:inline-block}
.month-pop .panel{
  position:absolute;top:110%;right:0;z-index:20;background:var(--card);border:1px solid var(--line);
  border-radius:10px;padding:8px;width:220px;box-shadow:0 10px 24px rgba(0,0,0,.25)
}
.month-pop .panel button{width:100%;text-align:left;margin:4px 0}

/* –∫–∞—Ä—Ç–æ—á–∫–∞ ¬´–ø–∞—Å—Å–∞–∂–∏—Ä–æ–º¬ª */
.card.inline{background:var(--ink);border:1px dashed var(--line)}
</style>
</head>

<body>
<header>
  <h1>–ë–ª–æ–∫–Ω–æ—Ç –ú–∞—à–∏–Ω–∏—Å—Ç–∞</h1>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <span id="netStatus" class="net-pill off">–û—Ñ—Ñ–ª–∞–π–Ω</span>
    <div class="badge">Lite v2025.32-PWA</div>
    <button id="appRefresh" class="update-pill" onclick="appUpdate()">–û–±–Ω–æ–≤–∏—Ç—å</button>
  </div>
</header>

<main class="container">
  <!-- –ì–ª–∞–≤–Ω–∞—è -->
  <section id="v-dashboard" class="view active">
    <div class="card">
      <div style="display:flex;justify-content:space-between"><b>–ú–µ—Å—è—á–Ω–∞—è –Ω–æ—Ä–º–∞</b><b id="mwNorm">‚Äî</b></div>
      <div class="progress" style="margin-top:6px"><div id="mwBar"></div></div>
      <div class="row"><label>–ù–æ—Ä–º–∞, —á/–º–µ—Å</label><input id="tar_norm" type="number" inputmode="decimal" placeholder="176" oninput="tarSave()"></div>
      <div class="row"><label>–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ</label><div id="mwWorked" class="small">‚Äî</div></div>
      <div class="row"><label>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</label><div id="mwPercent" class="small">‚Äî</div></div>
      <div class="row"><label>–û—Å—Ç–∞–ª–æ—Å—å/–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞</label><div id="mwRemain" class="small">‚Äî</div></div>
    </div>

    <!-- –ü–æ–∏—Å–∫ + –≤—ã–±–æ—Ä –º–µ—Å—è—Ü–∞ -->
    <div class="searchbar">
      <input id="searchTrips" placeholder="–ü–æ–∏—Å–∫: –¥–∞—Ç–∞, –º–∞—Ä—à—Ä—É—Ç, ‚Ññ, –≤–∏–¥, ¬´–¥–≤–µ –Ω–æ—á–∏¬ª, –∑–∞–º–µ—Ç–∫–∏‚Ä¶">
      <div class="month-pop">
        <button class="btn" onclick="toggleMonthPicker()">–ú–µ—Å—è—Ü: <span id="monthLbl"></span></button>
        <div id="monthPanel" class="panel" style="display:none"></div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>–ü–æ–µ–∑–¥–∫–∏</b>
        <div>
          <button class="btn primary" onclick="addTripOpen()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn" onclick="exportTripsCsv()">CSV</button>
        </div>
      </div>

      <!-- –§–æ—Ä–º–∞ –ø–æ–µ–∑–¥–∫–∏ –±—É–¥–µ—Ç –≤ Part 2/7 -->
      <div id="tripForm" class="card" style="display:none;margin-top:10px"></div>

      <!-- –°–ø–∏—Å–æ–∫ –¥–Ω–µ–π/–ø–æ–µ–∑–¥–æ–∫ -->
      <div id="daysList" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- –£—á–∞—Å—Ç–∫–∏ -->
  <section id="v-sections" class="view">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>–£—á–∞—Å—Ç–∫–∏</b>
        <div class="actions"><button class="btn" onclick="sectionOpen()">–ù–æ–≤—ã–π —É—á–∞—Å—Ç–æ–∫</button></div>
      </div>

      <div id="sectionForm" class="card" style="display:none;margin-top:10px">
        <div class="row"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="s_name" placeholder="–ù–∞–ø—Ä.: –ú–∞–ª–æ—à—É–π–∫–∞ ‚Äî –û–±–æ–∑–µ—Ä—Å–∫–∞—è"></div>
        <div class="row"><label>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label><input id="s_from"></div>
        <div class="row"><label>–ü—Ä–∏–±—ã—Ç–∏–µ</label><input id="s_to"></div>
        <div class="row"><label>–î–ª–∏–Ω–∞ (–∫–º)</label><input id="s_len" type="number" inputmode="decimal" placeholder="0"></div>
        <div class="row">
          <button id="s_save_btn" class="btn primary" onclick="sectionSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn" onclick="sectionCancel()">–û—Ç–º–µ–Ω–∞</button>
        </div>
        <div class="small" id="s_hint" style="opacity:.7"></div>
      </div>

      <div id="sectionList"></div>
    </div>
  </section>

  <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ -->
  <section id="v-more" class="view">
    <div class="card">
      <b>–ü–æ–ª–Ω—ã–π –æ—Ç–¥—ã—Ö –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–µ–∑–¥–∫–µ</b>
      <div id="restResult" style="margin-top:8px"></div>
      <div class="row" style="gap:8px;margin-top:10px">
        <button class="btn primary" onclick="calcFullRest()">–ü–æ—Å—á–∏—Ç–∞—Ç—å</button>
        <button class="btn" onclick="closeFullRest()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <div class="card">
      <b>–†–ñ–î –∑–∞—Ä–ø–ª–∞—Ç–∞</b>
      <div id="salaryBox" style="margin-top:8px"></div>
      <div class="row" style="gap:8px;margin-top:10px">
        <button class="btn primary" onclick="renderSalary()">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        <button class="btn" onclick="hideSalary()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <div class="card">
      <b>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ–µ–∑–¥–æ–∫</b>
      <div id="calendarBox" style="margin-top:8px"></div>
      <div class="row" style="gap:8px;margin-top:10px">
        <button class="btn primary" onclick="showCalendar()">–û—Ç–∫—Ä—ã—Ç—å</button>
        <button class="btn" onclick="hideCalendar()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <div class="card">
      <b>–¢–∞—Ä–∏—Ñ –∏ –Ω–∞–¥–±–∞–≤–∫–∏</b>
      <div class="row"><label>‚ÇΩ/—á–∞—Å (—Å—Ç–∞–≤–∫–∞)</label><input id="tar_base" type="number" inputmode="decimal" placeholder="358.46"></div>
      <div class="row"><label>–†–∞–π–æ–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç, %</label><input id="tar_rc" type="number" inputmode="decimal" placeholder="20"></div>
      <div class="row"><label>–°–µ–≤–µ—Ä–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç, %</label><input id="tar_north" type="number" inputmode="decimal" placeholder="50"></div>
      <div class="row"><label>–ö–æ–º. —Ä–∞—Å—Ö–æ–¥—ã, ‚ÇΩ</label><input id="tar_fee" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><button class="btn primary" onclick="tarSave(true)">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ</button></div>

      <div class="hr"></div>
      <div class="small" style="opacity:.8">
        –í –¥–µ—Ç–∞–ª—å–Ω–æ–º –∫–≤–∏—Ç–∫–µ (–±—É–¥–µ—Ç –≤ ¬´–†–ñ–î –∑–∞—Ä–ø–ª–∞—Ç–∞¬ª) –±—É–¥—É—Ç —Å—Ç—Ä–æ–∫–∏ ¬´–ö–æ–¥ / –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ / –ö–æ–ª-–≤–æ / –¢–∞—Ä–∏—Ñ / –°—É–º–º–∞¬ª.
        –ö–æ–¥—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –ø–æ–µ–∑–¥–∫–∞–º.
      </div>
    </div>
  </section>

  <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <section id="v-settings" class="view">
    <div class="card">
      <b>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</b>
      <div class="row"><button class="btn" onclick="appUpdate()">–û–±–Ω–æ–≤–∏—Ç—å –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏</button></div>
      <div class="small" style="opacity:.8">–ù–∞–∂–º–∏—Ç–µ –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏. –î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç—Å—è.</div>
    </div>

    <div class="card">
      <b>–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</b>
      <div class="row">
        <label>–ü–æ—è—Å</label>
        <select id="tz_select" onchange="tzSave()"></select>
      </div>
      <div class="small" style="opacity:.8">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è ¬´–≤ –ø—É—Ç–∏¬ª, –Ω–æ—á–Ω—ã—Ö –∏ —Ä–∞—Å—á—ë—Ç–∞ –æ—Ç–¥—ã—Ö–∞.</div>
    </div>

    <div class="card">
      <b>–ö–æ–¥-–¥–æ—Å—Ç—É–ø –∫ –∑–∞—Ä–ø–ª–∞—Ç–µ</b>
      <div class="row"><input id="pin_code" type="password" placeholder="PIN"></div>
      <div class="row"><button class="btn primary" onclick="savePin()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å PIN</button></div>
    </div>

    <div class="card">
      <b>–¢–µ–º–∞</b>
      <div class="row">
        <select id="theme_select" onchange="setTheme(this.value)">
          <option value="dark">–¢—ë–º–Ω–∞—è</option>
          <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
        </select>
      </div>
      <div class="small" style="opacity:.8">–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
    </div>

    <div class="card small" style="opacity:.8">–í–µ—Ä—Å–∏—è Lite 2025.32-PWA</div>
    <div class="small" style="opacity:.8;text-align:center">
      <a href="https://t.me/nikitagrigorev99" target="_blank" style="color:#e9eef5;text-decoration:underline">by Nikita Grigorev</a>
    </div>
  </section>

  <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
  <section id="v-profile" class="view">
    <div class="card">
      <b>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</b>
      <div class="row" style="align-items:flex-start">
        <label>–§–æ—Ç–æ</label>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <img id="pfAvatarBig" class="avatar big">
          <input id="pf_photo" type="file" accept="image/*" onchange="profilePhotoChanged(event)">
        </div>
      </div>
      <div class="row"><label>–ò–º—è</label><input id="pf_first" placeholder="–ò–≤–∞–Ω"></div>
      <div class="row"><label>–§–∞–º–∏–ª–∏—è</label><input id="pf_last" placeholder="–ò–≤–∞–Ω–æ–≤"></div>
      <div class="row"><label>–í–æ–∑—Ä–∞—Å—Ç</label><input id="pf_age" type="number" inputmode="numeric" placeholder="30"></div>
      <div class="row"><label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label><input id="pf_role" placeholder="–ú–∞—à–∏–Ω–∏—Å—Ç"></div>
      <div class="row"><label>–ú–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã</label><input id="pf_place" placeholder="–î–µ–ø–æ ..."></div>
      <div class="row"><label>–î–∞—Ç–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label><input id="pf_start" type="date" onchange="renderTenure()"></div>
      <div class="row"><label>–°—Ç–∞–∂</label><input id="pf_tenure" type="text" readonly></div>

      <div class="hr"></div>
      <b>–ó–∞–º–µ—Ç–∫–∏</b>
      <div class="row"><textarea id="pf_notes" placeholder="–õ–∏—á–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –ø–æ —Ä–∞–±–æ—Ç–µ..."></textarea></div>

      <div class="hr"></div>
      <b>–§–∞–π–ª—ã</b>
      <div class="row">
        <input id="fileInput" type="file" multiple onchange="addFilesToFolder(event)">
      </div>
      <div id="filesList"></div>

      <div class="row" style="gap:8px">
        <button class="btn primary" onclick="profileSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" onclick="goSettings()">–ù–∞–∑–∞–¥</button>
      </div>
    </div>
  </section>
</main>

<nav class="tabbar">
  <button class="active" data-tab="dashboard" onclick="nav(this)"><span class="ico">üè†</span>–ì–ª–∞–≤–Ω–∞—è</button>
  <button data-tab="sections" onclick="nav(this)"><span class="ico">üó∫Ô∏è</span>–£—á–∞—Å—Ç–∫–∏</button>
  <button data-tab="more" onclick="nav(this)"><span class="ico">‚ûï</span>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</button>
  <button data-tab="settings" onclick="nav(this)"><span class="ico">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  <button data-tab="profile" onclick="nav(this)"><span class="ico">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</button>
</nav>
<!-- PART 1/7 END --><!-- PART 2/7 START -->
<!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–µ–∑–¥–∫–∏ -->
<div id="tripForm" class="card" style="display:none;margin-top:10px">
  <div class="legend" style="margin-bottom:6px"><b>–¢—É–¥–∞</b></div>
  <div class="row"><label>–î–∞—Ç–∞ (—Ç—É–¥–∞)</label><input id="t_date" type="date"></div>
  <div class="row"><label>–ú–∞—Ä—à—Ä—É—Ç (—Ç—É–¥–∞)</label><input id="t_route1" list="routeList"></div>
  <datalist id="routeList"></datalist>
  <div class="row"><label>–Ø–≤–∫–∞ (—Ç—É–¥–∞)</label><input id="t_start1" type="time" oninput="recalcDuration()"></div>
  <div class="row"><label>–ù–æ–º–µ—Ä –ø–æ–µ–∑–¥–∞</label><input id="t_trainNo1" placeholder="2105"></div>
  <div class="row"><label>–í–∏–¥ –ø–æ–µ–∑–¥–∞</label>
    <button class="btn" onclick="chooseTrainType('t')">–í—ã–±—Ä–∞—Ç—å</button>
    <span id="trainType_t"></span>
  </div>
  <div class="row"><label>–ö–æ–Ω–µ—Ü —Ä–∞–±–æ—Ç—ã (—Ç—É–¥–∞)</label><input id="t_end1" type="time" oninput="recalcDuration()"></div>

  <div class="legend" style="margin-top:14px;margin-bottom:6px"><b>–û–±—Ä–∞—Ç–Ω–æ</b></div>
  <div class="row"><label>–î–∞—Ç–∞ (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_date2" type="date" oninput="recalcDuration()"></div>
  <div class="row"><label>–ú–∞—Ä—à—Ä—É—Ç (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_route2" list="routeList"></div>
  <div class="row"><label>–Ø–≤–∫–∞ (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_start2" type="time" oninput="recalcDuration()"></div>
  <div class="row"><label>–ù–æ–º–µ—Ä –ø–æ–µ–∑–¥–∞</label><input id="t_trainNo2" placeholder="2106"></div>
  <div class="row"><label>–í–∏–¥ –ø–æ–µ–∑–¥–∞</label>
    <button class="btn" onclick="chooseTrainType('r')">–í—ã–±—Ä–∞—Ç—å</button>
    <span id="trainType_r"></span>
  </div>
  <div class="row"><label>–ö–æ–Ω–µ—Ü —Ä–∞–±–æ—Ç—ã (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_end2" type="time" oninput="recalcDuration()"></div>

  <div class="legend" style="margin-top:14px;margin-bottom:6px"><b>–°–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º</b></div>
  <div class="row"><button class="btn" onclick="addPassengerFollow()">+ –î–æ–±–∞–≤–∏—Ç—å —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º</button></div>
  <div id="passengerList"></div>

  <div class="legend" style="margin-top:14px;margin-bottom:6px"><b>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</b></div>
  <div class="row"><label>–û—Ç–¥—ã—Ö</label><input id="t_rest_view" type="text" readonly></div>
  <div class="row"><label>–ù–æ—á–Ω—ã–µ</label><input id="t_night_view" type="text" readonly></div>
  <div class="row"><label>–ß–∞—Å—ã (–∏—Ç–æ–≥, –±–µ–∑ –æ—Ç–¥—ã—Ö–∞)</label><input id="t_hours_view" type="text" readonly></div>

  <div class="row"><label>–ó–∞–º–µ—Ç–∫–∏</label><textarea id="t_notes" placeholder="–ü—Ä–æ—Å—Ç–æ–∏, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏‚Ä¶"></textarea></div>

  <div class="row" id="tripButtonsNew">
    <button class="btn primary" onclick="tripSaveNew()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="btn" onclick="tripCancel()">–û—Ç–º–µ–Ω–∞</button>
  </div>
  <div class="row" id="tripButtonsEdit" style="display:none">
    <button class="btn primary" onclick="tripSaveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
    <button class="btn" onclick="tripCancel()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>
<!-- PART 2/7 END --><!-- PART 3/7 START -->
<script>
/* ========= helpers ========= */
function $(s){return document.querySelector(s)}
function $all(s){return Array.from(document.querySelectorAll(s))}
function toNum(v){const n=Number(v);return isNaN(n)?0:n}
function plural(n, one, few, many){
  n=Math.abs(n)%100; const n1=n%10;
  if(n>10 && n<20) return many; if(n1>1 && n1<5) return few; if(n1==1) return one; return many;
}
function fmtM(min){ if(min==null) return '‚Äî'; const h=Math.floor(min/60), m=min%60; return h+'—á '+String(m).padStart(2,'0')+'–º'; }
function fmtHMWords(min){
  if(min==null||min===0) return '0 –º–∏–Ω—É—Ç';
  const h=Math.floor(min/60), m=min%60;
  const hs=h>0?(h+' '+plural(h,'—á–∞—Å','—á–∞—Å–∞','—á–∞—Å–æ–≤')):''; const ms=m>0?(m+' '+plural(m,'–º–∏–Ω—É—Ç–∞','–º–∏–Ω—É—Ç—ã','–º–∏–Ω—É—Ç')):'';
  return (hs+' '+ms).trim();
}
const RUR=new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:0});

/* ========= SAFE STORAGE + AUTOSNAPSHOT ========= */
function S(k,v){
  try{
    if(arguments.length===2){
      localStorage.setItem(k, JSON.stringify(v));
      // –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∞–≤—Ç–æ-—Å–Ω–∞–ø—à–æ—Ç (–Ω–∞ —Å–ª—É—á–∞–π –ø–∞–¥–µ–Ω–∏—è/—Å–±—Ä–æ—Å–∞)
      const today = new Date().toISOString().slice(0,10);
      const snap = JSON.parse(localStorage.getItem('bm_autosnap')||'{}');
      if(snap.date !== today){
        localStorage.setItem('bm_autosnap', JSON.stringify({
          date: today,
          tar: JSON.parse(localStorage.getItem('tar')||'null'),
          trips: JSON.parse(localStorage.getItem('trips')||'null'),
          secs: JSON.parse(localStorage.getItem('secs')||'null'),
          routes: JSON.parse(localStorage.getItem('routes_cache')||'null'),
          tz: JSON.parse(localStorage.getItem('tz_pref')||'null'),
          profile: JSON.parse(localStorage.getItem('profile')||'null'),
          fs: JSON.parse(localStorage.getItem('pf_files')||'null')
        }));
      }
      return v;
    }else{
      const raw = localStorage.getItem(k); if(!raw) return null;
      return JSON.parse(raw);
    }
  }catch(e){ console.warn('Storage error', k, e); return null; }
}
function tryRestoreFromAutosnap(){
  const s=S('bm_autosnap'); if(!s) return false;
  if(s.tar) S('tar',s.tar);
  if(s.trips) S('trips',s.trips);
  if(s.secs) S('secs',s.secs);
  if(s.routes) S('routes_cache',s.routes);
  if(s.tz) S('tz_pref',s.tz);
  if(s.profile) S('profile',s.profile);
  if(s.fs) S('pf_files',s.fs);
  return true;
}

/* ========= Network pill ========= */
function updateNetPill(){
  const el=$('#netStatus'); if(!el) return;
  const on=navigator.onLine;
  el.textContent=on?'–û–Ω–ª–∞–π–Ω':'–û—Ñ—Ñ–ª–∞–π–Ω';
  el.classList.toggle('on',on); el.classList.toggle('off',!on);
}
window.addEventListener('online', updateNetPill);
window.addEventListener('offline', updateNetPill);

/* ========= Theme ========= */
function setTheme(val){
  S('theme', val);
  document.body.classList.toggle('theme-light', val==='light');
  const sel=$('#theme_select'); if(sel) sel.value=val;
}

/* ========= PIN (–¥–æ—Å—Ç—É–ø –∫ –∑–∞—Ä–ø–ª–∞—Ç–µ) ========= */
function savePin(){
  const pin=($('#pin_code')?.value||'').trim();
  S('pin',pin);
  // –¢–æ—Å—Ç –Ω–µ –≤—ã–∑—ã–≤–∞–µ–º –∑–¥–µ—Å—å ‚Äî –µ–¥–∏–Ω—ã–π —Ç–æ—Å—Ç –±—É–¥–µ—Ç –≤ Part 6 (—Ñ—É–Ω–∫—Ü–∏—è showToast)
  if(typeof showToast==='function') showToast('PIN —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
}
function checkPinBefore(fn){
  const need=(S('pin')||'').trim();
  if(!need) return fn();
  const inp=prompt('–í–≤–µ–¥–∏—Ç–µ PIN –¥–ª—è –¥–æ—Å—Ç—É–ø–∞:');
  if(inp===need) fn(); else alert('–ù–µ–≤–µ—Ä–Ω—ã–π PIN');
}

/* ========= Timezone ========= */
function tzList(){
  return ['AUTO','UTC-12:00','UTC-11:00','UTC-10:00','UTC-09:30','UTC-09:00','UTC-08:00','UTC-07:00','UTC-06:00',
  'UTC-05:00','UTC-04:30','UTC-04:00','UTC-03:30','UTC-03:00','UTC-02:00','UTC-01:00','UTC+00:00','UTC+01:00','UTC+02:00',
  'UTC+03:00','UTC+03:30','UTC+04:00','UTC+04:30','UTC+05:00','UTC+05:30','UTC+05:45','UTC+06:00','UTC+06:30','UTC+07:00',
  'UTC+08:00','UTC+08:45','UTC+09:00','UTC+09:30','UTC+10:00','UTC+10:30','UTC+11:00','UTC+12:00','UTC+12:45','UTC+13:00','UTC+14:00'];
}
function parseUtcLabelToOffsetMin(label){
  if(label==='AUTO') return null;
  const m=label.match(/UTC([+-])(\d{1,2}):(\d{2})/); if(!m) return 0;
  const sign=m[1]==='-'?-1:1; const hh=+m[2]||0; const mm=+m[3]||0;
  return sign*(hh*60+mm);
}
function getSelectedTzOffsetMin(){
  const pref=S('tz_pref');
  if(!pref || pref.mode==='AUTO') return -new Date().getTimezoneOffset();
  return pref.offsetMin||0;
}
function tzPopulateSelect(){
  const sel=$('#tz_select'); if(!sel) return; sel.innerHTML='';
  tzList().forEach(lb=>{
    const o=document.createElement('option');
    o.value=lb; o.textContent=(lb==='AUTO'?'–ê–≤—Ç–æ (—Å–∏—Å—Ç–µ–º–Ω—ã–π)':lb);
    sel.appendChild(o);
  });
  const pref=S('tz_pref');
  sel.value=pref?(pref.mode==='AUTO'?'AUTO':(pref.label||'AUTO')):'AUTO';
}
function tzSave(){
  const label=$('#tz_select').value;
  if(label==='AUTO'){ S('tz_pref',{mode:'AUTO'}); }
  else { S('tz_pref',{mode:'FIX',label,offsetMin:parseUtcLabelToOffsetMin(label)}); }
  // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∑–∞–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∞ TZ –≤–µ—â–∏
  if(typeof updateLiveTimers==='function') updateLiveTimers(true);
  if(typeof renderTrips==='function') renderTrips();
  if(typeof updateDash==='function') updateDash();
}

/* ========= Navigation ========= */
function nav(btn){
  $all('.tabbar button').forEach(x=>x.classList.remove('active'));
  btn.classList.add('active');
  const v=btn.getAttribute('data-tab');
  $all('.view').forEach(x=>x.classList.remove('active'));
  $('#v-'+v).classList.add('active');
}
function goSettings(){
  $all('.tabbar button').forEach(b=>b.classList.remove('active'));
  document.querySelector('.tabbar button[data-tab="settings"]').classList.add('active');
  $all('.view').forEach(v=>v.classList.remove('active'));
  $('#v-settings').classList.add('active');
}

/* ========= Tariffs (–±–∞–∑–æ–≤—ã–µ; —Ç–æ—Å—Ç –∏ –¥–æ–ø.–ª–æ–≥–∏–∫–∞ –±—É–¥–µ—Ç –≤ Part 6) ========= */
function getTar(){ return S('tar') || {base:358.46,rc:20,north:50,fee:0,norm:176}; }
function tarSave(goHome){
  let t=getTar();
  if($('#tar_base'))  t.base = toNum($('#tar_base').value)||t.base;
  if($('#tar_rc'))    t.rc   = toNum($('#tar_rc').value)||0;
  if($('#tar_north')) t.north= toNum($('#tar_north').value)||0;
  if($('#tar_fee'))   t.fee  = toNum($('#tar_fee').value)||0;
  if($('#tar_norm'))  t.norm = toNum($('#tar_norm').value)||t.norm;
  S('tar',t);
  if(typeof updateDash==='function') updateDash();
  if(typeof renderTrips==='function') renderTrips();
  if(goHome){ // –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ì–ª–∞–≤–Ω—É—é
    $all('.tabbar button').forEach(b=>b.classList.remove('active'));
    document.querySelector('.tabbar button[data-tab="dashboard"]').classList.add('active');
    $all('.view').forEach(v=>v.classList.remove('active'));
    $('#v-dashboard').classList.add('active');
  }
}
function loadTar(){
  const t=getTar();
  if($('#tar_base'))  $('#tar_base').value=t.base;
  if($('#tar_rc'))    $('#tar_rc').value=t.rc;
  if($('#tar_north')) $('#tar_north').value=t.north;
  if($('#tar_fee'))   $('#tar_fee').value=t.fee;
  if($('#tar_norm'))  $('#tar_norm').value=t.norm;
}

/* ========= PWA: SW-—Ö—É–∫ –∏ –∫–Ω–æ–ø–∫–∞ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª ========= */
(function(){
  const usp = new URLSearchParams(location.search);
  if (usp.get('no-sw') === '1') {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
    }
    if (window.caches) caches.keys().then(ks => ks.forEach(k => caches.delete(k)));
    console.log('SW disabled by ?no-sw=1');
  }

  window.appUpdate = async function(){
    try{
      if (!('serviceWorker' in navigator)) { location.replace(location.pathname+'?cb='+Date.now()); return; }
      const reg = await navigator.serviceWorker.getRegistration();
      if (!reg) { location.replace(location.pathname+'?cb='+Date.now()); return; }
      if (reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'}); else await reg.update();
      let reloaded=false;
      navigator.serviceWorker.addEventListener('controllerchange', ()=>{
        if(!reloaded){ reloaded=true; location.replace(location.pathname+'?cb='+Date.now()); }
      });
      setTimeout(()=>{ if(!reloaded) location.replace(location.pathname+'?cb='+Date.now()); }, 1000);
    }catch(e){
      location.replace(location.pathname+'?cb='+Date.now());
    }
  };

  window.addEventListener('load', function(){
    updateNetPill();
    if (!('serviceWorker' in navigator)) return;
    const scope = location.pathname.replace(/\/[^\/]*$/, '/') || '/';
    navigator.serviceWorker.register('sw.js', { scope }).then(reg => {
      const btn = document.getElementById('appRefresh');
      function showRefresh(){ if(btn) btn.style.display=''; }
      if (reg.waiting) showRefresh();
      reg.addEventListener('updatefound', ()=>{
        const nw = reg.installing; if(!nw) return;
        nw.addEventListener('statechange', ()=>{
          if (nw.state==='installed' && navigator.serviceWorker.controller) showRefresh();
        });
      });
      navigator.serviceWorker.addEventListener('controllerchange', ()=>{
        const btn = document.getElementById('appRefresh');
        if(btn) btn.style.display='none';
      });
    }).catch(err => console.warn('SW register failed', err));
  });
})();
</script>
<!-- PART 3/7 END --><!-- PART 4/7 START -->
<script>
/* ========= Trips storage ========= */
function getTrips(){ return S('trips')||[] }
function setTrips(a){ S('trips',a) }

/* ========= Passenger following ========= */
function addPassengerFollow(){
  const c=document.createElement('div'); c.className='card inline'; c.style.margin='8px 0';
  c.innerHTML=`
    <div class="row"><label>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
      <select data-f="dir"><option value="t">–¢—É–¥–∞</option><option value="r">–û–±—Ä–∞—Ç–Ω–æ</option></select>
    </div>
    <div class="row"><label>–î–∞—Ç–∞ (–Ω–∞—á–∞–ª–æ)</label><input data-f="dateStart" type="date"></div>
    <div class="row"><label>–ú–∞—Ä—à—Ä—É—Ç</label><input data-f="route" list="routeList" placeholder="—Å—Ç–∞–Ω—Ü–∏—è –ê ‚Äî —Å—Ç–∞–Ω—Ü–∏—è –ë"></div>
    <div class="row"><label>–û–∂–∏–¥–∞–Ω–∏–µ (–º–∏–Ω)</label><input data-f="waitMin" type="number" inputmode="numeric" placeholder="0"></div>
    <div class="row"><label>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label><input data-f="dep" type="time"></div>
    <div class="row"><label>–ü—Ä–∏–±—ã—Ç–∏–µ</label><input data-f="arr" type="time"></div>
    <div class="row"><label>–î–∞—Ç–∞ (–∫–æ–Ω–µ—Ü)</label><input data-f="dateEnd" type="date"></div>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button class="btn" onclick="this.closest('.card').remove(); recalcDuration();">–£–¥–∞–ª–∏—Ç—å</button>
    </div>`;
  $('#passengerList').appendChild(c);
}

/* ========= Train type picker ========= */
let trainType_t='', trainType_r='';
function chooseTrainType(which){
  const v = prompt('–í–∏–¥ –ø–æ–µ–∑–¥–∞:\n1 ‚Äî –≥—Ä—É–∑–æ–≤–æ–π\n2 ‚Äî –ø–æ—Ä–æ–∂–Ω–∏–π\n3 ‚Äî –¥–ª–∏–Ω–Ω–æ—Å–æ—Å—Ç–∞–≤–Ω—ã–π\n4 ‚Äî —Ä–µ–∑–µ—Ä–≤\n5 ‚Äî —Å–ø–ª–æ—Ç–∫–∞\n6 ‚Äî —Å–¥–≤–æ–µ–Ω–Ω—ã–π\n7 ‚Äî —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º');
  const map={1:'–≥—Ä—É–∑–æ–≤–æ–π',2:'–ø–æ—Ä–æ–∂–Ω–∏–π',3:'–¥–ª–∏–Ω–Ω–æ—Å–æ—Å—Ç–∞–≤–Ω—ã–π',4:'—Ä–µ–∑–µ—Ä–≤',5:'—Å–ø–ª–æ—Ç–∫–∞',6:'—Å–¥–≤–æ–µ–Ω–Ω—ã–π',7:'—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º'};
  const pick=map[(v||'').trim()]; if(!pick) return;
  if(which==='t'){ trainType_t=pick; $('#trainType_t').textContent=' ¬∑ '+pick; }
  else{ trainType_r=pick; $('#trainType_r').textContent=' ¬∑ '+pick; }
}

/* ========= Date/Time helpers ========= */
function toMin(hhmm){ if(!hhmm) return null; const p=hhmm.split(':'); if(p.length<2) return null; const H=+p[0],M=+p[1]; if(isNaN(H)||isNaN(M))return null; return H*60+M; }
function diffMinutes(a,b){ const x=toMin(a), y=toMin(b); if(x==null||y==null) return null; let d=y-x; if(d<0) d+=1440; return d; }
function dateAddDays(dateStr, days){ const d=new Date(dateStr+'T00:00:00Z'); d.setUTCDate(d.getUTCDate()+days); return d.toISOString().slice(0,10); }
function epochFromDateTimeTz(dateStr, timeStr, tzOffsetMin){
  if(!dateStr||!timeStr) return null;
  const [Y,M,D]=dateStr.split('-').map(Number); const [h,m]=timeStr.split(':').map(Number);
  if([Y,M,D,h,m].some(isNaN)) return null;
  return Date.UTC(Y,M-1,D,h,m) - tzOffsetMin*60000;
}
function overlap(a1,a2,b1,b2){ const s=Math.max(a1,b1), e=Math.min(a2,b2); return Math.max(0,e-s); }
function legNightMinutes(dateStr, startHHMM, endHHMM, tzMin){
  if(!startHHMM||!endHHMM||!dateStr) return 0;
  let a=epochFromDateTimeTz(dateStr,startHHMM,tzMin), b=epochFromDateTimeTz(dateStr,endHHMM,tzMin);
  if(a==null||b==null) return 0; if(b<a) b+=24*60*60000;
  const d0=epochFromDateTimeTz(dateStr,'00:00',tzMin);
  const blocks=[[d0+22*60*60000,d0+24*60*60000],[d0+24*60*60000,d0+30*60*60000]];
  let night=0; for(const [x,y] of blocks) night+=overlap(a,b,x,y);
  return Math.round(night/60000);
}
function countNightWindows0005(startEpoch,endEpoch, tzMin){
  if(startEpoch==null||endEpoch==null||endEpoch<=startEpoch) return 0;
  const s=new Date(startEpoch+tzMin*60000), e=new Date(endEpoch+tzMin*60000);
  let day=Date.UTC(s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate()), endDay=Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate());
  let cnt=0;
  while(day<=endDay+24*60*60000){
    const wS=day - tzMin*60000, wE=wS + 5*60*60000;
    if(overlap(startEpoch,endEpoch,wS,wE)>0) cnt++;
    day+=24*60*60000;
  }
  return cnt;
}
function fmtLocalFull(d, tzOffsetMin){
  if(!d) return '‚Äî';
  const localMs=d.getTime()+tzOffsetMin*60000; const x=new Date(localMs);
  const yyyy=x.getUTCFullYear(), mm=String(x.getUTCMonth()+1).padStart(2,'0'), dd=String(x.getUTCDate()).padStart(2,'0'), hh=String(x.getUTCHours()).padStart(2,'0'), mi=String(x.getUTCMinutes()).padStart(2,'0');
  return dd+'.'+mm+'.'+yyyy+' '+hh+':'+mi;
}

/* ========= –í–æ–∑–≤—Ä–∞—Ç–Ω–∞—è –¥–∞—Ç–∞ –ø–æ —Ñ–æ—Ä–º–µ ========= */
function effectiveReturnDate(){
  const d2=($('#t_date2').value||'').trim(); if(d2) return d2;
  const d1=$('#t_date').value||new Date().toISOString().slice(0,10);
  const st2=$('#t_start2').value, e1=$('#t_end1').value;
  if(toMin(st2)!=null && toMin(e1)!=null && toMin(st2)<toMin(e1)) return dateAddDays(d1,1);
  return d1;
}

/* ========= –ü–µ—Ä–µ—Å—á—ë—Ç –ø–æ —Ñ–æ—Ä–º–µ ========= */
function recalcDuration(){
  const tzMin=getSelectedTzOffsetMin();
  const date=$('#t_date').value, date2=effectiveReturnDate();
  const l1=diffMinutes($('#t_start1').value,$('#t_end1').value)||0;
  const l2=diffMinutes($('#t_start2').value,$('#t_end2').value)||0;
  const rest=diffMinutes($('#t_end1').value,$('#t_start2').value)||0;

  let passMin=0, passNight=0;
  $all('#passengerList .card').forEach(card=>{
    const dir=card.querySelector('[data-f="dir"]').value;
    const dS=(card.querySelector('[data-f="dateStart"]').value||'').trim() || (dir==='r'?date2:date);
    const wait=toNum(card.querySelector('[data-f="waitMin"]').value||'0');
    const dep=(card.querySelector('[data-f="dep"]').value||'').trim();
    const arr=(card.querySelector('[data-f="arr"]').value||'').trim();
    const tripMin=(diffMinutes(dep,arr)||0);
    passMin += wait + tripMin;
    passNight += legNightMinutes(dS, dep, arr, tzMin);
  });

  const totalMin=l1+l2+passMin;
  const night= legNightMinutes(date,$('#t_start1').value,$('#t_end1').value,tzMin) +
               legNightMinutes(date2,$('#t_start2').value,$('#t_end2').value,tzMin) + passNight;

  $('#t_rest_view').value=rest?fmtHMWords(rest):'0 –º–∏–Ω—É—Ç';
  $('#t_night_view').value=night?fmtHMWords(night):'0 –º–∏–Ω—É—Ç';
  $('#t_hours_view').value=fmtHMWords(totalMin);
}

/* ========= –°–±–æ—Ä–∫–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ========= */
function tripSkeletonFromForm(){
  const tzMin=getSelectedTzOffsetMin();
  const date=$('#t_date').value || new Date().toISOString().slice(0,10);
  const date2=effectiveReturnDate();

  const l1=diffMinutes($('#t_start1').value,$('#t_end1').value)||0;
  const l2=diffMinutes($('#t_start2').value,$('#t_end2').value)||0;
  const rest=diffMinutes($('#t_end1').value,$('#t_start2').value)||0;

  let pass=[], passMin=0, passNight=0;
  $all('#passengerList .card').forEach(card=>{
    const dir=card.querySelector('[data-f="dir"]').value;
    const dS=(card.querySelector('[data-f="dateStart"]').value||'').trim() || (dir==='r'?date2:date);
    const r=(card.querySelector('[data-f="route"]').value||'').trim();
    const wait=toNum(card.querySelector('[data-f="waitMin"]').value||'0');
    const dep=(card.querySelector('[data-f="dep"]').value||'').trim();
    const arr=(card.querySelector('[data-f="arr"]').value||'').trim();
    const dE=(card.querySelector('[data-f="dateEnd"]').value||'').trim() || dS;
    pass.push({id:Date.now()+Math.random(),dir,dateStart:dS,route:r,waitMin:wait,dep,arr,dateEnd:dE});
    passMin += wait + (diffMinutes(dep,arr)||0);
    passNight += legNightMinutes(dS, dep, arr, tzMin);
  });

  const night = legNightMinutes(date,$('#t_start1').value,$('#t_end1').value,tzMin) +
                legNightMinutes(date2,$('#t_start2').value,$('#t_end2').value,tzMin) + passNight;

  const totalHours = (l1 + l2 + passMin)/60;

  return {
    id: Date.now(),
    date, date2,
    route1: ($('#t_route1').value||'').trim(),
    route2: ($('#t_route2').value||'').trim(),
    trainNo1: ($('#t_trainNo1').value||'').trim(),
    trainNo2: ($('#t_trainNo2').value||'').trim(),
    trainType1: trainType_t || '',
    trainType2: trainType_r || '',
    start1: $('#t_start1').value || '', end1: $('#t_end1').value || '',
    start2: $('#t_start2').value || '', end2: $('#t_end2').value || '',
    rest, hours: totalHours, night,
    notes: ($('#t_notes').value||'').trim(),
    passenger: pass
  };
}

function clearTripForm(){
  const today=new Date().toISOString().slice(0,10);
  $('#t_date').value=today; $('#t_date2').value='';
  $('#t_route1').value=''; $('#t_route2').value='';
  $('#t_start1').value=''; $('#t_end1').value='';
  $('#t_start2').value=''; $('#t_end2').value='';
  $('#t_trainNo1').value=''; $('#t_trainNo2').value='';
  trainType_t=''; trainType_r=''; $('#trainType_t').textContent=''; $('#trainType_r').textContent='';
  $('#t_rest_view').value='0 –º–∏–Ω—É—Ç'; $('#t_night_view').value='0 –º–∏–Ω—É—Ç'; $('#t_hours_view').value='0 –º–∏–Ω—É—Ç';
  $('#t_notes').value=''; $('#passengerList').innerHTML='';
}
function addTripOpen(){ clearTripForm(); buildRouteOptions(); $('#tripButtonsNew').style.display=''; $('#tripButtonsEdit').style.display='none'; $('#tripForm').style.display='block'; }

function tripSaveNew(){
  const t=tripSkeletonFromForm();
  // –∫—ç—à –º–∞—Ä—à—Ä—É—Ç–æ–≤
  [t.route1,t.route2].forEach(r=>{
    if(r){
      let cache=getRoutesCache(); if(!cache.includes(r)){ cache.unshift(r); if(cache.length>50) cache.pop(); setRoutesCache(cache); }
    }
  });
  const arr=getTrips(); arr.push(t);
  arr.sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id));
  setTrips(arr);
  $('#tripForm').style.display='none';
  updateDash(); renderTrips();
  if(typeof showToast==='function') showToast('–ü–æ–µ–∑–¥–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
}

let currentTripId=null;
function tripOpen(id){
  const t=(getTrips()||[]).find(x=>x.id===id); if(!t) return; currentTripId=id;
  clearTripForm();
  $('#t_date').value=t.date||''; $('#t_date2').value=t.date2||'';
  $('#t_route1').value=t.route1||''; $('#t_route2').value=t.route2||'';
  $('#t_start1').value=t.start1||''; $('#t_end1').value=t.end1||'';
  $('#t_start2').value=t.start2||''; $('#t_end2').value=t.end2||'';
  $('#t_trainNo1').value=t.trainNo1||''; $('#t_trainNo2').value=t.trainNo2||'';
  trainType_t=t.trainType1||''; trainType_r=t.trainType2||'';
  if(trainType_t) $('#trainType_t').textContent=' ¬∑ '+trainType_t;
  if(trainType_r) $('#trainType_r').textContent=' ¬∑ '+trainType_r;
  $('#passengerList').innerHTML='';
  (t.passenger||[]).forEach(p=>{
    addPassengerFollow();
    const last=$('#passengerList .card:last-child');
    last.querySelector('[data-f="dir"]').value=p.dir||'t';
    last.querySelector('[data-f="dateStart"]').value=p.dateStart||'';
    last.querySelector('[data-f="route"]').value=p.route||'';
    last.querySelector('[data-f="waitMin"]').value=p.waitMin||0;
    last.querySelector('[data-f="dep"]').value=p.dep||'';
    last.querySelector('[data-f="arr"]').value=p.arr||'';
    last.querySelector('[data-f="dateEnd"]').value=p.dateEnd||'';
  });
  $('#t_notes').value=t.notes||'';
  recalcDuration();
  $('#tripButtonsNew').style.display='none'; $('#tripButtonsEdit').style.display=''; $('#tripForm').style.display='block';
}

function tripSaveEdit(){
  if(currentTripId==null) return;
  let arr=getTrips(); const ix=arr.findIndex(x=>x.id===currentTripId); if(ix<0) return;
  const fresh=tripSkeletonFromForm(); fresh.id=currentTripId;
  arr[ix]={...arr[ix], ...fresh};
  arr.sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id));
  setTrips(arr);
  $('#tripForm').style.display='none';
  updateDash(); renderTrips();
  if(typeof showToast==='function') showToast('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
}
function tripCancel(){ $('#tripForm').style.display='none'; currentTripId=null; }
function tripDel(id){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–µ–∑–¥–∫—É?')) return;
  setTrips(getTrips().filter(x=>x.id!==id));
  updateDash(); renderTrips();
  if(typeof showToast==='function') showToast('–£–¥–∞–ª–µ–Ω–æ');
}
</script>
<!-- PART 4/7 END --><!-- PART 5/7 START -->
<script>
/* ========= Live & Two nights ========= */
function shouldBeLive(t){ if(t.start1 && !t.end1) return 'leg1'; if(t.start2 && !t.end2) return 'leg2'; return ''; }
function humanSince(ms){ if(ms==null||ms<0) return '‚Äî'; const m=Math.floor(ms/60000); const h=Math.floor(m/60), mm=m%60; return h+'—á '+String(mm).padStart(2,'0')+'–º'; }
function effectiveReturnDateForTrip(t){
  if(t.date2&&t.date2.trim()) return t.date2.trim();
  if(t.start2&&t.end1&&toMin(t.start2)!=null&&toMin(t.end1)!=null&&toMin(t.start2)<toMin(t.end1)) return dateAddDays(t.date,1);
  return t.date;
}
function isTwoNightsTrip(t){
  const tzMin=getSelectedTzOffsetMin(); if(!t.date) return false;
  const startEpoch=epochFromDateTimeTz(t.date, t.start1||t.start2, tzMin);
  const date2=effectiveReturnDateForTrip(t);
  const endEpoch=epochFromDateTimeTz(date2, t.end2||t.end1||t.start2||t.start1, tzMin);
  const cnt=countNightWindows0005(startEpoch,endEpoch,tzMin); return cnt>=2;
}
function updateLiveTimers(){
  const tzMin=getSelectedTzOffsetMin(), now=Date.now();
  $all('[data-live-trip]').forEach(el=>{
    const id=Number(el.getAttribute('data-live-trip')); const t=(getTrips()||[]).find(x=>x.id===id);
    if(!t){ el.textContent=''; return; }
    const mode=shouldBeLive(t); if(!mode){ el.textContent=''; return; }
    const d1=t.date||new Date().toISOString().slice(0,10), d2=effectiveReturnDateForTrip(t);
    const startEpoch=(mode==='leg1')?epochFromDateTimeTz(d1,t.start1,tzMin):epochFromDateTimeTz(d2,t.start2,tzMin);
    if(startEpoch==null){ el.textContent=''; return; }
    el.textContent='–≤ –ø—É—Ç–∏ ¬∑ '+humanSince(now-startEpoch);
  });
}

/* ========= –ú–µ—Å—è—Ü—ã –∏ –ø–æ–∏—Å–∫ ========= */
function ymOf(d){ return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}`; }
function todayYM(){ const n=new Date(); return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}`; }
function getActiveYM(){ return S('ui_month') || todayYM(); }
function setActiveYM(ym){ S('ui_month', ym); refreshMonthUI(); renderTrips(); updateDash(); }
function refreshMonthUI(){
  const lbl=document.getElementById('monthLbl'); if(!lbl) return;
  const ym=getActiveYM(); const [y,m]=ym.split('-').map(Number);
  const names=['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];
  lbl.textContent=`${names[(m-1)%12]} ${y}`;
}
function toggleMonthPicker(){
  const p=$('#monthPanel'); if(!p) return;
  if(p.style.display==='none'||p.style.display===''){
    const now=new Date(); let html='';
    for(let i=0;i<12;i++){
      const d=new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth()-i, 1));
      const key=d.getUTCFullYear()+'-'+String(d.getUTCMonth()+1).padStart(2,'0');
      html+=`<button class="btn" onclick="pickMonth('${key}')">${key}</button>`;
    }
    html+=`<div class="hr"></div><button class="btn" onclick="pickMonth(null)">–¢–µ–∫—É—â–∏–π</button>`;
    p.innerHTML=html; p.style.display='block';
  }else p.style.display='none';
}
function pickMonth(key){ setActiveYM(key||todayYM()); $('#monthPanel').style.display='none'; }
document.getElementById('searchTrips').addEventListener('input', ()=>{ renderTrips(); });

/* ======= –†–∞–∑–±–∏–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º ======= */
function tzOffMin(){ return getSelectedTzOffsetMin(); }
function dtToEpoch(dateStr, timeHHMM){ return epochFromDateTimeTz(dateStr, timeHHMM, tzOffMin()); }
function clamp(a, lo, hi){ return Math.max(lo, Math.min(hi, a)); }
function splitIntervalByMonths(a,b){
  const out={}; if(a==null||b==null||b<=a) return out;
  let cur=new Date(a), last=new Date(b-1);
  while(cur.getUTCFullYear()*12+cur.getUTCMonth() <= last.getUTCFullYear()*12+last.getUTCMonth()){
    const ym=ymOf(cur);
    const startYM=Date.UTC(cur.getUTCFullYear(),cur.getUTCMonth(),1,0,0,0);
    const nextYM =Date.UTC(cur.getUTCFullYear(),cur.getUTCMonth()+1,1,0,0,0);
    const lo=Math.max(a,startYM), hi=Math.min(b,nextYM);
    if(hi>lo) out[ym]=(out[ym]||0)+Math.round((hi-lo)/60000);
    cur=new Date(nextYM);
  }
  return out;
}
function nightMinutesForInterval(a,b){
  if(a==null||b==null||b<=a) return 0;
  const tz=tzOffMin(); let sum=0;
  let dayStart=new Date(a+tz*60000);
  dayStart=Date.UTC(dayStart.getUTCFullYear(),dayStart.getUTCMonth(),dayStart.getUTCDate());
  for(let x=dayStart - tz*60000; x<b; x+=24*60*60000){
    const w1s=x+22*60*60000, w1e=x+24*60*60000;
    const w2s=x+24*60*60000, w2e=x+30*60*60000;
    sum+=overlap(a,b,w1s,w1e)+overlap(a,b,w2s,w2e);
  }
  return Math.round(sum/60000);
}
function intervalsForTrip(t){
  const out=[];
  // —Ç—É–¥–∞
  if(t.date && t.start1 && t.end1){
    let a=dtToEpoch(t.date,t.start1), b=dtToEpoch(t.date,t.end1);
    if(a!=null&&b!=null){ if(b<=a) b+=24*60*60000; out.push([a,b]); }
  }
  // –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º
  (t.passenger||[]).forEach(p=>{
    if(!p.dep||!p.arr) return;
    const baseDate=(p.dir==='r') ? (t.date2 || effectiveReturnDateForTrip(t)) : t.date;
    const dS=p.dateStart?.trim()?p.dateStart.trim():baseDate;
    const dE=p.dateEnd?.trim()?p.dateEnd.trim():dS;
    let waitMin=toNum(p.waitMin)||0;
    let dep=dtToEpoch(dS,p.dep), arr=dtToEpoch(dE,p.arr); if(dep==null||arr==null) return;
    if(arr<=dep) arr+=24*60*60000;
    let a=dep-waitMin*60000; if(a<dep-24*60*60000) a=dep-24*60*60000;
    out.push([a,arr]);
  });
  // –æ–±—Ä–∞—Ç–Ω–æ
  const d2=effectiveReturnDateForTrip(t);
  if(d2 && t.start2 && t.end2){
    let a=dtToEpoch(d2,t.start2), b=dtToEpoch(d2,t.end2);
    if(a!=null&&b!=null){ if(b<=a) b+=24*60*60000; out.push([a,b]); }
  }
  return out;
}
function splitTripByMonths(t){
  const ivals=intervalsForTrip(t); const out={}; // { ym:{work,night} }
  ivals.forEach(([a,b])=>{
    const per=splitIntervalByMonths(a,b);
    Object.keys(per).forEach(ym=>{
      const lo=Date.UTC(+ym.slice(0,4), +ym.slice(5,7)-1, 1,0,0,0);
      const hi=Date.UTC(+ym.slice(0,4), +ym.slice(5,7),   1,0,0,0);
      const clipA=clamp(a,lo,hi), clipB=clamp(b,lo,hi);
      const workMin=Math.round((clipB-clipA)/60000);
      const nightMin=nightMinutesForInterval(clipA,clipB);
      out[ym]=out[ym]||{work:0,night:0};
      out[ym].work+=workMin; out[ym].night+=nightMin;
    });
  });
  return out;
}

/* ========= –ü–æ–∏—Å–∫ ========= */
function currentQuery(){ return ($('#searchTrips').value||'').trim().toLowerCase(); }
function matchesQuery(t,q){
  if(!q) return true;
  const fields=[t.date,t.date2,t.route1,t.route2,t.trainNo1,t.trainNo2,t.trainType1,t.trainType2,t.notes]
    .filter(Boolean).join(' ').toLowerCase();
  const meta=[]; if(isTwoNightsTrip(t)) meta.push('–¥–≤–µ –Ω–æ—á–∏'); if(shouldBeLive(t)) meta.push('–≤ –ø—É—Ç–∏');
  return fields.includes(q) || meta.join(' ').toLowerCase().includes(q);
}

/* ========= –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ ========= */
window.renderTrips=function(){
  const ym=getActiveYM(); const q=currentQuery();
  const box=$('#daysList'); box.innerHTML='';
  let arr=getTrips().slice().sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id));
  arr=arr.filter(t=>matchesQuery(t,q));
  if(!arr.length){ const d=document.createElement('div'); d.className='small'; d.style.opacity=.7; d.textContent='–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫'; box.appendChild(d); updateLiveTimers(); return; }

  let totalMoney=0, any=false;
  arr.forEach(t=>{
    const split=splitTripByMonths(t);
    const mins=(split[ym]?.work)||0;
    if(mins<=0) return;
    any=true;
    const hrs=mins/60;
    const money=moneyFromMinutes(mins); // –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ Part 6/7
    totalMoney+=money;

    const live=shouldBeLive(t)?`<span class="badge-live" data-live-trip="${t.id}"></span>`:'';
    const twoN=isTwoNightsTrip(t)?'<span class="badge-two">–¥–≤–µ –Ω–æ—á–∏</span>':'';

    const row=document.createElement('div'); row.className='trip tap';
    row.innerHTML=`
      <div><b>${t.date||'‚Äî'}</b> ‚Ä¢ ${t.route1||'‚Äî'} ${live} ${twoN}</div>
      <div>${hrs.toFixed(1)} —á</div>
      <div class="money">${RUR.format(money)}</div>
      <div class="actions">
        <button class="btn" onclick="tripOpen(${t.id})">üîç</button>
        <button class="btn" onclick="tripDel(${t.id})">üóë</button>
      </div>`;
    const meta=`
      <div class="small" style="opacity:.8;margin-top:6px;line-height:1.4">
        ‚Ññ${t.trainNo1||'‚Äî'} ${t.trainType1||''} ‚Ä¢ —è–≤–∫–∞ ${t.start1||'‚Äî'} ‚Äî –∫–æ–Ω–µ—Ü ${t.end1||'‚Äî'}<br>
        ${t.date2?('['+t.date2+'] '):''}${t.route2||''} ‚Ññ${t.trainNo2||'‚Äî'} ${t.trainType2||''} ‚Ä¢ —è–≤–∫–∞ ${t.start2||'‚Äî'} ‚Äî –∫–æ–Ω–µ—Ü ${t.end2||'‚Äî'}
      </div>`;
    row.addEventListener('click', function(e){
      if(this.querySelector('.more')) this.querySelector('.more').remove();
      else { const dd=document.createElement('div'); dd.className='more'; dd.style.gridColumn='1 / -1'; dd.innerHTML=meta; this.appendChild(dd); }
      e.stopPropagation();
    });
    box.appendChild(row);
  });

  if(!any){
    const d=document.createElement('div'); d.className='small'; d.style.opacity=.7; d.textContent='–í –≤—ã–±—Ä–∞–Ω–Ω–æ–º –º–µ—Å—è—Ü–µ –ø–æ –∑–∞–ø—Ä–æ—Å—É –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤'; box.appendChild(d);
  }else{
    const sum=document.createElement('div'); sum.className='small'; sum.style.textAlign='right'; sum.style.marginTop='6px'; sum.style.opacity='.9';
    sum.textContent='–ò—Ç–æ–≥–æ –∑–∞ –º–µ—Å—è—Ü: '+RUR.format(totalMoney);
    box.appendChild(sum);
  }
  updateLiveTimers();
};

/* ========= –î–∞—à–±–æ—Ä–¥ ========= */
window.updateDash=function(){
  const ym=getActiveYM(), t=getTar(); const trips=getTrips().slice();
  let minsTotal=0, nightTotal=0;
  trips.forEach(tr=>{
    const per=splitTripByMonths(tr);
    if(per[ym]){ minsTotal+=(per[ym].work||0); nightTotal+=(per[ym].night||0); }
  });
  const norm=t.norm*60;
  const pct=norm?Math.round(minsTotal/norm*100):0;
  const rem=norm-minsTotal;
  $('#mwNorm').textContent=t.norm+' —á';
  $('#mwWorked').textContent=fmtM(minsTotal)+' (–Ω–æ—á–Ω—ã–µ: '+fmtHMWords(nightTotal)+')';
  $('#mwPercent').textContent=pct+'%';
  $('#mwRemain').textContent=rem>=0?('–û—Å—Ç–∞–ª–æ—Å—å: '+fmtM(rem)):('–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞: '+fmtM(-rem));
  $('#mwBar').style.width=Math.min(pct,100)+'%';
};
</script>
<!-- PART 5/7 END --><!-- PART 6/7 START -->
<script>
/* ========= –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ç–æ—Å—Ç ========= */
function showToast(msg){
  let t=document.getElementById('__bm_toast__');
  if(!t){
    t=document.createElement('div');
    t.id='__bm_toast__';
    t.style.position='fixed';
    t.style.left='50%';
    t.style.bottom='20px';
    t.style.transform='translateX(-50%)';
    t.style.background='rgba(20,28,40,.95)';
    t.style.color='#fff';
    t.style.border='1px solid rgba(255,255,255,.2)';
    t.style.padding='10px 14px';
    t.style.borderRadius='10px';
    t.style.fontSize='14px';
    t.style.zIndex='9999';
    t.style.boxShadow='0 10px 24px rgba(0,0,0,.35)';
    t.style.maxWidth='90%';
    t.style.textAlign='center';
    t.style.pointerEvents='none';
    document.body.appendChild(t);
  }
  t.textContent=msg;
  t.style.opacity='1';
  clearTimeout(t.__tmr);
  t.__tmr=setTimeout(()=>{ t.style.transition='opacity .4s'; t.style.opacity='0'; }, 1400);
}

/* ========= –î–µ–Ω—å–≥–∏ (–±–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏) ========= */
function tripMoney(hours){
  const t=getTar(); // {base, rc, north, fee}
  const basePay = hours * t.base;
  const rcAdd   = basePay * (t.rc||0)/100;
  const northAdd= basePay * (t.north||0)/100;
  const gross   = basePay + rcAdd + northAdd;
  const net     = Math.max(0, Math.round(gross - (t.fee||0)));
  return net;
}
function moneyFromMinutes(min){ return tripMoney((min||0)/60); }

/* ========= –†–ñ–î –∑–∞—Ä–ø–ª–∞—Ç–∞ (–¥–µ—Ç–∞–ª—å–Ω–∞—è —Å –∫–æ–¥–∞–º–∏) =========
   –ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –Ω–æ—á–Ω—ã—Ö/—Å–≤–µ—Ä—Ö—É—Ä–æ—á–Ω—ã—Ö –º–æ–∂–Ω–æ –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥ –≤–∞—à –∫–≤–∏—Ç–æ–∫.
*/
const PAY_CONST = {
  NIGHT_PCT: 0.20,      // –¥–æ–ø–ª–∞—Ç–∞ –∑–∞ –Ω–æ—á–Ω—ã–µ —á–∞—Å—ã (20% –æ—Ç —Ç–∞—Ä–∏—Ñ–Ω–æ–π —Å—Ç–∞–≤–∫–∏)
  OT_COEFF:  1.50       // –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–≤–µ—Ä—Ö—É—Ä–æ—á–Ω—ã—Ö (–≤—Å—ë —Å–≤–µ—Ä—Ö –Ω–æ—Ä–º—ã √ó1.5)
};

function renderSalary(){
  // 1) –°–±–æ—Ä –Ω–∞—Ä–∞–±–æ—Ç–∫–∏ –∏ –Ω–æ—á–Ω—ã—Ö –∑–∞ –∞–∫—Ç–∏–≤–Ω—ã–π –º–µ—Å—è—Ü
  const ym=getActiveYM();
  const t=getTar();
  let trips=getTrips().slice();

  let minsTotal=0;
  let nightTotal=0;
  trips.forEach(tr=>{
    const per=splitTripByMonths(tr);
    if(per[ym]){ minsTotal+=(per[ym].work||0); nightTotal+=(per[ym].night||0); }
  });

  const hrs      = minsTotal/60;
  const nightHrs = nightTotal/60;
  const normHrs  = (t.norm||0);
  const otHrs    = Math.max(0, hrs - normHrs);
  const baseHrs  = Math.max(0, hrs - otHrs); // –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã

  // 2) –†–∞—Å—á—ë—Ç –ø–æ —Å—Ç—Ä–æ–∫–∞–º (–∫–∞–∫ –≤ –∫–≤–∏—Ç–∫–µ)
  // –ö–æ–¥—ã ‚Äî –ø—Ä–∏–º–µ—Ä–Ω—ã–µ, —á—Ç–æ–±—ã –≤–∏–∑—É–∞–ª—å–Ω–æ —Å–æ–≤–ø–∞–¥–∞–ª–æ —Å–æ —Å—Ç–∏–ª–µ–º –∫–≤–∏—Ç–∫–∞.
  // –ï—Å–ª–∏ —É –≤–∞—Å —Å–≤–æ–π –Ω–∞–±–æ—Ä ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ–Ω—è–π—Ç–µ labels/codes –∏ —Ñ–æ—Ä–º—É–ª—ã.
  const rows = [];

  // 2001 ‚Äî –û–ø–ª–∞—Ç–∞ –ø–æ —Ç–∞—Ä–∏—Ñ–Ω–æ–π —Å—Ç–∞–≤–∫–µ (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã)
  const r2001 = {
    code:'2001', name:'–û–ø–ª–∞—Ç–∞ –ø–æ —á–∞—Å–æ–≤–æ–º—É —Ç–∞—Ä–∏—Ñ—É',
    qty: baseHrs, rate: t.base, sum: baseHrs * t.base
  }; rows.push(r2001);

  // 2002 ‚Äî –°–≤–µ—Ä—Ö—É—Ä–æ—á–Ω—ã–µ √ó1.5
  let r2002=null;
  if(otHrs>0){
    r2002 = {
      code:'2002', name:'–°–≤–µ—Ä—Ö—É—Ä–æ—á–Ω—ã–µ (√ó1.5)',
      qty: otHrs, rate: t.base*PAY_CONST.OT_COEFF, sum: otHrs * t.base * PAY_CONST.OT_COEFF
    }; rows.push(r2002);
  }

  // 2100 ‚Äî –ù–æ—á–Ω—ã–µ (–¥–æ–ø–ª–∞—Ç–∞ % –æ—Ç —Å—Ç–∞–≤–∫–∏)
  let r2100=null;
  if(nightHrs>0){
    r2100 = {
      code:'2100', name:`–î–æ–ø–ª–∞—Ç–∞ –∑–∞ –Ω–æ—á–Ω—ã–µ (${Math.round(PAY_CONST.NIGHT_PCT*100)}%)`,
      qty: nightHrs, rate: t.base*PAY_CONST.NIGHT_PCT, sum: nightHrs * t.base * PAY_CONST.NIGHT_PCT
    }; rows.push(r2100);
  }

  // –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –∏—Ç–æ–≥ –ø–µ—Ä–µ–¥ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º–∏
  const interGross = rows.reduce((a,r)=>a + r.sum, 0);

  // 3020 ‚Äî –†–∞–π–æ–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
  let r3020=null;
  if((t.rc||0)>0){
    r3020 = {
      code:'3020', name:`–†–∞–π–æ–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç ${t.rc}%`,
      qty: 1, rate: interGross*(t.rc/100), sum: interGross*(t.rc/100)
    }; rows.push(r3020);
  }

  // 3030 ‚Äî –°–µ–≤–µ—Ä–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
  let r3030=null;
  if((t.north||0)>0){
    // –∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, —Å–µ–≤–µ—Ä–Ω—ã–π –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –Ω–∞ ¬´—Ç–∞—Ä–∏—Ñ + –Ω–æ—á–Ω—ã–µ + —Å–≤–µ—Ä—Ö—É—Ä–æ—á–Ω—ã–µ + —Ä–∞–π–æ–Ω–Ω—ã–π¬ª
    const baseForNorth = interGross + (r3020?r3020.sum:0);
    r3030 = {
      code:'3030', name:`–°–µ–≤–µ—Ä–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç ${t.north}%`,
      qty: 1, rate: baseForNorth*(t.north/100), sum: baseForNorth*(t.north/100)
    }; rows.push(r3030);
  }

  // –ò—Ç–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–æ
  const accrued = interGross + (r3020?r3020.sum:0) + (r3030?r3030.sum:0);

  // 5010 ‚Äî –£–¥–µ—Ä–∂–∞–Ω–∏—è/–∫–æ–º–∏—Å—Å–∏—è (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ ¬´–ö–æ–º. —Ä–∞—Å—Ö–æ–¥—ã, ‚ÇΩ¬ª)
  let r5010=null;
  if((t.fee||0)>0){
    r5010 = {
      code:'5010', name:'–£–¥–µ—Ä–∂–∞–Ω–∏—è (–∫–æ–º–∏—Å—Å–∏—è/–ø—Ä–æ—á–µ–µ)', qty:1, rate:-t.fee, sum: -t.fee
    }; rows.push(r5010);
  }

  const total = Math.max(0, Math.round(accrued + (r5010?r5010.sum:0)));

  // 3) –†–µ–Ω–¥–µ—Ä –≤ —Ç–∞–±–ª–∏—Ü—É
  const fmtQty = v => (Math.abs(v- Math.round(v))<1e-6? v.toFixed(0) : v.toFixed(2));
  const fmtCur = v => RUR.format(Math.round(v));

  let html = `
    <div class="kv" style="margin-bottom:8px">
      <div>–ú–µ—Å—è—Ü</div><div>${ym}</div>
      <div>–£—á—Ç—ë–Ω–Ω—ã–µ —á–∞—Å—ã</div><div>${hrs.toFixed(2)} —á (–Ω/—á: ${nightHrs.toFixed(2)})</div>
      <div>–ù–æ—Ä–º–∞</div><div>${normHrs.toFixed(2)} —á</div>
      <div>–°–≤–µ—Ä—Ö—É—Ä–æ—á–Ω—ã–µ</div><div>${otHrs.toFixed(2)} —á</div>
    </div>
    <table>
      <tr><th>–ö–æ–¥</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ö–æ–ª-–≤–æ</th><th>–°—Ç–∞–≤–∫–∞/–∫–æ—ç—Ñ.</th><th>–°—É–º–º–∞</th></tr>
      ${rows.map(r=>`
        <tr>
          <td>${r.code}</td>
          <td>${r.name}</td>
          <td>${(r.qty===1 && Math.abs(r.rate)>=1) ? '' : fmtQty(r.qty)}</td>
          <td>${(r.qty===1 && Math.abs(r.rate)>=1) ? fmtCur(r.rate) : (Math.abs(r.rate)>=1?fmtCur(r.rate):r.rate.toFixed(4))}</td>
          <td><b>${fmtCur(r.sum)}</b></td>
        </tr>`).join('')}
      <tr>
        <td></td><td style="opacity:.8">–ù–∞—á–∏—Å–ª–µ–Ω–æ (–±–µ–∑ —É–¥–µ—Ä–∂–∞–Ω–∏–π)</td><td></td><td></td>
        <td><b>${fmtCur(accrued)}</b></td>
      </tr>
      <tr>
        <td></td><td><b>–ò—Ç–æ–≥–æ –∫ –≤—ã–ø–ª–∞—Ç–µ</b></td><td></td><td></td>
        <td><b>${fmtCur(total)}</b></td>
      </tr>
    </table>
    <div class="small" style="opacity:.75;margin-top:6px">
      –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –Ω–æ—á–Ω—ã—Ö/—Å–≤–µ—Ä—Ö—É—Ä–æ—á–Ω—ã—Ö –º–æ–∂–Ω–æ –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥ –≤–∞—à –∫–≤–∏—Ç–æ–∫ –≤ –∫–æ–¥–µ (PAY_CONST).
    </div>
  `;
  $('#salaryBox').innerHTML = html;
}
function hideSalary(){ $('#salaryBox').innerHTML=''; }

/* ========= –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ–µ–∑–¥–æ–∫ ========= */
function showCalendar(){
  const ym=getActiveYM();
  const trips=getTrips().slice();
  const box=$('#calendarBox'); let days={};
  trips.forEach(t=>{
    const split=splitTripByMonths(t); if(!split[ym]) return;
    const d=(t.date||'').slice(8,10);
    days[d]=(days[d]||0)+Math.round((split[ym].work||0)/60);
  });
  let html='<table><tr><th>–î–µ–Ω—å</th><th>–ß–∞—Å—ã</th></tr>';
  Object.keys(days).sort().forEach(d=>{ html+=`<tr><td>${d}</td><td>${days[d]}</td></tr>`; });
  html+='</table>'; box.innerHTML=html;
}
function hideCalendar(){ $('#calendarBox').innerHTML=''; }

/* ========= –≠–∫—Å–ø–æ—Ä—Ç CSV ========= */
function exportTripsCsv(){
  const ym=getActiveYM();
  const trips=getTrips().slice();
  const rows=[['id','date','date2','route1','route2','start1','end1','start2','end2','hours_in_month','night_min_in_month','notes']];
  trips.forEach(t=>{
    const split=splitTripByMonths(t);
    const mins=(split[ym]?.work)||0, night=(split[ym]?.night)||0;
    if(mins<=0) return;
    rows.push([
      t.id,t.date||'',t.date2||'',t.route1||'',t.route2||'',
      t.start1||'',t.end1||'',t.start2||'',t.end2||'',
      (mins/60).toFixed(2), String(night),
      (t.notes||'').replace(/\n/g,' ')
    ]);
  });
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='trips_'+ym+'.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ========= –ü–æ–ª–Ω—ã–π –æ—Ç–¥—ã—Ö –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–µ–∑–¥–∫–µ ========= */
function fmtLocalFull(d, tzOffsetMin){ if(!d) return '‚Äî';
  const localMs=d.getTime()+tzOffsetMin*60000; const x=new Date(localMs);
  const yyyy=x.getUTCFullYear(), mm=String(x.getUTCMonth()+1).padStart(2,'0'), dd=String(x.getUTCDate()).padStart(2,'0'),
        hh=String(x.getUTCHours()).padStart(2,'0'), mi=String(x.getUTCMinutes()).padStart(2,'0');
  return dd+'.'+mm+'.'+yyyy+' '+hh+':'+mi;
}
function calcFullRest(){
  const trips=getTrips(); if(!trips.length){ $('#restResult').textContent='–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫'; return; }
  const t=trips[trips.length-1];
  const iv=intervalsForTrip(t); if(!iv.length){ $('#restResult').textContent='–ù–µ—á–µ–≥–æ —Å—á–∏—Ç–∞—Ç—å: –Ω–µ—Ç –∫–æ–Ω–µ—á–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏'; return; }
  const endEpoch=iv[iv.length-1][1];

  // –ù–æ—á–Ω—ã–µ –∑–∞ –≤—Å—é –ø–æ–µ–∑–¥–∫—É
  let totalNight=0; iv.forEach(([a,b])=>{ totalNight+=nightMinutesForInterval(a,b); });

  // –ü—Ä–∞–≤–∏–ª–æ (–ø—Ä–∏–º–µ—Ä): –º–∏–Ω–∏–º—É–º 12—á, –ª–∏–±–æ 8—á + –∫–∞–∂–¥—ã–µ –Ω–æ—á–Ω—ã–µ –º–∏–Ω—É—Ç—ã (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã +3—á)
  const addByNight = Math.min(totalNight, 180); // –¥–æ +180 –º–∏–Ω—É—Ç
  const fullMin = Math.max(12*60, 8*60 + addByNight);

  const tz=getSelectedTzOffsetMin();
  const readyAt=new Date(endEpoch + fullMin*60000);

  const txt = '–û–∫–æ–Ω—á–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã: '+fmtLocalFull(new Date(endEpoch), tz)+'\n' +
              '–ü–æ–ª–Ω—ã–π –æ—Ç–¥—ã—Ö: '+fmtHMWords(fullMin)+'\n' +
              '–Ø–≤–∫–∞ –Ω–µ —Ä–∞–Ω–µ–µ: '+fmtLocalFull(readyAt, tz);
  $('#restResult').textContent=txt;
}
function closeFullRest(){ $('#restResult').textContent=''; }

/* ========= INIT ========= */
function init(){
  // –¢–µ–º–∞
  setTheme(S('theme')||'dark');
  // –°–µ—Ç—å
  (function(){ try{ updateNetPill(); }catch(_){} })();

  // –¢–∞—Ä–∏—Ñ—ã -> UI
  (function(){
    const t=getTar();
    if($('#tar_base'))  $('#tar_base').value=t.base;
    if($('#tar_rc'))    $('#tar_rc').value=t.rc;
    if($('#tar_north')) $('#tar_north').value=t.north;
    if($('#tar_fee'))   $('#tar_fee').value=t.fee;
    if($('#tar_norm'))  $('#tar_norm').value=t.norm;
  })();

  // TZ —Å–µ–ª–µ–∫—Ç–æ—Ä
  (function(){
    const sel=$('#tz_select'); if(!sel) return;
    sel.innerHTML=''; tzList().forEach(lb=>{
      const o=document.createElement('option'); o.value=lb; o.textContent=(lb==='AUTO'?'–ê–≤—Ç–æ (—Å–∏—Å—Ç–µ–º–Ω—ã–π)':lb); sel.appendChild(o);
    });
    const pref=S('tz_pref'); sel.value=pref?(pref.mode==='AUTO'?'AUTO':(pref.label||'AUTO')):'AUTO';
  })();

  // –£—á–∞—Å—Ç–∫–∏/–º–∞—Ä—à—Ä—É—Ç—ã
  renderSecs(); buildRouteOptions();

  // –ê–∫—Ç–∏–≤–Ω—ã–π –º–µ—Å—è—Ü
  if(!S('ui_month')) S('ui_month', todayYM());
  refreshMonthUI();

  // –ü–æ–µ–∑–¥–∫–∏/–¥–∞—à–±–æ—Ä–¥
  renderTrips(); updateDash();

  // –¢–∞–π–º–µ—Ä—ã ¬´–≤ –ø—É—Ç–∏¬ª
  setInterval(()=>{ try{ updateLiveTimers(); }catch(_){ } }, 30000);

  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Å–Ω–∞–ø—à–æ—Ç–∞ (–µ—Å–ª–∏ –ø—É—Å—Ç–æ)
  if(!getTrips().length && tryRestoreFromAutosnap()){ renderTrips(); updateDash(); }

  // –ü—Ä–æ—Ñ–∏–ª—å ‚Äî —Ñ–∞–π–ª—ã
  if($('#filesList')) renderFilesList();
}
document.addEventListener('DOMContentLoaded', init);
</script>
<!-- PART 6/7 END --><!-- PART 7/7 START -->
</main>

</body>
</html>
<!-- PART 7/7 END -->
