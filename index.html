<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>–ë–ª–æ–∫–Ω–æ—Ç –ú–∞—à–∏–Ω–∏—Å—Ç–∞ ¬∑ Lite v2025.25c</title>
<meta name="theme-color" content="#d32f2f">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180x180.png?v=202525c">
<link rel="apple-touch-icon" sizes="167x167" href="apple-touch-icon-167x167.png?v=202525c">
<link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon-152x152.png?v=202525c">
<link rel="apple-touch-icon" href="apple-touch-icon.png?v=202525c">
<style>
*{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html,body{ height:100%; margin:0; }
:root{ --red:#d32f2f; --bg:#0f1420; --card:#161d2a; --line:#243246; --muted:#8aa0b6; --text:#e9eef5; }
body{ background:var(--bg); color:var(--text); font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
header{ position:sticky; top:0; z-index:3; background:var(--red); color:#fff; padding:12px 14px; display:flex; justify-content:space-between; align-items:center; }
h1{ margin:0; font-size:18px; }
.badge{ font-size:12px; padding:2px 8px; border:1px solid rgba(255,255,255,.4); border-radius:999px; }
.container{ padding:12px; padding-bottom:84px; }
.card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; margin-bottom:10px; }
.grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.row{ display:flex; gap:8px; align-items:center; margin:8px 0; }
.row label{ width:42%; color:var(--muted); font-size:14px; }
.row input, .row select, .row textarea{ flex:1; background:#0e1622; border:1px solid var(--line); color:var(--text); padding:10px; border-radius:12px; font-size:16px; }
.row textarea{ min-height:90px; resize:vertical; }
.btn{ background:#1b2738; color:#fff; border:1px solid var(--line); padding:10px 14px; border-radius:12px; font-size:15px; }
.btn.primary{ background:#ffffff; color:#d32f2f; border-color:#fff; }
.btn.ghost{ background:transparent; border:1px solid var(--line); }
.small{ font-size:12px; }
.progress{ height:10px; border-radius:999px; background:#0f2035; overflow:hidden; border:1px solid var(--line); }
.progress>div{ height:100%; background:#d32f2f; width:0%; }
.view{ display:none; }
.view.active{ display:block; }
.tabbar{ position:fixed; left:0; right:0; bottom:0; height:70px; background:#121828; border-top:1px solid var(--line); display:flex; z-index:5; }
.tabbar button{ flex:1; background:transparent; border:none; color:#8aa0b6; font-size:12px; padding:6px 0; }
.tabbar button.active{ color:#fff; }
.tabbar .ico{ display:block; font-size:18px; margin-bottom:4px; }
.segs{ display:flex; gap:6px; background:#0e1622; border:1px solid var(--line); border-radius:12px; padding:4px; }
.segs button{ flex:1; border:none; padding:8px 10px; background:transparent; color:#8aa0b6; border-radius:8px; }
.segs button.active{ background:#1a2435; color:#fff; }
.trip{ display:grid; grid-template-columns:1fr auto auto; align-items:center; gap:8px; padding:8px 0; border-bottom:1px solid #233246; }
.trip:last-child{ border-bottom:0; }
.section{ display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #233246; gap:8px; }
.kv{ display:grid; grid-template-columns:1fr auto; gap:8px 12px; align-items:center; }
hr.sep{ border:0; border-top:1px solid var(--line); margin:8px 0; }
.right{ text-align:right; }
.badge2{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--line); color:#fff; font-size:12px; }
table{ width:100%; border-collapse:collapse; }
td,th{ border-bottom:1px solid #233246; padding:6px 4px; text-align:left; }
th{ color:#a9bacd; font-weight:600; }
a.link{ color:#8ecaff; text-decoration:none; }
#log{ position:fixed; left:8px; right:8px; bottom:76px; max-height:30vh; overflow:auto; background:#0e1622; border:1px dashed #2a3b57; padding:6px 8px; border-radius:10px; font-size:12px; display:none; }
</style>
</head>
<body>
<header>
  <h1>–ë–ª–æ–∫–Ω–æ—Ç –ú–∞—à–∏–Ω–∏—Å—Ç–∞</h1>
  <div class="badge">Lite v2025.25c</div>
</header>
<main class="container">
  <!-- –ì–ª–∞–≤–Ω–∞—è -->
  <section id="v-dashboard" class="view active">
    <div class="card">
      <div style="display:flex;justify-content:space-between"><b>–ú–µ—Å—è—á–Ω–∞—è –Ω–æ—Ä–º–∞</b><b id="mwNorm">‚Äî</b></div>
      <div class="progress" style="margin-top:6px"><div id="mwBar"></div></div>
      <div class="row"><label>–ë–∞–∑–∞ –Ω–æ—Ä–º—ã</label>
        <select id="normBasis" onchange="updateDashboard()">
          <option value="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –¥–Ω–∏</option>
          <option value="working">–†–∞–±–æ—á–∏–µ –¥–Ω–∏ (–ü–Ω‚Äì–ü—Ç)</option>
        </select>
      </div>
      <div class="row"><label>–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ</label><div id="mwWorked" class="small">‚Äî</div></div>
      <div class="row"><label>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</label><div id="mwPercent" class="small">‚Äî</div></div>
      <div class="row"><label>–û—Å—Ç–∞–ª–æ—Å—å/–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞</label><div id="mwRemain" class="small">‚Äî</div></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>–ü–æ–µ–∑–¥–∫–∏</b>
        <div>
          <button class="btn primary" onclick="addTripOpen()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn ghost" onclick="exportTripsCsv()">CSV</button>
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∏ –ü–æ –¥–Ω—è–º/–ü–æ –º–µ—Å—è—Ü–∞–º -->
      <div class="segs" style="margin-top:8px">
        <button id="segDays" class="active" onclick="switchTripsList('days')">–ü–æ –¥–Ω—è–º</button>
        <button id="segMonths" onclick="switchTripsList('months')">–ü–æ –º–µ—Å—è—Ü–∞–º</button>
      </div>

      <!-- –§–æ—Ä–º–∞ –ø–æ–µ–∑–¥–∫–∏ -->
      <div id="tripForm" class="card" style="display:none; margin-top:10px">
        <div class="grid2">
          <div class="row"><label>–î–∞—Ç–∞</label><input id="t_date" type="date"></div>
          <div class="row"><label>‚Ññ –ø–æ–µ–∑–¥–∞</label><input id="t_train" placeholder="‚Ññ"></div>
          <div class="row"><label>–Ø–≤–∫–∞</label><input id="t_start" type="time" onchange="recalcHours()" oninput="recalcHours()"></div>
          <div class="row"><label>–û–∫–æ–Ω—á–∞–Ω–∏–µ</label><input id="t_end" type="time" onchange="recalcHours()" oninput="recalcHours()"></div>
          <div class="row"><label>–õ–æ–∫–æ–º–æ—Ç–∏–≤</label><input id="t_loco" placeholder="–≠–ü1–ú‚Äëxxx / 2–¢–≠116‚Äëxxx"></div>
          <div class="row"><label>–°—Ç–æ—è–Ω–∫–∏ (–º–∏–Ω)</label><input id="t_stops" type="number" inputmode="numeric" placeholder="0" onchange="recalcHours()" oninput="recalcHours()"></div>
        </div>
        <div class="row"><label>–ú–∞—Ä—à—Ä—É—Ç</label><input id="t_route" placeholder="–ú–∞–ª–æ—à—É–π–∫–∞ ‚Äî –û–±–æ–∑–µ—Ä—Å–∫–∞—è"></div>
        <div class="row"><label>–ß–∞—Å—ã (–∏—Ç–æ–≥)</label><input id="t_hours" type="number" inputmode="decimal" step="0.1" placeholder="8"></div>
        <div class="row"><label>–ó–∞–º–µ—Ç–∫–∏</label><textarea id="t_notes" placeholder="–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, –ø—Ä–æ—Å—Ç–æ–∏‚Ä¶"></textarea></div>

        <hr class="sep">
        <div><b>–ü–µ—Ä–µ–≥–æ–Ω—ã</b> <button class="btn ghost" onclick="segAdd()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≥–æ–Ω</button></div>
        <table id="segTable" style="margin-top:6px">
          <thead><tr><th>–£—á–∞—Å—Ç–æ–∫/–ø–µ—Ä–µ–≥–æ–Ω</th><th>–ú–∏–Ω</th><th>–ö–º</th><th></th></tr></thead>
          <tbody></tbody>
        </table>

        <div class="row"><button class="btn primary" onclick="tripSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="btn ghost" onclick="tripCancel()">–û—Ç–º–µ–Ω–∞</button></div>
      </div>

      <!-- –°–ø–∏—Å–∫–∏ -->
      <div id="daysList" style="margin-top:8px"></div>
      <div id="monthsList" style="margin-top:8px; display:none"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>–ò—Ç–æ–≥ –ø–æ –º–µ—Å—è—Ü—É</b>
        <div>
          <button class="btn ghost" onclick="exportMonthsCsv()">CSV</button>
          <button class="btn ghost" onclick="printCurrentMonth()">PDF</button>
        </div>
      </div>
      <div class="kv">
        <div>–ß–∞—Å—ã</div><div class="right"><b id="sumHours">‚Äî</b></div>
        <div>–ü–æ–µ–∑–¥–æ–∫</div><div class="right"><b id="sumTrips">‚Äî</b></div>
        <div>–û–∫–ª–∞–¥ (–±–µ–∑ –Ω–∞–¥–±–∞–≤–æ–∫)</div><div class="right"><b id="sumBase">‚Äî</b></div>
        <div>–ù–∞–¥–±–∞–≤–∫–∏ (+%)</div><div class="right"><b id="sumAddons">‚Äî</b></div>
        <div>–ö–æ–º. —Ä–∞—Å—Ö–æ–¥—ã</div><div class="right"><b id="sumComm">‚Äî</b></div>
        <div><b>–ò—Ç–æ–≥–æ</b></div><div class="right"><b id="sumTotal" class="badge2">‚Äî</b></div>
      </div>
    </div>
  </section>

  <!-- –£—á–∞—Å—Ç–∫–∏ -->
  <section id="v-sections" class="view">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>–£—á–∞—Å—Ç–∫–∏</b><button class="btn" onclick="sectionOpen()">–ù–æ–≤—ã–π —É—á–∞—Å—Ç–æ–∫</button>
      </div>
      <div id="sectionForm" class="card" style="display:none; margin-top:8px">
        <div class="row"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="s_name"></div>
        <div class="row"><label>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label><input id="s_from"></div>
        <div class="row"><label>–ü—Ä–∏–±—ã—Ç–∏–µ</label><input id="s_to"></div>
        <div class="row"><label>–î–ª–∏–Ω–∞ (–∫–º)</label><input id="s_len" type="number" inputmode="decimal"></div>
        <div class="row"><button class="btn primary" onclick="sectionSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="btn ghost" onclick="sectionCancel()">–û—Ç–º–µ–Ω–∞</button></div>
      </div>
      <div id="sectionList"></div>
    </div>
  </section>

  <!-- –¢–∞—Ä–∏—Ñ—ã –∏ –ø—Ä–æ—Ñ–∏–ª–∏ -->
  <section id="v-tariffs" class="view">
    <div class="card">
      <b>–¢–∞—Ä–∏—Ñ—ã –∏ –Ω–∞–¥–±–∞–≤–∫–∏</b>
      <div class="grid2">
        <div class="row"><label>–¢–∞—Ä–∏—Ñ (‚ÇΩ/—á)</label><input id="tar_base" type="number" inputmode="decimal" placeholder="358.46"></div>
        <div class="row"><label>–ù–æ—Ä–º–∞ /–º–µ—Å (—á)</label><input id="tar_norm" type="number" inputmode="decimal" placeholder="176"></div>
        <div class="row"><label>–†–∞–π–æ–Ω–Ω—ã–π %</label><input id="tar_region" type="number" inputmode="decimal" placeholder="20"></div>
        <div class="row"><label>–°–µ–≤–µ—Ä–Ω—ã–π %</label><input id="tar_north" type="number" inputmode="decimal" placeholder="50"></div>
        <div class="row"><label>–ö–ª–∞—Å—Å %</label><input id="tar_class" type="number" inputmode="decimal" placeholder="0"></div>
        <div class="row"><label>–ó–æ–Ω–∞–ª—å–Ω–∞—è %</label><input id="tar_zone" type="number" inputmode="decimal" placeholder="0"></div>
        <div class="row"><label>–ë–ê–ú %</label><input id="tar_bam" type="number" inputmode="decimal" placeholder="0"></div>
        <div class="row"><label>–ö–æ–º.—Ä–∞—Å—Ö–æ–¥—ã /–ø–æ–µ–∑–¥–∫—É (‚ÇΩ)</label><input id="tar_comm" type="number" inputmode="decimal" placeholder="0"></div>
      </div>
      <div class="row">
        <button class="btn primary" onclick="tarSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <select id="profileSelect" style="flex:1" onchange="profileApply()"></select>
        <button class="btn ghost" onclick="profileSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
        <button class="btn ghost" onclick="profileDel()">–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
      </div>
      <div class="small" style="opacity:.8">–ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç —Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞–±–æ—Ä—ã –Ω–∞–¥–±–∞–≤–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ —Ä–∞–∑–Ω—ã–º –¥–µ–ø–æ/—É—á–∞—Å—Ç–∫–∞–º) –∏ –±—ã—Å—Ç—Ä–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è.</div>
    </div>
  </section>

  <!-- –°–ø—Ä–∞–≤–∫–∞ -->
  <section id="v-refs" class="view">
    <div class="card">
      <b>–®–ø–∞—Ä–≥–∞–ª–∫–∏</b>
      <div class="row"><textarea id="refText" placeholder="–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ –∑–∞–º–µ—Ç–∫–∏‚Ä¶"></textarea></div>
      <div class="row"><button class="btn" onclick="refSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    </div>
  </section>

  <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <section id="v-settings" class="view">
    <div class="card">
      <b>–ë—ç–∫–∞–ø</b>
      <div class="row"><button class="btn" onclick="backup()">–°–∫–∞—á–∞—Ç—å JSON</button></div>
      <div class="row"><input id="restoreFile" type="file" accept="application/json" onchange="restoreFileChanged(event)"></div>
      <div class="small" style="opacity:.8">–í–µ—Ä—Å–∏—è Lite single‚Äëfile 2025.25c</div>
    </div>
  </section>
</main>

<div id="log"></div>

<nav class="tabbar">
  <button class="active" data-tab="dashboard" onclick="nav(this)"><span class="ico">üè†</span>–ì–ª–∞–≤–Ω–∞—è</button>
  <button data-tab="sections" onclick="nav(this)"><span class="ico">üó∫Ô∏è</span>–£—á–∞—Å—Ç–∫–∏</button>
  <button data-tab="tariffs" onclick="nav(this)"><span class="ico">üí≥</span>–¢–∞—Ä–∏—Ñ—ã</button>
  <button data-tab="refs" onclick="nav(this)"><span class="ico">üìí</span>–°–ø—Ä–∞–≤–∫–∞</button>
  <button data-tab="settings" onclick="nav(this)"><span class="ico">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</nav>

<script>
// -------- helpers --------
function $(s){ return document.querySelector(s); }
function $all(s){ return Array.from(document.querySelectorAll(s)); }
function S(k,val){ if(arguments.length===2){ localStorage.setItem(k, JSON.stringify(val)); return val; } try{ const raw=localStorage.getItem(k); return raw? JSON.parse(raw): null; }catch(e){ return null; } }
function fmtTime(min){ const h=Math.floor(min/60), m=min%60; return h+'—á '+String(m).padStart(2,'0')+'–º'; }
function toMinutes(hhmm){ if(!hhmm) return 0; const p=hhmm.split(':'); return (Number(p[0])||0)*60 + (Number(p[1])||0); }
function log(s){ const box=$('#log'); if(!box) return; box.style.display='block'; const d=document.createElement('div'); d.textContent=String(s); box.appendChild(d); box.scrollTop=box.scrollHeight; }

// -------- nav --------
function nav(btn){
  $all('.tabbar button').forEach(x=>x.classList.remove('active'));
  btn.classList.add('active');
  const v = btn.getAttribute('data-tab');
  $all('.view').forEach(x=>x.classList.remove('active'));
  $('#v-'+v).classList.add('active');
}

// -------- tariffs + profiles --------
function getTariffs(){ return S('tariffs_sf') || { base:358.46, norm:176, region:20, north:50, klass:0, zone:0, bam:0, comm:0 }; }
function setTariffs(t){ S('tariffs_sf', t); }
function tarLoad(){
  const t=getTariffs();
  $('#tar_base').value=t.base; $('#tar_norm').value=t.norm; $('#tar_region').value=t.region||0; $('#tar_north').value=t.north||0;
  $('#tar_class').value=t.klass||0; $('#tar_zone').value=t.zone||0; $('#tar_bam').value=t.bam||0; $('#tar_comm').value=t.comm||0;
  // load profiles
  const list=S('profiles_sf')||[]; const sel=$('#profileSelect'); sel.innerHTML='';
  if(!list.length){ const opt=document.createElement('option'); opt.value=''; opt.textContent='‚Äî –ø—Ä–æ—Ñ–∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç ‚Äî'; sel.appendChild(opt); }
  list.forEach(p=>{ const opt=document.createElement('option'); opt.value=p.name; opt.textContent=p.name; sel.appendChild(opt); });
}
function tarSave(){
  const t={ base:Number($('#tar_base').value)||0, norm:Number($('#tar_norm').value)||0, region:Number($('#tar_region').value)||0, north:Number($('#tar_north').value)||0, klass:Number($('#tar_class').value)||0, zone:Number($('#tar_zone').value)||0, bam:Number($('#tar_bam').value)||0, comm:Number($('#tar_comm').value)||0 };
  setTariffs(t); updateDashboard(); renderMonths(); updateTotals();
}
function profileSave(){
  const name=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–∞–¥–±–∞–≤–æ–∫:',''); if(!name) return;
  const list=S('profiles_sf')||[]; const t=getTariffs(); const ex=list.findIndex(x=>x.name===name);
  const rec={name, t}; if(ex>=0) list[ex]=rec; else list.push(rec); S('profiles_sf',list); tarLoad(); alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
}
function profileDel(){
  const sel=$('#profileSelect'); const name=sel.value; if(!name) return;
  const list=(S('profiles_sf')||[]).filter(x=>x.name!==name); S('profiles_sf',list); tarLoad();
}
function profileApply(){
  const name=$('#profileSelect').value; if(!name) return;
  const p=(S('profiles_sf')||[]).find(x=>x.name===name); if(!p) return;
  setTariffs(p.t); tarLoad(); updateDashboard(); renderMonths(); updateTotals();
}

// -------- refs --------
function refSave(){ S('refs_sf', $('#refText').value); }

// -------- sections --------
function sectionOpen(){ $('#sectionForm').style.display='block'; $('#s_name').value=''; $('#s_from').value=''; $('#s_to').value=''; $('#s_len').value=''; }
function sectionCancel(){ $('#sectionForm').style.display='none'; }
function sectionSave(){
  const arr=S('sections_sf')||[];
  arr.push({ id:Date.now(), name:$('#s_name').value.trim(), from:$('#s_from').value.trim(), to:$('#s_to').value.trim(), len:Number($('#s_len').value)||0 });
  S('sections_sf',arr); $('#sectionForm').style.display='none'; renderSections();
}
function renderSections(){
  const list=$('#sectionList'); list.innerHTML='';
  const arr=S('sections_sf')||[];
  if(!arr.length){ const d=document.createElement('div'); d.className='small'; d.style.opacity=.7; d.textContent='–ù–µ—Ç —É—á–∞—Å—Ç–∫–æ–≤'; list.appendChild(d); }
  arr.forEach(s=>{
    const row=document.createElement('div'); row.className='section';
    row.innerHTML='<div><b>'+ (s.name||'‚Äî') +'</b><div class="small" style="opacity:.7">'+(s.from||'‚Äî')+' ‚Üí '+(s.to||'‚Äî')+' ‚Ä¢ '+(s.len||0)+' –∫–º</div></div>'
      +'<div><button class="btn ghost" onclick="sectionEdit('+s.id+')">‚úé</button> <button class="btn ghost" onclick="sectionDel('+s.id+')">üóë</button></div>';
    list.appendChild(row);
  });
}
function sectionEdit(id){
  const s=(S('sections_sf')||[]).find(x=>x.id===id); if(!s) return;
  $('#sectionForm').style.display='block';
  $('#s_name').value=s.name||''; $('#s_from').value=s.from||''; $('#s_to').value=s.to||''; $('#s_len').value=s.len||'';
  const save=function(){
    const arr=S('sections_sf')||[]; const ix=arr.findIndex(x=>x.id===id);
    arr[ix]={ id, name:$('#s_name').value.trim(), from:$('#s_from').value.trim(), to:$('#s_to').value.trim(), len:Number($('#s_len').value)||0 };
    S('sections_sf',arr); $('#sectionForm').style.display='none'; renderSections();
  };
  // –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∞–µ–º –∫–Ω–æ–ø–∫—É
  $('#sectionForm .btn.primary').setAttribute('onclick','('+save.toString()+')()');
}
function sectionDel(id){
  const arr=(S('sections_sf')||[]).filter(x=>x.id!==id); S('sections_sf',arr); renderSections();
}

// -------- trips --------
function getTrips(){ return S('trips_sf')||[]; }
function setTrips(a){ S('trips_sf', a); }
var editId=null;
function addTripOpen(){
  editId=null;
  $('#tripForm').style.display='block';
  $('#t_date').value=new Date().toISOString().slice(0,10);
  $('#t_route').value=''; $('#t_train').value=''; $('#t_loco').value='';
  $('#t_start').value='08:00'; $('#t_end').value='17:00'; $('#t_stops').value='0';
  $('#t_notes').value=''; $('#segTable tbody').innerHTML='';
  recalcHours();
}
function tripCancel(){ $('#tripForm').style.display='none'; }
function toNum(v){ const n=Number(v); return isNaN(n)?0:n; }
function recalcHours(){
  const st = toMinutes($('#t_start').value), en = toMinutes($('#t_end').value);
  let span=en-st; if(span<0) span+=24*60;
  const stops=toNum($('#t_stops').value);
  $('#t_hours').value=((span+stops)/60).toFixed(1);
}
function segAdd(name='', minutes=0, km=0){
  const tb=$('#segTable tbody');
  const tr=document.createElement('tr');
  const idx=Date.now()+Math.floor(Math.random()*1000);
  tr.setAttribute('data-i', idx);
  tr.innerHTML='<td><input class="segName" placeholder="–£—á–∞—Å—Ç–æ–∫/–ø–µ—Ä–µ–≥–æ–Ω" value="'+(name||'')+'"></td>' +
               '<td><input class="segMin" type="number" inputmode="numeric" value="'+(minutes||0)+'"></td>' +
               '<td><input class="segKm" type="number" inputmode="decimal" value="'+(km||0)+'"></td>' +
               '<td><button class="btn ghost" onclick="segDel('+idx+')">‚úñ</button></td>';
  tb.appendChild(tr);
}
function segDel(idx){
  const tr=$('#segTable tbody tr[data-i="'+idx+'"]'); if(tr) tr.remove();
}
function collectSegs(){
  const rows=$all('#segTable tbody tr');
  let segs=[]; let km_total=0;
  rows.forEach(r=>{
    const name=(r.querySelector('.segName')||{}).value||'';
    const min=toNum((r.querySelector('.segMin')||{}).value);
    const km=toNum((r.querySelector('.segKm')||{}).value);
    segs.push({name:name.trim(), min, km}); km_total+=km;
  });
  return {segs, km_total};
}
function tripSave(){
  const c=collectSegs();
  const rec={ id:editId||Date.now(), date:$('#t_date').value||new Date().toISOString().slice(0,10), route:$('#t_route').value.trim(), train:$('#t_train').value.trim(), loco:$('#t_loco').value.trim(),
    start:$('#t_start').value, end:$('#t_end').value, stops:toNum($('#t_stops').value), hours:toNum($('#t_hours').value), notes:($('#t_notes').value||'').trim(),
    segs:c.segs, km_total:c.km_total };
  const arr=getTrips(); const i=arr.findIndex(x=>x.id===rec.id); if(i>=0) arr[i]=rec; else arr.push(rec);
  setTrips(arr); $('#tripForm').style.display='none'; renderTripsByDays(); updateDashboard(); renderMonths(); updateTotals();
}
function tripEdit(id){
  const t=getTrips().find(x=>x.id===id); if(!t) return;
  editId=id; $('#tripForm').style.display='block';
  $('#t_date').value=t.date||new Date().toISOString().slice(0,10);
  $('#t_route').value=t.route||''; $('#t_train').value=t.train||''; $('#t_loco').value=t.loco||'';
  $('#t_start').value=t.start||''; $('#t_end').value=t.end||''; $('#t_stops').value=t.stops||0; $('#t_hours').value=t.hours||0; $('#t_notes').value=t.notes||'';
  $('#segTable tbody').innerHTML=''; (t.segs||[]).forEach(s=> segAdd(s.name||'', s.min||0, s.km||0));
}
function tripDel(id){
  const arr=getTrips().filter(x=>x.id!==id); setTrips(arr); renderTripsByDays(); updateDashboard(); renderMonths(); updateTotals();
}
function renderTripsByDays(){
  const list=$('#daysList'); list.innerHTML='';
  const arr=getTrips().slice().sort((a,b)=> (a.date||'').localeCompare(b.date));
  if(!arr.length){ const d=document.createElement('div'); d.className='small'; d.style.opacity=.7; d.textContent='–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫'; list.appendChild(d); }
  arr.forEach(t=>{
    const row=document.createElement('div'); row.className='trip';
    const meta=[t.train?'‚Ññ'+t.train:'', t.loco||''].filter(Boolean).join(' ¬∑ '); const kms=(t.km_total||0)?(' ¬∑ '+t.km_total+' –∫–º'):'';
    row.innerHTML='<div><div><b>'+ (t.date||'‚Äî') +'</b> ‚Ä¢ '+ (t.route||'‚Äî') +'</div><div class="small" style="opacity:.7">'+meta+kms+'</div></div>'
      +'<div>'+ (t.hours||0) +' —á</div>'
      +'<div><button class="btn ghost" onclick="tripEdit('+t.id+')">‚úé</button> <button class="btn ghost" onclick="tripDel('+t.id+')">üóë</button></div>';
    list.appendChild(row);
  });
}

function switchTripsList(which){
  if(which==='days'){ $('#segDays').classList.add('active'); $('#segMonths').classList.remove('active'); $('#daysList').style.display='block'; $('#monthsList').style.display='none'; }
  else { $('#segMonths').classList.add('active'); $('#segDays').classList.remove('active'); $('#daysList').style.display='none'; $('#monthsList').style.display='block'; }
}

// months
function renderMonths(){
  const root=$('#monthsList'); root.innerHTML='';
  const arr=getTrips(); if(!arr.length){ const d=document.createElement('div'); d.className='small'; d.style.opacity=.7; d.textContent='–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'; root.appendChild(d); return; }
  const base=Number(getTariffs().base)||0; const map={};
  arr.forEach(t=>{ const ym=(t.date||'').slice(0,7)||'‚Äî'; if(!map[ym]) map[ym]={hours:0,count:0,trips:[]}; map[ym].hours+=toNum(t.hours); map[ym].count++; map[ym].trips.push(t); });
  Object.keys(map).sort().forEach(m=>{
    const hours=map[m].hours, pay=Math.round(hours*base);
    const card=document.createElement('div'); card.className='card';
    card.innerHTML='<div class="section"><div><b>'+m+'</b> ‚Ä¢ '+map[m].count+' —Ä–µ–π—Å(–∞)</div><div>'+hours.toFixed(1)+' —á ¬∑ ~'+pay.toLocaleString('ru-RU')+' ‚ÇΩ</div></div>';
    const inner=document.createElement('div'); inner.style.display='none';
    const tbl=document.createElement('table'); tbl.innerHTML='<thead><tr><th>–î–∞—Ç–∞</th><th>–ú–∞—Ä—à—Ä—É—Ç</th><th>‚Ññ</th><th>–õ–æ–∫–æ</th><th>–ß–∞—Å—ã</th><th>–ö–º</th></tr></thead><tbody></tbody>';
    const tb=tbl.querySelector('tbody');
    map[m].trips.sort((a,b)=> (a.date||'').localeCompare(b.date)).forEach(t=>{
      const tr=document.createElement('tr'); tr.innerHTML='<td>'+ (t.date||'') +'</td><td>'+ (t.route||'') +'</td><td>'+ (t.train||'') +'</td><td>'+ (t.loco||'') +'</td><td>'+ (t.hours||0) +'</td><td>'+ (t.km_total||0) +'</td>';
      tb.appendChild(tr);
    });
    inner.appendChild(tbl); card.appendChild(inner);
    card.querySelector('.section').setAttribute('onclick','this.nextSibling.style.display=(this.nextSibling.style.display==="none"?"block":"none")');
    root.appendChild(card);
  });
}

// totals
function updateTotals(){
  const arr=getTrips(); const t=getTariffs();
  const hours=arr.reduce((a,x)=> a+toNum(x.hours),0); const trips=arr.length;
  const basePay=hours*(toNum(t.base)); const addonFactor=1+(toNum(t.region)+toNum(t.north)+toNum(t.klass)+toNum(t.zone)+toNum(t.bam))/100;
  const withAddons=basePay*addonFactor; const comm=toNum(t.comm)*trips; const total=Math.round(withAddons+comm);
  $('#sumHours').textContent=hours.toFixed(1)+' —á'; $('#sumTrips').textContent=String(trips);
  $('#sumBase').textContent=Math.round(basePay).toLocaleString('ru-RU')+' ‚ÇΩ';
  $('#sumAddons').textContent=Math.round(withAddons-basePay).toLocaleString('ru-RU')+' ‚ÇΩ';
  $('#sumComm').textContent=Math.round(comm).toLocaleString('ru-RU')+' ‚ÇΩ';
  $('#sumTotal').textContent=total.toLocaleString('ru-RU')+' ‚ÇΩ';
}

// dashboard
function updateDashboard(){
  const t=getTariffs(); const trips=getTrips();
  const workedMin=Math.round((trips.reduce((a,x)=>a+toNum(x.hours),0))*60);
  const normMin=(toNum(t.norm))*60;
  const percent=normMin? Math.round(workedMin/normMin*100) : 0;
  const remain=normMin-workedMin;
  const now=new Date(); const y=now.getFullYear(), m=now.getMonth(); const daysInMonth=new Date(y,m+1,0).getDate();
  let elapsedDays=now.getDate();
  if(($('#normBasis').value||'calendar')==='working'){ elapsedDays=0; for(let d=1; d<=now.getDate(); d++){ const wd=new Date(y,m,d).getDay(); if(wd!==0&&wd!==6) elapsedDays++; } }
  const totalDays=$('#normBasis').value==='working'? (function(){ let c=0; for(let d=1; d<=daysInMonth; d++){ const wd=new Date(y,m,d).getDay(); if(wd!==0&&wd!==6) c++; } return c; })() : daysInMonth;
  $('#mwNorm').textContent=(t.norm||0)+' —á';
  $('#mwWorked').textContent=fmtTime(workedMin);
  $('#mwPercent').textContent=percent+'%';
  $('#mwRemain').textContent=remain>=0? ('–û—Å—Ç–∞–ª–æ—Å—å: '+fmtTime(remain)) : ('–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞: '+fmtTime(-remain));
  $('#mwBar').style.width=Math.min(percent,100)+'%';
}

// export
function csvEscape(v){ if(v==null) return ''; const s=String(v).replace(/"/g,'""'); return /[",\n;]/.test(s)? '"'+s+'"' : s; }
function exportTripsCsv(){
  const arr=getTrips();
  const head=['–î–∞—Ç–∞','–ú–∞—Ä—à—Ä—É—Ç','‚Ññ –ø–æ–µ–∑–¥–∞','–õ–æ–∫–æ–º–æ—Ç–∏–≤','–Ø–≤–∫–∞','–û–∫–æ–Ω—á–∞–Ω–∏–µ','–°—Ç–æ—è–Ω–∫–∏ (–º–∏–Ω)','–ß–∞—Å—ã','–ö–º –≤—Å–µ–≥–æ','–ó–∞–º–µ—Ç–∫–∏'];
  const rows=[head];
  arr.forEach(t=> rows.push([t.date||'',t.route||'',t.train||'',t.loco||'',t.start||'',t.end||'',t.stops||0,t.hours||0,t.km_total||0,(t.notes||'').replace(/\n/g,' ')]));
  const csv=rows.map(r=> r.map(csvEscape).join(';')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='trips.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500);
}
function exportMonthsCsv(){
  const arr=getTrips(); const map={};
  arr.forEach(t=>{ const ym=(t.date||'').slice(0,7)||'‚Äî'; if(!map[ym]) map[ym]={hours:0,count:0}; map[ym].hours+=toNum(t.hours); map[ym].count++; });
  const rows=[['–ú–µ—Å—è—Ü','–ü–æ–µ–∑–¥–æ–∫','–ß–∞—Å—ã']]; Object.keys(map).sort().forEach(m=> rows.push([m,map[m].count,map[m].hours.toFixed(1)]));
  const csv=rows.map(r=> r.join(';')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='months.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500);
}
function printCurrentMonth(){
  const arr=getTrips(); if(!arr.length){ alert('–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫'); return; }
  const ym=(new Date().toISOString().slice(0,7)); const trips=arr.filter(t=> (t.date||'').slice(0,7)===ym).sort((a,b)=> (a.date||'').localeCompare(b.date));
  const t=getTariffs(); let html='<html><head><meta charset="utf-8"><title>–û—Ç—á—ë—Ç '+ym+'</title></head><body style="font-family:system-ui,Segoe UI,sans-serif">';
  html+='<h2>–û—Ç—á—ë—Ç –∑–∞ '+ym+'</h2><table border="1" cellspacing="0" cellpadding="6"><tr><th>–î–∞—Ç–∞</th><th>–ú–∞—Ä—à—Ä—É—Ç</th><th>‚Ññ</th><th>–õ–æ–∫–æ</th><th>–ß–∞—Å—ã</th><th>–ö–º</th><th>–ó–∞–º–µ—Ç–∫–∏</th></tr>';
  let hours=0, km=0; trips.forEach(x=>{ hours+=toNum(x.hours); km+=toNum(x.km_total);
    html+='<tr><td>'+ (x.date||'') +'</td><td>'+ (x.route||'') +'</td><td>'+ (x.train||'') +'</td><td>'+ (x.loco||'') +'</td><td>'+ (x.hours||0) +'</td><td>'+ (x.km_total||0) +'</td><td>'+ (x.notes||'').replace(/</g,'&lt;') +'</td></tr>'; });
  const basePay=hours*(toNum(t.base)); const addonFactor=1+(toNum(t.region)+toNum(t.north)+toNum(t.klass)+toNum(t.zone)+toNum(t.bam))/100; const comm=toNum(t.comm)*trips.length;
  const total=Math.round(basePay*addonFactor+comm);
  html+='</table><p><b>–ò—Ç–æ–≥–æ:</b> —á–∞—Å–æ–≤ '+hours.toFixed(1)+', –∫–º '+km.toFixed(1)+', –≤—ã–ø–ª–∞—Ç ~ '+ total.toLocaleString('ru-RU') +' ‚ÇΩ</p>';
  html+='<script>window.onload=function(){window.print();}</script></body></html>';
  const w=window.open('about:blank','_blank'); if(!w){ alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞'); return; } w.document.open(); w.document.write(html); w.document.close();
}

// backup
function backup(){
  const data={ tariffs:getTariffs(), trips:getTrips(), sections:S('sections_sf')||[], refs:S('refs_sf')||'', profiles:S('profiles_sf')||[] };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='bm-backup.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500);
}
function restoreFileChanged(e){
  const f=e.target.files[0]; if(!f) return; const rd=new FileReader();
  rd.onload=function(){ try{ const d=JSON.parse(rd.result);
    if(d.tariffs) setTariffs(d.tariffs); if(d.trips) setTrips(d.trips); if(d.sections) S('sections_sf', d.sections); if('refs' in d) S('refs_sf', d.refs); if(Array.isArray(d.profiles)) S('profiles_sf', d.profiles);
    init(); alert('–ë—ç–∫–∞–ø –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
  }catch(err){ alert('–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞: '+err.message); } };
  rd.readAsText(f);
}

// init
function renderAll(){ renderTripsByDays(); renderMonths(); renderSections(); updateDashboard(); updateTotals(); tarLoad(); $('#refText').value=S('refs_sf')||''; }
function init(){ try{ renderAll(); }catch(e){ log(e.message); } }
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
