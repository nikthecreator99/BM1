<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>–ë–ª–æ–∫–Ω–æ—Ç –ú–∞—à–∏–Ω–∏—Å—Ç–∞ ¬∑ Mega v2025.28Z</title>
<meta name="theme-color" content="#d32f2f">
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
:root{
 --red:#d32f2f;--bg:#0f1420;--card:#161d2a;--line:#243246;--mut:#8aa0b6;--txt:#e9eef5;
 --ink:#0e1622;--ok:#1b2738;--green:#2e7d32;--warn:#ffb300;--bad:#d32f2f;
}
:root.light{
 --bg:#f6f8fb;--card:#ffffff;--line:#e5e9f0;--mut:#5e6b7a;--txt:#101625;--ink:#f0f2f7;--ok:#d32f2f;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--txt)}
header{position:sticky;top:0;background:var(--red);color:#fff;padding:10px 12px;display:flex;align-items:center;gap:10px;z-index:10;flex-wrap:wrap}
h1{margin:0;font-size:18px}
.badge{margin-left:auto;border:1px solid rgba(255,255,255,.5);border-radius:999px;padding:2px 8px;font-size:12px;white-space:nowrap}
.update-pill{display:none;background:#fff;color:#d32f2f;border:1px solid #fff;border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer}
.container{padding:12px 12px 84px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0}
.row{display:flex;gap:8px;align-items:center;margin:8px 0;flex-wrap:wrap}
.row label{width:44%;color:var(--mut);font-size:14px}
.row input,.row select,.row textarea{flex:1;background:var(--ink);border:1px solid var(--line);color:inherit;padding:10px;border-radius:10px;font-size:16px}
.row textarea{min-height:90px;resize:vertical}
.btn{background:var(--ok);color:#fff;border:1px solid var(--line);padding:10px 14px;border-radius:10px;font-size:15px;cursor:pointer}
.btn.primary{background:#fff;color:#d32f2f;border-color:#fff}
.small{font-size:12px;color:var(--mut)}
.view{display:none}.view.active{display:block}
.tabbar{position:fixed;left:0;right:0;bottom:0;height:70px;background:#121828;border-top:1px solid var(--line);display:flex}
:root.light .tabbar{background:#ffffff;border-color:#e5e9f0}
.tabbar button{flex:1;background:transparent;border:none;color:#8aa0b6;font-size:12px;padding:6px 0}
.tabbar button.active{color:#fff}:root.light .tabbar button.active{color:#d32f2f}
.tabbar .ico{display:block;font-size:18px;margin-bottom:4px}
.progress{height:10px;border:1px solid var(--line);border-radius:999px;overflow:hidden;background:#0f2035}
.progress>div{height:100%;background:#d32f2f;width:0%}
.badge-live{display:inline-block;background:rgba(46,125,50,.12);border:1px solid rgba(46,125,50,.6);color:#a5d6a7;padding:2px 6px;border-radius:999px;font-size:12px;margin-left:6px}
.badge-two{display:inline-block;background:rgba(211,47,47,.15);border:1px solid rgba(211,47,47,.6);color:#ff8a80;padding:2px 6px;border-radius:999px;font-size:12px;margin-left:6px}
.livebar{display:none;position:sticky;top:46px;z-index:9;background:#10361c;color:#bce0c2;border:1px solid rgba(46,125,50,.4);border-left:none;border-right:none;padding:8px 12px}
:root.light .livebar{background:#e6f4ea;color:#1b5e20}
.trip-card{border:1px solid var(--line);border-radius:12px;margin:8px 0;overflow:hidden}
.trip-head{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:rgba(255,255,255,0.03);cursor:pointer}
.trip-body{display:none;padding:10px 12px;border-top:1px solid var(--line)}
.actions{display:flex;gap:6px}
.type-chip{background:#0f2035;border:1px solid var(--line);padding:6px 10px;border-radius:999px;cursor:pointer;font-size:13px}
.type-chip.active{background:#d32f2f;color:#fff;border-color:#d32f2f}
.hr{height:1px;background:#233246;margin:8px 0}
.net-pill{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.5);padding:4px 8px;border-radius:999px;font-size:12px}
.net-pill.off{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.3);color:#ffe082}
.net-pill.on{background:rgba(255,255,255,.2);border-color:rgba(255,255,255,.7);color:#c8e6c9}
.kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px}
.badge-ctx{position:absolute;background:#161d2a;border:1px solid var(--line);border-radius:10px;padding:8px;display:none;z-index:30}
.badge-ctx button{display:block;width:180px;text-align:left;margin:4px 0}
.swipe{touch-action:pan-y}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cal-cell{border:1px solid var(--line);border-radius:8px;padding:6px;min-height:64px}
.cal-date{font-size:12px;color:var(--mut)}
.pin-locked{filter:blur(10px);pointer-events:none}
.theme-toggle{background:#fff;color:#d32f2f;border:1px solid #fff;border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer}
</style>
</head>
<body>
<header>
  <h1>–ë–ª–æ–∫–Ω–æ—Ç –ú–∞—à–∏–Ω–∏—Å—Ç–∞</h1>
  <span id="netStatus" class="net-pill off">–û—Ñ—Ñ–ª–∞–π–Ω</span>
  <button id="themeBtn" class="theme-toggle" onclick="toggleTheme()">–¢–µ–º–∞</button>
  <div class="badge">Mega v2025.28Z</div>
  <button id="appRefresh" class="update-pill" onclick="appUpdate()">–û–±–Ω–æ–≤–∏—Ç—å</button>
</header>
<div id="liveBar" class="livebar" onclick="jumpToLive()">–í –ø—É—Ç–∏ ¬∑ <b id="liveTimer">‚Äî</b> ¬∑ —Ç–∞–ø–Ω–∏, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å</div>

<main class="container">
  <!-- –ì–ª–∞–≤–Ω–∞—è -->
  <section id="v-dashboard" class="view active">
    <div class="card">
      <div style="display:flex;justify-content:space-between"><b>–ú–µ—Å—è—á–Ω–∞—è –Ω–æ—Ä–º–∞</b><b id="mwNorm">‚Äî</b></div>
      <div class="progress" style="margin-top:6px"><div id="mwBar"></div></div>
      <div class="row"><label>–ù–æ—Ä–º–∞, —á/–º–µ—Å</label><input id="tar_norm" type="number" inputmode="decimal" placeholder="176" oninput="tarSave()"></div>
      <div class="row"><label>–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ</label><div id="mwWorked" class="small">‚Äî</div></div>
      <div class="row"><label>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</label><div id="mwPercent" class="small">‚Äî</div></div>
      <div class="row"><label>–û—Å—Ç–∞–ª–æ—Å—å/–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞</label><div id="mwRemain" class="small">‚Äî</div></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <b>–ü–æ–µ–∑–¥–∫–∏</b>
        <div>
          <button class="btn primary" onclick="addTripOpen()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn" onclick="exportTripsCsv()">CSV</button>
          <button class="btn" onclick="toggleCalendar()">–ö–∞–ª–µ–Ω–¥–∞—Ä—å/–°–ø–∏—Å–æ–∫</button>
        </div>
      </div>

      <!-- –§–æ—Ä–º–∞ –ø–æ–µ–∑–¥–∫–∏ -->
      <div id="tripForm" class="card" style="display:none;margin-top:10px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <b id="tripFormTitle">–ù–æ–≤–∞—è –ø–æ–µ–∑–¥–∫–∞</b>
          <div>
            <button id="tripEditBtn" class="btn" style="display:none" onclick="tripToggleEdit(true)">‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button id="tripViewBtn" class="btn" style="display:none" onclick="tripToggleEdit(false)">üîí –ü—Ä–æ—Å–º–æ—Ç—Ä</button>
          </div>
        </div>

        <div class="row"><label>–î–∞—Ç–∞</label><input id="t_date" type="date"></div>
        <div class="row"><label>–ù–æ–º–µ—Ä –ø–æ–µ–∑–¥–∞</label><input id="t_trainNo" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 2105"></div>
        <div class="row" style="gap:8px">
          <label style="width:100%;color:#a9bacd">–í–∏–¥ –ø–æ–µ–∑–¥–∞</label>
          <div id="trainTypes" style="display:flex;flex-wrap:wrap;gap:8px">
            <span class="type-chip" data-type="–≥—Ä—É–∑–æ–≤–æ–π" onclick="setTrainType(this)">–ì—Ä—É–∑–æ–≤–æ–π</span>
            <span class="type-chip" data-type="–ø–æ—Ä–æ–∂–Ω–∏–π" onclick="setTrainType(this)">–ü–æ—Ä–æ–∂–Ω–∏–π</span>
            <span class="type-chip" data-type="–¥–ª–∏–Ω–Ω–æ—Å–æ—Å—Ç–∞–≤–Ω—ã–π" onclick="setTrainType(this)">–î–ª–∏–Ω–Ω–æ—Å–æ—Å—Ç–∞–≤–Ω—ã–π</span>
            <span class="type-chip" data-type="—Ä–µ–∑–µ—Ä–≤" onclick="setTrainType(this)">–†–µ–∑–µ—Ä–≤</span>
            <span class="type-chip" data-type="—Å–ø–ª–æ—Ç–∫–∞" onclick="setTrainType(this)">–°–ø–ª–æ—Ç–∫–∞</span>
            <span class="type-chip" data-type="—Å–¥–≤–æ–µ–Ω–Ω—ã–π" onclick="setTrainType(this)">–°–¥–≤–æ–µ–Ω–Ω—ã–π</span>
          </div>
        </div>

        <div class="row"><label>–ú–∞—Ä—à—Ä—É—Ç 1 (—Ç—É–¥–∞)</label>
          <input id="t_route1" list="routeList" placeholder="–Ω–∞–ø—Ä.: –ú–∞–ª–æ—à—É–π–∫–∞ ‚Äî –û–±–æ–∑–µ—Ä—Å–∫–∞—è">
          <datalist id="routeList"></datalist>
        </div>
        <div class="row"><label>–ú–∞—Ä—à—Ä—É—Ç 2 (–æ–±—Ä–∞—Ç–Ω–æ)</label>
          <input id="t_route2" list="routeList" placeholder="–Ω–∞–ø—Ä.: –û–±–æ–∑–µ—Ä—Å–∫–∞—è ‚Äî –ú–∞–ª–æ—à—É–π–∫–∞" onfocus="suggestReverseRoute()">
        </div>

        <div class="row"><label>–Ø–≤–∫–∞ (—Ç—É–¥–∞)</label><input id="t_start1" type="time" oninput="recalcDuration()"></div>
        <div class="row"><label>–ö–æ–Ω–µ—Ü —Ä–∞–±–æ—Ç—ã (—Ç—É–¥–∞)</label><input id="t_end1" type="time" oninput="recalcDuration()"></div>

        <div class="row"><label>–î–∞—Ç–∞ (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_date2" type="date" oninput="recalcDuration()"></div>
        <div class="row"><label>–Ø–≤–∫–∞ (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_start2" type="time" oninput="recalcDuration()"></div>
        <div class="row"><label>–ö–æ–Ω–µ—Ü —Ä–∞–±–æ—Ç—ã (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_end2" type="time" oninput="recalcDuration()"></div>

        <div class="row"><label>–û—Ç–¥—ã—Ö (–∞–≤—Ç–æ)</label><input id="t_rest_view" type="text" readonly></div>
        <div class="row"><label>–ù–æ—á–Ω—ã–µ (–∞–≤—Ç–æ)</label><input id="t_night_view" type="text" readonly></div>
        <div class="row"><label>–ß–∞—Å—ã (–∏—Ç–æ–≥)</label><input id="t_hours_view" type="text" readonly></div>

        <div class="row"><label>–¢–æ–ø–ª–∏–≤–æ/—ç–Ω–µ—Ä–≥–∏—è (–ª –∏–ª–∏ –∫–í—Ç‚ãÖ—á)</label><input id="t_fuel" type="number" inputmode="decimal" placeholder="0"></div>

        <div class="row"><label>–ó–∞–º–µ—Ç–∫–∏</label><textarea id="t_notes" placeholder="–ü—Ä–æ—Å—Ç–æ–∏, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏‚Ä¶"></textarea></div>

        <div class="row" style="gap:6px">
          <button class="btn" onclick="bumpTime('t_start1',10)">+10 –º–∏–Ω —è–≤–∫–∞(—Ç—É–¥–∞)</button>
          <button class="btn" onclick="bumpTime('t_end1',10)">+10 –º–∏–Ω –∫–æ–Ω–µ—Ü(—Ç—É–¥–∞)</button>
          <button class="btn" onclick="bumpTime('t_start2',10)">+10 –º–∏–Ω —è–≤–∫–∞(–æ–±—Ä.)</button>
          <button class="btn" onclick="bumpTime('t_end2',10)">+10 –º–∏–Ω –∫–æ–Ω–µ—Ü(–æ–±—Ä.)</button>
        </div>

        <div class="row" id="tripButtonsNew">
          <button class="btn primary" onclick="tripSaveNew()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn" onclick="tripCancel()">–û—Ç–º–µ–Ω–∞</button>
        </div>

        <div class="row" id="tripButtonsEdit" style="display:none">
          <button class="btn primary" onclick="tripSaveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
          <button class="btn" onclick="tripCancel()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>

        <div class="small">–ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫.</div>
      </div>

      <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è -->
      <div id="listMode">
        <div id="tripsList"></div>
      </div>
      <div id="calMode" style="display:none">
        <div class="row"><label>–ú–µ—Å—è—Ü</label><input id="calMonth" type="month" onchange="renderCalendar()"></div>
        <div id="calendar" class="calendar"></div>
      </div>
    </div>

    <div class="card">
      <b>–¢–∞–π–º–µ—Ä –¥–æ —è–≤–∫–∏</b>
      <div class="row">
        <label>–î–∞—Ç–∞/–≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–π —è–≤–∫–∏</label>
        <input id="nextDutyDate" type="date" style="max-width:160px">
        <input id="nextDutyTime" type="time" style="max-width:120px">
      </div>
      <div class="row">
        <button class="btn primary" onclick="startDutyCountdown()">–°—Ç–∞—Ä—Ç –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á—ë—Ç–∞</button>
        <div id="dutyCountdown" class="small">‚Äî</div>
      </div>
    </div>
  </section>

  <!-- –ü—Ä–æ—Ñ–∏–ª—å / —Ñ–∞–π–ª—ã -->
  <section id="v-profile" class="view">
    <div class="card">
      <b>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</b>
      <div class="row"><label>–ò–º—è</label><input id="pf_first" placeholder="–ò–≤–∞–Ω"></div>
      <div class="row"><label>–§–∞–º–∏–ª–∏—è</label><input id="pf_last" placeholder="–ò–≤–∞–Ω–æ–≤"></div>
      <div class="row"><label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label><input id="pf_role" placeholder="–ú–∞—à–∏–Ω–∏—Å—Ç"></div>
      <div class="row"><label>–§–æ—Ç–æ</label><input id="pf_photo" type="file" accept="image/*" onchange="profilePhotoChanged(event)"></div>
      <div class="row" style="gap:8px">
        <button class="btn primary" onclick="profileSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>

    <div class="card">
      <b>–§–∞–π–ª—ã –∏ –∑–∞–º–µ—Ç–∫–∏</b>
      <div class="row"><label>–ü–æ–∏—Å–∫</label><input id="fileSearch" placeholder="–ò–º—è/–∑–∞–º–µ—Ç–∫–∏" oninput="renderFilesList()"></div>
      <div class="row"><label>–î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª—ã</label><input id="fileInput" type="file" multiple onchange="addFiles(event)"></div>
      <div class="row"><label>–ó–∞–º–µ—Ç–∫–∏ –∫ —Ñ–∞–π–ª—É</label><input id="fileNote" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∑–∞–º–µ—Ç–∫–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞"></div>
      <div id="filesList"></div>
    </div>
  </section>

  <!-- –¢–∞—Ä–∏—Ñ / –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <section id="v-settings" class="view">
    <div class="card">
      <b>–¢–∞—Ä–∏—Ñ</b>
      <div class="row"><label>‚ÇΩ/—á–∞—Å (—Å—Ç–∞–≤–∫–∞)</label><input id="tar_base" type="number" inputmode="decimal" placeholder="358.46"></div>
      <div class="row"><label>–†–∞–π–æ–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç, %</label><input id="tar_rc" type="number" inputmode="decimal" placeholder="20"></div>
      <div class="row"><label>–°–µ–≤–µ—Ä–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç, %</label><input id="tar_north" type="number" inputmode="decimal" placeholder="50"></div>
      <div class="row"><label>–ù–∞–¥–±–∞–≤–∫–∏, % (–∫–ª–∞—Å—Å+–∑–æ–Ω–∞+–ë–ê–ú)</label><input id="tar_other" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><label>–ö–æ–º. —Ä–∞—Å—Ö–æ–¥—ã, ‚ÇΩ/–ø–æ–µ–∑–¥–∫–∞</label><input id="tar_fee" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><button class="btn primary" onclick="tarSave(true)">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –Ω–∞ –ì–ª–∞–≤–Ω—É—é</button></div>
    </div>

    <div class="card">
      <b>–¢–µ–º–∞</b>
      <div class="row">
        <label>–†–µ–∂–∏–º</label>
        <select id="themeSelect" onchange="applyThemeFromSelect()">
          <option value="auto">–ê–≤—Ç–æ (—Å–∏—Å—Ç–µ–º–∞)</option>
          <option value="dark">–¢—ë–º–Ω–∞—è</option>
          <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
        </select>
      </div>
    </div>

    <div class="card">
      <b>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</b>
      <div class="row"><label>PIN –¥–ª—è ¬´–§–∞–π–ª–æ–≤/–ó–∞—Ä–ø–ª–∞—Ç—ã¬ª</label><input id="pinCode" type="password" placeholder="4‚Äì8 —Ü–∏—Ñ—Ä"></div>
      <div class="row"><button class="btn" onclick="savePin()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å PIN</button></div>
      <div class="small">–ü—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Ä–∞–∑–¥–µ–ª –º–æ–∂–µ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å—Å—è –ø–∏–Ω-–∫–æ–¥.</div>
    </div>

    <div class="card">
      <b>–ë—ç–∫–∞–ø</b>
      <div class="row"><button class="btn" onclick="backup()">–°–∫–∞—á–∞—Ç—å JSON</button></div>
      <div class="row"><input id="restoreFile" type="file" accept="application/json" onchange="restoreFileChanged(event)"></div>
    </div>

    <div class="small" style="opacity:.8;text-align:center;margin-top:8px">
      by <a href="https://t.me/nikitagrigorev99" target="_blank" style="color:#e9eef5;text-decoration:underline">Nikita Grigorev</a>
    </div>
  </section>
</main>

<nav class="tabbar">
  <button class="active" data-tab="dashboard" onclick="nav(this)"><span class="ico">üè†</span>–ì–ª–∞–≤–Ω–∞—è</button>
  <button data-tab="profile" onclick="openProtected('profile', this)"><span class="ico">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</button>
  <button data-tab="settings" onclick="nav(this)"><span class="ico">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</nav>

<!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é -->
<div id="ctxMenu" class="badge-ctx"></div>

<script>
/* ====== helpers ====== */
function $(s){return document.querySelector(s)}
function $all(s){return Array.from(document.querySelectorAll(s))}
function S(k,v){if(arguments.length===2){localStorage.setItem(k,JSON.stringify(v));return v}try{let r=localStorage.getItem(k);return r?JSON.parse(r):null}catch(e){return null}}
function toNum(v){let n=Number(v);return isNaN(n)?0:n}
const RUR=new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:0})
function plural(n, one, few, many){ n=Math.abs(n)%100; let n1=n%10; if(n>10&&n<20) return many; if(n1>1&&n1<5) return few; if(n1==1) return one; return many; }
function fmtHM(min){ if(min==null) return '‚Äî'; const h=Math.floor(min/60), m=min%60; let t=''; if(h) t += h+' '+plural(h,'—á–∞—Å','—á–∞—Å–∞','—á–∞—Å–æ–≤'); if(m) t += (t?' ':'')+m+' '+plural(m,'–º–∏–Ω—É—Ç–∞','–º–∏–Ω—É—Ç—ã','–º–∏–Ω—É—Ç'); return t||'0 –º–∏–Ω—É—Ç'; }
function toMin(hhmm){if(!hhmm)return null;let [H,M]=hhmm.split(':').map(Number);if(isNaN(H)||isNaN(M))return null;return H*60+M}
function diffMinutes(a,b){let x=toMin(a),y=toMin(b);if(x==null||y==null)return null;let d=y-x; if(d<0) d+=24*60; return d}
function nowISO(){ const d=new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0'); const hh=String(d.getHours()).padStart(2,'0'); const mi=String(d.getMinutes()).padStart(2,'0'); return `${y}-${m}-${da} ${hh}:${mi}`; }
function combineISO(dateStr,timeStr){ if(!dateStr||!timeStr) return ''; return `${dateStr} ${timeStr}`; }
function splitISO(iso){ if(!iso) return {d:'',t:''}; const [d,t]=iso.split(' '); return {d:d||'', t:(t||'').slice(0,5)}; }

/* ====== theme ====== */
function applyTheme(mode){ document.documentElement.classList.toggle('light', mode==='light'); S('themeMode',mode); }
function applyThemeFromSelect(){ const v=$('#themeSelect').value; if(v==='auto'){ const prefers=matchMedia('(prefers-color-scheme: light)').matches?'light':'dark'; applyTheme(prefers); } else applyTheme(v); }
function toggleTheme(){ const cur=S('themeMode')||'dark'; const next = (cur==='dark')?'light':'dark'; applyTheme(next); $('#themeSelect').value = next==='dark'?'dark':'light'; }

/* ====== network pill ====== */
function updateNet(){ const el=$('#netStatus'); if(!el) return; const on=navigator.onLine; el.textContent=on?'–û–Ω–ª–∞–π–Ω':'–û—Ñ—Ñ–ª–∞–π–Ω'; el.classList.toggle('on',on); el.classList.toggle('off',!on); }
addEventListener('online',updateNet); addEventListener('offline',updateNet);

/* ====== schema & migration ====== */
const SCHEMA=3; // 1: –±–∞–∑–æ–≤–∞—è, 2: –¥–æ–±–∞–≤–ª–µ–Ω—ã ISO –ø–æ–ª—è, 3: fuel & trainType
function migrate(){
  let sv=S('schemaVersion')||0;
  if(sv<1){ S('trips', S('trips')||[] ); sv=1; }
  if(sv<2){
    let arr=S('trips')||[];
    arr=arr.map(t=>{
      if(!t.start1_iso && t.date && t.start1){ t.start1_iso = combineISO(t.date,t.start1); }
      if(!t.end1_iso && t.date && t.end1){ t.end1_iso = combineISO(t.date,t.end1); }
      const d2 = t.date2 || t.date;
      if(!t.start2_iso && d2 && t.start2){ t.start2_iso = combineISO(d2,t.start2); }
      if(!t.end2_iso && d2 && t.end2){ t.end2_iso = combineISO(d2,t.end2); }
      return t;
    });
    S('trips',arr); sv=2;
  }
  if(sv<3){
    let arr=S('trips')||[];
    arr=arr.map(t=>({fuel:(t.fuel||0), ...t}));
    S('trips',arr); sv=3;
  }
  S('schemaVersion',SCHEMA);
}

/* ====== tariffs ====== */
function getTar(){return S('tar')||{base:358.46,norm:176,rc:20,north:50,other:0,fee:0}}
function tarSave(goHome){
  let t=getTar();
  t.base=toNum($('#tar_base').value)||t.base;
  t.norm=toNum($('#tar_norm').value)||t.norm;
  t.rc=toNum($('#tar_rc').value)||0;
  t.north=toNum($('#tar_north').value)||0;
  t.other=toNum($('#tar_other').value)||0;
  t.fee=toNum($('#tar_fee').value)||0;
  S('tar',t); updateDash(); renderTrips(); if(goHome) switchTab('dashboard');
}
function loadTar(){
  let t=getTar();
  $('#tar_base').value=t.base; $('#tar_norm').value=t.norm; $('#tar_rc').value=t.rc;
  $('#tar_north').value=t.north; $('#tar_other').value=t.other; $('#tar_fee').value=t.fee;
}
function tripMoney(hours){
  let t=getTar();
  let pct=(t.rc+t.north+t.other)/100;
  let gross=hours*t.base*(1+pct);
  let net=gross-(t.fee||0);
  return Math.max(0, Math.round(net));
}

/* ====== storage ====== */
function getTrips(){return S('trips')||[]} function setTrips(a){S('trips',a)}

/* ====== navigation & protected ====== */
function switchTab(name){ $all('.tabbar button').forEach(b=>b.classList.remove('active')); $all('.view').forEach(v=>v.classList.remove('active')); $(`.tabbar button[data-tab="${name}"]`).classList.add('active'); $(`#v-${name}`).classList.add('active'); }
function nav(btn){ $all('.tabbar button').forEach(x=>x.classList.remove('active')); btn.classList.add('active'); const v=btn.getAttribute('data-tab'); $all('.view').forEach(x=>x.classList.remove('active')); $('#v-'+v).classList.add('active'); }
function savePin(){ const v=$('#pinCode').value.trim(); if(v && !/^\d{4,8}$/.test(v)){ alert('PIN: 4‚Äì8 —Ü–∏—Ñ—Ä'); return;} S('pin',v||''); alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); }
function openProtected(tab, btn){
  const pin=S('pin')||''; if(!pin){ nav(btn); return; }
  const val=prompt('–í–≤–µ–¥–∏—Ç–µ PIN'); if(val===pin){ nav(btn); } else if(val!==null){ alert('–ù–µ–≤–µ—Ä–Ω—ã–π PIN'); }
}

/* ====== profile/files simple ====== */
function profileSave(){
  S('profile',{first:$('#pf_first').value||'', last:$('#pf_last').value||'', role:$('#pf_role').value||'', photo:S('pf_photo')||''});
  alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
}
function profilePhotoChanged(e){
  const f=e.target.files[0]; if(!f) return;
  const rd=new FileReader(); rd.onload=()=>S('pf_photo',rd.result); rd.readAsDataURL(f);
}
function getFiles(){return S('files')||[]} function setFiles(a){S('files',a)}
function addFiles(e){
  const files = Array.from(e.target.files||[]); if(!files.length) return;
  const note = $('#fileNote').value||'';
  const list = getFiles();
  let pending = files.length;
  files.forEach(f=>{
    const rd=new FileReader();
    rd.onload=()=>{ list.push({id:Date.now()+Math.random(), name:f.name, note, data:rd.result, type:f.type}); pending--; if(!pending){ setFiles(list); $('#fileInput').value=''; renderFilesList(); } };
    rd.readAsDataURL(f);
  });
}
function renderFilesList(){
  const q=($('#fileSearch').value||'').toLowerCase();
  const list=getFiles().filter(f=>(f.name.toLowerCase().includes(q) || (f.note||'').toLowerCase().includes(q)));
  const box=$('#filesList'); box.innerHTML='';
  if(!list.length){ box.innerHTML='<div class="small">–ù–µ—Ç —Ñ–∞–π–ª–æ–≤</div>'; return; }
  list.forEach(f=>{
    const row=document.createElement('div'); row.className='row'; row.innerHTML=`<div style="flex:1"><b>${f.name}</b><div class="small">${f.note||''}</div></div>`;
    const a=document.createElement('a'); a.href=f.data; a.download=f.name; a.className='btn'; a.textContent='–°–∫–∞—á–∞—Ç—å';
    const del=document.createElement('button'); del.className='btn'; del.textContent='üóë'; del.onclick=()=>{ setFiles(getFiles().filter(x=>x.id!==f.id)); renderFilesList(); };
    row.appendChild(a); row.appendChild(del); box.appendChild(row);
  });
}

/* ====== live & timers ====== */
function shouldLive(t){
  // leg1 live: –µ—Å—Ç—å start1, –Ω–µ—Ç end1; leg2 live: –µ—Å—Ç—å start2, –Ω–µ—Ç end2
  if(t.start1_iso && !t.end1_iso) return {leg:1, since:t.start1_iso};
  if(t.start2_iso && !t.end2_iso) return {leg:2, since:t.start2_iso};
  return null;
}
function msSinceISO(iso){
  if(!iso) return 0;
  const [d,t]=iso.split(' ');
  const [Y,M,D]=d.split('-').map(Number);
  const [h,m]=t.split(':').map(Number);
  const ms = Date.UTC(Y,M-1,D,h,m);
  return Date.now() - ms;
}
function liveTick(){
  const trips=getTrips();
  const live=trips.find(shouldLive);
  const bar=$('#liveBar'); const timer=$('#liveTimer');
  if(!live){ bar.style.display='none'; return; }
  bar.style.display='block';
  const info=shouldLive(live)||{};
  const ms = msSinceISO(info.since);
  const min=Math.floor(ms/60000), h=Math.floor(min/60), m=min%60;
  timer.textContent = `${h}—á ${String(m).padStart(2,'0')}–º`;
  bar.dataset.liveId = live.id;
}
function jumpToLive(){
  const id = Number($('#liveBar').dataset.liveId||0);
  if(!id) return;
  tripOpen(id); switchTab('dashboard');
}

/* ====== calendar ====== */
function toggleCalendar(){
  const l=$('#listMode'), c=$('#calMode');
  const onCal = c.style.display!=='none';
  if(onCal){ c.style.display='none'; l.style.display=''; }
  else{ c.style.display=''; l.style.display='none'; renderCalendar(); }
}
function renderCalendar(){
  const m = $('#calMonth').value || new Date().toISOString().slice(0,7);
  $('#calMonth').value = m;
  const [Y,Mo]=m.split('-').map(Number);
  const first=new Date(Date.UTC(Y,Mo-1,1));
  const startDay=(first.getUTCDay()||7)-1; // Mon=0
  const days = new Date(Date.UTC(Y,Mo,0)).getUTCDate();
  const box=$('#calendar'); box.innerHTML='';
  for(let i=0;i<startDay;i++){ box.appendChild(makeCalCell('')); }
  for(let d=1; d<=days; d++){ const ds=`${m}-${String(d).padStart(2,'0')}`; box.appendChild(makeCalCell(ds)); }
}
function makeCalCell(dateStr){
  const div=document.createElement('div'); div.className='cal-cell';
  const head=document.createElement('div'); head.className='cal-date'; head.textContent = dateStr?dateStr.slice(-2):'';
  div.appendChild(head);
  if(dateStr){
    getTrips().filter(t=>t.date===dateStr).forEach(t=>{
      const a=document.createElement('div'); a.className='small'; a.textContent=(t.route||t.route1||'‚Äî')+' ‚Ä¢ '+(t.hours?`${t.hours.toFixed? t.hours.toFixed(1):t.hours}—á`:'‚Äî');
      a.onclick=()=>{ tripOpen(t.id); switchTab('dashboard'); };
      div.appendChild(a);
    });
  }
  return div;
}

/* ====== night & rest ====== */
function overlap(a1,a2,b1,b2){ const s=Math.max(a1,b1), e=Math.min(a2,b2); return Math.max(0, e-s); }
function epochFromISO(iso){ if(!iso) return null; const [d,t]=iso.split(' '); const [Y,M,D]=d.split('-').map(Number); const [h,m]=t.split(':').map(Number); return Date.UTC(Y,M-1,D,h||0,m||0); }
function legNightMinutesISO(startISO,endISO){
  if(!startISO||!endISO) return 0;
  let start=epochFromISO(startISO), end=epochFromISO(endISO);
  if(end<start) end += 24*60*60000; // —á–µ—Ä–µ–∑ –ø–æ–ª–Ω–æ—á—å
  const base = epochFromISO(startISO.split(' ')[0]+' 00:00');
  let sum=0;
  const blocks = [
    [base + 22*60*60000, base + 24*60*60000],
    [base + 24*60*60000, base + 30*60*60000],
    [base + 46*60*60000, base + 48*60*60000]
  ];
  for(const [b1,b2] of blocks) sum += overlap(start,end,b1,b2);
  return Math.round(sum/60000);
}
function count0005Windows(startISO,endISO){
  let s=epochFromISO(startISO), e=epochFromISO(endISO); if(!s||!e) return 0; if(e<s) e+=24*60*60000;
  const sd = new Date(s); sd.setUTCHours(0,0,0,0);
  const ed = new Date(e); ed.setUTCHours(0,0,0,0);
  let day = sd.getTime(), last = ed.getTime()+24*60*60000, n=0;
  while(day<=last){
    const wStart = day + 0; const wEnd = day + 5*60*60000;
    if(overlap(s,e,wStart,wEnd)>0) n++;
    day += 24*60*60000;
  }
  return n;
}

/* ====== form & draft ====== */
let currentTripId=null, currentTrainType='', draftTimer=null;
function setTrainType(el){ $all('#trainTypes .type-chip').forEach(x=>x.classList.remove('active')); if(el){ el.classList.add('active'); currentTrainType = el.dataset.type||''; } }
function suggestReverseRoute(){
  const r1=($('#t_route1').value||'').trim(); const r2=$('#t_route2').value.trim();
  if(!r1 || r2) return;
  const parts = r1.split('‚Äî').map(x=>x.trim()).filter(Boolean);
  if(parts.length===2){ $('#t_route2').value = `${parts[1]} ‚Äî ${parts[0]}`; }
}
function bumpTime(id,delta){
  const el=$('#'+id); const v=el.value; if(!v) return;
  let m=toMin(v)||0; m=(m+delta+24*60)%(24*60);
  const hh=String(Math.floor(m/60)).padStart(2,'0'), mi=String(m%60).padStart(2,'0'); el.value=`${hh}:${mi}`; recalcDuration();
}
function effectiveDate2(){
  const d2=$('#t_date2').value.trim(), d1=$('#t_date').value.trim(); if(d2) return d2;
  const st2=$('#t_start2').value, e1=$('#t_end1').value;
  if(toMin(st2)!=null && toMin(e1)!=null && toMin(st2)<toMin(e1)) return addDays(d1,1);
  return d1||new Date().toISOString().slice(0,10);
}
function addDays(ds,days){ const d=new Date(ds+'T00:00:00Z'); d.setUTCDate(d.getUTCDate()+days); return d.toISOString().slice(0,10); }
function recalcDuration(){
  const start1_iso = combineISO($('#t_date').value,$('#t_start1').value);
  const end1_iso   = combineISO($('#t_date').value,$('#t_end1').value);
  const d2 = effectiveDate2();
  const start2_iso = combineISO(d2,$('#t_start2').value);
  const end2_iso   = combineISO(d2,$('#t_end2').value);

  const l1 = diffMinutes($('#t_start1').value,$('#t_end1').value)||0;
  const rest = diffMinutes($('#t_end1').value,$('#t_start2').value)||0;
  const l2 = diffMinutes($('#t_start2').value,$('#t_end2').value)||0;
  const hours = l1+l2;

  $('#t_rest_view').value = fmtHM(rest);
  $('#t_hours_view').value = fmtHM(hours);

  const night = legNightMinutesISO(start1_iso,end1_iso) + legNightMinutesISO(start2_iso,end2_iso);
  $('#t_night_view').value = fmtHM(night);
}
function clearTripForm(){
  const today=new Date().toISOString().slice(0,10);
  $('#t_date').value=today; $('#t_route1').value=''; $('#t_route2').value='';
  $('#t_trainNo').value=''; currentTrainType=''; $all('#trainTypes .type-chip').forEach(x=>x.classList.remove('active'));
  $('#t_start1').value=''; $('#t_end1').value=''; $('#t_date2').value=''; $('#t_start2').value=''; $('#t_end2').value='';
  $('#t_rest_view').value='0 –º–∏–Ω—É—Ç'; $('#t_night_view').value='0 –º–∏–Ω—É—Ç'; $('#t_hours_view').value='0 –º–∏–Ω—É—Ç'; $('#t_notes').value=''; $('#t_fuel').value='';
}
function addTripOpen(){
  currentTripId=null; $('#tripFormTitle').textContent='–ù–æ–≤–∞—è –ø–æ–µ–∑–¥–∫–∞';
  $('#tripButtonsNew').style.display=''; $('#tripButtonsEdit').style.display='none'; $('#tripEditBtn').style.display='none'; $('#tripViewBtn').style.display='none';
  clearTripForm(); tripToggleEdit(true); openTripForm(true); startDraftAutosave();
}
function openTripForm(show){ $('#tripForm').style.display=show?'block':'none'; }
function tripToggleEdit(on){
  const ids=['t_date','t_date2','t_trainNo','t_route1','t_route2','t_start1','t_end1','t_start2','t_end2','t_notes','t_fuel'];
  ids.forEach(id=>{ const el=$('#'+id); if(!el) return; el.readOnly = !on; el.disabled = !on && el.tagName==='SELECT'; });
  $all('#trainTypes .type-chip').forEach(ch=>ch.style.pointerEvents = on?'auto':'none');
  $('#tripEditBtn').style.display = on?'none':''; $('#tripViewBtn').style.display = on?'':'none';
}
function startDraftAutosave(){
  if(draftTimer) clearInterval(draftTimer);
  draftTimer = setInterval(()=>{ const d=collectTripFromForm(); S('draft_trip',d); }, 10000);
}
function maybeRestoreDraft(){
  const d=S('draft_trip'); if(!d) return;
  if(confirm('–ù–∞–π–¥–µ–Ω —á–µ—Ä–Ω–æ–≤–∏–∫. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å?')){
    fillFormFromTrip(d); openTripForm(true); tripToggleEdit(true);
  } else { localStorage.removeItem('draft_trip'); }
}
function collectTripFromForm(){
  const date1=$('#t_date').value||new Date().toISOString().slice(0,10);
  const date2=effectiveDate2();
  const t={
    id: currentTripId || Date.now(),
    date: date1, date2: date2,
    route: ($('#t_route1').value||'').trim(),
    route1: ($('#t_route1').value||'').trim(),
    route2: ($('#t_route2').value||'').trim(),
    trainNo: ($('#t_trainNo').value||'').trim(),
    trainType: currentTrainType||'',
    start1_iso: combineISO(date1,$('#t_start1').value),
    end1_iso:   combineISO(date1,$('#t_end1').value),
    start2_iso: combineISO(date2,$('#t_start2').value),
    end2_iso:   combineISO(date2,$('#t_end2').value),
    rest: diffMinutes($('#t_end1').value,$('#t_start2').value)||0,
    hours: ((diffMinutes($('#t_start1').value,$('#t_end1').value)||0)+(diffMinutes($('#t_start2').value,$('#t_end2').value)||0))/60,
    night: legNightMinutesISO(combineISO(date1,$('#t_start1').value),combineISO(date1,$('#t_end1').value)) +
           legNightMinutesISO(combineISO(date2,$('#t_start2').value),combineISO(date2,$('#t_end2').value)),
    fuel: toNum($('#t_fuel').value)||0,
    notes: ($('#t_notes').value||'').trim()
  };
  return t;
}
function fillFormFromTrip(t){
  $('#t_date').value = t.date||new Date().toISOString().slice(0,10);
  $('#t_date2').value = t.date2||'';
  $('#t_trainNo').value = t.trainNo||'';
  currentTrainType = t.trainType||''; $all('#trainTypes .type-chip').forEach(ch=>{ ch.classList.toggle('active', ch.dataset.type===currentTrainType); });
  $('#t_route1').value = t.route1||t.route||''; $('#t_route2').value = t.route2||'';
  $('#t_start1').value = splitISO(t.start1_iso).t; $('#t_end1').value = splitISO(t.end1_iso).t;
  $('#t_start2').value = splitISO(t.start2_iso).t; $('#t_end2').value = splitISO(t.end2_iso).t;
  $('#t_rest_view').value = fmtHM(toNum(t.rest)); $('#t_night_view').value = fmtHM(toNum(t.night));
  $('#t_hours_view').value = fmtHM(Math.round(toNum(t.hours)*60)); $('#t_notes').value = t.notes||''; $('#t_fuel').value = t.fuel||'';
}
function tripSaveNew(){
  const t=collectTripFromForm();
  const arr=getTrips(); arr.push(t);
  arr.sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id));
  setTrips(arr); localStorage.removeItem('draft_trip');
  openTripForm(false); renderTrips(); updateDash();
}
function tripOpen(id){
  const t=getTrips().find(x=>x.id===id); if(!t) return;
  currentTripId=id; $('#tripFormTitle').textContent='–ü–æ–µ–∑–¥–∫–∞: '+(t.route||t.route1||'‚Äî');
  $('#tripButtonsNew').style.display='none'; $('#tripButtonsEdit').style.display=''; $('#tripEditBtn').style.display=''; $('#tripViewBtn').style.display='none';
  fillFormFromTrip(t); tripToggleEdit(false); openTripForm(true);
}
function tripSaveEdit(){
  if(currentTripId==null) return;
  let arr=getTrips(); const ix=arr.findIndex(x=>x.id===currentTripId); if(ix<0) return;
  arr[ix] = {...arr[ix], ...collectTripFromForm()}; arr.sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id));
  setTrips(arr); localStorage.removeItem('draft_trip');
  tripToggleEdit(false); openTripForm(false); renderTrips(); updateDash();
}
function tripDel(id){ if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–µ–∑–¥–∫—É?')) return; setTrips(getTrips().filter(x=>x.id!==id)); renderTrips(); updateDash(); }

/* ====== list/accordion + context + swipe ====== */
function makeTripCard(t){
  const money = t.hours? tripMoney(toNum(t.hours)) : 0;
  const twoN = count0005Windows(t.start1_iso||t.start2_iso, t.end2_iso||t.end1_iso)>=2;
  const live = !!shouldLive(t);
  const head = document.createElement('div'); head.className='trip-head swipe'; head.dataset.id=t.id;
  head.innerHTML = `<div><b>${t.date||'‚Äî'}</b> ‚Ä¢ ${t.route||t.route1||'‚Äî'} ${live?'<span class="badge-live">–≤ –ø—É—Ç–∏</span>':''} ${twoN?'<span class="badge-two">–¥–≤–µ –Ω–æ—á–∏</span>':''}<div class="small" style="opacity:.8">${t.trainNo?('‚Ññ'+t.trainNo+' ‚Ä¢ '):''}${t.trainType||''}</div></div><div>${t.hours? (toNum(t.hours).toFixed(1)+' —á'):'‚Äî'} ‚Ä¢ <b>${money? RUR.format(money):'‚Äî'}</b></div>`;
  const body = document.createElement('div'); body.className='trip-body';
  const rest = t.rest? ` ‚Ä¢ –æ—Ç–¥—ã—Ö ${fmtHM(toNum(t.rest))}`:''; const night = t.night? ` ‚Ä¢ –Ω–æ—á–Ω—ã–µ ${fmtHM(toNum(t.night))}`:'';
  body.innerHTML = `<div class="kv"><div>–¢—É–¥–∞</div><div>${splitISO(t.start1_iso).t||'‚Äî'} ‚Üí ${splitISO(t.end1_iso).t||'‚Äî'}</div><div>–û–±—Ä–∞—Ç–Ω–æ</div><div>${(t.date2?('['+t.date2+'] '):'')}${splitISO(t.start2_iso).t||'‚Äî'} ‚Üí ${splitISO(t.end2_iso).t||'‚Äî'}</div><div>–î–µ—Ç–∞–ª–∏</div><div>${t.route2?('–º–∞—Ä—à—Ä—É—Ç—ã: '+(t.route1||t.route)+' ‚Ä¢ '+t.route2):('–º–∞—Ä—à—Ä—É—Ç: '+(t.route1||t.route||'‚Äî'))}${rest}${night}${t.fuel?(' ‚Ä¢ —Ç–æ–ø–ª–∏–≤–æ '+t.fuel):''}${t.notes?(' ‚Ä¢ '+t.notes):''}</div></div><div class="hr"></div><div class="actions"><button class="btn" onclick="tripOpen(${t.id})">–û—Ç–∫—Ä—ã—Ç—å</button><button class="btn" onclick="duplicateTrip(${t.id})">–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button><button class="btn" onclick="exportOneCsv(${t.id})">CSV</button><button class="btn" onclick="tripDel(${t.id})">–£–¥–∞–ª–∏—Ç—å</button></div>`;
  const card = document.createElement('div'); card.className='trip-card'; card.appendChild(head); card.appendChild(body);
  head.addEventListener('click', (e)=>{ if(e.detail===1){ body.style.display = body.style.display==='block'?'none':'block'; }});
  // long press context
  let pressTimer=null;
  head.addEventListener('touchstart',e=>{ pressTimer=setTimeout(()=>{ showContext(head,t.id,e.touches[0].clientX,e.touches[0].clientY) },600) },{passive:true});
  head.addEventListener('touchend',()=>{ clearTimeout(pressTimer) });
  head.addEventListener('mousedown',e=>{ pressTimer=setTimeout(()=>{ showContext(head,t.id,e.clientX,e.clientY) },600) });
  head.addEventListener('mouseup',()=>clearTimeout(pressTimer));
  // swipe
  let sx=0, moved=false;
  head.addEventListener('touchstart',e=>{ sx=e.touches[0].clientX; moved=false },{passive:true});
  head.addEventListener('touchmove',e=>{ const dx=e.touches[0].clientX - sx; if(Math.abs(dx)>40){ moved=true; } },{passive:true});
  head.addEventListener('touchend',e=>{ if(!moved) return; const dx=e.changedTouches[0].clientX - sx; if(dx<-60){ if(confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–µ–∑–¥–∫—É?')){ tripDel(t.id);} } else if(dx>60){ tripOpen(t.id);} });
  return card;
}
function showContext(el,id,x,y){
  const m=$('#ctxMenu'); m.innerHTML='';
  const add=(txt,fn)=>{ const b=document.createElement('button'); b.className='btn'; b.textContent=txt; b.onclick=()=>{ m.style.display='none'; fn(); }; m.appendChild(b); };
  add('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',()=>tripOpen(id));
  add('–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å',()=>duplicateTrip(id));
  add('–£–¥–∞–ª–∏—Ç—å',()=>tripDel(id));
  add('CSV —ç—Ç–æ–π –ø–æ–µ–∑–¥–∫–∏',()=>exportOneCsv(id));
  m.style.left=x+'px'; m.style.top=y+'px'; m.style.display='block';
}
addEventListener('click',e=>{ if(e.target.closest('#ctxMenu')) return; $('#ctxMenu').style.display='none'; });

function renderTrips(){
  const box=$('#tripsList'); box.innerHTML='';
  const arr=getTrips().slice().sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id));
  if(!arr.length){ box.innerHTML='<div class="small">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫</div>'; return; }
  arr.forEach(t=> box.appendChild(makeTripCard(t)) );
  updateDash(); liveTick();
}

/* ====== duplicate & CSV ====== */
function duplicateTrip(id){
  const t=getTrips().find(x=>x.id===id); if(!t) return;
  const copy={...t, id:Date.now(), start1_iso:'',end1_iso:'',start2_iso:'',end2_iso:'', rest:0, hours:0, night:0};
  const arr=getTrips(); arr.push(copy); setTrips(arr); renderTrips(); alert('–î—É–±–ª–∏–∫–∞—Ç —Å–æ–∑–¥–∞–Ω');
}
function csvEscape(v){if(v==null)return'';let s=String(v).replace(/"/g,'""');return /[",\n;]/.test(s)?('"'+s+'"'):s}
function exportTripsCsv(){
  let arr=getTrips().slice().sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id));
  let head=['–î–∞—Ç–∞','‚Ññ','–í–∏–¥','–ú–∞—Ä—à—Ä—É—Ç1','–ú–∞—Ä—à—Ä—É—Ç2','–¢—É–¥–∞','–û–±—Ä–∞—Ç–Ω–æ','–û—Ç–¥—ã—Ö(–º–∏–Ω)','–ß–∞—Å—ã','–ù–æ—á–Ω—ã–µ(–º–∏–Ω)','–¢–æ–ø–ª–∏–≤–æ','–ó–∞–º–µ—Ç–∫–∏','–î–µ–Ω—å–≥–∏'];
  let rows=[head];
  arr.forEach(t=>{
    rows.push([t.date||'', t.trainNo||'', t.trainType||'', t.route1||t.route||'', t.route2||'', (splitISO(t.start1_iso).t||'')+'‚Äì'+(splitISO(t.end1_iso).t||''), (splitISO(t.start2_iso).t||'')+'‚Äì'+(splitISO(t.end2_iso).t||''), toNum(t.rest)||0, toNum(t.hours)||0, toNum(t.night)||0, toNum(t.fuel)||0, (t.notes||'').replace(/\n/g,' '), tripMoney(toNum(t.hours)) ]);
  });
  let csv=rows.map(r=>r.map(csvEscape).join(';')).join('\n');
  let blob=new Blob([csv],{type:'text/csv;charset=utf-8'});let url=URL.createObjectURL(blob);
  let a=document.createElement('a');a.href=url;a.download='trips.csv';a.click();setTimeout(()=>URL.revokeObjectURL(url),500);
}
function exportOneCsv(id){
  const t=getTrips().find(x=>x.id===id); if(!t) return;
  const rows=[['–î–∞—Ç–∞','‚Ññ','–í–∏–¥','–ú–∞—Ä—à—Ä—É—Ç1','–ú–∞—Ä—à—Ä—É—Ç2','–¢—É–¥–∞','–û–±—Ä–∞—Ç–Ω–æ','–û—Ç–¥—ã—Ö(–º–∏–Ω)','–ß–∞—Å—ã','–ù–æ—á–Ω—ã–µ(–º–∏–Ω)','–¢–æ–ø–ª–∏–≤–æ','–ó–∞–º–µ—Ç–∫–∏','–î–µ–Ω—å–≥–∏'],
    [t.date||'', t.trainNo||'', t.trainType||'', t.route1||t.route||'', t.route2||'', (splitISO(t.start1_iso).t||'')+'‚Äì'+(splitISO(t.end1_iso).t||''), (splitISO(t.start2_iso).t||'')+'‚Äì'+(splitISO(t.end2_iso).t||''), toNum(t.rest)||0, toNum(t.hours)||0, toNum(t.night)||0, toNum(t.fuel)||0, (t.notes||'').replace(/\n/g,' '), tripMoney(toNum(t.hours)) ]];
  const csv=rows.map(r=>r.map(csvEscape).join(';')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`trip-${t.date||t.id}.csv`;a.click();setTimeout(()=>URL.revokeObjectURL(url),500);
}

/* ====== dashboard ====== */
function updateDash(){
  const trips=getTrips();
  const mins=Math.round(trips.reduce((a,x)=>a+toNum(x.hours),0)*60);
  const night=trips.reduce((a,x)=>a+toNum(x.night),0);
  const norm = getTar().norm*60;
  const pct = norm?Math.round(mins/norm*100):0; const rem=norm-mins;
  $('#mwNorm').textContent=getTar().norm+' —á';
  $('#mwWorked').textContent=fmtHM(mins)+' (–Ω–æ—á–Ω—ã–µ: '+fmtHM(night)+')';
  $('#mwPercent').textContent=pct+'%';
  $('#mwRemain').textContent=rem>=0?('–û—Å—Ç–∞–ª–æ—Å—å: '+fmtHM(rem)):('–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞: '+fmtHM(-rem));
  $('#mwBar').style.width=Math.min(100,pct)+'%';
}

/* ====== countdown to duty + notification ====== */
let dutyTimer=null;
function startDutyCountdown(){
  const d=$('#nextDutyDate').value, t=$('#nextDutyTime').value; if(!d||!t){ alert('–ó–∞–ø–æ–ª–Ω–∏ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è'); return; }
  const iso=combineISO(d,t); S('nextDuty',iso);
  notify('–û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á—ë—Ç', '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ —è–≤–∫–µ –≤–∫–ª—é—á–µ–Ω–æ');
  if(dutyTimer) clearInterval(dutyTimer);
  dutyTimer = setInterval(()=>renderDutyCountdown(),1000);
  renderDutyCountdown();
}
function renderDutyCountdown(){
  const iso=S('nextDuty'); if(!iso){ $('#dutyCountdown').textContent='‚Äî'; return; }
  const diff = epochFromISO(iso) - Date.now();
  if(diff<=0){ $('#dutyCountdown').textContent='–ü–æ—Ä–∞ —è–≤–ª—è—Ç—å—Å—è!'; tryNotifyOnce(); clearInterval(dutyTimer); return; }
  const s=Math.floor(diff/1000), h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sc=s%60;
  $('#dutyCountdown').textContent=`${h}—á ${String(m).padStart(2,'0')}–º ${String(sc).padStart(2,'0')}—Å`;
}
let firedOnce=false;
function notify(title,body){ try{ if(Notification && Notification.permission==='granted'){ new Notification(title,{body}); } else if(Notification && Notification.permission!=='denied'){ Notification.requestPermission().then(p=>{ if(p==='granted') new Notification(title,{body}); }); } }catch(e){} }
function tryNotifyOnce(){ if(firedOnce) return; firedOnce=true; notify('–Ø–≤–∫–∞','–°–µ–π—á–∞—Å –≤—Ä–µ–º—è —è–≤–∫–∏'); }

/* ====== update button for SW ====== */
(function(){
  const usp=new URLSearchParams(location.search);
  if(usp.get('no-sw')==='1'){ if('serviceWorker' in navigator){ navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister())); } if(window.caches){ caches.keys().then(ks=>ks.forEach(k=>caches.delete(k))); } return; }
  window.appUpdate=async function(){
    try{
      if(!('serviceWorker' in navigator)) { location.reload(); return; }
      const reg = await navigator.serviceWorker.getRegistration(); if(!reg){ location.reload(); return; }
      if(reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'}); else await reg.update();
      let reloaded=false;
      navigator.serviceWorker.addEventListener('controllerchange', ()=>{ if(!reloaded){reloaded=true; location.replace(location.pathname+'?cb='+Date.now());}});
      setTimeout(()=>{ if(!reloaded) location.replace(location.pathname+'?cb='+Date.now()); }, 1000);
    }catch(e){ location.reload(); }
  };
  addEventListener('load', function(){
    if(!('serviceWorker' in navigator)) return;
    navigator.serviceWorker.register('sw.js').then(reg=>{
      const btn=$('#appRefresh');
      const show=()=>{ if(btn) btn.style.display=''; };
      if(reg.waiting) show();
      reg.addEventListener('updatefound', ()=>{ const nw=reg.installing; if(!nw) return; nw.addEventListener('statechange', ()=>{ if(nw.state==='installed' && navigator.serviceWorker.controller) show(); }); });
      navigator.serviceWorker.addEventListener('controllerchange', ()=>{ if(btn) btn.style.display='none'; });
    }).catch(()=>{});
  });
})();

/* ====== init ====== */
function renderTripsAndCalendar(){ renderTrips(); renderCalendar(); }
function switchTab(name){ $all('.tabbar button').forEach(b=>b.classList.remove('active')); $all('.view').forEach(v=>v.classList.remove('active')); $(`.tabbar button[data-tab="${name}"]`).classList.add('active'); $(`#v-${name}`).classList.add('active'); }
function init(){
  migrate(); loadTar(); updateDash(); updateNet();
  // theme
  const savedTheme=S('themeMode')||'dark'; applyTheme(savedTheme); $('#themeSelect').value = (savedTheme==='light')?'light':(savedTheme==='dark'?'dark':'auto');
  // default calendar month
  $('#calMonth').value = new Date().toISOString().slice(0,7);
  renderTripsAndCalendar(); setInterval(liveTick, 30000); liveTick();
  maybeRestoreDraft(); renderFilesList(); renderDutyCountdown(); if(S('nextDuty')){ dutyTimer=setInterval(renderDutyCountdown,1000); }
}
init();
</script>
</body>
</html>
