<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>–ë–ª–æ–∫–Ω–æ—Ç –ú–∞—à–∏–Ω–∏—Å—Ç–∞ ¬∑ Lite v2025.28Z2-PWA</title>
<meta name="theme-color" content="#d32f2f">
<link rel="apple-touch-icon" href="apple-touch-icon.png?v=202528Z2">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180x180.png?v=202528Z2">
<link rel="apple-touch-icon" sizes="167x167" href="apple-touch-icon-167x167.png?v=202528Z2">
<link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon-152x152.png?v=202528Z2">
<link rel="manifest" href="manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0}
:root{
  --red:#d32f2f;--bg:#0f1420;--card:#161d2a;--line:#243246;--mut:#8aa0b6;--txt:#e9eef5;
  --ink:#0e1622;--ok:#1b2738;--green:#2e7d32;--amber:#ffb300
}
body{background:var(--bg);color:var(--txt);font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
header{position:sticky;top:0;background:var(--red);color:#fff;padding:12px 14px;display:flex;gap:10px;justify-content:space-between;align-items:center;z-index:10;flex-wrap:wrap}
h1{margin:0;font-size:18px}
.badge{font-size:12px;padding:2px 8px;border:1px solid rgba(255,255,255,.4);border-radius:999px;white-space:nowrap}
.container{padding:12px 12px 84px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:10px}
.row{display:flex;gap:8px;align-items:center;margin:8px 0}
.row label{width:44%;color:var(--mut);font-size:14px}
.row input,.row select,.row textarea{flex:1;background:var(--ink);border:1px solid var(--line);color:#e9eef5;padding:10px;border-radius:10px;font-size:16px}
.row textarea{min-height:90px;resize:vertical}
.btn{background:var(--ok);color:#fff;border:1px solid var(--line);padding:10px 14px;border-radius:10px;font-size:15px;cursor:pointer}
.btn.primary{background:#fff;color:#d32f2f;border-color:#fff}
.small{font-size:12px}
.view{display:none}
.view.active{display:block}
.tabbar{position:fixed;left:0;right:0;bottom:0;height:70px;background:#121828;border-top:1px solid var(--line);display:flex}
.tabbar button{flex:1;background:transparent;border:none;color:#8aa0b6;font-size:12px;padding:6px 0}
.tabbar button.active{color:#fff}
.tabbar .ico{display:block;font-size:18px;margin-bottom:4px}
.progress{height:10px;border:1px solid var(--line);border-radius:999px;overflow:hidden;background:#0f2035}
.progress>div{height:100%;background:#d32f2f;width:0%}
.trip{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center;padding:10px 0;border-bottom:1px solid #233246}
.trip:last-child{border-bottom:0}
.money{white-space:nowrap}

/* –ü–ª–∞—à–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ */
.badge-live{
  display:inline-block;background:rgba(46,125,50,.12);border:1px solid rgba(46,125,50,.6);
  color:#a5d6a7;padding:2px 6px;border-radius:999px;font-size:12px;margin-left:6px;white-space:nowrap
}
.badge-two{
  display:inline-block;background:rgba(211,47,47,.15);border:1px solid rgba(211,47,47,.6);
  color:#ff8a80;padding:2px 6px;border-radius:999px;font-size:12px;margin-left:6px;white-space:nowrap
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–µ—Ç–∏ */
.net-pill{
  background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.5);
  padding:4px 8px;border-radius:999px;font-size:12px
}
.net-pill.off{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.3);color:#ffe082}
.net-pill.on{background:rgba(255,255,255,.2);border-color:rgba(255,255,255,.7);color:#c8e6c9}

/* –ö–Ω–æ–ø–∫–∞ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª */
.update-pill{background:#fff;color:#d32f2f;border:1px solid #fff;padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer;display:none}

/* –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –≤–∏–¥–∞ –ø–æ–µ–∑–¥–∞ */
.menu{position:fixed;left:0;right:0;bottom:0;background:#0f1420;border-top:1px solid var(--line);border-radius:12px 12px 0 0;box-shadow:0 -10px 30px rgba(0,0,0,.5);padding:12px;display:none;z-index:20}
.menu.show{display:block}
.menu h3{margin:0 0 8px 0;font-size:16px}
.menu .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.menu .grid .btn{width:100%}

/* –ü—Ä–æ—Ñ–∏–ª—å ‚Äî —Ñ–∞–π–ª—ã */
.file-item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:10px;padding:8px 10px;margin:6px 0}

/* –ü–æ–ª–Ω—ã–π –æ—Ç–¥—ã—Ö ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∏ */
.metrics{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.metric{border:1px solid var(--line);border-radius:10px;padding:10px;background:#121a28}
.metric b{display:block;margin-bottom:4px}

/* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
body.theme-light{--bg:#f6f7fb;--card:#ffffff;--line:#e4e7ee;--mut:#5b6b7c;--txt:#1a2433;--ink:#ffffff;--ok:#eaeef6}
</style>
</head>
<body>
<header>
  <h1>–ë–ª–æ–∫–Ω–æ—Ç –ú–∞—à–∏–Ω–∏—Å—Ç–∞</h1>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <span id="netStatus" class="net-pill off">–û—Ñ—Ñ–ª–∞–π–Ω</span>
    <div class="badge">Lite v2025.28Z2-PWA</div>
    <button id="appRefresh" class="update-pill" onclick="appUpdate()">–û–±–Ω–æ–≤–∏—Ç—å</button>
  </div>
</header>

<main class="container">
  <!-- –ì–ª–∞–≤–Ω–∞—è -->
  <section id="v-dashboard" class="view active">
    <div class="card">
      <div style="display:flex;justify-content:space-between"><b>–ú–µ—Å—è—á–Ω–∞—è –Ω–æ—Ä–º–∞</b><b id="mwNorm">‚Äî</b></div>
      <div class="progress" style="margin-top:6px"><div id="mwBar"></div></div>
      <div class="row"><label>–ù–æ—Ä–º–∞, —á/–º–µ—Å</label><input id="tar_norm" type="number" inputmode="decimal" placeholder="176" oninput="tarSave()"></div>
      <div class="row"><label>–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ</label><div id="mwWorked" class="small">‚Äî</div></div>
      <div class="row"><label>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</label><div id="mwPercent" class="small">‚Äî</div></div>
      <div class="row"><label>–û—Å—Ç–∞–ª–æ—Å—å/–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞</label><div id="mwRemain" class="small">‚Äî</div></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>–ü–æ–µ–∑–¥–∫–∏</b>
        <div>
          <button class="btn primary" onclick="addTripOpen()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn" onclick="exportTripsCsv()">CSV</button>
        </div>
      </div>

      <!-- –§–æ—Ä–º–∞ –ø–æ–µ–∑–¥–∫–∏ -->
      <div id="tripForm" class="card" style="display:none;margin-top:10px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <b id="tripFormTitle">–ù–æ–≤–∞—è –ø–æ–µ–∑–¥–∫–∞</b>
          <div>
            <button id="tripEditBtn" class="btn" style="display:none" onclick="tripToggleEdit(true)">‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button id="tripViewBtn" class="btn" style="display:none" onclick="tripToggleEdit(false)">üîí –ü—Ä–æ—Å–º–æ—Ç—Ä</button>
          </div>
        </div>

        <!-- –ü–æ—Ä—è–¥–æ–∫ –ø–æ–ª–µ–π -->
        <div class="row"><label>–î–∞—Ç–∞</label><input id="t_date" type="date"></div>

        <div class="legend">–ú–∞—Ä—à—Ä—É—Ç ¬´—Ç—É–¥–∞¬ª</div>
        <div class="row"><label>–ú–∞—Ä—à—Ä—É—Ç 1 (—Ç—É–¥–∞)</label>
          <input id="t_route1" list="routeList" placeholder="–Ω–∞–ø—Ä.: –ú–∞–ª–æ—à—É–π–∫–∞ ‚Äî –û–±–æ–∑–µ—Ä—Å–∫–∞—è">
          <datalist id="routeList"></datalist>
        </div>
        <div class="row"><label>–Ø–≤–∫–∞ (—Ç—É–¥–∞)</label><input id="t_start1" type="time" oninput="recalcDuration()"></div>

        <div class="legend">–†–µ–∫–≤–∏–∑–∏—Ç—ã ¬´—Ç—É–¥–∞¬ª</div>
        <div class="row"><label>–ù–æ–º–µ—Ä –ø–æ–µ–∑–¥–∞</label><input id="t_trainNo1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 2105"></div>
        <div class="row">
          <label>–í–∏–¥ –ø–æ–µ–∑–¥–∞</label>
          <div style="display:flex;gap:8px;flex:1">
            <input id="t_type1" readonly placeholder="–Ω–µ –≤—ã–±—Ä–∞–Ω–æ">
            <button class="btn" onclick="openTrainTypeMenu(1)">–í—ã–±—Ä–∞—Ç—å</button>
          </div>
        </div>
        <div class="row"><label>–ö–æ–Ω–µ—Ü —Ä–∞–±–æ—Ç—ã (—Ç—É–¥–∞)</label><input id="t_end1" type="time" oninput="recalcDuration()"></div>

        <div class="legend">–û–±—Ä–∞—Ç–Ω–æ</div>
        <div class="row"><label>–î–∞—Ç–∞ (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_date2" type="date" oninput="recalcDuration()"></div>
        <div class="row"><label>–ú–∞—Ä—à—Ä—É—Ç 2 (–æ–±—Ä–∞—Ç–Ω–æ)</label>
          <input id="t_route2" list="routeList" placeholder="–Ω–∞–ø—Ä.: –û–±–æ–∑–µ—Ä—Å–∫–∞—è ‚Äî –ú–∞–ª–æ—à—É–π–∫–∞">
        </div>
        <div class="row"><label>–Ø–≤–∫–∞ (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_start2" type="time" oninput="recalcDuration()"></div>

        <div class="legend">–†–µ–∫–≤–∏–∑–∏—Ç—ã ¬´–æ–±—Ä–∞—Ç–Ω–æ¬ª</div>
        <div class="row"><label>–ù–æ–º–µ—Ä –ø–æ–µ–∑–¥–∞</label><input id="t_trainNo2" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 2106"></div>
        <div class="row">
          <label>–í–∏–¥ –ø–æ–µ–∑–¥–∞</label>
          <div style="display:flex;gap:8px;flex:1">
            <input id="t_type2" readonly placeholder="–Ω–µ –≤—ã–±—Ä–∞–Ω–æ">
            <button class="btn" onclick="openTrainTypeMenu(2)">–í—ã–±—Ä–∞—Ç—å</button>
          </div>
        </div>
        <div class="row"><label>–ö–æ–Ω–µ—Ü —Ä–∞–±–æ—Ç—ã (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_end2" type="time" oninput="recalcDuration()"></div>

        <div class="legend">–°–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º</div>
        <div class="row">
          <button class="btn" onclick="togglePassengerBox()">–î–æ–±–∞–≤–∏—Ç—å —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º</button>
        </div>
        <div id="passengerBox" class="card" style="display:none; margin-top:6px">
          <div class="row"><label>–ö—É–¥–∞ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å</label>
            <select id="pf_side">
              <option value="to">–í–º–µ—Å—Ç–æ ¬´—Ç—É–¥–∞¬ª</option>
              <option value="back">–í–º–µ—Å—Ç–æ ¬´–æ–±—Ä–∞—Ç–Ω–æ¬ª</option>
            </select>
          </div>
          <div class="row"><label>–î–∞—Ç–∞ (–Ω–∞—á–∞–ª–æ)</label><input id="pf_date1" type="date"></div>
          <div class="row"><label>–ú–∞—Ä—à—Ä—É—Ç (—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ)</label><input id="pf_route" list="routeList" placeholder="—Å—Ç–∞–Ω—Ü–∏—è –ê ‚Äî —Å—Ç–∞–Ω—Ü–∏—è –ë"></div>
          <div class="row"><label>–û–∂–∏–¥–∞–Ω–∏–µ, –º–∏–Ω—É—Ç</label><input id="pf_wait" type="number" inputmode="numeric" placeholder="0"></div>
          <div class="row"><label>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label><input id="pf_dep" type="time"></div>
          <div class="row"><label>–ü—Ä–∏–±—ã—Ç–∏–µ</label><input id="pf_arr" type="time"></div>
          <div class="row"><label>–î–∞—Ç–∞ (–∫–æ–Ω–µ—Ü)</label><input id="pf_date2" type="date"></div>
          <div class="row" style="gap:8px">
            <button class="btn primary" onclick="confirmPassenger()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <button class="btn" onclick="clearPassenger()">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
          <div class="small" style="opacity:.8">–°–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º –∑–∞–º–µ–Ω—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –ø–ª–µ—á–æ –≤ —Ä–∞—Å—á—ë—Ç–µ —á–∞—Å–æ–≤/–Ω–æ—á–Ω—ã—Ö/–∑–∞—Ä–ø–ª–∞—Ç—ã.</div>
        </div>

        <div class="legend">–ò—Ç–æ–≥–∏</div>
        <div class="row"><label>–û—Ç–¥—ã—Ö (–∞–≤—Ç–æ)</label><input id="t_rest_view" type="text" readonly></div>
        <div class="row"><label>–ù–æ—á–Ω—ã–µ (–∞–≤—Ç–æ)</label><input id="t_night_view" type="text" readonly></div>
        <div class="row"><label>–ß–∞—Å—ã (–∏—Ç–æ–≥, –±–µ–∑ –æ—Ç–¥—ã—Ö–∞)</label><input id="t_hours_view" type="text" readonly></div>

        <div class="row"><label>–ó–∞–º–µ—Ç–∫–∏</label><textarea id="t_notes" placeholder="–ü—Ä–æ—Å—Ç–æ–∏, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏‚Ä¶"></textarea></div>

        <div class="row" id="tripButtonsNew">
          <button class="btn primary" onclick="tripSaveNew()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn" onclick="tripCancel()">–û—Ç–º–µ–Ω–∞</button>
        </div>

        <div class="row" id="tripButtonsEdit" style="display:none">
          <button class="btn primary" onclick="tripSaveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
          <button class="btn" onclick="tripCancel()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>

      <div id="daysList" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- –£—á–∞—Å—Ç–∫–∏ -->
  <section id="v-sections" class="view">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>–£—á–∞—Å—Ç–∫–∏</b><div class="actions"><button class="btn" onclick="sectionOpen()">–ù–æ–≤—ã–π —É—á–∞—Å—Ç–æ–∫</button></div>
      </div>

      <div id="sectionForm" class="card" style="display:none;margin-top:10px">
        <div class="row"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="s_name" placeholder="–ù–∞–ø—Ä.: –ú–∞–ª–æ—à—É–π–∫–∞ ‚Äî –û–±–æ–∑–µ—Ä—Å–∫–∞—è"></div>
        <div class="row"><label>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label><input id="s_from"></div>
        <div class="row"><label>–ü—Ä–∏–±—ã—Ç–∏–µ</label><input id="s_to"></div>
        <div class="row"><label>–î–ª–∏–Ω–∞ (–∫–º)</label><input id="s_len" type="number" inputmode="decimal" placeholder="0"></div>
        <div class="row">
          <button id="s_save_btn" class="btn primary" onclick="sectionSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn" onclick="sectionCancel()">–û—Ç–º–µ–Ω–∞</button>
        </div>
        <div class="small" id="s_hint" style="opacity:.7"></div>
      </div>

      <div id="sectionList"></div>
    </div>
  </section>

  <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ -->
  <section id="v-more" class="view">
    <div class="card">
      <b>–ü–æ–ª–Ω—ã–π –æ—Ç–¥—ã—Ö –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–µ–∑–¥–∫–µ</b>
      <div class="row" style="gap:8px">
        <button class="btn primary" onclick="calcFullRest()">–ü–æ—Å—á–∏—Ç–∞—Ç—å</button>
        <button class="btn" onclick="closeFullRest()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="restResult"></div>
      <div class="small" style="opacity:.8;margin-top:8px">
        –§–æ—Ä–º—É–ª–∞: (–≤—Ä–µ–º—è –Ω–∞ —Ä–∞–±–æ—Ç–µ ¬´—Ç—É–¥–∞+–æ–±—Ä–∞—Ç–Ω–æ¬ª) √ó 2.6 ‚àí –æ—Ç–¥—ã—Ö –º–µ–∂–¥—É ¬´–∫–æ–Ω—Ü–æ–º (—Ç—É–¥–∞)¬ª –∏ ¬´—è–≤–∫–æ–π (–æ–±—Ä–∞—Ç–Ω–æ)¬ª. –ï—Å–ª–∏ –∑–∞—Ö–≤–∞—á–µ–Ω—ã <b>–¥–≤–µ –Ω–æ—á–∏ (00‚Äì05)</b> ‚Äî –æ—Ç–¥—ã—Ö –Ω–µ –≤—ã—á–∏—Ç–∞–µ–º. –û—Ç—Å—á—ë—Ç –æ—Ç ¬´–∫–æ–Ω—Ü–∞ (–æ–±—Ä–∞—Ç–Ω–æ)¬ª.
      </div>
    </div>

    <div class="card">
      <b>–¢–∞—Ä–∏—Ñ –∏ –Ω–∞–¥–±–∞–≤–∫–∏</b>
      <div class="row"><label>‚ÇΩ/—á–∞—Å (—Å—Ç–∞–≤–∫–∞)</label><input id="tar_base" type="number" inputmode="decimal" placeholder="358.46"></div>
      <div class="row"><label>–†–∞–π–æ–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç, %</label><input id="tar_rc" type="number" inputmode="decimal" placeholder="20"></div>
      <div class="row"><label>–°–µ–≤–µ—Ä–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç, %</label><input id="tar_north" type="number" inputmode="decimal" placeholder="50"></div>
      <div class="row"><label>–ù–∞–¥–±–∞–≤–∫–∞ –∑–∞ –∫–ª–∞—Å—Å, %</label><input id="tar_cls" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><label>–ó–æ–Ω–∞–ª—å–Ω–∞—è –Ω–∞–¥–±–∞–≤–∫–∞, %</label><input id="tar_zone" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><label>–ë–ê–ú-–Ω–∞–¥–±–∞–≤–∫–∞, %</label><input id="tar_bam" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><label>–ö–æ–º. —Ä–∞—Å—Ö–æ–¥—ã (–∑–∞ –ø–æ–µ–∑–¥–∫—É), ‚ÇΩ</label><input id="tar_fee" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><button class="btn primary" onclick="tarSave(true)">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ</button></div>
    </div>

    <div class="card">
      <b>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</b>
      <div class="row" style="gap:8px">
        <button class="btn primary" onclick="openCalendar()">–û—Ç–∫—Ä—ã—Ç—å</button>
        <button class="btn" onclick="closeCalendar()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="calendarBox"></div>
    </div>

    <div class="card">
      <b>–†–ñ–î-–∑–∞—Ä–ø–ª–∞—Ç–∞</b>
      <div class="row" style="gap:8px">
        <button class="btn primary" onclick="openRzdSalary()">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        <button class="btn" onclick="closeRzdSalary()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="rzdBox"></div>
      <div class="small" style="opacity:.8;margin-top:6px">–ü–æ–∫–∞ –¥–µ–π—Å—Ç–≤—É–µ—Ç —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤; –ø—Ä–∏—à–ª—ë—Ç–µ —Ç–æ—á–Ω—ã–µ ‚Äî –ø–æ–¥—Å—Ç—Ä–æ—é —Ñ–æ—Ä–º—É–ª—ã.</div>
    </div>
  </section>

  <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
  <section id="v-profile" class="view">
    <div class="card">
      <b>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</b>
      <div class="row" style="align-items:flex-start">
        <label>–§–æ—Ç–æ</label>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <img id="pfAvatarBig" style="width:64px;height:64px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,.3)">
          <input id="pf_photo" type="file" accept="image/*" onchange="profilePhotoChanged(event)">
        </div>
      </div>
      <div class="row"><label>–ò–º—è</label><input id="pf_first" placeholder="–ò–≤–∞–Ω"></div>
      <div class="row"><label>–§–∞–º–∏–ª–∏—è</label><input id="pf_last" placeholder="–ò–≤–∞–Ω–æ–≤"></div>
      <div class="row"><label>–í–æ–∑—Ä–∞—Å—Ç</label><input id="pf_age" type="number" inputmode="numeric" placeholder="30"></div>
      <div class="row"><label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label><input id="pf_role" placeholder="–ú–∞—à–∏–Ω–∏—Å—Ç"></div>
      <div class="row"><label>–ú–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã</label><input id="pf_place" placeholder="–î–µ–ø–æ ..."></div>
      <div class="row"><label>–î–∞—Ç–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label><input id="pf_start" type="date" onchange="renderTenure()"></div>
      <div class="row"><label>–°—Ç–∞–∂</label><input id="pf_tenure" type="text" readonly></div>

      <div class="hr"></div>
      <b>–§–∞–π–ª—ã</b>
      <div class="row"><input id="pf_files" type="file" multiple onchange="profileAddFiles(event)"></div>
      <div id="pf_files_list"></div>

      <div class="row" style="gap:8px">
        <button class="btn primary" onclick="profileSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </section>

  <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <section id="v-settings" class="view">
    <div class="card">
      <details>
        <summary>–ë—ç–∫–∞–ø / –≠–∫—Å–ø–æ—Ä—Ç</summary>
        <div class="inside">
          <div class="row"><button class="btn" onclick="backup()">–°–∫–∞—á–∞—Ç—å JSON</button></div>
        </div>
      </details>
      <div style="height:8px"></div>
      <details>
        <summary>–ò–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–∞ JSON</summary>
        <div class="inside">
          <div class="row"><input id="restoreFile" type="file" accept="application/json" onchange="restoreFileChanged(event)"></div>
        </div>
      </details>
      <div style="height:8px"></div>
      <details>
        <summary>–ò–º–ø–æ—Ä—Ç –∏–∑ –±—É—Ñ–µ—Ä–∞</summary>
        <div class="inside">
          <div class="row"><textarea id="restoreText" placeholder='–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ {"tar":...}'></textarea></div>
          <div class="row">
            <button class="btn" onclick="pasteFromClipboard()">–í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞</button>
            <button class="btn primary" onclick="restoreFromText()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>
      </details>
    </div>

    <div class="card">
      <b>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</b>
      <div class="row"><button class="btn" onclick="appUpdate()">–û–±–Ω–æ–≤–∏—Ç—å –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏</button></div>
      <div class="small" style="opacity:.8">–ù–∞–∂–º–∏—Ç–µ –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏. –î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç—Å—è.</div>
    </div>

    <div class="card">
      <b>–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</b>
      <div class="row">
        <label>–ü–æ—è—Å</label>
        <select id="tz_select" onchange="tzSave()"></select>
      </div>
      <div class="small" style="opacity:.8">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è ¬´–≤ –ø—É—Ç–∏¬ª, –Ω–æ—á–Ω—ã—Ö –∏ —Ä–∞—Å—á—ë—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏–π –æ—Ç–¥—ã—Ö–∞.</div>
    </div>

    <div class="card">
      <b>–î–æ—Å—Ç—É–ø –∫ ¬´–†–ñ–î-–∑–∞—Ä–ø–ª–∞—Ç–∞¬ª</b>
      <div class="row"><label>PIN-–∫–æ–¥</label><input id="pin_input" type="password" placeholder="–Ω–µ –∑–∞–¥–∞–Ω"></div>
      <div class="row"><button class="btn primary" onclick="savePIN()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å PIN</button></div>
      <div class="small" style="opacity:.8">–ü—Ä–∏ –≤—Ö–æ–¥–µ –≤ ¬´–†–ñ–î-–∑–∞—Ä–ø–ª–∞—Ç–∞¬ª –±—É–¥–µ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å—Å—è —ç—Ç–æ—Ç PIN.</div>
    </div>

    <div class="card">
      <b>–¢–µ–º–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</b>
      <div class="row"><label>–¢–µ–º–∞</label>
        <select id="theme_select" onchange="setTheme(this.value)">
          <option value="dark">–¢—ë–º–Ω–∞—è</option>
          <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
        </select>
      </div>
    </div>

    <div class="card small" style="opacity:.8">–í–µ—Ä—Å–∏—è Lite 2025.28Z2-PWA</div>
    <div class="small" style="opacity:.8;text-align:center">
      <a href="https://t.me/nikitagrigorev99" target="_blank" style="color:inherit;text-decoration:underline">by Nikita Grigorev</a>
    </div>
  </section>
</main>

<nav class="tabbar">
  <button class="active" data-tab="dashboard" onclick="nav(this)"><span class="ico">üè†</span>–ì–ª–∞–≤–Ω–∞—è</button>
  <button data-tab="sections" onclick="nav(this)"><span class="ico">üó∫Ô∏è</span>–£—á–∞—Å—Ç–∫–∏</button>
  <button data-tab="more" onclick="nav(this)"><span class="ico">‚ûï</span>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</button>
  <button data-tab="profile" onclick="nav(this)"><span class="ico">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</button>
  <button data-tab="settings" onclick="nav(this)"><span class="ico">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</nav>

<!-- –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –≤–∏–¥–∞ –ø–æ–µ–∑–¥–∞ -->
<div id="typeMenu" class="menu">
  <h3>–í–∏–¥ –ø–æ–µ–∑–¥–∞</h3>
  <div class="grid">
    <button class="btn" onclick="pickTrainType('–≥—Ä—É–∑–æ–≤–æ–π')">–ì—Ä—É–∑–æ–≤–æ–π</button>
    <button class="btn" onclick="pickTrainType('–ø–æ—Ä–æ–∂–Ω–∏–π')">–ü–æ—Ä–æ–∂–Ω–∏–π</button>
    <button class="btn" onclick="pickTrainType('–¥–ª–∏–Ω–Ω–æ—Å–æ—Å—Ç–∞–≤–Ω—ã–π')">–î–ª–∏–Ω–Ω–æ—Å–æ—Å—Ç–∞–≤–Ω—ã–π</button>
    <button class="btn" onclick="pickTrainType('—Ä–µ–∑–µ—Ä–≤')">–†–µ–∑–µ—Ä–≤</button>
    <button class="btn" onclick="pickTrainType('—Å–ø–ª–æ—Ç–∫–∞')">–°–ø–ª–æ—Ç–∫–∞</button>
    <button class="btn" onclick="pickTrainType('—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º')">–°–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º</button>
  </div>
  <div class="row" style="margin-top:10px;justify-content:flex-end">
    <button class="btn" onclick="closeTypeMenu()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<script>
/* ========= helpers ========= */
function $(s){return document.querySelector(s)}
function $all(s){return Array.from(document.querySelectorAll(s))}
function S(k,v){if(arguments.length===2){localStorage.setItem(k,JSON.stringify(v));return v}try{let r=localStorage.getItem(k);return r?JSON.parse(r):null}catch(e){return null}}
function toNum(v){let n=Number(v);return isNaN(n)?0:n}
function plural(n, one, few, many){ n=Math.abs(n)%100; let n1=n%10; if(n>10 && n<20) return many; if(n1>1 && n1<5) return few; if(n1==1) return one; return many; }
function fmtM(min){if(min==null)return '‚Äî';let h=Math.floor(min/60),m=min%60;return h+'—á '+String(m).padStart(2,'0')+'–º'}
function fmtHMWords(min){if(min==null||min===0)return'0 –º–∏–Ω—É—Ç';const h=Math.floor(min/60),m=min%60;const hs=h>0?(h+' '+plural(h,'—á–∞—Å','—á–∞—Å–∞','—á–∞—Å–æ–≤')):'';const ms=m>0?(m+' '+plural(m,'–º–∏–Ω—É—Ç–∞','–º–∏–Ω—É—Ç—ã','–º–∏–Ω—É—Ç')):'';return(hs+' '+ms).trim()}
function toMin(hhmm){if(!hhmm)return null;let p=hhmm.split(':');if(p.length<2)return null;let H=Number(p[0]),M=Number(p[1]);if(isNaN(H)||isNaN(M))return null;return H*60+M}
function diffMinutes(a,b){let x=toMin(a),y=toMin(b);if(x==null||y==null)return null;let d=y-x; if(d<0) d+=24*60; return d}
const RUR=new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:0})

/* ========= Network & Theme ========= */
function updateNetPill(){const el=$('#netStatus');if(!el)return;const on=navigator.onLine;el.textContent=on?'–û–Ω–ª–∞–π–Ω':'–û—Ñ—Ñ–ª–∞–π–Ω';el.classList.toggle('on',on);el.classList.toggle('off',!on)}
window.addEventListener('online',updateNetPill);window.addEventListener('offline',updateNetPill);
function applyTheme(){const t=S('theme')||'dark';document.body.classList.toggle('theme-light',t==='light');const sel=$('#theme_select');if(sel)sel.value=t}
function setTheme(v){S('theme',v);applyTheme()}

/* ========= timezone ========= */
function tzList(){return['AUTO','UTC-12:00','UTC-11:00','UTC-10:00','UTC-09:30','UTC-09:00','UTC-08:00','UTC-07:00','UTC-06:00','UTC-05:00','UTC-04:30','UTC-04:00','UTC-03:30','UTC-03:00','UTC-02:00','UTC-01:00','UTC+00:00','UTC+01:00','UTC+02:00','UTC+03:00','UTC+03:30','UTC+04:00','UTC+04:30','UTC+05:00','UTC+05:30','UTC+05:45','UTC+06:00','UTC+06:30','UTC+07:00','UTC+08:00','UTC+08:45','UTC+09:00','UTC+09:30','UTC+10:00','UTC+10:30','UTC+11:00','UTC+12:00','UTC+12:45','UTC+13:00','UTC+14:00']}
function parseUtcLabelToOffsetMin(label){if(label==='AUTO')return null;const m=label.match(/UTC([+-])(\d{2}):(\d{2})/);if(!m)return 0;const sign=m[1]==='-'?-1:1;const hh=Number(m[2])||0,mm=Number(m[3])||0;return sign*(hh*60+mm)}
function getSelectedTzOffsetMin(){const pref=S('tz_pref');if(!pref||pref.mode==='AUTO'){return -new Date().getTimezoneOffset()}return pref.offsetMin||0}
function tzPopulateSelect(){const sel=$('#tz_select');sel.innerHTML='';tzList().forEach(lb=>{const o=document.createElement('option');o.value=lb;o.textContent=(lb==='AUTO'?'–ê–≤—Ç–æ (—Å–∏—Å—Ç–µ–º–Ω—ã–π)':lb);sel.appendChild(o)});const pref=S('tz_pref');sel.value=pref?(pref.mode==='AUTO'?'AUTO':(pref.label||'AUTO')):'AUTO'}
function tzSave(){const label=$('#tz_select').value;if(label==='AUTO'){S('tz_pref',{mode:'AUTO'})}else{S('tz_pref',{mode:'FIX',label,offsetMin:parseUtcLabelToOffsetMin(label)})}updateLiveTimers(true)}

/* ========= navigation ========= */
function nav(btn){$all('.tabbar button').forEach(x=>x.classList.remove('active'));btn.classList.add('active');let v=btn.getAttribute('data-tab');$all('.view').forEach(x=>x.classList.remove('active'));$('#v-'+v).classList.add('active');if(v==='profile')loadProfile()}

/* ========= tariffs ========= */
function getTar(){return S('tar')||{base:358.46,norm:176,rc:20,north:50,cls:0,zone:0,bam:0,fee:0}}
function tarSave(goHome){let t=getTar();t.base=toNum($('#tar_base').value)||t.base;t.norm=toNum($('#tar_norm').value)||t.norm;t.rc=toNum($('#tar_rc').value)||0;t.north=toNum($('#tar_north').value)||0;t.cls=toNum($('#tar_cls').value)||0;t.zone=toNum($('#tar_zone').value)||0;t.bam=toNum($('#tar_bam').value)||0;t.fee=toNum($('#tar_fee').value)||0;S('tar',t);updateDash();renderTrips();if(goHome){$all('.tabbar button').forEach(b=>b.classList.remove('active'));document.querySelector('.tabbar button[data-tab="dashboard"]').classList.add('active');$all('.view').forEach(v=>v.classList.remove('active'));$('#v-dashboard').classList.add('active')}}
function loadTar(){let t=getTar();$('#tar_base').value=t.base;$('#tar_norm').value=t.norm;$('#tar_rc').value=t.rc;$('#tar_north').value=t.north;$('#tar_cls').value=t.cls;$('#tar_zone').value=t.zone;$('#tar_bam').value=t.bam;$('#tar_fee').value=t.fee}

/* ========= money & salary helpers ========= */
function tripMoneyBase(hours){let t=getTar();let pct=(t.rc+t.north+t.cls+t.zone+t.bam)/100;let gross=hours*t.base*(1+pct);let net=gross-(t.fee||0);return Math.max(0,Math.round(net))}
const TYPE_COEF={ '–≥—Ä—É–∑–æ–≤–æ–π':1.00,'–ø–æ—Ä–æ–∂–Ω–∏–π':0.95,'–¥–ª–∏–Ω–Ω–æ—Å–æ—Å—Ç–∞–≤–Ω—ã–π':1.10,'—Ä–µ–∑–µ—Ä–≤':0.80,'—Å–ø–ª–æ—Ç–∫–∞':1.05,'—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º':0.60 };
function salaryForTrip(t){ // —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –º–æ–¥–µ–ª—å: –≤–∑–≤–µ—à–∏–≤–∞–µ–º –ø–æ —Ç–∏–ø–∞–º –ø–ª–µ—á
  const h1=toNum(diffMinutes(t.start1,t.end1)||0)/60;
  const h2=toNum(diffMinutes(t.start2,t.end2)||0)/60;
  const pf=t.pfollow && t.pfollow.enabled?t.pfollow:null;
  let coef1=TYPE_COEF[t.trainType1||'']||1, coef2=TYPE_COEF[t.trainType2||'']||1;
  if(pf){ if(pf.side==='to') coef1=TYPE_COEF['—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º']; else coef2=TYPE_COEF['—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º']; }
  const tbase=getTar();
  const pct=(tbase.rc+tbase.north+tbase.cls+tbase.zone+tbase.bam)/100;
  const base=tbase.base*(1+pct);
  const fee=tbase.fee||0;
  const money=Math.max(0,Math.round(h1*base*coef1 + h2*base*coef2 - fee));
  return {money, h1, h2, coef1, coef2}
}
function tripMoney(h){return tripMoneyBase(h)} // –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞: –æ–±—â–∏–π –≤–∏–¥

/* ========= sections ========= */
function getSecs(){return S('secs')||[]} function setSecs(a){S('secs',a)}
let editingSectionId=null;
function titleForSection(s){let t=(s.name&&s.name.trim())?s.name.trim():((s.frm||'').trim()+' ‚Äî '+(s.to||'').trim());t=t.replace(/\s+/g,' ').trim();return t||'‚Äî'}
function sectionOpen(){editingSectionId=null;$('#sectionForm').style.display='block';$('#s_name').value='';$('#s_from').value='';$('#s_to').value='';$('#s_len').value='';$('#s_save_btn').textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';$('#s_hint').textContent='–ù–æ–≤—ã–π —É—á–∞—Å—Ç–æ–∫'}
function sectionCancel(){$('#sectionForm').style.display='none';editingSectionId=null}
function sectionEdit(id){let s=(getSecs()||[]).find(x=>x.id===id);if(!s)return;editingSectionId=id;$('#sectionForm').style.display='block';$('#s_name').value=s.name||'';$('#s_from').value=s.frm||'';$('#s_to').value=s.to||'';$('#s_len').value=(s.len!=null?s.len:'');$('#s_save_btn').textContent='–û–±–Ω–æ–≤–∏—Ç—å';$('#s_hint').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—á–∞—Å—Ç–∫–∞'}
function sectionSave(){let name=($('#s_name').value||'').trim(),frm=($('#s_from').value||'').trim(),to=($('#s_to').value||'').trim(),len=toNum($('#s_len').value);let arr=getSecs();if(editingSectionId){let ix=arr.findIndex(x=>x.id===editingSectionId);if(ix>=0){arr[ix]={id:editingSectionId,name,frm,to,len};setSecs(arr)}editingSectionId=null}else{arr.push({id:Date.now(),name,frm,to,len});setSecs(arr)}$('#sectionForm').style.display='none';renderSecs();buildRouteOptions()}
function sectionDel(id,ev){if(ev)ev.stopPropagation();if(!confirm('–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–æ–∫?'))return;setSecs(getSecs().filter(x=>x.id!==id));renderSecs();buildRouteOptions()}
function renderSecs(){let box=$('#sectionList');box.innerHTML='';let a=getSecs();if(!a.length){let d=document.createElement('div');d.className='small';d.style.opacity=.7;d.textContent='–ù–µ—Ç —É—á–∞—Å—Ç–∫–æ–≤';box.appendChild(d)}a.forEach(s=>{let title=titleForSection(s),info=(s.frm||'‚Äî')+' ‚Üí '+(s.to||'‚Äî')+(s.len?(' ‚Ä¢ '+s.len+' –∫–º'):'');let r=document.createElement('div');r.className='row tap';r.setAttribute('onclick','sectionEdit('+s.id+')');r.innerHTML='<div style="flex:1"><b>'+title+'</b><div class="small" style="opacity:.7">'+info+'</div></div>'+'<div class="actions"><button class="btn" onclick="event.stopPropagation(); sectionEdit('+s.id+')">‚úé</button>'+'<button class="btn" onclick="sectionDel('+s.id+', event)">üóë</button></div>';box.appendChild(r)})}

/* ========= routes (datalist) ========= */
function getRoutesCache(){return S('routes_cache')||[]} function setRoutesCache(a){S('routes_cache',a)}
function buildRouteOptions(){let dl=$('#routeList');dl.innerHTML='';let seen=new Set();getSecs().forEach(s=>{let title=titleForSection(s);if(title&&!seen.has(title)){seen.add(title);let o=document.createElement('option');o.value=title;dl.appendChild(o)}});(getRoutesCache()).forEach(r=>{let t=(r||'').trim();if(t&&!seen.has(t)){seen.add(t);let o=document.createElement('option');o.value=t;dl.appendChild(o)}});(getTrips()).forEach(t=>{[t.route1,t.route2,t.route].forEach(r=>{let rr=(r||'').trim();if(rr&&!seen.has(rr)){seen.add(rr);let o=document.createElement('option');o.value=rr;dl.appendChild(o)}})})}

/* ========= trips storage ========= */
function getTrips(){return S('trips')||[]} function setTrips(a){S('trips',a)}

/* ========= trip form state ========= */
let currentTripId=null,editEnabled=true,currentTrainType1='',currentTrainType2='',trainTypeTarget=1;
let pfollowDraft=null; // {enabled, side, date1, route, wait, dep, arr, date2}

function setReadonly(readonly){['t_date','t_date2','t_trainNo1','t_trainNo2','t_route1','t_route2','t_start1','t_end1','t_start2','t_end2','t_notes','pf_wait','pf_dep','pf_arr','pf_date1','pf_date2','pf_route','pf_side'].forEach(id=>{const el=$('#'+id);if(el){el.readOnly=readonly; if(el.tagName==='SELECT') el.disabled=readonly;}})}
function tripToggleEdit(on){editEnabled=!!on;setReadonly(!editEnabled);$('#tripEditBtn').style.display=editEnabled?'none':'';$('#tripViewBtn').style.display=editEnabled?'':'none'}
function openTripForm(show){$('#tripForm').style.display=show?'block':'none'}
function openTrainTypeMenu(target){trainTypeTarget=target||1;$('#typeMenu').classList.add('show')}
function closeTypeMenu(){$('#typeMenu').classList.remove('show')}
function pickTrainType(type){if(trainTypeTarget===1){currentTrainType1=type;$('#t_type1').value=type}else{currentTrainType2=type;$('#t_type2').value=type}closeTypeMenu()}

/* ========= passenger following UI ========= */
function togglePassengerBox(){const b=$('#passengerBox');b.style.display=(b.style.display==='none'||!b.style.display)?'block':'none'}
function clearPassenger(){pfollowDraft=null;$('#pf_side').value='to';$('#pf_date1').value='';$('#pf_route').value='';$('#pf_wait').value='';$('#pf_dep').value='';$('#pf_arr').value='';$('#pf_date2').value=''}
function confirmPassenger(){pfollowDraft={enabled:true,side:$('#pf_side').value||'to',date1:$('#pf_date1').value||'',route:($('#pf_route').value||'').trim(),wait:toNum($('#pf_wait').value)||0,dep:$('#pf_dep').value||'',arr:$('#pf_arr').value||'',date2:$('#pf_date2').value||''};alert('–°–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º –ø—Ä–∏–º–µ–Ω–µ–Ω–æ');}

/* ========= date/time helpers ========= */
function dateAddDays(dateStr,days){const d=new Date(dateStr+'T00:00:00Z');d.setUTCDate(d.getUTCDate()+days);return d.toISOString().slice(0,10)}
function epochFromDateTimeTz(dateStr,timeStr,tzOffsetMin){if(!dateStr||!timeStr)return null;const [Y,M,D]=dateStr.split('-').map(Number);const [h,m]=timeStr.split(':').map(Number);if([Y,M,D,h,m].some(isNaN))return null;return Date.UTC(Y,M-1,D,h,m)-tzOffsetMin*60000}
function addMinutesEpoch(epoch,minutes){return new Date(epoch+minutes*60000)}
function fmtLocalFull(d,tzOffsetMin){if(!d)return'‚Äî';const localMs=d.getTime()+tzOffsetMin*60000;const x=new Date(localMs);const yyyy=x.getUTCFullYear();const mm=String(x.getUTCMonth()+1).padStart(2,'0');const dd=String(x.getUTCDate()).padStart(2,'0');const hh=String(x.getUTCHours()).padStart(2,'0');const mi=String(x.getUTCMinutes()).padStart(2,'0');return dd+'.'+mm+'.'+yyyy+' '+hh+':'+mi}

/* ========= night minutes (22‚Äì06) ========= */
function overlap(a1,a2,b1,b2){const s=Math.max(a1,b1),e=Math.min(a2,b2);return Math.max(0,e-s)}
function legNightMinutes(dateStr,startHHMM,endHHMM,tzMin){if(!startHHMM||!endHHMM)return 0;let start=epochFromDateTimeTz(dateStr,startHHMM,tzMin);let end=epochFromDateTimeTz(dateStr,endHHMM,tzMin);if(start==null||end==null)return 0;if(end<start)end+=24*60*60000;const day0=epochFromDateTimeTz(dateStr,'00:00',tzMin);let night=0;const blocks=[[day0+22*60*60000,day0+24*60*60000],[day0+24*60*60000,day0+30*60*60000],[day0+46*60*60000,day0+48*60*60000],[day0+48*60*60000,day0+54*60*60000]];for(const[b1,b2]of blocks){night+=overlap(start,end,b1,b2)}return Math.round(night/60000)}
function countNightWindows0005(startEpoch,endEpoch,tzMin){if(startEpoch==null||endEpoch==null)return 0;if(endEpoch<=startEpoch)return 0;const startLocal=new Date(startEpoch+tzMin*60000);const endLocal=new Date(endEpoch+tzMin*60000);let day=Date.UTC(startLocal.getUTCFullYear(),startLocal.getUTCMonth(),startLocal.getUTCDate());const endDay=Date.UTC(endLocal.getUTCFullYear(),endLocal.getUTCMonth(),endLocal.getUTCDate());let cnt=0;while(day<=endDay+24*60*60000){const wStart=day-tzMin*60000;const wEnd=wStart+5*60*60000;const inter=overlap(startEpoch,endEpoch,wStart,wEnd);if(inter>0)cnt++;day+=24*60*60000}return cnt}

/* ========= recalc & passenger logic ========= */
function invertRoute(str){if(!str)return'';const parts=str.split('‚Äî').map(s=>s.trim());if(parts.length===2)return parts[1]+' ‚Äî '+parts[0];const dash=str.indexOf('-')>=0?'-':'‚Äî';const p=str.split(dash).map(s=>s.trim());if(p.length===2)return p[1]+' '+dash+' '+p[0];return str}
function effectiveReturnDate(){const d=($('#t_date2').value||'').trim();if(d)return d;const d1=$('#t_date').value||new Date().toISOString().slice(0,10);const st2=$('#t_start2').value,e1=$('#t_end1').value; if(toMin(st2)!=null&&toMin(e1)!=null&&toMin(st2)<toMin(e1))return dateAddDays(d1,1);return d1}
function passengerLegMinutes(pf,tzMin){if(!pf||!pf.enabled)return 0;const dep=epochFromDateTimeTz(pf.date1||$('#t_date').value,pf.dep,tzMin);const arr=epochFromDateTimeTz(pf.date2||pf.date1||effectiveReturnDate(),pf.arr,tzMin);if(dep==null||arr==null)return toNum(pf.wait)||0;let mins=Math.round((arr-dep)/60000);if(mins<0)mins+=24*60; return (toNum(pf.wait)||0)+Math.max(0,mins)}
function recalcDuration(){
  const tzMin=getSelectedTzOffsetMin();
  // –∞–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –ø–ª–µ—á–∞
  $('#t_route2').onfocus=function(){const r1=($('#t_route1').value||'').trim();if(this.value.trim()===''&&r1)this.value=invertRoute(r1)}
  const date=$('#t_date').value, date2=effectiveReturnDate();
  // –±–∞–∑–æ–≤—ã–µ –ø–ª–µ—á–∏
  let l1=diffMinutes($('#t_start1').value,$('#t_end1').value)||0;
  let l2=diffMinutes($('#t_start2').value,$('#t_end2').value)||0;
  // —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º –ø–æ–¥–º–µ–Ω—è–µ—Ç –ø–ª–µ—á–æ
  if(pfollowDraft&&pfollowDraft.enabled){
    const pfM=passengerLegMinutes(pfollowDraft,tzMin);
    if(pfollowDraft.side==='to'){ l1=pfM; if(pfollowDraft.route) $('#t_route1').value=pfollowDraft.route; }
    else { l2=pfM; if(pfollowDraft.route) $('#t_route2').value=pfollowDraft.route; if(pfollowDraft.date2) $('#t_date2').value=pfollowDraft.date2; }
  }
  const rest=diffMinutes($('#t_end1').value,$('#t_start2').value)||0; $('#t_rest_view').value=rest?fmtHMWords(rest):'0 –º–∏–Ω—É—Ç';
  const totalMin=(l1||0)+(l2||0); $('#t_hours_view').value=fmtHMWords(totalMin);
  const n1=legNightMinutes(date,$('#t_start1').value,$('#t_end1').value,tzMin);
  const n2=legNightMinutes(date2,$('#t_start2').value,$('#t_end2').value,tzMin);
  const nightTotal=n1+n2; $('#t_night_view').value=nightTotal?fmtHMWords(nightTotal):'0 –º–∏–Ω—É—Ç';
}

/* ========= build trip from form ========= */
function tripSkeletonFromForm(){
  const tzMin=getSelectedTzOffsetMin();
  let date=$('#t_date').value||new Date().toISOString().slice(0,10);
  let date2=effectiveReturnDate();
  let route1=($('#t_route1').value||'').trim();
  let route2=($('#t_route2').value||'').trim();
  let l1=diffMinutes($('#t_start1').value,$('#t_end1').value)||0;
  let l2=diffMinutes($('#t_start2').value,$('#t_end2').value)||0;

  let pf=null;
  if(pfollowDraft&&pfollowDraft.enabled){
    const mins=passengerLegMinutes(pfollowDraft,tzMin);
    pf={...pfollowDraft};
    if(pf.side==='to'){ l1=mins; if(pf.route) route1=pf.route; if(pf.date1) date=pf.date1; }
    else { l2=mins; if(pf.route) route2=pf.route; if(pf.date2) date2=pf.date2; }
  }

  const hours=(l1+l2)/60;
  const rest=diffMinutes($('#t_end1').value,$('#t_start2').value)||0;
  const night=legNightMinutes(date,$('#t_start1').value,$('#t_end1').value,getSelectedTzOffsetMin())+
              legNightMinutes(date2,$('#t_start2').value,$('#t_end2').value,getSelectedTzOffsetMin());

  return {
    date,date2,
    route:route1||'',route1,route2,
    trainNo1:($('#t_trainNo1').value||'').trim(), trainNo2:($('#t_trainNo2').value||'').trim(),
    trainType1:currentTrainType1||'', trainType2:currentTrainType2||'',
    start1:$('#t_start1').value||'', end1:$('#t_end1').value||'',
    start2:$('#t_start2').value||'', end2:$('#t_end2').value||'',
    rest,hours,night,
    notes:($('#t_notes').value||'').trim(),
    pfollow: pf
  };
}

/* ========= save ========= */
function addTripOpen(){currentTripId=null;$('#tripFormTitle').textContent='–ù–æ–≤–∞—è –ø–æ–µ–∑–¥–∫–∞';$('#tripButtonsNew').style.display='';$('#tripButtonsEdit').style.display='none';$('#tripEditBtn').style.display='none';$('#tripViewBtn').style.display='none';clearTripForm();buildRouteOptions();tripToggleEdit(true);openTripForm(true)}
function clearTripForm(){const today=new Date().toISOString().slice(0,10);$('#t_date').value=today;$('#t_date2').value='';$('#t_trainNo1').value='';$('#t_trainNo2').value='';currentTrainType1='';currentTrainType2='';$('#t_type1').value='';$('#t_type2').value='';$('#t_route1').value='';$('#t_route2').value='';$('#t_start1').value='';$('#t_end1').value='';$('#t_start2').value='';$('#t_end2').value='';$('#t_rest_view').value='0 –º–∏–Ω—É—Ç';$('#t_night_view').value='0 –º–∏–Ω—É—Ç';$('#t_hours_view').value='0 –º–∏–Ω—É—Ç';$('#t_notes').value='';clearPassenger();$('#passengerBox').style.display='none'}
function tripSaveNew(){const t=tripSkeletonFromForm();t.id=Date.now();[t.route1,t.route2].forEach(r=>{if(r){let cache=getRoutesCache();if(!cache.includes(r)){cache.unshift(r);if(cache.length>50)cache.pop();setRoutesCache(cache)}});const arr=getTrips();arr.push(t);arr.sort((a,b)=>(a.date||'').localeCompare(b.date)||(a.id-b.id));setTrips(arr);openTripForm(false);renderTrips();updateDash()}
function tripOpen(id){const t=getTrips().find(x=>x.id===id);if(!t)return;currentTripId=id;$('#tripFormTitle').textContent='–ü–æ–µ–∑–¥–∫–∞: '+(t.route||'‚Äî');$('#tripButtonsNew').style.display='none';$('#tripButtonsEdit').style.display='';$('#tripEditBtn').style.display='';$('#tripViewBtn').style.display='none';$('#t_date').value=t.date||new Date().toISOString().slice(0,10);$('#t_date2').value=t.date2||'';$('#t_trainNo1').value=t.trainNo1||'';$('#t_trainNo2').value=t.trainNo2||'';currentTrainType1=t.trainType1||'';$('#t_type1').value=currentTrainType1;currentTrainType2=t.trainType2||'';$('#t_type2').value=currentTrainType2;$('#t_route1').value=t.route1||t.route||'';$('#t_route2').value=t.route2||'';$('#t_start1').value=t.start1||'';$('#t_end1').value=t.end1||'';$('#t_start2').value=t.start2||'';$('#t_end2').value=t.end2||'';$('#t_rest_view').value=t.rest?fmtHMWords(toNum(t.rest)):'0 –º–∏–Ω—É—Ç';const totalMin=Math.round(toNum(t.hours)*60);$('#t_hours_view').value=fmtHMWords(totalMin);$('#t_night_view').value=t.night?fmtHMWords(toNum(t.night)):'0 –º–∏–Ω—É—Ç';$('#t_notes').value=t.notes||'';pfollowDraft=t.pfollow||null;if(pfollowDraft&&pfollowDraft.enabled){$('#passengerBox').style.display='block';$('#pf_side').value=pfollowDraft.side||'to';$('#pf_date1').value=pfollowDraft.date1||'';$('#pf_route').value=pfollowDraft.route||'';$('#pf_wait').value=pfollowDraft.wait||0;$('#pf_dep').value=pfollowDraft.dep||'';$('#pf_arr').value=pfollowDraft.arr||'';$('#pf_date2').value=pfollowDraft.date2||'';}else{$('#passengerBox').style.display='none';clearPassenger()}buildRouteOptions();recalcDuration();tripToggleEdit(false);openTripForm(true)}
function tripSaveEdit(){if(currentTripId==null)return;let arr=getTrips();const ix=arr.findIndex(x=>x.id===currentTripId);if(ix<0)return;const updated={...arr[ix],...tripSkeletonFromForm()};arr[ix]=updated;arr.sort((a,b)=>(a.date||'').localeCompare(b.date)||(a.id-b.id));setTrips(arr);tripToggleEdit(false);openTripForm(false);renderTrips();updateDash()}
function tripCancel(){openTripForm(false);currentTripId=null}

/* ========= live & two-nights ========= */
function shouldBeLive(t){if(t.start1&&!t.end1)return'leg1';if(t.start2&&!t.end2)return'leg2';return''}
function humanSince(ms){if(ms==null||ms<0)return'‚Äî';const min=Math.floor(ms/60000);const h=Math.floor(min/60),m=min%60;return h+'—á '+String(m).padStart(2,'0')+'–º'}
function effectiveReturnDateForTrip(t){if(t.date2&&t.date2.trim())return t.date2.trim();if(t.start2&&t.end1&&toMin(t.start2)!=null&&toMin(t.end1)!=null&&toMin(t.start2)<toMin(t.end1))return dateAddDays(t.date,1);return t.date}
function isTwoNightsTrip(t){const tzMin=getSelectedTzOffsetMin();const date=t.date;if(!date)return false;const startEpoch=epochFromDateTimeTz(date,t.start1||t.start2,tzMin);const date2=effectiveReturnDateForTrip(t);const endEpoch=epochFromDateTimeTz(date2,t.end2||t.end1||t.start2||t.start1,tzMin);const cnt=countNightWindows0005(startEpoch,endEpoch,tzMin);return cnt>=2}
function updateLiveTimers(force){const tzMin=getSelectedTzOffsetMin();const now=Date.now();$all('[data-live-trip]').forEach(el=>{const id=Number(el.getAttribute('data-live-trip'));const t=(getTrips()||[]).find(x=>x.id===id);if(!t){el.textContent='';return}const mode=shouldBeLive(t);if(!mode){el.textContent='';return}const date=t.date||new Date().toISOString().slice(0,10);const date2=effectiveReturnDateForTrip(t);let startEpoch=(mode==='leg1')?epochFromDateTimeTz(date,t.start1,tzMin):epochFromDateTimeTz(date2,t.start2,tzMin);if(startEpoch==null){el.textContent='';return}el.textContent='–≤ –ø—É—Ç–∏ ¬∑ '+humanSince(now-startEpoch)});if(force){}}

/* ========= list & delete (–∫–æ–º–ø–∞–∫—Ç–Ω—ã–π) ========= */
function tripDel(id){if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–µ–∑–¥–∫—É?'))return;setTrips(getTrips().filter(x=>x.id!==id));renderTrips();updateDash()}
function renderTrips(){let box=$('#daysList');box.innerHTML='';let arr=getTrips().slice();arr.sort((a,b)=>(a.date||'').localeCompare(b.date)||(a.id-b.id));if(!arr.length){let d=document.createElement('div');d.className='small';d.style.opacity=.7;d.textContent='–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫';box.appendChild(d)}let totalMoney=0;arr.forEach(t=>{let h=toNum(t.hours);let m=tripMoney(h);totalMoney+=m;let row=document.createElement('div');row.className='trip';const live=shouldBeLive(t)?'<span class="badge-live" data-live-trip="'+t.id+'"></span>':'';const twoN=isTwoNightsTrip(t)?'<span class="badge-two">–¥–≤–µ –Ω–æ—á–∏</span>':'';row.innerHTML='<div><b>'+(t.date||'‚Äî')+'</b> ‚Ä¢ '+(t.route||t.route1||'‚Äî')+live+twoN+'</div>'+'<div>'+(h?(h.toFixed?h.toFixed(1):h):'‚Äî')+' —á</div>'+'<div class="money">'+(h?RUR.format(m):'‚Äî')+'</div>'+'<div><button class="btn" onclick="tripOpen('+t.id+')">üîç</button> <button class="btn" onclick="tripDel('+t.id+')">üóë</button></div>';box.appendChild(row)});if(arr.length){let sum=document.createElement('div');sum.className='small';sum.style.textAlign='right';sum.style.marginTop='6px';sum.style.opacity='.9';sum.textContent='–ò—Ç–æ–≥–æ –∑–∞ –º–µ—Å—è—Ü: '+RUR.format(totalMoney);box.appendChild(sum)}updateLiveTimers(true)}

/* ========= CSV ========= */
function csvEscape(v){if(v==null)return'';let s=String(v).replace(/"/g,'""');return /[",\n;]/.test(s)?('"'+s+'"'):s}
function exportTripsCsv(){let arr=getTrips().slice().sort((a,b)=>(a.date||'').localeCompare(b.date)||(a.id-b.id));let head=['–î–∞—Ç–∞','‚Ññ1','–í–∏–¥1','–ú–∞—Ä—à—Ä—É—Ç 1','–î–∞—Ç–∞2','‚Ññ2','–í–∏–¥2','–ú–∞—Ä—à—Ä—É—Ç 2','–¢—É–¥–∞ —è–≤–∫–∞','–¢—É–¥–∞ –∫–æ–Ω–µ—Ü','–û–±—Ä–∞—Ç–Ω–æ —è–≤–∫–∞','–û–±—Ä–∞—Ç–Ω–æ –∫–æ–Ω–µ—Ü','–û—Ç–¥—ã—Ö (–º–∏–Ω)','–ß–∞—Å—ã','–ù–æ—á–Ω—ã–µ (–º–∏–Ω)','–°–ª–µ–¥–æ–≤–∞–Ω–∏–µ','–ó–∞–º–µ—Ç–∫–∏','–î–µ–Ω—å–≥–∏'];let rows=[head];arr.forEach(t=>{rows.push([t.date||'',t.trainNo1||'',t.trainType1||'',t.route1||t.route||'',t.date2||'',t.trainNo2||'',t.trainType2||'',t.route2||'',t.start1||'',t.end1||'',t.start2||'',t.end2||'',toNum(t.rest)||0,toNum(t.hours)||0,toNum(t.night)||0,(t.pfollow&&t.pfollow.enabled)?(t.pfollow.side+' ‚Ä¢ '+(t.pfollow.route||'')):'', (t.notes||'').replace(/\n/g,' '),tripMoney(toNum(t.hours))])});let csv=rows.map(r=>r.map(csvEscape).join(';')).join('\n');let blob=new Blob([csv],{type:'text/csv;charset=utf-8'});let url=URL.createObjectURL(blob);let a=document.createElement('a');a.href=url;a.download='trips.csv';a.click();setTimeout(()=>URL.revokeObjectURL(url),500)}

/* ========= dashboard ========= */
function updateDash(){let t=getTar();let trips=getTrips().slice().sort((a,b)=>(a.date||'').localeCompare(b.date)||(a.id-b.id));let minsTotal=Math.round((trips.reduce((a,x)=>a+toNum(x.hours),0))*60);let nightTotal=trips.reduce((a,x)=>a+toNum(x.night),0);let norm=t.norm*60;let pct=norm?Math.round(minsTotal/norm*100):0;let rem=norm-minsTotal;$('#mwNorm').textContent=t.norm+' —á';$('#mwWorked').textContent=fmtM(minsTotal)+' (–Ω–æ—á–Ω—ã–µ: '+fmtHMWords(nightTotal)+')';$('#mwPercent').textContent=pct+'%';$('#mwRemain').textContent=rem>=0?('–û—Å—Ç–∞–ª–æ—Å—å: '+fmtM(rem)):('–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞: '+fmtM(-rem));$('#mwBar').style.width=Math.min(pct,100)+'%'}

/* ========= backup/import ========= */
function backup(){let data={tar:getTar(),trips:getTrips(),secs:getSecs(),routes:getRoutesCache(),tz:S('tz_pref'),profile:S('profile'),pfiles:S('pfiles')};let blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});let url=URL.createObjectURL(blob);let a=document.createElement('a');a.href=url;a.download='bm-backup.json';a.click();setTimeout(()=>URL.revokeObjectURL(url),500)}
function restoreFileChanged(e){let f=e.target.files[0];if(!f)return;let rd=new FileReader();rd.onload=()=>{try{let d=JSON.parse(rd.result);if(d.tar)S('tar',d.tar);if(d.trips)S('trips',d.trips);if(d.secs)S('secs',d.secs);if(d.routes)S('routes_cache',d.routes);if(d.tz)S('tz_pref',d.tz);if(d.profile)S('profile',d.profile);if(d.pfiles)S('pfiles',d.pfiles);init();alert('–ì–æ—Ç–æ–≤–æ')}catch(err){alert('–û—à–∏–±–∫–∞: '+err.message)}};rd.readAsText(f)}
function restoreFromText(){const raw=(document.getElementById('restoreText').value||'').trim();if(!raw){alert('–ü–æ–ª–µ –ø—É—Å—Ç–æ–µ');return}try{const d=JSON.parse(raw);if(d.tar)S('tar',d.tar);if(d.trips)S('trips',d.trips);if(d.secs)S('secs',d.secs);if(d.routes)S('routes_cache',d.routes);if(d.tz)S('tz_pref',d.tz);if(d.profile)S('profile',d.profile);if(d.pfiles)S('pfiles',d.pfiles);init();alert('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω')}catch(e){alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å JSON: '+e.message)}}
async function pasteFromClipboard(){try{if(!navigator.clipboard){alert('–ë—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');return}const txt=await navigator.clipboard.readText();document.getElementById('restoreText').value=txt||'';if(!txt)alert('–í –±—É—Ñ–µ—Ä–µ –æ–±–º–µ–Ω–∞ –ø—É—Å—Ç–æ')}catch(e){alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –±—É—Ñ–µ—Ä: '+e.message)}}

/* ========= –ü–æ–ª–Ω—ã–π –æ—Ç–¥—ã—Ö ========= */
function closeFullRest(){const box=$('#restResult');if(box){box.innerHTML=''}}
function calcFullRest(){const arr=getTrips();if(!arr.length){alert('–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫');return}const t=arr.slice().sort((a,b)=>(a.date||'').localeCompare(b.date)||(a.id-b.id)).pop();const d1=diffMinutes(t.start1,t.end1)||0;const date2=effectiveReturnDateForTrip(t);const d2=diffMinutes(t.start2,t.end2)||0;const totalWorkMin=d1+d2;const restMin=toNum(t.rest)||0;const tzMin=getSelectedTzOffsetMin();const startEpoch=epochFromDateTimeTz(t.date,t.start1||t.start2,tzMin);const endEpoch=epochFromDateTimeTz(date2,t.end2||t.end1||t.start2||t.start1,tzMin);const twoNights=countNightWindows0005(startEpoch,endEpoch,tzMin)>=2;const fullRestMin=Math.max(0,Math.round(totalWorkMin*2.6-(twoNights?0:restMin)));const fullRestWithDayMin=fullRestMin+24*60;const endBackEpoch=epochFromDateTimeTz(date2,t.end2||t.start2||t.end1||t.start1,tzMin);let endRest=null,endRestW=null;if(endBackEpoch!=null){endRest=addMinutesEpoch(endBackEpoch,fullRestMin);endRestW=addMinutesEpoch(endBackEpoch,fullRestWithDayMin)}const box=$('#restResult');box.innerHTML='';let top=document.createElement('div');top.className='metrics';top.innerHTML=`<div class="metric"><b>–í—Ä–µ–º—è –Ω–∞ —Ä–∞–±–æ—Ç–µ</b><span>${fmtHMWords(totalWorkMin)}</span></div><div class="metric"><b>–û—Ç–¥—ã—Ö –º–µ–∂–¥—É –ø–ª–µ—á–∞–º–∏</b><span>${restMin?fmtHMWords(restMin):'‚Äî'}</span></div><div class="metric"><b>–ü–æ–ª–Ω—ã–π –æ—Ç–¥—ã—Ö</b><span>${fmtHMWords(fullRestMin)}</span></div><div class="metric"><b>–° –≤—ã—Ö–æ–¥–Ω—ã–º</b><span>${fmtHMWords(fullRestWithDayMin)}</span></div>`;box.appendChild(top);let details=document.createElement('div');details.className='card';details.style.marginTop='8px';details.innerHTML=`<div class="kv"><div>–ü–æ–µ–∑–¥–∫–∞</div><div>${t.date||'‚Äî'} ‚Ä¢ ${t.route1||t.route||'‚Äî'}</div><div>–î–≤–µ –Ω–æ—á–∏ (00‚Äì05)</div><div>${twoNights?'–î–∞':'–ù–µ—Ç'}</div><div>–û–∫–æ–Ω—á–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞</div><div>${endRest?fmtLocalFull(endRest,tzMin):'‚Äî'}</div><div>–û–∫–æ–Ω—á–∞–Ω–∏–µ —Å –≤—ã—Ö–æ–¥–Ω—ã–º</div><div>${endRestW?fmtLocalFull(endRestW,tzMin):'‚Äî'}</div></div>`;box.appendChild(details)}

/* ========= –ö–∞–ª–µ–Ω–¥–∞—Ä—å ========= */
function openCalendar(){const box=$('#calendarBox');box.innerHTML='';const trips=getTrips().slice().sort((a,b)=>(a.date||'').localeCompare(b.date));if(!trips.length){box.textContent='–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫';return}const byDay={};trips.forEach(t=>{const k=t.date||'‚Äî';if(!byDay[k])byDay[k]=[];byDay[k].push(t)});const table=document.createElement('table');let html='<thead><tr><th>–î–∞—Ç–∞</th><th>–ü–æ–µ–∑–¥–∫–∏</th><th>–ß–∞—Å—ã</th><th>‚ÇΩ</th></tr></thead><tbody>';Object.keys(byDay).sort().forEach(d=>{const list=byDay[d];const h=list.reduce((s,x)=>s+toNum(x.hours),0);const m=list.reduce((s,x)=>s+tripMoney(toNum(x.hours)),0);const titles=list.map(x=>x.route1||x.route||'‚Äî').join(', ');html+=`<tr><td>${d}</td><td>${titles}</td><td>${h.toFixed(1)}</td><td>${RUR.format(m)}</td></tr>`});html+='</tbody>';table.innerHTML=html;box.appendChild(table)}
function closeCalendar(){$('#calendarBox').innerHTML=''}

/* ========= –†–ñ–î-–∑–∞—Ä–ø–ª–∞—Ç–∞ ========= */
function ensurePin(){const pin=localStorage.getItem('rzd_pin');if(!pin)return true;const entered=prompt('PIN –¥–ª—è ¬´–†–ñ–î-–∑–∞—Ä–ø–ª–∞—Ç–∞¬ª:');return entered===pin}
function openRzdSalary(){if(!ensurePin())return alert('–ù–µ–≤–µ—Ä–Ω—ã–π PIN');const box=$('#rzdBox');box.innerHTML='';const t=getTar();const trips=getTrips().slice().sort((a,b)=>(a.date||'').localeCompare(b.date)||(a.id-b.id));if(!trips.length){box.textContent='–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';return}let monthKey=(s)=>s?s.slice(0,7):'0000-00';let byM={};trips.forEach(tr=>{const mk=monthKey(tr.date);if(!byM[mk])byM[mk]={list:[],money:0,h1:0,h2:0};const calc=salaryForTrip(tr);byM[mk].list.push({tr,calc});byM[mk].money+=calc.money;byM[mk].h1+=calc.h1;byM[mk].h2+=calc.h2});Object.keys(byM).sort().forEach(mk=>{const sec=document.createElement('div');sec.className='card';let rows='<table style="width:100%;border-collapse:collapse;margin-top:6px"><thead><tr><th style="text-align:left">–î–∞—Ç–∞</th><th>–ú–∞—Ä—à—Ä—É—Ç</th><th>h1¬∑k1</th><th>h2¬∑k2</th><th>‚ÇΩ</th></tr></thead><tbody>';byM[mk].list.forEach(({tr,calc})=>{rows+=`<tr><td>${tr.date||''}</td><td>${tr.route1||tr.route||''}${tr.route2?(' / '+tr.route2):''}</td><td>${calc.h1.toFixed(1)}√ó${calc.coef1.toFixed(2)}</td><td>${calc.h2.toFixed(1)}√ó${calc.coef2.toFixed(2)}</td><td>${RUR.format(calc.money)}</td></tr>`});rows+=`</tbody></table><div style="text-align:right;margin-top:6px">–ò—Ç–æ–≥–æ ${mk}: <b>${RUR.format(Math.round(byM[mk].money))}</b></div>`;sec.innerHTML=`<b>${mk}</b>${rows}`;box.appendChild(sec)})}
function closeRzdSalary(){$('#rzdBox').innerHTML=''}
function savePIN(){const v=($('#pin_input').value||'').trim();if(!v){localStorage.removeItem('rzd_pin');alert('PIN –æ—á–∏—â–µ–Ω');return}localStorage.setItem('rzd_pin',v);alert('PIN —Å–æ—Ö—Ä–∞–Ω—ë–Ω')}

/* ========= Profile ========= */
function getProfile(){return S('profile')||{first:'',last:'',age:'',role:'',place:'',start:'',photo:''}}
function setProfile(p){S('profile',p)}
function loadProfile(){const p=getProfile();$('#pf_first').value=p.first||'';$('#pf_last').value=p.last||'';$('#pf_age').value=p.age||'';$('#pf_role').value=p.role||'';$('#pf_place').value=p.place||'';$('#pf_start').value=p.start||'';renderTenure();if(p.photo){$('#pfAvatarBig').src=p.photo}else{$('#pfAvatarBig').removeAttribute('src')}renderProfileFiles()}
function renderTenure(){const start=$('#pf_start').value;if(!start){$('#pf_tenure').value='';return}const a=new Date(start+'T00:00:00');const b=new Date();let years=b.getFullYear()-a.getFullYear();let months=b.getMonth()-a.getMonth();let days=b.getDate()-a.getDate();if(days<0){months--}if(months<0){years--;months+=12}$('#pf_tenure').value=`${years} ${plural(years,'–≥–æ–¥','–≥–æ–¥–∞','–ª–µ—Ç')} ${months} ${plural(months,'–º–µ—Å—è—Ü','–º–µ—Å—è—Ü–∞','–º–µ—Å—è—Ü–µ–≤')}`}
function profilePhotoChanged(e){const f=e.target.files[0];if(!f)return;const rd=new FileReader();rd.onload=()=>{$('#pfAvatarBig').src=rd.result};rd.readAsDataURL(f)}
function profileSave(){const p=getProfile();p.first=$('#pf_first').value||'';p.last=$('#pf_last').value||'';p.age=$('#pf_age').value||'';p.role=$('#pf_role').value||'';p.place=$('#pf_place').value||'';p.start=$('#pf_start').value||'';const img=$('#pfAvatarBig');if(img&&img.src)p.photo=img.src;setProfile(p);alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω')}
function profileFiles(){return S('pfiles')||[]}function setProfileFiles(a){S('pfiles',a)}
function profileAddFiles(e){const files=Array.from(e.target.files||[]);if(!files.length)return;let list=profileFiles();let pending=files.length;files.forEach(f=>{const rd=new FileReader();rd.onload=()=>{list.push({id:Date.now()+Math.random(),name:f.name,dataUrl:rd.result,type:f.type,size:f.size,addedAt:Date.now()});pending--;if(pending===0){setProfileFiles(list);renderProfileFiles();e.target.value=''}};rd.readAsDataURL(f)})}
function renderProfileFiles(){const box=$('#pf_files_list');box.innerHTML='';const list=profileFiles().slice().sort((a,b)=>a.name.localeCompare(b.name));if(!list.length){box.innerHTML='<div class="small" style="opacity:.7">–§–∞–π–ª—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>';return}list.forEach(f=>{const row=document.createElement('div');row.className='file-item';const left=document.createElement('div');left.innerHTML=`<div><b>${f.name}</b></div><div class="small" style="opacity:.7">${f.type||'file'} ‚Ä¢ ${(f.size/1024).toFixed(1)} –ö–ë</div>`;const right=document.createElement('div');const a=document.createElement('a');a.href=f.dataUrl;a.download=f.name;a.textContent='–°–∫–∞—á–∞—Ç—å';a.className='btn';a.style.marginRight='6px';const del=document.createElement('button');del.className='btn';del.textContent='üóë';del.onclick=()=>{let l=profileFiles().filter(x=>x.id!==f.id);setProfileFiles(l);renderProfileFiles()};right.appendChild(a);right.appendChild(del);row.appendChild(left);row.appendChild(right);box.appendChild(row)})}

/* ========= init ========= */
function init(){applyTheme();updateNetPill();loadTar();tzPopulateSelect();renderTrips();renderSecs();buildRouteOptions();updateDash();setInterval(updateLiveTimers,30000)}
init();

/* ========= PWA ========= */
(function(){const usp=new URLSearchParams(location.search);if(usp.get('no-sw')==='1'){if('serviceWorker'in navigator){navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister()))}if(window.caches)caches.keys().then(ks=>ks.forEach(k=>caches.delete(k)));console.log('SW disabled by ?no-sw=1');return}
window.appUpdate=async function(){try{if(!('serviceWorker'in navigator)){location.reload();return}const reg=await navigator.serviceWorker.getRegistration();if(!reg){location.reload();return}if(reg.waiting)reg.waiting.postMessage({type:'SKIP_WAITING'});else await reg.update();let reloaded=false;navigator.serviceWorker.addEventListener('controllerchange',()=>{if(!reloaded){reloaded=true;location.replace(location.pathname+'?cb='+Date.now())}});setTimeout(()=>{if(!reloaded)location.replace(location.pathname+'?cb='+Date.now())},1000)}catch(e){location.reload()}}
window.addEventListener('load',function(){if(!('serviceWorker'in navigator))return;const scope=location.pathname.replace(/\/[^\/]*$/,'/')||'/';navigator.serviceWorker.register('sw.js',{scope}).then(reg=>{const btn=document.getElementById('appRefresh');function showRefresh(){if(btn)btn.style.display=''}if(reg.waiting)showRefresh();reg.addEventListener('updatefound',()=>{const nw=reg.installing;if(!nw)return;nw.addEventListener('statechange',()=>{if(nw.state==='installed'&&navigator.serviceWorker.controller)showRefresh()})});navigator.serviceWorker.addEventListener('controllerchange',()=>{if(btn)btn.style.display='none'})}).catch(err=>console.warn('SW register failed',err))})})();
</script>
</body>
</html>
