<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>–ë–ª–æ–∫–Ω–æ—Ç –º–∞—à–∏–Ω–∏—Å—Ç–∞ ¬∑ Lite v2025.27B-HOTFIX</title>
<meta name="theme-color" content="#d32f2f">
<base href="./">
<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0}
:root{--red:#d32f2f;--bg:#0f1420;--card:#161d2a;--line:#243246;--mut:#8aa0b6;--txt:#e9eef5}
body{background:var(--bg);color:var(--txt);font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
header{position:sticky;top:0;background:var(--red);color:#fff;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;z-index:10}
h1{margin:0;font-size:18px}
.badge{font-size:12px;padding:2px 8px;border:1px solid rgba(255,255,255,.4);border-radius:999px}
.container{padding:12px 12px 90px}
.view{display:none}.view.active{display:block}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:10px}
.row{display:flex;gap:8px;align-items:center;margin:8px 0}
.row label{width:46%;color:var(--mut);font-size:14px}
.row input,.row select,.row textarea{flex:1;background:#0e1622;border:1px solid var(--line);color:#e9eef5;padding:10px;border-radius:10px;font-size:16px}
.row textarea{min-height:90px;resize:vertical}
.btn{background:#1b2738;color:#fff;border:1px solid var(--line);padding:10px 14px;border-radius:10px;font-size:15px;cursor:pointer}
.btn.primary{background:#fff;color:#d32f2f;border-color:#fff}
.small{font-size:12px}.mono{font-variant-numeric:tabular-nums}
.progress{height:10px;border:1px solid var(--line);border-radius:999px;overflow:hidden;background:#0f2035}
.progress>div{height:100%;background:#d32f2f;width:0%}
.trip{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid #233246}
.trip:last-child{border-bottom:0}
.actions{display:flex;gap:6px}
.badge-live{display:inline-block;background:rgba(211,47,47,.15);border:1px solid rgba(211,47,47,.6);color:#ff8a80;padding:2px 6px;border-radius:999px;font-size:12px;margin-left:6px;white-space:nowrap}
.money{white-space:nowrap}
.tabbar{position:fixed;left:0;right:0;bottom:0;height:70px;background:#121828;border-top:1px solid var(--line);display:flex}
.tabbar button{flex:1;background:transparent;border:none;color:#8aa0b6;font-size:12px;padding:6px 0}
.tabbar button.active{color:#fff}
.tabbar .ico{display:block;font-size:18px;margin-bottom:4px}
#toast{position:fixed;left:50%;bottom:84px;transform:translateX(-50%);background:#182436;color:#fff;border:1px solid #2c3b53;padding:10px 14px;border-radius:10px;display:none;z-index:9999}
#diag{position:fixed;left:8px;bottom:8px;background:#1a2a1a;color:#9eff9e;border:1px solid #2f7f2f;padding:6px 8px;border-radius:8px;font:12px/1.2 -apple-system,system-ui;z-index:99999}
#diag.err{background:#5b1a1a;color:#fff;border-color:#b33}
</style>
</head>
<body>

<!-- –Ø–î–ï–†–ù–ê–Ø –æ—á–∏—Å—Ç–∫–∞ SW/–∫—ç—à–∞ + –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä + –ª–æ–≤—É—à–∫–∞ –æ—à–∏–±–æ–∫ -->
<script>
(function(){
  const box=document.createElement('div'); box.id='diag'; box.textContent='JS –∂–∏–≤–æ–π ¬∑ SW –æ—á–∏—â–µ–Ω ¬∑ v27B';
  document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(box));
  window.addEventListener('error',e=>{ box.classList.add('err'); box.textContent='–û—à–∏–±–∫–∞ JS ‚Üí '+e.message; });
  (async()=>{try{
    if(navigator.serviceWorker?.getRegistrations){for(const r of await navigator.serviceWorker.getRegistrations()){try{await r.unregister()}catch{}}}
    if(self.caches?.keys){for(const k of await caches.keys()){try{await caches.delete(k)}catch{}}}
  }catch(e){}})();
})();
</script>

<header>
  <h1>–ë–ª–æ–∫–Ω–æ—Ç –ú–∞—à–∏–Ω–∏—Å—Ç–∞</h1>
  <div class="badge">Lite v2025.27B-HOTFIX</div>
</header>

<main class="container">
  <!-- –ì–õ–ê–í–ù–ê–Ø -->
  <section id="v-dashboard" class="view active">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>–ú–µ—Å—è—á–Ω–∞—è –Ω–æ—Ä–º–∞</b><b id="mwNorm">‚Äî</b>
      </div>
      <div class="progress" style="margin-top:6px"><div id="mwBar"></div></div>

      <div class="row"><label>–ù–æ—Ä–º–∞, —á/–º–µ—Å</label><input id="tar_norm" type="number" inputmode="decimal" placeholder="176" oninput="tarSave()"></div>
      <div class="row"><label>–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ (–≤–∫–ª. ¬´–≤ –ø—É—Ç–∏¬ª)</label><div id="mwWorked" class="small mono">‚Äî</div></div>
      <div class="row"><label>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</label><div id="mwPercent" class="small mono">‚Äî</div></div>
      <div class="row"><label>–û—Å—Ç–∞–ª–æ—Å—å/–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞</label><div id="mwRemain" class="small mono">‚Äî</div></div>
      <div class="row"><label>–ó–∞—Ä–ø–ª–∞—Ç–∞ (–∞–∫—Ç—É–∞–ª—å–Ω–æ)</label><div id="mwSalary" class="small mono">‚Äî</div></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <b>–ü–æ–µ–∑–¥–∫–∏</b>
        <div>
          <button class="btn primary" type="button" onclick="addTripOpen()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn" type="button" onclick="exportTripsCsv()">CSV</button>
        </div>
      </div>

      <!-- –§–æ—Ä–º–∞ –ø–æ–µ–∑–¥–∫–∏ -->
      <div id="tripForm" class="card" style="display:none;margin-top:10px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <b id="tripFormTitle">–ù–æ–≤–∞—è –ø–æ–µ–∑–¥–∫–∞</b>
          <div>
            <button id="tripEditBtn" class="btn" type="button" style="display:none" onclick="tripToggleEdit(true)">‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button id="tripViewBtn" class="btn" type="button" style="display:none" onclick="tripToggleEdit(false)">üîí –ü—Ä–æ—Å–º–æ—Ç—Ä</button>
          </div>
        </div>

        <div class="row"><label>–î–∞—Ç–∞</label><input id="t_date" type="date"></div>

        <div class="row"><label>–ú–∞—Ä—à—Ä—É—Ç 1 (—Ç—É–¥–∞)</label>
          <input id="t_route1" list="routeList" placeholder="–Ω–∞–ø—Ä.: –ú–∞–ª–æ—à—É–π–∫–∞ ‚Äî –û–±–æ–∑–µ—Ä—Å–∫–∞—è">
          <datalist id="routeList"></datalist>
        </div>
        <div class="row"><label>–ú–∞—Ä—à—Ä—É—Ç 2 (–æ–±—Ä–∞—Ç–Ω–æ)</label>
          <input id="t_route2" list="routeList" placeholder="–Ω–∞–ø—Ä.: –û–±–æ–∑–µ—Ä—Å–∫–∞—è ‚Äî –ú–∞–ª–æ—à—É–π–∫–∞">
        </div>

        <div class="row"><label>–Ø–≤–∫–∞ (—Ç—É–¥–∞)</label><input id="t_start1" type="time" oninput="recalcDuration()"></div>
        <div class="row"><label>–ö–æ–Ω–µ—Ü —Ä–∞–±–æ—Ç—ã (—Ç—É–¥–∞)</label><input id="t_end1" type="time" oninput="recalcDuration()"></div>

        <div class="row"><label>–Ø–≤–∫–∞ (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_start2" type="time" oninput="recalcDuration()"></div>
        <div class="row"><label>–ö–æ–Ω–µ—Ü —Ä–∞–±–æ—Ç—ã (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_end2" type="time" oninput="recalcDuration()"></div>

        <div class="card" style="background:#0f1622">
          <div class="row"><label>–û—Ç–¥—ã—Ö (–º–∏–Ω, –∞–≤—Ç–æ)</label><input id="t_rest" type="number" inputmode="numeric" value="0" readonly></div>
          <div class="row"><button class="btn" type="button" onclick="calcRest()">–ü–æ—Å—á–∏—Ç–∞—Ç—å –æ—Ç–¥—ã—Ö</button></div>
          <div class="row"><label>–ú–∏–Ω. –æ—Ç–¥—ã—Ö (1/2 —Å–º–µ–Ω—ã, ‚â•4—á)</label><input id="rest_min_minutes" type="text" readonly></div>
          <div class="row"><label>–ö–æ–Ω–µ—Ü –æ—Ç–¥—ã—Ö–∞ (–º–∏–Ω.)</label><input id="rest_min_endtime" type="text" readonly></div>
          <div class="row"><label>–ö–æ–Ω–µ—Ü –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞</label><input id="rest_full_endtime" type="text" readonly></div>
          <div class="row"><button class="btn" type="button" onclick="applyRestAsStart2()">‚§¥Ô∏é –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–∞–∫ ¬´–Ø–≤–∫–∞ (–æ–±—Ä–∞—Ç–Ω–æ)¬ª</button></div>
        </div>

        <div class="row"><label>–ß–∞—Å—ã (–∏—Ç–æ–≥, –±–µ–∑ –æ—Ç–¥—ã—Ö–∞)</label><input id="t_hours" type="number" inputmode="decimal" step="0.1" readonly></div>
        <div class="row"><label>–ó–∞–º–µ—Ç–∫–∏</label><textarea id="t_notes" placeholder="–ü—Ä–æ—Å—Ç–æ–∏, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏‚Ä¶"></textarea></div>

        <div class="row" id="tripButtonsNew">
          <button class="btn primary" type="button" onclick="tripSaveNew()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn" type="button" onclick="tripCancel()">–û—Ç–º–µ–Ω–∞</button>
        </div>

        <div class="row" id="tripButtonsEdit" style="display:none">
          <button class="btn primary" type="button" onclick="tripSaveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
          <button class="btn" type="button" onclick="tripCancel()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>

      <div id="daysList" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- –£–ß–ê–°–¢–ö–ò -->
  <section id="v-sections" class="view">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>–£—á–∞—Å—Ç–∫–∏</b><div class="actions"><button class="btn" type="button" onclick="sectionOpen()">–ù–æ–≤—ã–π —É—á–∞—Å—Ç–æ–∫</button></div>
      </div>

      <div id="sectionForm" class="card" style="display:none;margin-top:10px">
        <div class="row"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="s_name" placeholder="–ù–∞–ø—Ä.: –ú–∞–ª–æ—à—É–π–∫–∞ ‚Äî –û–±–æ–∑–µ—Ä—Å–∫–∞—è"></div>
        <div class="row"><label>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label><input id="s_from"></div>
        <div class="row"><label>–ü—Ä–∏–±—ã—Ç–∏–µ</label><input id="s_to"></div>
        <div class="row"><label>–î–ª–∏–Ω–∞ (–∫–º)</label><input id="s_len" type="number" inputmode="decimal" placeholder="0"></div>
        <div class="row">
          <button id="s_save_btn" class="btn primary" type="button" onclick="sectionSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn" type="button" onclick="sectionCancel()">–û—Ç–º–µ–Ω–∞</button>
        </div>
        <div class="small" id="s_hint" style="opacity:.7"></div>
      </div>

      <div id="sectionList"></div>
    </div>
  </section>

  <!-- –¢–ê–†–ò–§–´ / –ß–ê–°–û–í–û–ô –ü–û–Ø–° -->
  <section id="v-tariffs" class="view">
    <div class="card">
      <b>–¢–∞—Ä–∏—Ñ –∏ –Ω–∞–¥–±–∞–≤–∫–∏</b>
      <div class="row"><label>‚ÇΩ/—á–∞—Å (—Å—Ç–∞–≤–∫–∞)</label><input id="tar_base" type="number" inputmode="decimal" placeholder="358.46"></div>
      <div class="row"><label>–†–∞–π–æ–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç, %</label><input id="tar_rc" type="number" inputmode="decimal" placeholder="20"></div>
      <div class="row"><label>–°–µ–≤–µ—Ä–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç, %</label><input id="tar_north" type="number" inputmode="decimal" placeholder="50"></div>
      <div class="row"><label>–ù–∞–¥–±–∞–≤–∫–∞ –∑–∞ –∫–ª–∞—Å—Å, %</label><input id="tar_cls" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><label>–ó–æ–Ω–∞–ª—å–Ω–∞—è –Ω–∞–¥–±–∞–≤–∫–∞, %</label><input id="tar_zone" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><label>–ë–ê–ú-–Ω–∞–¥–±–∞–≤–∫–∞, %</label><input id="tar_bam" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><label>–ö–æ–º. —Ä–∞—Å—Ö–æ–¥—ã (–∑–∞ –ø–æ–µ–∑–¥–∫—É), ‚ÇΩ</label><input id="tar_fee" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><button class="btn primary" type="button" onclick="tarSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ</button></div>
    </div>

    <div class="card">
      <b>–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</b>
      <div class="row">
        <label>–ü–æ—è—Å</label>
        <select id="tz_select" onchange="tzSave()"></select>
      </div>
      <div class="small" style="opacity:.8">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ª–∞–π–≤-—Ç–∞–π–º–µ—Ä–∞ ¬´–í –ø—É—Ç–∏¬ª –∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∑–∞—Ä–ø–ª–∞—Ç—ã.</div>
    </div>
  </section>

  <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
  <section id="v-settings" class="view">
    <div class="card">
      <b>–ë—ç–∫–∞–ø / –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</b>
      <div class="row"><button class="btn" type="button" onclick="backup()">–°–∫–∞—á–∞—Ç—å JSON</button></div>
      <div class="row"><input id="restoreFile" type="file" accept="application/json" onchange="restoreFileChanged(event)"></div>
      <div class="small" style="opacity:.8">–í–µ—Ä—Å–∏—è Lite 2025.27B-HOTFIX</div>
    </div>
  </section>
</main>

<nav class="tabbar">
  <button class="active" data-tab="dashboard" onclick="nav(this)"><span class="ico">üè†</span>–ì–ª–∞–≤–Ω–∞—è</button>
  <button data-tab="sections" onclick="nav(this)"><span class="ico">üó∫Ô∏è</span>–£—á–∞—Å—Ç–∫–∏</button>
  <button data-tab="tariffs" onclick="nav(this)"><span class="ico">üí≥</span>–¢–∞—Ä–∏—Ñ</button>
  <button data-tab="settings" onclick="nav(this)"><span class="ico">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</nav>

<div id="toast"></div>

<script>
/* ===== helpers ===== */
const $=s=>document.querySelector(s), $all=s=>Array.from(document.querySelectorAll(s));
const S=(k,v)=> (arguments.length===2?(localStorage.setItem(k,JSON.stringify(v)),v):((v=localStorage.getItem(k))?JSON.parse(v):null));
const RUR=new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:0});
const toNum=v=>{let n=Number(v);return isNaN(n)?0:n}
const fmtM=min=>min==null?'‚Äî':(Math.floor(min/60)+'—á '+String(min%60).padStart(2,'0')+'–º');
function toast(t){const el=$('#toast');el.textContent=t;el.style.display='block';clearTimeout(toast._t);toast._t=setTimeout(()=>el.style.display='none',1600)}

/* ===== timezone ===== */
function tzList(){return ['AUTO','UTC-12:00','UTC-11:00','UTC-10:00','UTC-09:30','UTC-09:00','UTC-08:00','UTC-07:00','UTC-06:00','UTC-05:00','UTC-04:30','UTC-04:00','UTC-03:30','UTC-03:00','UTC-02:00','UTC-01:00','UTC+00:00','UTC+01:00','UTC+02:00','UTC+03:00','UTC+03:30','UTC+04:00','UTC+04:30','UTC+05:00','UTC+05:30','UTC+05:45','UTC+06:00','UTC+06:30','UTC+07:00','UTC+08:00','UTC+08:45','UTC+09:00','UTC+09:30','UTC+10:00','UTC+10:30','UTC+11:00','UTC+12:00','UTC+12:45','UTC+13:00','UTC+14:00']}
function parseOffset(label){if(label==='AUTO')return null;const m=label.match(/UTC([+-])(\d{2}):(\d{2})/);if(!m)return 0;const s=m[1]==='-'?-1:1,h=+m[2],mm=+m[3];return s*(h*60+mm)}
function tzPref(){return S('tz_pref')||{mode:'AUTO'}}
function getTzOffsetMin(){const p=tzPref();return p.mode==='AUTO'?-new Date().getTimezoneOffset():(p.offsetMin||0)}
function tzPopulate(){const sel=$('#tz_select');sel.innerHTML='';tzList().forEach(lb=>{const o=document.createElement('option');o.value=lb;o.textContent=(lb==='AUTO'?'–ê–≤—Ç–æ (—Å–∏—Å—Ç–µ–º–Ω—ã–π)':lb);sel.appendChild(o)});const p=tzPref();sel.value=(p.mode==='AUTO'?'AUTO':(p.label||'AUTO'))}
function tzSave(){const lb=$('#tz_select').value;if(lb==='AUTO')S('tz_pref',{mode:'AUTO'});else S('tz_pref',{mode:'FIX',label:lb,offsetMin:parseOffset(lb)});updateLive(true);updateDash()}

/* ===== time math ===== */
const toMin=hhmm=>{if(!hhmm)return null;let [H,M]=hhmm.split(':').map(Number);if(isNaN(H)||isNaN(M))return null;return H*60+M}
const diffMin=(a,b)=>{let x=toMin(a),y=toMin(b);if(x==null||y==null)return null;let d=y-x;return d<0?d+1440:d}
const addMin=(hhmm,add)=>{let m=toMin(hhmm);if(m==null)return'';m=(m+add)%(24*60);if(m<0)m+=1440;let h=Math.floor(m/60),mm=m%60;return String(h).padStart(2,'0')+':'+String(mm).padStart(2,'0')}
function epochFrom(dateStr,timeStr,off){if(!dateStr||!timeStr)return null;const [Y,M,D]=dateStr.split('-').map(Number);const [h,m]=timeStr.split(':').map(Number);if([Y,M,D,h,m].some(isNaN))return null;return Date.UTC(Y,M-1,D,h,m)-(off*60000)}

/* ===== data ===== */
const getTar=()=>S('tar')||{base:358.46,norm:176,rc:20,north:50,cls:0,zone:0,bam:0,fee:0}
function tarSave(){let t=getTar();t.base=toNum($('#tar_base').value)||t.base;t.norm=toNum($('#tar_norm').value)||t.norm;t.rc=toNum($('#tar_rc').value)||0;t.north=toNum($('#tar_north').value)||0;t.cls=toNum($('#tar_cls').value)||0;t.zone=toNum($('#tar_zone').value)||0;t.bam=toNum($('#tar_bam').value)||0;t.fee=toNum($('#tar_fee').value)||0;S('tar',t);updateDash();renderTrips()}
function loadTar(){let t=getTar();$('#tar_base').value=t.base;$('#tar_norm').value=t.norm;$('#tar_rc').value=t.rc;$('#tar_north').value=t.north;$('#tar_cls').value=t.cls;$('#tar_zone').value=t.zone;$('#tar_bam').value=t.bam;$('#tar_fee').value=t.fee}

const getSecs=()=>S('secs')||[], setSecs=a=>S('secs',a)
const getTrips=()=>S('trips')||[], setTrips=a=>S('trips',a)
const getRoutesCache=()=>S('routes_cache')||[], setRoutesCache=a=>S('routes_cache',a)

function titleForSection(s){let t=(s.name||'').trim()||(s.from||'')+' ‚Äî '+(s.to||'');return t.replace(/\s+/g,' ').trim()}

/* ===== money ===== */
function tripMoney(hours,includeFee=true){
  const t=getTar();const pct=(t.rc+t.north+t.cls+t.zone+t.bam)/100;
  let gross=hours*t.base*(1+pct);let net=includeFee?(gross-(t.fee||0)):gross;
  return Math.max(0,Math.round(net));
}

/* ===== nav ===== */
function nav(btn){$all('.tabbar button').forEach(x=>x.classList.remove('active'));btn.classList.add('active');$all('.view').forEach(v=>v.classList.remove('active'));$('#v-'+btn.dataset.tab).classList.add('active')}

/* ===== sections ===== */
let editingSectionId=null;
function sectionOpen(){editingSectionId=null;$('#sectionForm').style.display='block';$('#s_name').value='';$('#s_from').value='';$('#s_to').value='';$('#s_len').value='';$('#s_save_btn').textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';$('#s_hint').textContent='–ù–æ–≤—ã–π —É—á–∞—Å—Ç–æ–∫'}
function sectionCancel(){$('#sectionForm').style.display='none';editingSectionId=null}
function sectionEdit(id){const s=getSecs().find(x=>x.id===id);if(!s)return;editingSectionId=id;$('#sectionForm').style.display='block';$('#s_name').value=s.name||'';$('#s_from').value=s.from||'';$('#s_to').value=s.to||'';$('#s_len').value=(s.len!=null?s.len:'');$('#s_save_btn').textContent='–û–±–Ω–æ–≤–∏—Ç—å';$('#s_hint').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—á–∞—Å—Ç–∫–∞'}
function sectionSave(){const a=getSecs();const obj={id:editingSectionId||Date.now(),name:($('#s_name').value||'').trim(),from:($('#s_from').value||'').trim(),to:($('#s_to').value||'').trim(),len:toNum($('#s_len').value)};if(editingSectionId){const i=a.findIndex(x=>x.id===editingSectionId);if(i>=0)a[i]=obj}else a.push(obj);setSecs(a);$('#sectionForm').style.display='none';renderSecs();buildRouteOptions()}
function sectionDel(id,e){e&&e.stopPropagation();if(!confirm('–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–æ–∫?'))return;setSecs(getSecs().filter(x=>x.id!==id));renderSecs();buildRouteOptions()}
function renderSecs(){const box=$('#sectionList');box.innerHTML='';const a=getSecs();if(!a.length){box.innerHTML='<div class="small" style="opacity:.7">–ù–µ—Ç —É—á–∞—Å—Ç–∫–æ–≤</div>';return}
  a.forEach(s=>{const title=titleForSection(s);const info=(s.from||'‚Äî')+' ‚Üí '+(s.to||'‚Äî')+(s.len?(' ‚Ä¢ '+s.len+' –∫–º'):'');
    const r=document.createElement('div');r.className='row';r.innerHTML='<div style="flex:1"><b>'+title+'</b><div class="small" style="opacity:.7">'+info+'</div></div><div class="actions"><button class="btn" type="button" onclick="sectionEdit('+s.id+')">‚úé</button><button class="btn" type="button" onclick="sectionDel('+s.id+',event)">üóë</button></div>';
    box.appendChild(r);
  });
}

/* ===== routes datalist ===== */
function buildRouteOptions(){
  const dl=$('#routeList');dl.innerHTML='';const used=new Set();
  getSecs().forEach(s=>{const t=titleForSection(s);if(t&&!used.has(t)){used.add(t);const o=document.createElement('option');o.value=t;dl.appendChild(o)}})
  ;(getRoutesCache()).forEach(r=>{const t=(r||'').trim();if(t&&!used.has(t)){used.add(t);const o=document.createElement('option');o.value=t;dl.appendChild(o)}})
  ;(getTrips()).forEach(t=>{[t.route1,t.route2,t.route].forEach(r=>{const rr=(r||'').trim();if(rr&&!used.has(rr)){used.add(rr);const o=document.createElement('option');o.value=rr;dl.appendChild(o)}})});
}

/* ===== trips ===== */
let currentTripId=null, editOn=true;
function setReadonly(ro){['t_date','t_route1','t_route2','t_start1','t_end1','t_start2','t_end2','t_notes'].forEach(id=>{const el=$('#'+id);if(!el)return;el.readOnly=ro})}
function tripToggleEdit(on){editOn=!!on;setReadonly(!editOn);$('#tripEditBtn').style.display=editOn?'none':'';$('#tripViewBtn').style.display=editOn?'':'none'}
function openTripForm(s){$('#tripForm').style.display=s?'block':'none'}
function clearTripForm(){ $('#t_date').value=new Date().toISOString().slice(0,10);['t_route1','t_route2','t_start1','t_end1','t_start2','t_end2','t_notes'].forEach(id=>$('#'+id).value='');$('#t_rest').value='0';$('#rest_min_minutes').value='';$('#rest_min_endtime').value='';$('#rest_full_endtime').value='';$('#t_hours').value=''}
function addTripOpen(){currentTripId=null;$('#tripFormTitle').textContent='–ù–æ–≤–∞—è –ø–æ–µ–∑–¥–∫–∞';$('#tripButtonsNew').style.display='';$('#tripButtonsEdit').style.display='none';$('#tripEditBtn').style.display='none';$('#tripViewBtn').style.display='none';clearTripForm();buildRouteOptions();tripToggleEdit(true);openTripForm(true)}
function recalcDuration(){const l1=diffMin($('#t_start1').value,$('#t_end1').value)||0;const l2=diffMin($('#t_start2').value,$('#t_end2').value)||0;const rest=diffMin($('#t_end1').value,$('#t_start2').value);$('#t_rest').value=(rest==null?0:rest);const h=((l1+l2)/60)||0;$('#t_hours').value=h?h.toFixed(1):''}
function calcRest(){const s1=$('#t_start1').value,e1=$('#t_end1').value;const work=diffMin(s1,e1);if(work==null){alert('–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏ ¬´–Ø–≤–∫–∞ (—Ç—É–¥–∞)¬ª –∏ ¬´–ö–æ–Ω–µ—Ü —Ä–∞–±–æ—Ç—ã (—Ç—É–¥–∞)¬ª.');return}const minRest=Math.max(240,Math.round(work/2));$('#rest_min_minutes').value=fmtM(minRest)+' ('+minRest+' –º–∏–Ω)';$('#rest_min_endtime').value=addMin(e1,minRest);$('#rest_full_endtime').value=addMin(e1,work)}
function applyRestAsStart2(){const v=$('#rest_min_endtime').value;if(!v){alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ ¬´–ü–æ—Å—á–∏—Ç–∞—Ç—å –æ—Ç–¥—ã—Ö¬ª.');return}$('#t_start2').value=v;recalcDuration()}
function saveRoutesCache(r1,r2){[r1,r2].forEach(r=>{if(r){let c=getRoutesCache();if(!c.includes(r)){c.unshift(r);if(c.length>50)c.pop();setRoutesCache(c)}}})}

function tripSaveNew(){
  try{
    const t={id:Date.now(),date:$('#t_date').value||new Date().toISOString().slice(0,10),route:($('#t_route1').value||'').trim(),route1:($('#t_route1').value||'').trim(),route2:($('#t_route2').value||'').trim(),start1:$('#t_start1').value||'',end1:$('#t_end1').value||'',start2:$('#t_start2').value||'',end2:$('#t_end2').value||'',rest:toNum($('#t_rest').value)||0,hours:toNum($('#t_hours').value)||0,notes:($('#t_notes').value||'').trim()};
    const arr=getTrips(); arr.push(t); setTrips(arr);
    saveRoutesCache(t.route1,t.route2);
    openTripForm(false); renderTrips(); updateDash(); toast('–ü–æ–µ–∑–¥–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
  }catch(e){
    const d=$('#diag'); d.classList.add('err'); d.textContent='–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: '+e.message;
  }
}
function tripOpen(id){
  const t=getTrips().find(x=>x.id===id); if(!t){toast('–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); return;}
  currentTripId=id;
  $('#tripFormTitle').textContent='–ü–æ–µ–∑–¥–∫–∞: '+(t.route||'‚Äî');$('#tripButtonsNew').style.display='none';$('#tripButtonsEdit').style.display='';$('#tripEditBtn').style.display='';$('#tripViewBtn').style.display='none';
  $('#t_date').value=t.date||new Date().toISOString().slice(0,10);$('#t_route1').value=t.route1||t.route||'';$('#t_route2').value=t.route2||'';$('#t_start1').value=t.start1||'';$('#t_end1').value=t.end1||'';$('#t_start2').value=t.start2||'';$('#t_end2').value=t.end2||'';$('#t_rest').value=toNum(t.rest)||0;$('#t_hours').value=(t.hours!=null&&t.hours!=='')?t.hours:'';$('#t_notes').value=t.notes||'';$('#rest_min_minutes').value='';$('#rest_min_endtime').value='';$('#rest_full_endtime').value='';buildRouteOptions();recalcDuration();tripToggleEdit(false);openTripForm(true)
}
function tripSaveEdit(){
  try{
    if(currentTripId==null){toast('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ–µ–∑–¥–∫–∏');return;}
    const arr=getTrips(); const i=arr.findIndex(x=>x.id===currentTripId); if(i<0){toast('–ù–µ –Ω–∞–π–¥–µ–Ω–∞');return;}
    const t=arr[i];
    const u={...t,date:$('#t_date').value||t.date,route:($('#t_route1').value||t.route||'').trim(),route1:($('#t_route1').value||'').trim(),route2:($('#t_route2').value||'').trim(),start1:$('#t_start1').value||'',end1:$('#t_end1').value||'',start2:$('#t_start2').value||'',end2:$('#t_end2').value||'',rest:toNum($('#t_rest').value)||0,hours:toNum($('#t_hours').value)||0,notes:($('#t_notes').value||'').trim()};
    arr[i]=u; setTrips(arr);
    tripToggleEdit(false); renderTrips(); updateDash(); toast('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
  }catch(e){
    const d=$('#diag'); d.classList.add('err'); d.textContent='–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: '+e.message;
  }
}
function tripCancel(){openTripForm(false);currentTripId=null}
function tripDel(id){if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–µ–∑–¥–∫—É?'))return;setTrips(getTrips().filter(x=>x.id!==id));renderTrips();updateDash();toast('–£–¥–∞–ª–µ–Ω–æ')}

function shouldLive(t){return !!(t.start1 && !t.end2)}
function humanSince(ms){if(ms<0)ms=0;const m=Math.floor(ms/60000);const h=Math.floor(m/60),mm=m%60;return h+'—á '+String(mm).padStart(2,'0')+'–º'}
function liveWorkedMinForTrip(t){const off=getTzOffsetMin(); if(!t.start1) return 0;
  const s1=epochFrom(t.date,t.start1,off); if(s1==null) return 0;
  const e1=t.end1?epochFrom(t.date,t.end1,off):null;
  let m1=0;
  if(!t.end1) m1=Math.max(0,Math.floor((Date.now()-s1)/60000));
  else m1=Math.max(0,Math.floor((e1-s1)/60000));
  let m2=0;
  if(t.start2){
    const s2=epochFrom(t.date,t.start2,off);
    if(!t.end2) m2=Math.max(0,Math.floor((Date.now()-s2)/60000));
    else m2=Math.max(0,Math.floor((epochFrom(t.date,t.end2,off)-s2)/60000));
  }
  return m1+m2;
}
function updateLive(force){
  const off=getTzOffsetMin();const now=Date.now();
  $all('[data-live-id]').forEach(el=>{
    const id=+el.dataset.liveId;const t=(getTrips().find(x=>x.id===id));
    if(!t||!shouldLive(t)){el.textContent='';return}
    const s1=epochFrom(t.date,t.start1,off); if(s1==null){el.textContent='';return}
    el.textContent='–í –ø—É—Ç–∏ ¬∑ '+humanSince(now-s1);
  });
  if(force){}
}

function renderTrips(){
  const box=$('#daysList');box.innerHTML='';
  const arr=getTrips().slice().sort((a,b)=>(a.date||'').localeCompare(b.date));
  if(!arr.length){box.innerHTML='<div class="small" style="opacity:.7">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫</div>';return}
  let sumMoney=0;
  arr.forEach(t=>{
    const h=toNum(t.hours); const money=tripMoney(h); sumMoney+=money;
    const meta=(t.route2?('–º–∞—Ä—à—Ä—É—Ç—ã: '+(t.route1||t.route||'‚Äî')+' ‚Ä¢ '+t.route2):('–º–∞—Ä—à—Ä—É—Ç: '+(t.route1||t.route||'‚Äî')))
      +' ‚Ä¢ —Ç—É–¥–∞ '+(t.start1||'‚Äî')+'‚Äî'+(t.end1||'‚Äî')
      +' ‚Ä¢ –æ–±—Ä–∞—Ç–Ω–æ '+(t.start2||'‚Äî')+'‚Äî'+(t.end2||'‚Äî')
      +(t.rest?(' ‚Ä¢ –æ—Ç–¥—ã—Ö '+fmtM(toNum(t.rest))):'')
      +(t.notes?(' ‚Ä¢ '+t.notes):'');
    const row=document.createElement('div');
    row.className='trip';
    row.innerHTML=
      '<div><b>'+ (t.date||'‚Äî') +'</b> ‚Ä¢ '+ (t.route||t.route1||'‚Äî')
      +(shouldLive(t)?'<span class="badge-live" data-live-id="'+t.id+'"></span>':'')
      +'<div class="small" style="opacity:.75">'+meta+'</div></div>'
      +'<div>'+ (h?(h.toFixed?h.toFixed(1):h):'‚Äî') +' —á</div>'
      +'<div class="money">'+ (h?RUR.format(money):'‚Äî') +'</div>'
      +'<div class="actions"><button class="btn" type="button" onclick="tripOpen('+t.id+')">üîç</button><button class="btn" type="button" onclick="tripDel('+t.id+')">üóë</button></div>';
    box.appendChild(row);
  });
  const sum=document.createElement('div');sum.className='small';sum.style.textAlign='right';sum.style.opacity=.9;sum.style.marginTop='6px';sum.textContent='–ò—Ç–æ–≥–æ (–∑–∞–∫—Ä—ã—Ç—ã–µ): '+RUR.format(sumMoney);box.appendChild(sum);
  updateLive(true);
}

/* ===== CSV ===== */
function csvEsc(v){if(v==null)return'';let s=String(v).replace(/"/g,'""');return /[",\n;]/.test(s)?('"'+s+'"'):s}
function exportTripsCsv(){
  const arr=getTrips();const head=['–î–∞—Ç–∞','–ú–∞—Ä—à—Ä—É—Ç 1','–ú–∞—Ä—à—Ä—É—Ç 2','–¢—É–¥–∞: —è–≤–∫–∞','–¢—É–¥–∞: –∫–æ–Ω–µ—Ü','–û–±—Ä–∞—Ç–Ω–æ: —è–≤–∫–∞','–û–±—Ä–∞—Ç–Ω–æ: –∫–æ–Ω–µ—Ü','–û—Ç–¥—ã—Ö (–º–∏–Ω)','–ß–∞—Å—ã','–ó–∞–º–µ—Ç–∫–∏','–î–µ–Ω—å–≥–∏'];const rows=[head];
  arr.forEach(t=>rows.push([t.date||'',t.route1||t.route||'',t.route2||'',t.start1||'',t.end1||'',t.start2||'',t.end2||'',toNum(t.rest)||0,toNum(t.hours)||0,(t.notes||'').replace(/\n/g,' '),tripMoney(toNum(t.hours))]));
  const csv=rows.map(r=>r.map(csvEsc).join(';')).join('\n');const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='trips.csv';a.click();setTimeout(()=>URL.revokeObjectURL(url),500)
}

/* ===== dashboard ===== */
function updateDash(){
  const t=getTar();const today=new Date();const ym=today.toISOString().slice(0,7);
  const trips=(getTrips()).filter(x=>(x.date||'').slice(0,7)===ym);

  const fixedMin=Math.round(trips.reduce((acc,x)=>acc+toNum(x.hours),0)*60);
  let liveMin=0,liveMoney=0;
  trips.forEach(tr=>{
    if(shouldLive(tr)){const m=liveWorkedMinForTrip(tr);liveMin+=m;liveMoney+=tripMoney(m/60,false)}
  });

  const mins=fixedMin+liveMin;
  const norm=t.norm*60;
  const pct=norm?Math.round(mins/norm*100):0;
  const rem=norm-mins;

  const fixedMoney=trips.reduce((a,x)=>a+tripMoney(toNum(x.hours)),0);
  const totalMoney=fixedMoney+liveMoney;

  $('#mwNorm').textContent=t.norm+' —á';
  $('#mwWorked').textContent=fmtM(mins)+' (–≤ —Ç.—á. –≤ –ø—É—Ç–∏: '+fmtM(liveMin)+')';
  $('#mwPercent').textContent=pct+'%';
  $('#mwRemain').textContent=rem>=0?('–û—Å—Ç–∞–ª–æ—Å—å: '+fmtM(rem)):('–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞: '+fmtM(-rem));
  $('#mwSalary').textContent=RUR.format(totalMoney)+' (–≤ –ø—É—Ç–∏: '+RUR.format(liveMoney)+')';
  $('#mwBar').style.width=Math.min(pct,100)+'%';
}

/* ===== backup ===== */
function backup(){const data={tar:getTar(),trips:getTrips(),secs:getSecs(),routes:getRoutesCache(),tz:tzPref()};const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='bm-backup.json';a.click();setTimeout(()=>URL.revokeObjectURL(url),500)}
function restoreFileChanged(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{const d=JSON.parse(r.result);if(d.tar)S('tar',d.tar);if(d.trips)S('trips',d.trips);if(d.secs)S('secs',d.secs);if(d.routes)S('routes_cache',d.routes);if(d.tz)S('tz_pref',d.tz);init();toast('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ')}catch(err){alert('–û—à–∏–±–∫–∞: '+err.message)}};r.readAsText(f)}
function tzPref(){return S('tz_pref')||{mode:'AUTO'}}

/* ===== init ===== */
function renderSecsAndRoutes(){renderSecs();buildRouteOptions()}
function init(){loadTar();tzPopulate();renderTrips();renderSecsAndRoutes();updateDash();setInterval(()=>{updateLive();updateDash()},30000)}
init();
</script>
</body>
</html>
