<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>–ë–ª–æ–∫–Ω–æ—Ç –ú–∞—à–∏–Ω–∏—Å—Ç–∞ ¬∑ Lite v2025.28Z-PWA</title>
<meta name="theme-color" content="#d32f2f">

<!-- iOS –∏–∫–æ–Ω–∫–∏ -->
<link rel="apple-touch-icon" href="apple-touch-icon.png?v=202528Z">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180x180.png?v=202528Z">
<link rel="apple-touch-icon" sizes="167x167" href="apple-touch-icon-167x167.png?v=202528Z">
<link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon-152x152.png?v=202528Z">

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0}
:root{
  --red:#d32f2f;--bg:#0f1420;--card:#161d2a;--line:#243246;--mut:#8aa0b6;--txt:#e9eef5;
  --ink:#0e1622;--ok:#1b2738;--green:#2e7d32;--amber:#ffb300;--chip:#0f2035
}
body{background:var(--bg);color:var(--txt);font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
header{position:sticky;top:0;background:var(--red);color:#fff;padding:12px 14px;display:flex;gap:10px;justify-content:space-between;align-items:center;z-index:10;flex-wrap:wrap}
h1{margin:0;font-size:18px}
.badge{font-size:12px;padding:2px 8px;border:1px solid rgba(255,255,255,.4);border-radius:999px;white-space:nowrap}
.container{padding:12px 12px 84px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:10px}
.row{display:flex;gap:8px;align-items:center;margin:8px 0}
.row label{width:48%;color:var(--mut);font-size:14px}
.row input,.row select,.row textarea, .row button.selector{flex:1;background:var(--ink);border:1px solid var(--line);color:#e9eef5;padding:10px;border-radius:10px;font-size:16px}
.row textarea{min-height:90px;resize:vertical}
.btn{background:var(--ok);color:#fff;border:1px solid var(--line);padding:10px 14px;border-radius:10px;font-size:15px;cursor:pointer}
.btn.primary{background:#fff;color:#d32f2f;border-color:#fff}
.small{font-size:12px}
.view{display:none}
.view.active{display:block}
.tabbar{position:fixed;left:0;right:0;bottom:0;height:70px;background:#121828;border-top:1px solid var(--line);display:flex}
.tabbar button{flex:1;background:transparent;border:none;color:#8aa0b6;font-size:12px;padding:6px 0}
.tabbar button.active{color:#fff}
.tabbar .ico{display:block;font-size:18px;margin-bottom:4px}
.progress{height:10px;border:1px solid var(--line);border-radius:999px;overflow:hidden;background:#0f2035}
.progress>div{height:100%;background:#d32f2f;width:0%}

/* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–µ–∑–¥–∫–∏ */
.trip{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center;padding:10px;border:1px solid var(--line);border-radius:10px;margin:8px 0;background:#141b29}
.trip .meta{display:none;margin-top:6px;color:#a9bacd}
.trip.open .meta{display:block}
.trip .hdr{font-weight:600}
.actions{display:flex;gap:6px}
.tap{cursor:pointer}
.money{white-space:nowrap}

/* –ü–ª–∞—à–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ */
.badge-live{
  display:inline-block;background:rgba(46,125,50,.12);border:1px solid rgba(46,125,50,.6);
  color:#a5d6a7;padding:2px 6px;border-radius:999px;font-size:12px;margin-left:6px;white-space:nowrap
}
.badge-two{
  display:inline-block;background:rgba(211,47,47,.15);border:1px solid rgba(211,47,47,.6);
  color:#ff8a80;padding:2px 6px;border-radius:999px;font-size:12px;margin-left:6px;white-space:nowrap
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–µ—Ç–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è */
.net-pill{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.5);padding:4px 8px;border-radius:999px;font-size:12px}
.net-pill.off{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.3);color:#ffe082}
.net-pill.on{background:rgba(255,255,255,.2);border-color:rgba(255,255,255,.7);color:#c8e6c9}
.update-pill{background:#fff;color:#d32f2f;border:1px solid #fff;padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer;display:none}

/* –ß–∏–ø—ã –≤–∏–¥–∞ –ø–æ–µ–∑–¥–∞ (–¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞) */
.type-chip{background:var(--chip);border:1px solid var(--line);padding:8px 10px;border-radius:999px;cursor:pointer;font-size:13px;user-select:none}
.type-chip.active{background:#d32f2f;color:#fff;border-color:#d32f2f}

/* –ü—Ä–æ—Ñ–∏–ª—å */
.avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,.3)}
.avatar.big{width:64px;height:64px}
.kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px}
.kv div{min-height:24px}
.hr{height:1px;background:#233246;margin:8px 0}

/* details –∫–æ–º–ø–∞–∫—Ç */
details > summary {cursor:pointer; list-style:none; user-select:none; color:#e9eef5; background:#10192a; border:1px solid var(--line); padding:10px 12px; border-radius:8px;}
details[open] > summary {border-bottom-left-radius:0;border-bottom-right-radius:0}
details .inside {border:1px solid var(--line); border-top:none; padding:10px 12px; border-bottom-left-radius:8px;border-bottom-right-radius:8px; background:#161d2a}

/* –ü–ª–∞–≤–∞—é—â–∏–π –≤–µ—Ä—Ö–Ω–∏–π –º–æ–Ω–∏—Ç–æ—Ä "–≤ –ø—É—Ç–∏" */
.monitor{position:sticky;top:52px;z-index:5;display:none}
.monitor .box{margin-top:8px;background:#12321c;border:1px solid #2e7d32;color:#c8e6c9;border-radius:12px;padding:10px}
.monitor.show{display:block}

/* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.cal-cell{border:1px solid var(--line);border-radius:8px;padding:6px;min-height:64px;background:#141b29}
.cal-cell .d{font-size:12px;color:#a9bacd}
.cal-cell .sum{font-size:12px;margin-top:4px}

/* –¢–µ–º–∞ */
:root[data-theme="light"]{
  --bg:#f6f7fb; --card:#ffffff; --ink:#ffffff; --txt:#102033; --line:#d8dfeb; --mut:#5c6a78; --ok:#e9eef5; --chip:#eef3fb;
  --red:#d32f2f;
}
</style>
</head>
<body>
<header>
  <h1>–ë–ª–æ–∫–Ω–æ—Ç –ú–∞—à–∏–Ω–∏—Å—Ç–∞</h1>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <span id="netStatus" class="net-pill off">–û—Ñ—Ñ–ª–∞–π–Ω</span>
    <div class="badge">Lite v2025.28Z-PWA</div>
    <button id="appRefresh" class="update-pill" onclick="appUpdate()">–û–±–Ω–æ–≤–∏—Ç—å</button>
  </div>
</header>

<main class="container">
  <!-- –ú–æ–Ω–∏—Ç–æ—Ä "–≤ –ø—É—Ç–∏" -->
  <div id="monitor" class="monitor"><div class="box">
    <b id="monTitle">–í –ø—É—Ç–∏</b> ¬∑ <span id="monTimer">‚Äî</span>
    <button class="btn" style="float:right" onclick="scrollToCurrentTrip()">–û—Ç–∫—Ä—ã—Ç—å</button>
  </div></div>

  <!-- –ì–ª–∞–≤–Ω–∞—è -->
  <section id="v-dashboard" class="view active">
    <div class="card">
      <div style="display:flex;justify-content:space-between"><b>–ú–µ—Å—è—á–Ω–∞—è –Ω–æ—Ä–º–∞</b><b id="mwNorm">‚Äî</b></div>
      <div class="progress" style="margin-top:6px"><div id="mwBar"></div></div>
      <div class="row"><label>–ù–æ—Ä–º–∞, —á/–º–µ—Å</label><input id="tar_norm" type="number" inputmode="decimal" placeholder="176" oninput="tarSave()"></div>
      <div class="row"><label>–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ</label><div id="mwWorked" class="small">‚Äî</div></div>
      <div class="row"><label>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</label><div id="mwPercent" class="small">‚Äî</div></div>
      <div class="row"><label>–û—Å—Ç–∞–ª–æ—Å—å/–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞</label><div id="mwRemain" class="small">‚Äî</div></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <b>–ü–æ–µ–∑–¥–∫–∏</b>
        <div style="display:flex;gap:6px">
          <input id="tripSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É/–∑–∞–º–µ—Ç–∫–∞–º" style="min-width:210px" oninput="renderTrips()">
          <button class="btn primary" onclick="addTripOpen()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn" onclick="exportTripsCsv()">CSV</button>
        </div>
      </div>

      <!-- –§–æ—Ä–º–∞ –ø–æ–µ–∑–¥–∫–∏ -->
      <div id="tripForm" class="card" style="display:none;margin-top:10px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <b id="tripFormTitle">–ù–æ–≤–∞—è –ø–æ–µ–∑–¥–∫–∞</b>
          <div>
            <button id="tripEditBtn" class="btn" style="display:none" onclick="tripToggleEdit(true)">‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button id="tripViewBtn" class="btn" style="display:none" onclick="tripToggleEdit(false)">üîí –ü—Ä–æ—Å–º–æ—Ç—Ä</button>
          </div>
        </div>

        <!-- –ü–æ—Ä—è–¥–æ–∫ –ø–æ–ª–µ–π –ø–æ –¢–ó -->
        <div class="row"><label>–î–∞—Ç–∞</label><input id="t_date" type="date" oninput="recalcDuration();saveDraft()"></div>

        <div class="legend">–¢—É–¥–∞</div>
        <div class="row"><label>–ú–∞—Ä—à—Ä—É—Ç (—Ç—É–¥–∞)</label>
          <input id="t_route1" list="routeList" placeholder="–Ω–∞–ø—Ä.: –ú–∞–ª–æ—à—É–π–∫–∞ ‚Äî –û–±–æ–∑–µ—Ä—Å–∫–∞—è" oninput="saveDraft()">
          <datalist id="routeList"></datalist>
        </div>
        <div class="row"><label>–Ø–≤–∫–∞ (—Ç—É–¥–∞)</label><input id="t_start1" type="time" oninput="recalcDuration();saveDraft()"></div>
        <div class="row"><label>–ù–æ–º–µ—Ä –ø–æ–µ–∑–¥–∞ (—Ç—É–¥–∞)</label><input id="t_trainNo1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 2105" oninput="saveDraft()"></div>
        <div class="row"><label>–í–∏–¥ –ø–æ–µ–∑–¥–∞ (—Ç—É–¥–∞)</label><button class="selector" id="t_typeBtn1" onclick="openTypePicker(1)">–í—ã–±—Ä–∞—Ç—å</button></div>
        <div class="row"><label>–ö–æ–Ω–µ—Ü —Ä–∞–±–æ—Ç—ã (—Ç—É–¥–∞)</label><input id="t_end1" type="time" oninput="recalcDuration();saveDraft()"></div>

        <div class="legend">–û–±—Ä–∞—Ç–Ω–æ</div>
        <div class="row"><label>–î–∞—Ç–∞ (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_date2" type="date" oninput="recalcDuration();saveDraft()"></div>
        <div class="row"><label>–ú–∞—Ä—à—Ä—É—Ç (–æ–±—Ä–∞—Ç–Ω–æ)</label>
          <input id="t_route2" list="routeList" placeholder="–Ω–∞–ø—Ä.: –û–±–æ–∑–µ—Ä—Å–∫–∞—è ‚Äî –ú–∞–ª–æ—à—É–π–∫–∞" onfocus="suggestInverse()" oninput="saveDraft()">
        </div>
        <div class="row"><label>–Ø–≤–∫–∞ (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_start2" type="time" oninput="recalcDuration();saveDraft()"></div>
        <div class="row"><label>–ù–æ–º–µ—Ä –ø–æ–µ–∑–¥–∞ (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_trainNo2" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 2106" oninput="saveDraft()"></div>
        <div class="row"><label>–í–∏–¥ –ø–æ–µ–∑–¥–∞ (–æ–±—Ä–∞—Ç–Ω–æ)</label><button class="selector" id="t_typeBtn2" onclick="openTypePicker(2)">–í—ã–±—Ä–∞—Ç—å</button></div>
        <div class="row"><label>–ö–æ–Ω–µ—Ü —Ä–∞–±–æ—Ç—ã (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_end2" type="time" oninput="recalcDuration();saveDraft()"></div>

        <div class="legend">–°–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º</div>
        <div class="small" style="opacity:.8;margin-top:-6px">–ü—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –º–æ–∂–µ—Ç <b>–∑–∞–º–µ–Ω—è—Ç—å</b> –ø–ª–µ—á–æ ¬´—Ç—É–¥–∞¬ª –∏–ª–∏ ¬´–æ–±—Ä–∞—Ç–Ω–æ¬ª (–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –Ω–∏–∂–µ).</div>
        <div class="row"><label>–†–µ–∂–∏–º</label>
          <select id="pass_mode" onchange="passengerModeChanged();recalcDuration();saveDraft()">
            <option value="off">–í—ã–∫–ª—é—á–µ–Ω–æ</option>
            <option value="replace1">–ó–∞–º–µ–Ω—è–µ—Ç ¬´—Ç—É–¥–∞¬ª</option>
            <option value="replace2">–ó–∞–º–µ–Ω—è–µ—Ç ¬´–æ–±—Ä–∞—Ç–Ω–æ¬ª</option>
          </select>
        </div>
        <div class="row"><label>–î–∞—Ç–∞ (–Ω–∞—á–∞–ª–æ)</label><input id="p_date1" type="date" oninput="recalcDuration();saveDraft()"></div>
        <div class="row"><label>–ú–∞—Ä—à—Ä—É—Ç</label><input id="p_route" list="routeList" placeholder="—Å—Ç–∞–Ω—Ü–∏—è –ê ‚Äî —Å—Ç–∞–Ω—Ü–∏—è –ë" oninput="saveDraft()"></div>
        <div class="row"><label>–û–∂–∏–¥–∞–Ω–∏–µ (–º–∏–Ω)</label><input id="p_wait" type="number" inputmode="numeric" placeholder="0" oninput="recalcDuration();saveDraft()"></div>
        <div class="row"><label>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label><input id="p_start" type="time" oninput="recalcDuration();saveDraft()"></div>
        <div class="row"><label>–ü—Ä–∏–±—ã—Ç–∏–µ</label><input id="p_end" type="time" oninput="recalcDuration();saveDraft()"></div>
        <div class="row"><label>–î–∞—Ç–∞ (–∫–æ–Ω–µ—Ü)</label><input id="p_date2" type="date" oninput="recalcDuration();saveDraft()"></div>

        <div class="legend">–ò—Ç–æ–≥–∏</div>
        <div class="row"><label>–û—Ç–¥—ã—Ö (–º–µ–∂–¥—É –ø–ª–µ—á–∞–º–∏)</label><input id="t_rest_view" type="text" readonly></div>
        <div class="row"><label>–ù–æ—á–Ω—ã–µ</label><input id="t_night_view" type="text" readonly></div>
        <div class="row"><label>–ß–∞—Å—ã (–∏—Ç–æ–≥, –±–µ–∑ –æ—Ç–¥—ã—Ö–∞)</label><input id="t_hours_view" type="text" readonly></div>

        <div class="row"><label>–ó–∞–º–µ—Ç–∫–∏</label><textarea id="t_notes" placeholder="–ü—Ä–æ—Å—Ç–æ–∏, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏‚Ä¶"></textarea></div>

        <div class="row" id="tripButtonsNew">
          <button class="btn primary" onclick="tripSaveNew()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn" onclick="tripCancel()">–û—Ç–º–µ–Ω–∞</button>
        </div>
        <div class="row" id="tripButtonsEdit" style="display:none">
          <button class="btn primary" onclick="tripSaveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
          <button class="btn" onclick="tripCancel()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>

      <div id="daysList" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- –£—á–∞—Å—Ç–∫–∏ -->
  <section id="v-sections" class="view">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>–£—á–∞—Å—Ç–∫–∏</b><div class="actions"><button class="btn" onclick="sectionOpen()">–ù–æ–≤—ã–π —É—á–∞—Å—Ç–æ–∫</button></div>
      </div>
      <div id="sectionForm" class="card" style="display:none;margin-top:10px">
        <div class="row"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="s_name" placeholder="–ù–∞–ø—Ä.: –ú–∞–ª–æ—à—É–π–∫–∞ ‚Äî –û–±–æ–∑–µ—Ä—Å–∫–∞—è"></div>
        <div class="row"><label>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label><input id="s_from"></div>
        <div class="row"><label>–ü—Ä–∏–±—ã—Ç–∏–µ</label><input id="s_to"></div>
        <div class="row"><label>–î–ª–∏–Ω–∞ (–∫–º)</label><input id="s_len" type="number" inputmode="decimal" placeholder="0"></div>
        <div class="row">
          <button id="s_save_btn" class="btn primary" onclick="sectionSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn" onclick="sectionCancel()">–û—Ç–º–µ–Ω–∞</button>
        </div>
        <div class="small" id="s_hint" style="opacity:.7"></div>
      </div>
      <div id="sectionList"></div>
    </div>
  </section>

  <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ -->
  <section id="v-more" class="view">
    <div class="card">
      <b>–ü–æ–ª–Ω—ã–π –æ—Ç–¥—ã—Ö –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–µ–∑–¥–∫–µ</b>
      <div class="row" style="gap:8px">
        <button class="btn primary" onclick="calcFullRest()">–ü–æ—Å—á–∏—Ç–∞—Ç—å</button>
        <button class="btn" onclick="closeFullRest()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="restResult" class="kv"></div>
      <div class="small" style="opacity:.8;margin-top:8px">
        –§–æ—Ä–º—É–ª–∞: (–≤—Ä–µ–º—è –Ω–∞ —Ä–∞–±–æ—Ç–µ ¬´—Ç—É–¥–∞+–æ–±—Ä–∞—Ç–Ω–æ¬ª) √ó 2.6 ‚àí –æ—Ç–¥—ã—Ö –º–µ–∂–¥—É –ø–ª–µ—á–∞–º–∏. –ü—Ä–∏ ¬´–¥–≤—É—Ö –Ω–æ—á–∞—Ö¬ª –æ—Ç–¥—ã—Ö –Ω–µ –≤—ã—á–∏—Ç–∞–µ—Ç—Å—è.
        –û—Ç—Å—á—ë—Ç –æ—Ç ¬´–∫–æ–Ω—Ü–∞ —Ä–∞–±–æ—Ç—ã (–æ–±—Ä–∞—Ç–Ω–æ)¬ª. –ü–æ–∫–∞–∑ ‚Äî –¥–∞—Ç–∞+–≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è. ¬´–° –≤—ã—Ö–æ–¥–Ω—ã–º¬ª = +24 —á–∞—Å–∞.
      </div>
    </div>

    <div class="card">
      <b>–†–ñ–î-–∑–∞—Ä–ø–ª–∞—Ç–∞</b>
      <div id="payLock" class="row">
        <label>PIN-–∫–æ–¥</label><input id="payPin" type="password" inputmode="numeric" placeholder="–í–≤–µ–¥–∏—Ç–µ PIN –∏–∑ –ù–∞—Å—Ç—Ä–æ–µ–∫">
      </div>
      <div class="row" style="gap:8px">
        <button class="btn primary" onclick="openSalary()">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        <button class="btn" onclick="hideSalary()">–°–≤–µ—Ä–Ω—É—Ç—å</button>
      </div>
      <div id="salaryBox"></div>
    </div>

    <div class="card">
      <b>–¢–∞—Ä–∏—Ñ –∏ –Ω–∞–¥–±–∞–≤–∫–∏</b>
      <div class="row"><label>‚ÇΩ/—á–∞—Å (—Å—Ç–∞–≤–∫–∞)</label><input id="tar_base" type="number" inputmode="decimal" placeholder="358.46"></div>
      <div class="row"><label>–†–∞–π–æ–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç, %</label><input id="tar_rc" type="number" inputmode="decimal" placeholder="20"></div>
      <div class="row"><label>–°–µ–≤–µ—Ä–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç, %</label><input id="tar_north" type="number" inputmode="decimal" placeholder="50"></div>
      <div class="row"><label>–ù–∞–¥–±–∞–≤–∫–∞ –∑–∞ –∫–ª–∞—Å—Å, %</label><input id="tar_cls" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><label>–ó–æ–Ω–∞–ª—å–Ω–∞—è –Ω–∞–¥–±–∞–≤–∫–∞, %</label><input id="tar_zone" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><label>–ë–ê–ú-–Ω–∞–¥–±–∞–≤–∫–∞, %</label><input id="tar_bam" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><label>–ö–æ–º. —Ä–∞—Å—Ö–æ–¥—ã (–∑–∞ –ø–æ–µ–∑–¥–∫—É), ‚ÇΩ</label><input id="tar_fee" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><button class="btn primary" onclick="tarSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ</button></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <b>–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</b>
        <div>
          <button class="btn" onclick="toggleListCalendar(false)">–°–ø–∏—Å–æ–∫</button>
          <button class="btn" onclick="toggleListCalendar(true)">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
          <button class="btn" onclick="closeCalendar()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
      <div id="calendarBox" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <section id="v-settings" class="view">
    <div class="card" style="display:flex; align-items:center; gap:12px">
      <img id="pfAvatar" class="avatar" src="" alt="avatar" onerror="this.src=''; this.style.display='none'">
      <div style="flex:1">
        <b>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</b>
        <div class="small" style="opacity:.8">–ò–º—è, –¥–æ–ª–∂–Ω–æ—Å—Ç—å, —Å—Ç–∞–∂; —Ñ–æ—Ç–æ –∏ —Ñ–∞–π–ª—ã</div>
      </div>
      <button class="btn" onclick="goProfile()">–û—Ç–∫—Ä—ã—Ç—å</button>
    </div>

    <div class="card">
      <b>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</b>
      <div class="row"><button class="btn" onclick="appUpdate()">–û–±–Ω–æ–≤–∏—Ç—å –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏</button></div>
      <div class="small" style="opacity:.8">–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç—Å—è.</div>
    </div>

    <div class="card">
      <b>–î–æ—Å—Ç—É–ø –∫ ¬´–†–ñ–î-–∑–∞—Ä–ø–ª–∞—Ç–µ¬ª</b>
      <div class="row"><label>PIN</label><input id="cfg_pin" type="password" inputmode="numeric" placeholder="–ó–∞–¥–∞–π—Ç–µ PIN" oninput="cfgSave()"></div>
      <div class="small" style="opacity:.8">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ PIN –Ω–µ –Ω—É–∂–µ–Ω.</div>
    </div>

    <div class="card">
      <details>
        <summary>–ë—ç–∫–∞–ø / –≠–∫—Å–ø–æ—Ä—Ç</summary>
        <div class="inside">
          <div class="row"><button class="btn" onclick="backup()">–°–∫–∞—á–∞—Ç—å JSON</button></div>
        </div>
      </details>
      <div style="height:8px"></div>
      <details>
        <summary>–ò–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–∞ JSON</summary>
        <div class="inside">
          <div class="row"><input id="restoreFile" type="file" accept="application/json" onchange="restoreFileChanged(event)"></div>
        </div>
      </details>
      <div style="height:8px"></div>
      <details>
        <summary>–ò–º–ø–æ—Ä—Ç –∏–∑ –±—É—Ñ–µ—Ä–∞</summary>
        <div class="inside">
          <div class="row"><textarea id="restoreText" placeholder='–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ {"tar":...}'></textarea></div>
          <div class="row">
            <button class="btn" onclick="pasteFromClipboard()">–í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞</button>
            <button class="btn primary" onclick="restoreFromText()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>
      </details>
    </div>

    <div class="card">
      <b>–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</b>
      <div class="row">
        <label>–ü–æ—è—Å</label>
        <select id="tz_select" onchange="tzSave()"></select>
      </div>
      <div class="small" style="opacity:.8">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è ¬´–≤ –ø—É—Ç–∏¬ª, –Ω–æ—á–Ω—ã—Ö –∏ —Ä–∞—Å—á—ë—Ç–æ–≤ –æ—Ç–¥—ã—Ö–∞.</div>
    </div>

    <div class="card">
      <b>–¢–µ–º–∞</b>
      <div class="row">
        <label>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</label>
        <select id="theme_select" onchange="themeSave()">
          <option value="auto">–ê–≤—Ç–æ (–ø–æ —Å–∏—Å—Ç–µ–º–µ)</option>
          <option value="dark">–¢—ë–º–Ω–∞—è</option>
          <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
        </select>
      </div>
    </div>

    <div class="card small" style="opacity:.8">–í–µ—Ä—Å–∏—è Lite 2025.28Z-PWA</div>
    <div class="small" style="opacity:.8;text-align:center">
      <a href="https://t.me/nikitagrigorev99" target="_blank" style="color:inherit;text-decoration:underline">by Nikita Grigorev</a>
    </div>
  </section>

  <!-- –ü—Ä–æ—Ñ–∏–ª—å (–æ—Ç–¥–µ–ª—å–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞) -->
  <section id="v-profile" class="view">
    <div class="card">
      <b>–ü—Ä–æ—Ñ–∏–ª—å</b>
      <div class="row" style="align-items:flex-start">
        <label>–§–æ—Ç–æ</label>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <img id="pfAvatarBig" class="avatar big">
          <input id="pf_photo" type="file" accept="image/*" onchange="profilePhotoChanged(event)">
        </div>
      </div>
      <div class="row"><label>–ò–º—è</label><input id="pf_first" placeholder="–ò–≤–∞–Ω"></div>
      <div class="row"><label>–§–∞–º–∏–ª–∏—è</label><input id="pf_last" placeholder="–ò–≤–∞–Ω–æ–≤"></div>
      <div class="row"><label>–í–æ–∑—Ä–∞—Å—Ç</label><input id="pf_age" type="number" inputmode="numeric" placeholder="30"></div>
      <div class="row"><label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label><input id="pf_role" placeholder="–ú–∞—à–∏–Ω–∏—Å—Ç"></div>
      <div class="row"><label>–ú–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã</label><input id="pf_place" placeholder="–î–µ–ø–æ ..."></div>
      <div class="row"><label>–î–∞—Ç–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label><input id="pf_start" type="date" onchange="renderTenure()"></div>
      <div class="row"><label>–°—Ç–∞–∂</label><input id="pf_tenure" type="text" readonly></div>

      <div class="hr"></div>
      <b>–ó–∞–º–µ—Ç–∫–∏</b>
      <div class="row"><textarea id="pf_notes" placeholder="–õ–∏—á–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –ø–æ —Ä–∞–±–æ—Ç–µ..."></textarea></div>

      <div class="hr"></div>
      <b>–§–∞–π–ª—ã</b>
      <div class="row">
        <input id="fileInput" type="file" multiple onchange="addFilesToProfile(event)">
      </div>
      <div id="filesList"></div>

      <div class="row" style="gap:8px">
        <button class="btn primary" onclick="profileSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" onclick="goHome()">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
      </div>
    </div>
  </section>
</main>

<nav class="tabbar">
  <button class="active" data-tab="dashboard" onclick="nav(this)"><span class="ico">üè†</span>–ì–ª–∞–≤–Ω–∞—è</button>
  <button data-tab="sections" onclick="nav(this)"><span class="ico">üó∫Ô∏è</span>–£—á–∞—Å—Ç–∫–∏</button>
  <button data-tab="more" onclick="nav(this)"><span class="ico">‚ûï</span>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</button>
  <button data-tab="profile" onclick="nav(this)"><span class="ico">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</button>
  <button data-tab="settings" onclick="nav(this)"><span class="ico">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</nav>

<script>
/* ========= helpers ========= */
function $(s){return document.querySelector(s)}
function $all(s){return Array.from(document.querySelectorAll(s))}
function S(k,v){if(arguments.length===2){localStorage.setItem(k,JSON.stringify(v));return v}try{let r=localStorage.getItem(k);return r?JSON.parse(r):null}catch(e){return null}}
function toNum(v){let n=Number(v);return isNaN(n)?0:n}
function plural(n, one, few, many){ n=Math.abs(n)%100; let n1=n%10; if(n>10 && n<20) return many; if(n1>1 && n1<5) return few; if(n1==1) return one; return many; }
function fmtM(min){if(min==null)return '‚Äî';let h=Math.floor(min/60),m=min%60;return h+'—á '+String(m).padStart(2,'0')+'–º'}
function fmtHMWords(min){ if(min==null || min===0) return '0 –º–∏–Ω—É—Ç'; const h=Math.floor(min/60), m=min%60;
  const hs = h>0 ? (h+' '+plural(h,'—á–∞—Å','—á–∞—Å–∞','—á–∞—Å–æ–≤')) : ''; const ms = m>0 ? (m+' '+plural(m,'–º–∏–Ω—É—Ç–∞','–º–∏–Ω—É—Ç—ã','–º–∏–Ω—É—Ç')) : '';
  return (hs+' '+ms).trim(); }
function toMin(hhmm){if(!hhmm)return null;let p=hhmm.split(':');if(p.length<2)return null;let H=Number(p[0]),M=Number(p[1]);if(isNaN(H)||isNaN(M))return null;return H*60+M}
function diffMinutes(a,b){let x=toMin(a),y=toMin(b);if(x==null||y==null)return null;let d=y-x; if(d<0) d+=24*60; return d}
const RUR=new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:0})

/* ========= Network pill ========= */
function updateNetPill(){
  const el = $('#netStatus'); if(!el) return;
  const on = navigator.onLine;
  el.textContent = on ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ—Ñ–ª–∞–π–Ω';
  el.classList.toggle('on', on); el.classList.toggle('off', !on);
}
window.addEventListener('online', updateNetPill);
window.addEventListener('offline', updateNetPill);

/* ========= Theme ========= */
function themeApply(){
  const pref=S('theme')||{mode:'auto'};
  const root=document.documentElement;
  if(pref.mode==='light') root.setAttribute('data-theme','light');
  else if(pref.mode==='dark') root.removeAttribute('data-theme'); // dark –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  else { // auto
    const mq = window.matchMedia('(prefers-color-scheme: light)');
    if(mq.matches) root.setAttribute('data-theme','light'); else root.removeAttribute('data-theme');
  }
  const sel=$('#theme_select'); if(sel) sel.value = pref.mode||'auto';
}
function themeSave(){ const v=$('#theme_select').value||'auto'; S('theme',{mode:v}); themeApply(); }

/* ========= timezone ========= */
function tzList(){ const vals=['AUTO','UTC-12:00','UTC-11:00','UTC-10:00','UTC-09:30','UTC-09:00','UTC-08:00','UTC-07:00','UTC-06:00',
  'UTC-05:00','UTC-04:30','UTC-04:00','UTC-03:30','UTC-03:00','UTC-02:00','UTC-01:00','UTC+00:00','UTC+01:00','UTC+02:00',
  'UTC+03:00','UTC+03:30','UTC+04:00','UTC+04:30','UTC+05:00','UTC+05:30','UTC+05:45','UTC+06:00','UTC+06:30','UTC+07:00',
  'UTC+08:00','UTC+08:45','UTC+09:00','UTC+09:30','UTC+10:00','UTC+10:30','UTC+11:00','UTC+12:00','UTC+12:45','UTC+13:00','UTC+14:00']; return vals; }
function parseUtcLabelToOffsetMin(label){
  if(label==='AUTO') return null;
  const m = label.match(/UTC([+-])(\d{2}):(\d{2})/); if(!m) return 0;
  const sign = m[1]==='-'?-1:1; const hh = Number(m[2])||0, mm = Number(m[3])||0; return sign*(hh*60+mm);
}
function getSelectedTzOffsetMin(){ const pref=S('tz_pref'); if(!pref || pref.mode==='AUTO'){ return -new Date().getTimezoneOffset(); } return pref.offsetMin||0; }
function tzPopulateSelect(){ const sel=$('#tz_select'); if(!sel) return; sel.innerHTML=''; tzList().forEach(lb=>{ const opt=document.createElement('option'); opt.value=lb; opt.textContent = lb==='AUTO'?'–ê–≤—Ç–æ (—Å–∏—Å—Ç–µ–º–Ω—ã–π)':lb; sel.appendChild(opt); });
  const pref=S('tz_pref'); sel.value = pref? (pref.mode==='AUTO'?'AUTO':(pref.label||'AUTO')) : 'AUTO'; }
function tzSave(){ const label=$('#tz_select').value; if(label==='AUTO'){ S('tz_pref',{mode:'AUTO'}); } else { S('tz_pref',{mode:'FIX',label,offsetMin:parseUtcLabelToOffsetMin(label)}); } updateLiveTimers(true); }

/* ========= navigation ========= */
function nav(btn){$all('.tabbar button').forEach(x=>x.classList.remove('active'));btn.classList.add('active');let v=btn.getAttribute('data-tab');$all('.view').forEach(x=>x.classList.remove('active'));$('#v-'+v).classList.add('active')}
function goHome(){ $all('.tabbar button').forEach(b=>b.classList.remove('active')); document.querySelector('.tabbar button[data-tab="dashboard"]').classList.add('active'); $all('.view').forEach(v=>v.classList.remove('active')); $('#v-dashboard').classList.add('active'); }
function goProfile(){ $all('.tabbar button').forEach(b=>b.classList.remove('active')); document.querySelector('.tabbar button[data-tab="profile"]').classList.add('active'); $all('.view').forEach(v=>v.classList.remove('active')); $('#v-profile').classList.add('active'); loadProfile(); }

/* ========= tariffs ========= */
function getTar(){return S('tar')||{base:358.46,norm:176,rc:20,north:50,cls:0,zone:0,bam:0,fee:0}}
function tarSave(){ let t=getTar();
  t.base=toNum($('#tar_base').value)||t.base; t.norm=toNum($('#tar_norm').value)||t.norm;
  t.rc=toNum($('#tar_rc').value)||0; t.north=toNum($('#tar_north').value)||0;
  t.cls=toNum($('#tar_cls').value)||0; t.zone=toNum($('#tar_zone').value)||0;
  t.bam=toNum($('#tar_bam').value)||0; t.fee=toNum($('#tar_fee').value)||0;
  S('tar',t); updateDash(); renderTrips();
}

/* ========= money ========= */
function tripMoney(hours, type){ // —É–ø—Ä–æ—â—ë–Ω–Ω–æ + –Ω–∞–¥–±–∞–≤–∫–∏ –ø–æ —Ç–∏–ø—É
  let t=getTar();
  let typeK = 1;
  if(type==='–¥–ª–∏–Ω–Ω–æ—Å–æ—Å—Ç–∞–≤–Ω—ã–π') typeK=1.1;
  else if(type==='—Å–ø–ª–æ—Ç–∫–∞') typeK=1.05;
  else if(type==='—Å–¥–≤–æ–µ–Ω–Ω—ã–π') typeK=1.08;
  else if(type==='—Ä–µ–∑–µ—Ä–≤') typeK=0.9;
  else if(type==='–ø–æ—Ä–æ–∂–Ω–∏–π') typeK=0.95;
  // —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º —É—á—Ç—ë–º —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–∏–Ω—É—Ç—ã –Ω–∏–∂–µ –ø—Ä–∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞—Ä–ø–ª–∞—Ç—ã (–¥–ª—è –∫—Ä–∞—Ç–∫–æ–π —Å—É–º–º—ã –æ—Å—Ç–∞–≤–∏–º 1.0)
  let pct=(t.rc+t.north+t.cls+t.zone+t.bam)/100;
  let gross=hours*t.base*typeK*(1+pct);
  let net=gross-(t.fee||0);
  return Math.max(0, Math.round(net));
}

/* ========= sections ========= */
function getSecs(){return S('secs')||[]} function setSecs(a){S('secs',a)}
let editingSectionId=null;
function titleForSection(s){ let t=(s.name&&s.name.trim())?s.name.trim():((s.frm||'').trim()+' ‚Äî '+(s.to||'').trim()); t=t.replace(/\s+/g,' ').trim(); return t||'‚Äî'; }
function sectionOpen(){ editingSectionId=null; $('#sectionForm').style.display='block'; $('#s_name').value=''; $('#s_from').value=''; $('#s_to').value=''; $('#s_len').value=''; $('#s_save_btn').textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'; $('#s_hint').textContent='–ù–æ–≤—ã–π —É—á–∞—Å—Ç–æ–∫'; }
function sectionCancel(){ $('#sectionForm').style.display='none'; editingSectionId=null; }
function sectionEdit(id){ let s=(getSecs()||[]).find(x=>x.id===id); if(!s) return; editingSectionId=id; $('#sectionForm').style.display='block'; $('#s_name').value=s.name||''; $('#s_from').value=s.frm||''; $('#s_to').value=s.to||''; $('#s_len').value=(s.len!=null?s.len:''); $('#s_save_btn').textContent='–û–±–Ω–æ–≤–∏—Ç—å'; $('#s_hint').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—á–∞—Å—Ç–∫–∞'; }
function sectionSave(){ let name=($('#s_name').value||'').trim(), frm=($('#s_from').value||'').trim(), to=($('#s_to').value||'').trim(), len=toNum($('#s_len').value); let arr=getSecs();
  if(editingSectionId){ let ix=arr.findIndex(x=>x.id===editingSectionId); if(ix>=0){ arr[ix]={id:editingSectionId,name,frm,to,len}; setSecs(arr);} editingSectionId=null; }
  else{ arr.push({id:Date.now(),name,frm,to,len}); setSecs(arr); }
  $('#sectionForm').style.display='none'; renderSecs(); buildRouteOptions(); }
function sectionDel(id, ev){ if(ev) ev.stopPropagation(); if(!confirm('–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–æ–∫?')) return; setSecs(getSecs().filter(x=>x.id!==id)); renderSecs(); buildRouteOptions(); }
function renderSecs(){ let box=$('#sectionList'); box.innerHTML=''; let a=getSecs();
  if(!a.length){ let d=document.createElement('div'); d.className='small'; d.style.opacity=.7; d.textContent='–ù–µ—Ç —É—á–∞—Å—Ç–∫–æ–≤'; box.appendChild(d); }
  a.forEach(s=>{ let title=titleForSection(s), info=(s.frm||'‚Äî')+' ‚Üí '+(s.to||'‚Äî')+(s.len?(' ‚Ä¢ '+s.len+' –∫–º'):'');
    let r=document.createElement('div'); r.className='row tap'; r.setAttribute('onclick','sectionEdit('+s.id+')');
    r.innerHTML='<div style="flex:1"><b>'+title+'</b><div class="small" style="opacity:.7">'+info+'</div></div>'
               +'<div class="actions"><button class="btn" onclick="event.stopPropagation(); sectionEdit('+s.id+')">‚úé</button>'
               +'<button class="btn" onclick="sectionDel('+s.id+', event)">üóë</button></div>';
    box.appendChild(r);
  });
}

/* ========= routes (datalist) ========= */
function getRoutesCache(){return S('routes_cache')||[]} function setRoutesCache(a){S('routes_cache',a)}
function buildRouteOptions(){
  let dl=$('#routeList'); if(!dl) return; dl.innerHTML=''; let seen=new Set();
  getSecs().forEach(s=>{let title=titleForSection(s); if(title && !seen.has(title)){ seen.add(title); let o=document.createElement('option'); o.value=title; dl.appendChild(o); }});
  (getRoutesCache()).forEach(r=>{let t=(r||'').trim(); if(t && !seen.has(t)){ seen.add(t); let o=document.createElement('option'); o.value=t; dl.appendChild(o); }});
  (getTrips()).forEach(t=>{ [t.route1,t.route2,t.route].forEach(r=>{ let rr=(r||'').trim(); if(rr && !seen.has(rr)){ seen.add(rr); let o=document.createElement('option'); o.value=rr; dl.appendChild(o); }}) });
}
function suggestInverse(){
  const r1 = ($('#t_route1').value||'').trim();
  if(!r1 || !r1.includes('‚Äî')) return;
  const [a,b]=r1.split('‚Äî').map(s=>s.trim());
  if(a && b){ const inv=b+' ‚Äî '+a; if(!$('#t_route2').value) $('#t_route2').value=inv; }
}

/* ========= trips storage & schema ========= */
function getTrips(){return S('trips')||[]} function setTrips(a){S('trips',a)}
function migrate(){
  const v = S('schemaVersion')||1;
  if(v<2){
    // –ø—Ä–∏–º–µ—Ä—ã –º–∏–≥—Ä–∞—Ü–∏–π: –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è type –ø–æ –ø–ª–µ—á–∞–º
    let arr=getTrips();
    arr.forEach(t=>{ if(!('type1' in t)) t.type1 = t.trainType||''; if(!('type2' in t)) t.type2 = t.trainType||''; });
    setTrips(arr); S('schemaVersion',2);
  }
}

/* ========= trip form state ========= */
let currentTripId = null;  // null = new
let editEnabled = true;
let type1 = '', type2 = '';

function setReadonly(readonly){
  const ids = ['t_date','t_date2','t_route1','t_route2','t_start1','t_end1','t_start2','t_end2','t_trainNo1','t_trainNo2','t_notes',
               'pass_mode','p_date1','p_route','p_wait','p_start','p_end','p_date2'];
  ids.forEach(id=>{ const el=$( '#'+id ); if(el){ el.readOnly = readonly; el.disabled = readonly && (el.tagName==='SELECT'); }});
}
function tripToggleEdit(on){ editEnabled = !!on; setReadonly(!editEnabled);
  $('#tripEditBtn').style.display = editEnabled ? 'none' : '';
  $('#tripViewBtn').style.display = editEnabled ? '' : 'none';
}
function openTripForm(show){ $('#tripForm').style.display = show ? 'block' : 'none'; }

/* ========= Type picker ========= */
function openTypePicker(which){
  const wrap=document.createElement('div');
  wrap.style.position='fixed'; wrap.style.left=0; wrap.style.top=0; wrap.style.right=0; wrap.style.bottom=0;
  wrap.style.background='rgba(0,0,0,.5)'; wrap.style.zIndex=9999; wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.justifyContent='center';
  const box=document.createElement('div');
  box.style.background='var(--card)'; box.style.border='1px solid var(--line)'; box.style.borderRadius='12px'; box.style.padding='12px';
  box.innerHTML='<div style="margin-bottom:8px"><b>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ –ø–æ–µ–∑–¥–∞</b></div>';
  const types=['–≥—Ä—É–∑–æ–≤–æ–π','–ø–æ—Ä–æ–∂–Ω–∏–π','–¥–ª–∏–Ω–Ω–æ—Å–æ—Å—Ç–∞–≤–Ω—ã–π','—Ä–µ–∑–µ—Ä–≤','—Å–ø–ª–æ—Ç–∫–∞','—Å–¥–≤–æ–µ–Ω–Ω—ã–π','—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º'];
  const row=document.createElement('div'); row.style.display='flex'; row.style.flexWrap='wrap'; row.style.gap='8px';
  types.forEach(t=>{
    const s=document.createElement('span'); s.className='type-chip'; s.textContent=t;
    s.onclick=()=>{ if(which===1){ type1=t; $('#t_typeBtn1').textContent=t; } else { type2=t; $('#t_typeBtn2').textContent=t; } document.body.removeChild(wrap); recalcDuration(); saveDraft(); };
    row.appendChild(s);
  });
  const cancel=document.createElement('div'); cancel.style.marginTop='10px'; cancel.innerHTML='<button class="btn" id="typeCancel">–û—Ç–º–µ–Ω–∞</button>';
  box.appendChild(row); box.appendChild(cancel); wrap.appendChild(box); document.body.appendChild(wrap);
  $('#typeCancel').onclick=()=>document.body.removeChild(wrap);
}

/* ========= Passenger mode visibility ========= */
function passengerModeChanged(){
  const mode = $('#pass_mode').value;
  const enable = mode!=='off';
  ['p_date1','p_route','p_wait','p_start','p_end','p_date2'].forEach(id=>{
    const el=$('#'+id); if(enable){ el.removeAttribute('disabled'); } else { el.setAttribute('disabled','disabled'); }
  });
}

/* ========= date/time helpers ========= */
function dateAddDays(dateStr, days){ const d=new Date(dateStr+'T00:00:00Z'); d.setUTCDate(d.getUTCDate()+days); return d.toISOString().slice(0,10); }
function epochFromDateTimeTz(dateStr, timeStr, tzOffsetMin){
  if(!dateStr || !timeStr) return null;
  const [Y,M,D]=dateStr.split('-').map(Number); const [h,m]=timeStr.split(':').map(Number);
  if([Y,M,D,h,m].some(isNaN)) return null;
  return Date.UTC(Y,M-1,D,h,m) - tzOffsetMin*60000; // UTC = local - offset
}
function addMinutesEpoch(epoch, minutes){ return new Date(epoch + minutes*60000); }
function fmtLocalFull(d, tzOffsetMin){
  if(!d) return '‚Äî';
  const localMs = d.getTime() + tzOffsetMin*60000;
  const x = new Date(localMs);
  const yyyy = x.getUTCFullYear();
  const mm = String(x.getUTCMonth()+1).padStart(2,'0');
  const dd = String(x.getUTCDate()).padStart(2,'0');
  const hh = String(x.getUTCHours()).padStart(2,'0');
  const mi = String(x.getUTCMinutes()).padStart(2,'0');
  return dd+'.'+mm+'.'+yyyy+' '+hh+':'+mi;
}

/* ========= night minutes (22:00‚Äì06:00) ========= */
function overlap(a1,a2,b1,b2){ const s=Math.max(a1,b1), e=Math.min(a2,b2); return Math.max(0, e-s); }
function legNightMinutes(dateStr, startHHMM, endHHMM, tzMin){
  if(!startHHMM || !endHHMM) return 0;
  let start = epochFromDateTimeTz(dateStr, startHHMM, tzMin);
  let end   = epochFromDateTimeTz(dateStr, endHHMM, tzMin);
  if(start==null || end==null) return 0;
  if(end < start) end += 24*60*60000; // —á–µ—Ä–µ–∑ –ø–æ–ª–Ω–æ—á—å

  const day0 = epochFromDateTimeTz(dateStr, '00:00', tzMin);
  let night = 0;
  const blocks = [
    [day0 + 22*60*60000, day0 + 24*60*60000],
    [day0 + 24*60*60000, day0 + 30*60*60000]
  ];
  for(const [b1,b2] of blocks){ night += overlap(start,end,b1,b2); }
  return Math.round(night/60000);
}
function countNightWindows0005(startEpoch,endEpoch, tzMin){
  if(startEpoch==null || endEpoch==null || endEpoch<=startEpoch) return 0;
  const startLocal = new Date(startEpoch + tzMin*60000);
  const endLocal   = new Date(endEpoch   + tzMin*60000);
  let day = Date.UTC(startLocal.getUTCFullYear(), startLocal.getUTCMonth(), startLocal.getUTCDate());
  const endDay = Date.UTC(endLocal.getUTCFullYear(), endLocal.getUTCMonth(), endLocal.getUTCDate());
  let cnt=0;
  while(day <= endDay + 24*60*60000){
    const wStart = day - tzMin*60000;
    const wEnd   = wStart + 5*60*60000;
    const inter = overlap(startEpoch, endEpoch, wStart, wEnd);
    if(inter > 0) cnt++;
    day += 24*60*60000;
  }
  return cnt;
}

/* ========= recalc on form ========= */
function effectiveReturnDate(){
  const d2 = ($('#t_date2').value || '').trim();
  if(d2) return d2;
  const d1 = $('#t_date').value || new Date().toISOString().slice(0,10);
  const st2=$('#t_start2').value, e1=$('#t_end1').value;
  if(toMin(st2)!=null && toMin(e1)!=null && toMin(st2)<toMin(e1)) return dateAddDays(d1,1);
  return d1;
}
function recalcDuration(){
  const tzMin = getSelectedTzOffsetMin();
  const date = $('#t_date').value;
  const date2 = effectiveReturnDate();

  // –£—á—ë—Ç ¬´—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º¬ª
  const passMode = $('#pass_mode').value;
  const passOn = passMode!=='off';
  const passWait = toNum($('#p_wait').value)||0;
  const pStart = $('#p_start').value, pEnd=$('#p_end').value;
  const pDate1 = $('#p_date1').value||date, pDate2 = $('#p_date2').value||( (pStart&&pEnd && toMin(pEnd)<toMin(pStart)) ? dateAddDays(pDate1,1) : pDate1 );
  let pMin=0;
  if(passOn && pStart && pEnd){
    let e1=epochFromDateTimeTz(pDate1,pStart,tzMin), e2=epochFromDateTimeTz(pDate2,pEnd,tzMin);
    if(e1!=null && e2!=null && e2<e1) e2+=24*60*60000;
    pMin = Math.max(0, Math.round((e2-e1)/60000)) + passWait;
  }

  // –ë–∞–∑–æ–≤—ã–µ –ø–ª–µ—á–∏ (–º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–º–µ–Ω–µ–Ω—ã passenger)
  let l1 = diffMinutes($('#t_start1').value, $('#t_end1').value)||0;
  let l2 = diffMinutes($('#t_start2').value, $('#t_end2').value)||0;
  if(passMode==='replace1') l1 = pMin;
  if(passMode==='replace2') l2 = pMin;

  // –û—Ç–¥—ã—Ö –º–µ–∂–¥—É –ø–ª–µ—á–∞–º–∏
  const rest = diffMinutes($('#t_end1').value, $('#t_start2').value) || 0;
  $('#t_rest_view').value = rest ? fmtHMWords(rest) : '0 –º–∏–Ω—É—Ç';

  const totalMin = l1 + l2;
  $('#t_hours_view').value = fmtHMWords(totalMin);

  // –ù–æ—á–Ω—ã–µ
  const n1 = legNightMinutes(date,  $('#t_start1').value, $('#t_end1').value, tzMin);
  const n2 = legNightMinutes(date2, $('#t_start2').value, $('#t_end2').value, tzMin);
  let nPass = 0;
  if(passOn && pStart && pEnd){
    nPass = legNightMinutes(pDate1,pStart,pEnd,tzMin);
    if(passMode==='replace1') nPass = nPass; // –∑–∞–º–µ–Ω—è–µ—Ç –ø–ª–µ—á–æ1
    if(passMode==='replace2') nPass = nPass; // –∑–∞–º–µ–Ω—è–µ—Ç –ø–ª–µ—á–æ2
  }
  const nightTotal = (passMode==='replace1' ? nPass : n1) + (passMode==='replace2' ? nPass : n2);
  $('#t_night_view').value = nightTotal ? fmtHMWords(nightTotal) : '0 –º–∏–Ω—É—Ç';
}

/* ========= segments removed (–ø–µ—Ä–µ–≥–æ–Ω—ã —É–±—Ä–∞–Ω—ã –ø–æ –¢–ó) ========= */

/* ========= build trip from form ========= */
function tripSkeletonFromForm(){
  const tzMin = getSelectedTzOffsetMin();
  const date = $('#t_date').value || new Date().toISOString().slice(0,10);
  const date2 = effectiveReturnDate();

  const passMode = $('#pass_mode').value;
  const pass = {
    mode: passMode,
    date1: $('#p_date1').value||'',
    route: ($('#p_route').value||'').trim(),
    wait: toNum($('#p_wait').value)||0,
    start: $('#p_start').value||'',
    end: $('#p_end').value||'',
    date2: $('#p_date2').value||''
  };

  let l1 = diffMinutes($('#t_start1').value, $('#t_end1').value)||0;
  let l2 = diffMinutes($('#t_start2').value, $('#t_end2').value)||0;
  const rest = diffMinutes($('#t_end1').value, $('#t_start2').value) || 0;

  // passenger minutes
  let pMin=0; if(pass.mode!=='off' && pass.start && pass.end){
    const pDate1 = pass.date1 || date; const pDate2 = pass.date2 || ( (toMin(pass.end)<toMin(pass.start))? dateAddDays(pDate1,1): pDate1 );
    const e1=epochFromDateTimeTz(pDate1,pass.start,tzMin), e2=epochFromDateTimeTz(pDate2,pass.end,tzMin);
    if(e1!=null && e2!=null){ pMin = Math.round(Math.max(0,(e2 - (e2<e1?e1-24*60*60000:e1))/60000)) + (pass.wait||0); }
  }
  if(pass.mode==='replace1') l1 = pMin;
  if(pass.mode==='replace2') l2 = pMin;

  const hours = (l1 + l2) / 60;

  return {
    date, date2,
    route: ($('#t_route1').value||'').trim(),
    route1: ($('#t_route1').value||'').trim(),
    route2: ($('#t_route2').value||'').trim(),
    trainNo1: ($('#t_trainNo1').value||'').trim(),
    trainNo2: ($('#t_trainNo2').value||'').trim(),
    type1: type1||'',
    type2: type2||'',
    start1: $('#t_start1').value || '', end1: $('#t_end1').value || '',
    start2: $('#t_start2').value || '', end2: $('#t_end2').value || '',
    rest, hours,
    pass
  };
}

/* ========= save ========= */
function saveDraft(){
  const t = tripSkeletonFromForm();
  S('draft_trip', t);
}
function restoreDraft(){
  const t=S('draft_trip'); if(!t) return;
  $('#t_date').value=t.date||''; $('#t_date2').value=t.date2||'';
  $('#t_route1').value=t.route1||t.route||''; $('#t_route2').value=t.route2||'';
  $('#t_trainNo1').value=t.trainNo1||''; $('#t_trainNo2').value=t.trainNo2||'';
  type1=t.type1||''; type2=t.type2||'';
  $('#t_typeBtn1').textContent=type1?type1:'–í—ã–±—Ä–∞—Ç—å'; $('#t_typeBtn2').textContent=type2?type2:'–í—ã–±—Ä–∞—Ç—å';
  $('#t_start1').value=t.start1||''; $('#t_end1').value=t.end1||'';
  $('#t_start2').value=t.start2||''; $('#t_end2').value=t.end2||'';
  if(t.pass){ $('#pass_mode').value=t.pass.mode||'off'; $('#p_date1').value=t.pass.date1||''; $('#p_route').value=t.pass.route||''; $('#p_wait').value=t.pass.wait||0; $('#p_start').value=t.pass.start||''; $('#p_end').value=t.pass.end||''; $('#p_date2').value=t.pass.date2||''; }
  passengerModeChanged(); recalcDuration();
}
function clearTripForm(){
  const today = new Date().toISOString().slice(0,10);
  $('#t_date').value = today; $('#t_date2').value = '';
  $('#t_route1').value=''; $('#t_route2').value='';
  $('#t_trainNo1').value=''; $('#t_trainNo2').value='';
  type1=''; type2=''; $('#t_typeBtn1').textContent='–í—ã–±—Ä–∞—Ç—å'; $('#t_typeBtn2').textContent='–í—ã–±—Ä–∞—Ç—å';
  $('#t_start1').value=''; $('#t_end1').value='';
  $('#t_start2').value=''; $('#t_end2').value='';
  $('#pass_mode').value='off'; ['p_date1','p_route','p_wait','p_start','p_end','p_date2'].forEach(id=>$('#'+id).value='');
  $('#t_rest_view').value='0 –º–∏–Ω—É—Ç'; $('#t_night_view').value='0 –º–∏–Ω—É—Ç'; $('#t_hours_view').value='0 –º–∏–Ω—É—Ç'; $('#t_notes').value='';
  passengerModeChanged();
}
function addTripOpen(){
  currentTripId = null;
  $('#tripFormTitle').textContent = '–ù–æ–≤–∞—è –ø–æ–µ–∑–¥–∫–∞';
  $('#tripButtonsNew').style.display='';
  $('#tripButtonsEdit').style.display='none';
  $('#tripEditBtn').style.display='none';
  $('#tripViewBtn').style.display='none';
  clearTripForm(); buildRouteOptions(); tripToggleEdit(true); openTripForm(true);
  const dr=S('draft_trip'); if(dr){ restoreDraft(); }
}
function tripSaveNew(){
  const t = tripSkeletonFromForm();
  t.id = Date.now();
  [t.route1,t.route2,t.pass?.route].forEach(r=>{if(r){let cache=getRoutesCache(); if(!cache.includes(r)){cache.unshift(r); if(cache.length>50) cache.pop(); setRoutesCache(cache);}}});
  const arr=getTrips(); arr.push(t);
  arr.sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id));
  setTrips(arr);
  S('draft_trip', null);
  openTripForm(false); renderTrips(); updateDash();
}
function tripOpen(id){
  const t = getTrips().find(x=>x.id===id); if(!t) return;
  currentTripId = id;
  $('#tripFormTitle').textContent = '–ü–æ–µ–∑–¥–∫–∞: '+(t.route1||t.route||'‚Äî');
  $('#tripButtonsNew').style.display='none';
  $('#tripButtonsEdit').style.display='';
  $('#tripEditBtn').style.display='';
  $('#tripViewBtn').style.display='none';

  $('#t_date').value = t.date || new Date().toISOString().slice(0,10);
  $('#t_date2').value = t.date2 || '';
  $('#t_route1').value = t.route1 || t.route || '';
  $('#t_route2').value = t.route2 || '';
  $('#t_trainNo1').value = t.trainNo1 || '';
  $('#t_trainNo2').value = t.trainNo2 || '';
  type1 = t.type1 || ''; type2 = t.type2 || '';
  $('#t_typeBtn1').textContent=type1?type1:'–í—ã–±—Ä–∞—Ç—å';
  $('#t_typeBtn2').textContent=type2?type2:'–í—ã–±—Ä–∞—Ç—å';
  $('#t_start1').value = t.start1 || '';
  $('#t_end1').value = t.end1 || '';
  $('#t_start2').value = t.start2 || '';
  $('#t_end2').value = t.end2 || '';
  if(t.pass){ $('#pass_mode').value=t.pass.mode||'off'; $('#p_date1').value=t.pass.date1||''; $('#p_route').value=t.pass.route||''; $('#p_wait').value=t.pass.wait||0; $('#p_start').value=t.pass.start||''; $('#p_end').value=t.pass.end||''; $('#p_date2').value=t.pass.date2||''; } else { $('#pass_mode').value='off'; ['p_date1','p_route','p_wait','p_start','p_end','p_date2'].forEach(id=>$('#'+id).value=''); }
  passengerModeChanged();

  recalcDuration(); tripToggleEdit(false); openTripForm(true);
}
function tripSaveEdit(){
  if(currentTripId==null) return;
  let arr=getTrips();
  const ix = arr.findIndex(x=>x.id===currentTripId); if(ix<0) return;
  const upd = {...arr[ix], ...tripSkeletonFromForm()};
  arr[ix]=upd; arr.sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id));
  setTrips(arr);
  tripToggleEdit(false);
  openTripForm(false); // —Å–≤–µ—Ä–Ω—É—Ç—å –ø–æ –≤–∞—à–µ–º—É –¢–ó
  renderTrips(); updateDash();
}
function tripCancel(){ openTripForm(false); currentTripId=null; }

/* ========= live & two-nights ========= */
function shouldBeLive(t){
  if(t.start1 && !t.end1) return 'leg1';
  if(t.start2 && !t.end2) return 'leg2';
  return '';
}
function humanSince(ms){ if(ms==null || ms<0) return '‚Äî'; const min = Math.floor(ms/60000); const h = Math.floor(min/60), m=min%60; return h+'—á '+String(m).padStart(2,'0')+'–º'; }
function effectiveReturnDateForTrip(t){
  if(t.date2 && t.date2.trim()) return t.date2.trim();
  if(t.start2 && t.end1 && toMin(t.start2)!=null && toMin(t.end1)!=null && toMin(t.start2) < toMin(t.end1)) return dateAddDays(t.date,1);
  return t.date;
}
function isTwoNightsTrip(t){
  const tzMin = getSelectedTzOffsetMin();
  const date = t.date;
  if(!date) return false;
  const startEpoch = epochFromDateTimeTz(date, t.start1 || t.start2, tzMin);
  const date2 = effectiveReturnDateForTrip(t);
  const endEpoch = epochFromDateTimeTz(date2, t.end2 || t.end1 || t.start2 || t.start1, tzMin);
  const cnt = countNightWindows0005(startEpoch, endEpoch, tzMin);
  return cnt >= 2;
}
function updateLiveTimers(force){
  const tzMin = getSelectedTzOffsetMin();
  const now = Date.now();
  let currentLiveTrip=null, currentLiveTitle='';
  $all('[data-live-trip]').forEach(el=>{
    const id = Number(el.getAttribute('data-live-trip'));
    const t = (getTrips()||[]).find(x=>x.id===id);
    if(!t){ el.textContent=''; return; }
    const mode = shouldBeLive(t);
    if(!mode){ el.textContent=''; return; }
    const date = t.date || new Date().toISOString().slice(0,10);
    const date2 = effectiveReturnDateForTrip(t);
    let startEpoch = (mode==='leg1')
      ? epochFromDateTimeTz(date, t.start1, tzMin)
      : epochFromDateTimeTz(date2, t.start2, tzMin);
    if(startEpoch==null){ el.textContent=''; return; }
    el.textContent = '–≤ –ø—É—Ç–∏ ¬∑ '+humanSince(now - startEpoch);
    currentLiveTrip=t; currentLiveTitle=(t.route1||t.route||'‚Äî');
  });
  const mon=$('#monitor');
  if(currentLiveTrip){
    $('#monTitle').textContent='–í –ø—É—Ç–∏ ¬∑ '+(currentLiveTitle||'‚Äî');
    $('#monTimer').textContent = '–æ–±–Ω–æ–≤–ª–µ–Ω–æ: '+new Date().toLocaleTimeString();
    mon.classList.add('show');
  }else{
    mon.classList.remove('show');
  }
  if(force){ /* noop */ }
}
function scrollToCurrentTrip(){
  const arr=getTrips().slice();
  const live = arr.find(t=>shouldBeLive(t));
  if(!live) return;
  const el = document.querySelector('[data-trip="'+live.id+'"]');
  if(el) el.scrollIntoView({behavior:'smooth',block:'center'});
}

/* ========= list & delete & compact accordion ========= */
function tripDel(id){ if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–µ–∑–¥–∫—É?')) return; setTrips(getTrips().filter(x=>x.id!==id)); renderTrips(); updateDash(); }
function toggleTripOpen(el){ el.classList.toggle('open'); }
function renderTrips(){
  let box=$('#daysList');box.innerHTML='';
  let q = ($('#tripSearch').value||'').trim().toLowerCase();
  let arr=getTrips().slice();
  arr.sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id));
  if(q) arr = arr.filter(t=>(t.route1||t.route||'').toLowerCase().includes(q) || (t.route2||'').toLowerCase().includes(q) || (t.notes||'').toLowerCase().includes(q));
  if(!arr.length){let d=document.createElement('div');d.className='small';d.style.opacity=.7;d.textContent='–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫';box.appendChild(d)}
  let totalMoney=0;
  arr.forEach(t=>{
    let minutes = Math.round(toNum(t.hours)*60);
    let h = minutes/60;
    let m = tripMoney(h, t.type1||t.type2||'');
    totalMoney+=m;
    const live = shouldBeLive(t) ? '<span class="badge-live" data-live-trip="'+t.id+'"></span>' : '';
    const twoN = isTwoNightsTrip(t) ? '<span class="badge-two">–¥–≤–µ –Ω–æ—á–∏</span>' : '';
    const row=document.createElement('div'); row.className='trip'; row.setAttribute('data-trip', t.id);
    row.onclick = (e)=>{ if(e.target.closest('button')) return; toggleTripOpen(row); };
    const meta = `
      <div class="meta">
        <div>‚Ññ(—Ç—É–¥–∞/–æ–±—Ä): ${(t.trainNo1||'‚Äî')} / ${(t.trainNo2||'‚Äî')} ‚Ä¢ –≤–∏–¥: ${(t.type1||'‚Äî')} / ${(t.type2||'‚Äî')}</div>
        <div>–¢—É–¥–∞: —è–≤–∫–∞ ${t.start1||'‚Äî'} ‚Äî –∫–æ–Ω–µ—Ü ${t.end1||'‚Äî'}</div>
        <div>–û–±—Ä–∞—Ç–Ω–æ: ${t.date2?('['+t.date2+'] '):''}—è–≤–∫–∞ ${t.start2||'‚Äî'} ‚Äî –∫–æ–Ω–µ—Ü ${t.end2||'‚Äî'}</div>
        ${t.pass && t.pass.mode!=='off' ? `<div>–°–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º (${t.pass.mode==='replace1'?'–≤–º–µ—Å—Ç–æ –¢–£–î–ê':'–≤–º–µ—Å—Ç–æ –û–ë–†–ê–¢–ù–û'}): ${t.pass.route||'‚Äî'} ‚Ä¢ ${t.pass.date1||'‚Äî'} ${t.pass.start||'‚Äî'} ‚Üí ${t.pass.date2||'‚Äî'} ${t.pass.end||'‚Äî'} ‚Ä¢ –æ–∂–∏–¥–∞–Ω–∏–µ ${toNum(t.pass.wait)||0} –º–∏–Ω</div>` : ''}
        <div>–û—Ç–¥—ã—Ö: ${fmtHMWords(toNum(t.rest)||0)}</div>
        <div>–ò—Ç–æ–≥ –±–µ–∑ –æ—Ç–¥—ã—Ö–∞: ${fmtHMWords(minutes)}</div>
        ${t.notes?('<div>–ó–∞–º–µ—Ç–∫–∏: '+t.notes+'</div>'):''}
      </div>`;
    row.innerHTML = `
      <div><span class="hdr">${t.date||'‚Äî'} ‚Ä¢ ${(t.route1||t.route||'‚Äî')}</span> ${live} ${twoN} ${meta}</div>
      <div>${(h? h.toFixed(1):'‚Äî')} —á</div>
      <div class="money">${h? RUR.format(m) : '‚Äî'}</div>
      <div class="actions">
        <button class="btn" onclick="event.stopPropagation(); tripOpen(${t.id})">üîç</button>
        <button class="btn" onclick="event.stopPropagation(); tripDel(${t.id})">üóë</button>
      </div>`;
    box.appendChild(row);
  });
  if(arr.length){
    let sum=document.createElement('div'); sum.className='small'; sum.style.textAlign='right'; sum.style.marginTop='6px'; sum.style.opacity='.9';
    sum.textContent='–ò—Ç–æ–≥–æ –∑–∞ –º–µ—Å—è—Ü: '+RUR.format(totalMoney);
    box.appendChild(sum);
  }
  updateLiveTimers(true);
}

/* ========= CSV ========= */
function csvEscape(v){if(v==null)return'';let s=String(v).replace(/"/g,'""');return /[",\n;]/.test(s)?('"'+s+'"'):s}
function exportTripsCsv(){
  let arr=getTrips().slice().sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id));
  let head=['–î–∞—Ç–∞','–ú–∞—Ä—à—Ä—É—Ç 1','–ú–∞—Ä—à—Ä—É—Ç 2','–¢—É–¥–∞ —è–≤–∫–∞','–¢—É–¥–∞ –∫–æ–Ω–µ—Ü','–î–∞—Ç–∞ (–æ–±—Ä.)','–û–±—Ä–∞—Ç–Ω–æ —è–≤–∫–∞','–û–±—Ä–∞—Ç–Ω–æ –∫–æ–Ω–µ—Ü','‚Ññ(—Ç—É–¥–∞)','‚Ññ(–æ–±—Ä)','–í–∏–¥(—Ç—É–¥–∞)','–í–∏–¥(–æ–±—Ä)','–û—Ç–¥—ã—Ö (–º–∏–Ω)','–ß–∞—Å—ã','–ó–∞–º–µ—Ç–∫–∏'];
  let rows=[head];
  arr.forEach(t=>{
    rows.push([
      t.date||'', t.route1||t.route||'', t.route2||'',
      t.start1||'', t.end1||'', t.date2||'', t.start2||'', t.end2||'',
      t.trainNo1||'', t.trainNo2||'', t.type1||'', t.type2||'',
      toNum(t.rest)||0, toNum(t.hours)||0, (t.notes||'').replace(/\n/g,' ')
    ]);
  });
  let csv=rows.map(r=>r.map(csvEscape).join(';')).join('\n');
  let blob=new Blob([csv],{type:'text/csv;charset=utf-8'});let url=URL.createObjectURL(blob);
  let a=document.createElement('a');a.href=url;a.download='trips.csv';a.click();setTimeout(()=>URL.revokeObjectURL(url),500);
}

/* ========= dashboard ========= */
function updateDash(){
  let t=getTar();
  let trips=getTrips().slice().sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id));
  let minsTotal = Math.round((trips.reduce((a,x)=>a+toNum(x.hours),0))*60);
  let norm=t.norm*60; let pct=norm?Math.round(minsTotal/norm*100):0; let rem=norm-minsTotal;
  $('#mwNorm').textContent=t.norm+' —á';
  $('#mwWorked').textContent=fmtM(minsTotal);
  $('#mwPercent').textContent=pct+'%';
  $('#mwRemain').textContent=rem>=0?('–û—Å—Ç–∞–ª–æ—Å—å: '+fmtM(rem)):('–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞: '+fmtM(-rem));
  $('#mwBar').style.width=Math.min(pct,100)+'%';
}

/* ========= backup/import ========= */
function backup(){
  let data={tar:getTar(),trips:getTrips(),secs:getSecs(),routes:getRoutesCache(),tz:S('tz_pref'),profile:S('profile'),files:S('pf_files'),cfg:S('cfg'),theme:S('theme'),draft:S('draft_trip'),schema:S('schemaVersion')};
  let blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  let url=URL.createObjectURL(blob);let a=document.createElement('a');a.href=url;a.download='bm-backup.json';a.click();setTimeout(()=>URL.revokeObjectURL(url),500);
}
function restoreFileChanged(e){
  let f=e.target.files[0]; if(!f)return;
  let rd=new FileReader();
  rd.onload=()=>{try{
    let d=JSON.parse(rd.result);
    if(d.tar)S('tar',d.tar); if(d.trips)S('trips',d.trips); if(d.secs)S('secs',d.secs); if(d.routes)S('routes_cache',d.routes);
    if(d.tz)S('tz_pref',d.tz); if(d.profile)S('profile',d.profile); if(d.files)S('pf_files',d.files);
    if(d.cfg)S('cfg',d.cfg); if(d.theme)S('theme',d.theme); if(d.draft)S('draft_trip',d.draft); if(d.schema)S('schemaVersion',d.schema);
    init(); alert('–ì–æ—Ç–æ–≤–æ');
  }catch(err){alert('–û—à–∏–±–∫–∞: '+err.message)}};
  rd.readAsText(f);
}
function restoreFromText(){
  const raw = (document.getElementById('restoreText').value || '').trim();
  if(!raw){ alert('–ü–æ–ª–µ –ø—É—Å—Ç–æ–µ'); return; }
  try{
    const d = JSON.parse(raw);
    Object.keys(d).forEach(k=>S(k, d[k]));
    init(); alert('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
  }catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å JSON: ' + e.message); }
}
async function pasteFromClipboard(){
  try{
    if(!navigator.clipboard){ alert('–ë—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); return; }
    const txt = await navigator.clipboard.readText();
    document.getElementById('restoreText').value = txt || '';
    if(!txt) alert('–í –±—É—Ñ–µ—Ä–µ –æ–±–º–µ–Ω–∞ –ø—É—Å—Ç–æ');
  }catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –±—É—Ñ–µ—Ä: ' + e.message); }
}

/* ========= –ü–æ–ª–Ω—ã–π –æ—Ç–¥—ã—Ö ========= */
function closeFullRest(){ const box=$('#restResult'); if(box){ box.innerHTML=''; } }
function calcFullRest(){
  const arr=getTrips(); if(!arr.length){ alert('–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫'); return; }
  const t = arr.slice().sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id)).pop();

  const d1 = diffMinutes(t.start1, t.end1) || 0;
  const date2 = effectiveReturnDateForTrip(t);
  const d2 = diffMinutes(t.start2, t.end2) || 0;

  const totalWorkMin = d1 + d2;
  const restMin = toNum(t.rest) || 0;

  const tzMin = getSelectedTzOffsetMin();
  const startEpoch = epochFromDateTimeTz(t.date, t.start1 || t.start2, tzMin);
  const endEpoch   = epochFromDateTimeTz(date2, t.end2 || t.end1 || t.start2 || t.start1, tzMin);
  const night0005Count = countNightWindows0005(startEpoch, endEpoch, tzMin);
  const twoNights = night0005Count >= 2;

  const fullRestMin = Math.max(0, Math.round(totalWorkMin * 2.6 - (twoNights ? 0 : restMin)));
  const fullRestWithDayMin = fullRestMin + 24*60;

  const endBackEpoch = epochFromDateTimeTz(date2, t.end2 || t.start2 || t.end1 || t.start1, tzMin);
  let endRest=null, endRestW=null;
  if(endBackEpoch!=null){
    endRest  = addMinutesEpoch(endBackEpoch, fullRestMin);
    endRestW = addMinutesEpoch(endBackEpoch, fullRestWithDayMin);
  }

  const box = $('#restResult'); box.innerHTML='';
  const toRow=(k,v)=>{ let kdiv=document.createElement('div');kdiv.textContent=k; let vdiv=document.createElement('div');vdiv.textContent=v; box.appendChild(kdiv); box.appendChild(vdiv); };
  toRow('–î–∞—Ç–∞', t.date||'‚Äî');
  toRow('–ú–∞—Ä—à—Ä—É—Ç', t.route1 || t.route || '‚Äî');
  toRow('–í—Ä–µ–º—è –Ω–∞ —Ä–∞–±–æ—Ç–µ (—Ç—É–¥–∞+–æ–±—Ä–∞—Ç–Ω–æ)', fmtHMWords(totalWorkMin));
  toRow('–û—Ç–¥—ã—Ö –º–µ–∂–¥—É –ø–ª–µ—á–∞–º–∏', restMin?fmtHMWords(restMin):'‚Äî');
  toRow('–î–≤–µ –Ω–æ—á–∏ (00‚Äì05)', twoNights?'–î–∞':'–ù–µ—Ç');
  toRow('–ü–æ–ª–Ω—ã–π –æ—Ç–¥—ã—Ö (√ó2.6 ‚àí –æ—Ç–¥—ã—Ö*)', fmtHMWords(fullRestMin) + (twoNights?'* (–±–µ–∑ –≤—ã—á–∏—Ç–∞–Ω–∏—è –æ—Ç–¥—ã—Ö–∞, 2 –Ω–æ—á–∏)':''));
  toRow('–û–∫–æ–Ω—á–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞', endRest?fmtLocalFull(endRest,tzMin):'‚Äî');
  toRow('–ü–æ–ª–Ω—ã–π –æ—Ç–¥—ã—Ö + –≤—ã—Ö–æ–¥–Ω–æ–π', fmtHMWords(fullRestWithDayMin));
  toRow('–û–∫–æ–Ω—á–∞–Ω–∏–µ —Å –≤—ã—Ö–æ–¥–Ω—ã–º', endRestW?fmtLocalFull(endRestW,tzMin):'‚Äî');
}

/* ========= –†–ñ–î-–∑–∞—Ä–ø–ª–∞—Ç–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –º–æ–¥–µ–ª—å) ========= */
function cfgGet(){ return S('cfg')||{pin:'', theme:'auto'} }
function cfgSave(){ const c=cfgGet(); c.pin = $('#cfg_pin')?$('#cfg_pin').value:''; S('cfg',c); }
function openSalary(){
  const c=cfgGet(); const pin=(document.getElementById('payPin')||{}).value||'';
  if((c.pin||'').length && pin!==c.pin){ alert('–ù–µ–≤–µ—Ä–Ω—ã–π PIN'); return; }
  renderSalary();
}
function hideSalary(){ const b=$('#salaryBox'); if(b) b.innerHTML=''; }

function monthKeyFromDate(dateStr){ if(!dateStr) return '0000-00'; return dateStr.slice(0,7); } // YYYY-MM
function renderSalary(){
  const box = $('#salaryBox'); box.innerHTML='';
  const trips = getTrips().slice().sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.id-b.id));
  if(!trips.length){ box.textContent='–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'; return; }
  const t=getTar();
  let monthAgg={};

  trips.forEach(tr=>{
    const mk = monthKeyFromDate(tr.date);
    if(!monthAgg[mk]) monthAgg[mk]={hours:0, nightMin:0, money:0, passMin:0};
    const minutes = Math.round(toNum(tr.hours)*60);
    let baseHours = minutes/60;

    // –£—á–µ—Ç passenger –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ (–¥–ª—è –ø—Ä–∏–º–µ—Ä–∞) ‚Äî –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å –ø–æ–¥ —Ä–µ–∞–ª—å–Ω—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã
    let passMin=0;
    if(tr.pass && tr.pass.mode!=='off' && tr.pass.start && tr.pass.end){
      const tzMin=getSelectedTzOffsetMin();
      const pDate1=tr.pass.date1||tr.date; const pDate2= tr.pass.date2 || (toMin(tr.pass.end)<toMin(tr.pass.start)?dateAddDays(pDate1,1):pDate1);
      const e1=epochFromDateTimeTz(pDate1,tr.pass.start,tzMin), e2=epochFromDateTimeTz(pDate2,tr.pass.end,tzMin);
      if(e1!=null && e2!=null){ passMin = Math.max(0, Math.round((e2-e1)/60000)) + (toNum(tr.pass.wait)||0); }
    }

    const type = tr.type1||tr.type2||'';
    const money = tripMoney(baseHours, type);

    monthAgg[mk].hours += baseHours;
    monthAgg[mk].money += money;
    monthAgg[mk].passMin += passMin;
  });

  let html = '';
  Object.keys(monthAgg).sort().forEach(mk=>{
    const a=monthAgg[mk];
    html += `<div class="card"><b>${mk}</b>
      <div class="kv" style="margin-top:6px">
        <div>–ß–∞—Å—ã (–±–µ–∑ –æ—Ç–¥—ã—Ö–∞)</div><div>${a.hours.toFixed(1)} —á</div>
        <div>–°–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º</div><div>${fmtHMWords(Math.round(a.passMin))}</div>
        <div>–ò—Ç–æ–≥–æ –¥–µ–Ω–µ–≥</div><div>${RUR.format(Math.round(a.money))}</div>
      </div></div>`;
  });
  box.innerHTML = html;
}

/* ========= –ö–∞–ª–µ–Ω–¥–∞—Ä—å ========= */
function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
function toggleListCalendar(showCal){
  const box=$('#calendarBox'); if(!showCal){ box.innerHTML=''; return; }
  const now=new Date();
  const y=now.getFullYear(), m=now.getMonth();
  const trips=getTrips().slice().filter(t=>t.date && t.date.startsWith(`${y}-${String(m+1).padStart(2,'0')}`));
  const map={};
  trips.forEach(t=>{
    const d=Number(t.date.slice(8,10));
    (map[d]=map[d]||[]).push(t);
  });
  const dm=daysInMonth(y,m);
  let grid='<div class="calendar">';
  for(let d=1; d<=dm; d++){
    const list = map[d]||[];
    const sum = list.reduce((a,x)=>a+toNum(x.hours),0);
    grid+=`<div class="cal-cell"><div class="d">${String(d).padStart(2,'0')}</div>${list.length?`<div class="sum">${list.length} –ø–æ–µ–∑–¥. ‚Ä¢ ${sum.toFixed(1)} —á</div>`:''}</div>`;
  }
  grid+='</div>';
  box.innerHTML=grid;
}
function closeCalendar(){ $('#calendarBox').innerHTML=''; }

/* ========= Profile data ========= */
function getProfile(){ return S('profile') || {first:'',last:'',age:'',role:'',place:'',start:'',photo:'',notes:''}; }
function setProfile(p){ S('profile',p); }
function loadProfile(){
  const p=getProfile();
  $('#pf_first').value=p.first||''; $('#pf_last').value=p.last||'';
  $('#pf_age').value=p.age||''; $('#pf_role').value=p.role||'';
  $('#pf_place').value=p.place||''; $('#pf_start').value=p.start||''; $('#pf_notes').value=p.notes||'';
  renderTenure();
  if(p.photo){ $('#pfAvatar').src=p.photo; $('#pfAvatar').style.display=''; $('#pfAvatarBig').src=p.photo; }
  else { $('#pfAvatar').style.display='none'; $('#pfAvatarBig').removeAttribute('src'); }
  renderFilesList();
}
function renderTenure(){
  const start = $('#pf_start').value;
  if(!start){ $('#pf_tenure').value=''; return; }
  const a = new Date(start+'T00:00:00');
  const b = new Date();
  let years = b.getFullYear()-a.getFullYear();
  let months = b.getMonth()-a.getMonth();
  if(b.getDate()<a.getDate()) months--;
  if(months<0){ years--; months+=12; }
  $('#pf_tenure').value = `${years} ${plural(years,'–≥–æ–¥','–≥–æ–¥–∞','–ª–µ—Ç')} ${months} ${plural(months,'–º–µ—Å—è—Ü','–º–µ—Å—è—Ü–∞','–º–µ—Å—è—Ü–µ–≤')}`;
}
function profilePhotoChanged(e){
  const f=e.target.files[0]; if(!f) return;
  const rd=new FileReader();
  rd.onload=()=>{ $('#pfAvatar').src=rd.result; $('#pfAvatar').style.display=''; $('#pfAvatarBig').src=rd.result; };
  rd.readAsDataURL(f);
}
function profileSave(){
  const p=getProfile();
  p.first=$('#pf_first').value||''; p.last=$('#pf_last').value||'';
  p.age=$('#pf_age').value||''; p.role=$('#pf_role').value||'';
  p.place=$('#pf_place').value||''; p.start=$('#pf_start').value||'';
  p.notes=$('#pf_notes').value||'';
  const img=$('#pfAvatarBig'); if(img && img.src) p.photo=img.src;
  setProfile(p);
  if(p.photo){ $('#pfAvatar').src=p.photo; $('#pfAvatar').style.display=''; }
  else { $('#pfAvatar').style.display='none'; }
  alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
}

/* ========= Profile: files (–ø—Ä–æ—Å—Ç–∞—è –ª–∏—Å—Ç–∞) ========= */
function getPfFiles(){ return S('pf_files')||[] }
function setPfFiles(v){ S('pf_files', v); }
function addFilesToProfile(e){
  const files = Array.from(e.target.files||[]);
  if(!files.length) return;
  let list=getPfFiles();
  let pending = files.length;
  files.forEach(f=>{
    const rd=new FileReader();
    rd.onload=()=>{
      list.push({id:Date.now()+Math.random(), name:f.name, dataUrl:rd.result, type:f.type, size:f.size, addedAt:Date.now()});
      pending--; if(pending===0){ setPfFiles(list); renderFilesList(); e.target.value=''; }
    };
    rd.readAsDataURL(f);
  });
}
function renderFilesList(){
  const box=$('#filesList'); if(!box) return;
  const list=getPfFiles().slice().sort((a,b)=>a.name.localeCompare(b.name));
  box.innerHTML='';
  if(!list.length){ box.innerHTML='<div class="small" style="opacity:.7">–ù–µ—Ç —Ñ–∞–π–ª–æ–≤</div>'; return; }
  list.forEach(f=>{
    const row = document.createElement('div'); row.className='file-row'; row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
    row.style.border='1px solid var(--line)'; row.style.borderRadius='10px'; row.style.padding='8px 10px'; row.style.margin='6px 0';
    row.innerHTML = `<div><b>${f.name}</b><div class="small" style="opacity:.7">${f.type||'file'} ‚Ä¢ ${(f.size/1024).toFixed(1)} –ö–ë</div></div>`;
    const right=document.createElement('div');
    const a = document.createElement('a'); a.href=f.dataUrl; a.download=f.name; a.textContent='–°–∫–∞—á–∞—Ç—å'; a.className='btn'; a.style.marginRight='6px';
    const del = document.createElement('button'); del.className='btn'; del.textContent='üóë'; del.onclick=()=>{ let x=getPfFiles().filter(x=>x.id!==f.id); setPfFiles(x); renderFilesList(); };
    right.appendChild(a); right.appendChild(del); row.appendChild(right); box.appendChild(row);
  });
}

/* ========= INIT ========= */
function cfgInitUI(){ const c=cfgGet(); if($('#cfg_pin')) $('#cfg_pin').value=c.pin||''; }
function init(){
  migrate();
  updateNetPill(); themeApply(); cfgInitUI();
  tzPopulateSelect();
  // –ø—Ä–æ—Ç—è–Ω—É—Ç—å —Ç–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ –∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–æ—Ä–º—ã –∏ —Ç.–ø. –≤ UI
  const t=getTar();
  if($('#tar_base')) $('#tar_base').value=t.base;
  if($('#tar_norm')) $('#tar_norm').value=t.norm;
  if($('#tar_rc')) $('#tar_rc').value=t.rc;
  if($('#tar_north')) $('#tar_north').value=t.north;
  if($('#tar_cls')) $('#tar_cls').value=t.cls;
  if($('#tar_zone')) $('#tar_zone').value=t.zone;
  if($('#tar_bam')) $('#tar_bam').value=t.bam;
  if($('#tar_fee')) $('#tar_fee').value=t.fee;

  const p=getProfile(); if(p.photo){ $('#pfAvatar').src=p.photo; $('#pfAvatar').style.display=''; }

  renderTrips(); renderSecs(); buildRouteOptions(); updateDash();
  passengerModeChanged();
  setInterval(updateLiveTimers, 30000);
}
init();

/* ========= PWA: SW + –û–±–Ω–æ–≤–∏—Ç—å + –≤—ã–∫–ª—é—á–∞—Ç–µ–ª—å ?no-sw=1 ========= */
(function(){
  const usp = new URLSearchParams(location.search);
  if (usp.get('no-sw') === '1') {
    if ('serviceWorker' in navigator) { navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister())); }
    if (window.caches) caches.keys().then(ks => ks.forEach(k => caches.delete(k)));
    console.log('SW disabled by ?no-sw=1');
    return;
  }
  window.appUpdate = async function(){
    try{
      if (!('serviceWorker' in navigator)) { location.reload(); return; }
      const reg = await navigator.serviceWorker.getRegistration();
      if (!reg) { location.reload(); return; }
      if (reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'}); else await reg.update();
      let reloaded=false;
      navigator.serviceWorker.addEventListener('controllerchange', ()=>{ if(!reloaded){reloaded=true; location.replace(location.pathname+'?cb='+Date.now());}});
      setTimeout(()=>{ if(!reloaded) location.replace(location.pathname+'?cb='+Date.now()); }, 1000);
    }catch(e){ location.reload(); }
  };
  window.addEventListener('load', function(){
    if (!('serviceWorker' in navigator)) return;
    const scope = location.pathname.replace(/\/[^\/]*$/, '/') || '/';
    navigator.serviceWorker.register('sw.js', { scope }).then(reg => {
      const btn = document.getElementById('appRefresh');
      function showRefresh(){ if(btn) btn.style.display=''; }
      if (reg.waiting) showRefresh();
      reg.addEventListener('updatefound', ()=>{
        const nw = reg.installing; if(!nw) return;
        nw.addEventListener('statechange', ()=>{ if (nw.state==='installed' && navigator.serviceWorker.controller) showRefresh(); });
      });
      navigator.serviceWorker.addEventListener('controllerchange', ()=>{ if(btn) btn.style.display='none'; });
    }).catch(err => console.warn('SW register failed', err));
  });
})();
</script>
</body>
</html>
