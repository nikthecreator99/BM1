<!-- PART 1/6 START: HEAD & STYLES -->
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>–ë–ª–æ–∫–Ω–æ—Ç –ú–∞—à–∏–Ω–∏—Å—Ç–∞ ¬∑ Lite v2025.29A-PWA</title>
<meta name="theme-color" content="#d32f2f">
<link rel="manifest" href="manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<!-- iOS –∏–∫–æ–Ω–∫–∏ -->
<link rel="apple-touch-icon" href="apple-touch-icon.png?v=202529A">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180x180.png?v=202529A">
<link rel="apple-touch-icon" sizes="167x167" href="apple-touch-icon-167x167.png?v=202529A">
<link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon-152x152.png?v=202529A">

<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0}
:root{
  --red:#d32f2f;--bg:#0f1420;--card:#161d2a;--line:#243246;--mut:#8aa0b6;--txt:#e9eef5;
  --ink:#0e1622;--ok:#1b2738;--green:#2e7d32;--amber:#ffb300
}
body.theme-light{ --bg:#ffffff; --card:#ffffff; --line:#e6ecf3; --mut:#5b6b7a; --txt:#101622; --ink:#f5f7fb; --ok:#e8eef7; }
body{background:var(--bg);color:var(--txt);font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
a{color:inherit}
header{position:sticky;top:0;background:var(--red);color:#fff;padding:12px 14px;display:flex;gap:10px;justify-content:space-between;align-items:center;z-index:10;flex-wrap:wrap}
h1{margin:0;font-size:18px}
.badge{font-size:12px;padding:2px 8px;border:1px solid rgba(255,255,255,.4);border-radius:999px;white-space:nowrap}
.container{padding:12px 12px 84px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:10px}
.row{display:flex;gap:8px;align-items:center;margin:8px 0}
.row label{width:48%;color:var(--mut);font-size:14px}
.row input,.row select,.row textarea{flex:1;background:var(--ink);border:1px solid var(--line);color:var(--txt);padding:10px;border-radius:10px;font-size:16px}
.row textarea{min-height:90px;resize:vertical}
.btn{background:var(--ok);color:#fff;border:1px solid var(--line);padding:10px 14px;border-radius:10px;font-size:15px;cursor:pointer}
.btn.primary{background:#fff;color:#d32f2f;border-color:#fff}
.small{font-size:12px}
.view{display:none}
.view.active{display:block}
.tabbar{position:fixed;left:0;right:0;bottom:0;height:70px;background:#121828;border-top:1px solid var(--line);display:flex}
body.theme-light .tabbar{background:#f6f8fb;border-top-color:#e6ecf3}
.tabbar button{flex:1;background:transparent;border:none;color:#8aa0b6;font-size:12px;padding:6px 0}
.tabbar button.active{color:#fff}
body.theme-light .tabbar button.active{color:#d32f2f}
.tabbar .ico{display:block;font-size:18px;margin-bottom:4px}
.progress{height:10px;border:1px solid var(--line);border-radius:999px;overflow:hidden;background:#0f2035}
body.theme-light .progress{background:#ffe6e6}
.progress>div{height:100%;background:#d32f2f;width:0%}
.trip{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid var(--line)}
.trip:last-child{border-bottom:0}
.actions{display:flex;gap:6px}
.tap{cursor:pointer}
.money{white-space:nowrap}
.legend{color:#a9bacd;font-size:12px;margin:-2px 0 6px}
table{width:100%;border-collapse:collapse}
th,td{padding:6px 4px;border-bottom:1px solid var(--line);text-align:left}
th{color:#a9bacd}
.badge-live{display:inline-block;background:rgba(46,125,50,.12);border:1px solid rgba(46,125,50,.6);color:#2e7d32;padding:2px 6px;border-radius:999px;font-size:12px;margin-left:6px;white-space:nowrap}
.badge-two{display:inline-block;background:rgba(211,47,47,.15);border:1px solid rgba(211,47,47,.6);color:#ff8a80;padding:2px 6px;border-radius:999px;font-size:12px;margin-left:6px;white-space:nowrap}
.net-pill{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.5);padding:4px 8px;border-radius:999px;font-size:12px}
.net-pill.off{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.3);color:#ffe082}
.net-pill.on{background:rgba(255,255,255,.2);border-color:rgba(255,255,255,.7);color:#c8e6c9}
.update-pill{background:#fff;color:#d32f2f;border:1px solid #fff;padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer;display:none}

/* –ü—Ä–æ—Ñ–∏–ª—å */
.avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,.3)}
.avatar.big{width:64px;height:64px}

/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ */
.hr{height:1px;background:var(--line);margin:8px 0}
.kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px}
</style>
</head>
<!-- PART 1/6 END --><!-- PART 2/6 START: BODY HEADER & MAIN VIEWS -->
<body>
<header>
  <h1>–ë–ª–æ–∫–Ω–æ—Ç –ú–∞—à–∏–Ω–∏—Å—Ç–∞</h1>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <span id="netStatus" class="net-pill off">–û—Ñ—Ñ–ª–∞–π–Ω</span>
    <div class="badge">Lite v2025.29A-PWA</div>
    <button id="appRefresh" class="update-pill" onclick="appUpdate()">–û–±–Ω–æ–≤–∏—Ç—å</button>
  </div>
</header>

<main class="container">
  <!-- –ì–ª–∞–≤–Ω–∞—è -->
  <section id="v-dashboard" class="view active">
    <div class="card">
      <div style="display:flex;justify-content:space-between"><b>–ú–µ—Å—è—á–Ω–∞—è –Ω–æ—Ä–º–∞</b><b id="mwNorm">‚Äî</b></div>
      <div class="progress" style="margin-top:6px"><div id="mwBar"></div></div>
      <div class="row"><label>–ù–æ—Ä–º–∞, —á/–º–µ—Å</label><input id="tar_norm" type="number" inputmode="decimal" placeholder="176" oninput="tarSave()"></div>
      <div class="row"><label>–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ</label><div id="mwWorked" class="small">‚Äî</div></div>
      <div class="row"><label>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</label><div id="mwPercent" class="small">‚Äî</div></div>
      <div class="row"><label>–û—Å—Ç–∞–ª–æ—Å—å/–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞</label><div id="mwRemain" class="small">‚Äî</div></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>–ü–æ–µ–∑–¥–∫–∏</b>
        <div>
          <button class="btn primary" onclick="addTripOpen()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn" onclick="exportTripsCsv()">CSV</button>
        </div>
      </div>

      <!-- –§–æ—Ä–º–∞ –ø–æ–µ–∑–¥–∫–∏ -->
      <div id="tripForm" class="card" style="display:none;margin-top:10px">
        <div class="legend" style="margin-bottom:6px"><b>–¢—É–¥–∞</b></div>
        <div class="row"><label>–î–∞—Ç–∞ (—Ç—É–¥–∞)</label><input id="t_date" type="date"></div>
        <div class="row"><label>–ú–∞—Ä—à—Ä—É—Ç (—Ç—É–¥–∞)</label><input id="t_route1" list="routeList"></div>
        <datalist id="routeList"></datalist>
        <div class="row"><label>–Ø–≤–∫–∞ (—Ç—É–¥–∞)</label><input id="t_start1" type="time" oninput="recalcDuration()"></div>
        <div class="row"><label>–ù–æ–º–µ—Ä –ø–æ–µ–∑–¥–∞</label><input id="t_trainNo1" placeholder="2105"></div>
        <div class="row"><label>–í–∏–¥ –ø–æ–µ–∑–¥–∞</label><button class="btn" onclick="chooseTrainType('t')">–í—ã–±—Ä–∞—Ç—å</button><span id="trainType_t"></span></div>
        <div class="row"><label>–ö–æ–Ω–µ—Ü —Ä–∞–±–æ—Ç—ã (—Ç—É–¥–∞)</label><input id="t_end1" type="time" oninput="recalcDuration()"></div>

        <div class="legend" style="margin-top:14px;margin-bottom:6px"><b>–û–±—Ä–∞—Ç–Ω–æ</b></div>
        <div class="row"><label>–î–∞—Ç–∞ (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_date2" type="date" oninput="recalcDuration()"></div>
        <div class="row"><label>–ú–∞—Ä—à—Ä—É—Ç (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_route2" list="routeList"></div>
        <div class="row"><label>–Ø–≤–∫–∞ (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_start2" type="time" oninput="recalcDuration()"></div>
        <div class="row"><label>–ù–æ–º–µ—Ä –ø–æ–µ–∑–¥–∞</label><input id="t_trainNo2" placeholder="2106"></div>
        <div class="row"><label>–í–∏–¥ –ø–æ–µ–∑–¥–∞</label><button class="btn" onclick="chooseTrainType('r')">–í—ã–±—Ä–∞—Ç—å</button><span id="trainType_r"></span></div>
        <div class="row"><label>–ö–æ–Ω–µ—Ü —Ä–∞–±–æ—Ç—ã (–æ–±—Ä–∞—Ç–Ω–æ)</label><input id="t_end2" type="time" oninput="recalcDuration()"></div>

        <div class="legend" style="margin-top:14px;margin-bottom:6px"><b>–°–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º</b></div>
        <div class="row"><button class="btn" onclick="addPassengerFollow()">+ –î–æ–±–∞–≤–∏—Ç—å —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º</button></div>
        <div id="passengerList"></div>

        <div class="legend" style="margin-top:14px;margin-bottom:6px"><b>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</b></div>
        <div class="row"><label>–û—Ç–¥—ã—Ö</label><input id="t_rest_view" type="text" readonly></div>
        <div class="row"><label>–ù–æ—á–Ω—ã–µ</label><input id="t_night_view" type="text" readonly></div>
        <div class="row"><label>–ß–∞—Å—ã (–∏—Ç–æ–≥, –±–µ–∑ –æ—Ç–¥—ã—Ö–∞)</label><input id="t_hours_view" type="text" readonly></div>

        <div class="row"><label>–ó–∞–º–µ—Ç–∫–∏</label><textarea id="t_notes" placeholder="–ü—Ä–æ—Å—Ç–æ–∏, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏‚Ä¶"></textarea></div>

        <div class="row" id="tripButtonsNew">
          <button class="btn primary" onclick="tripSaveNew()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn" onclick="tripCancel()">–û—Ç–º–µ–Ω–∞</button>
        </div>
        <div class="row" id="tripButtonsEdit" style="display:none">
          <button class="btn primary" onclick="tripSaveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
          <button class="btn" onclick="tripCancel()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>

      <div id="daysList" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- –£—á–∞—Å—Ç–∫–∏ -->
  <section id="v-sections" class="view">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>–£—á–∞—Å—Ç–∫–∏</b><div class="actions"><button class="btn" onclick="sectionOpen()">–ù–æ–≤—ã–π —É—á–∞—Å—Ç–æ–∫</button></div>
      </div>
      <div id="sectionForm" class="card" style="display:none;margin-top:10px">
        <div class="row"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="s_name" placeholder="–ù–∞–ø—Ä.: –ú–∞–ª–æ—à—É–π–∫–∞ ‚Äî –û–±–æ–∑–µ—Ä—Å–∫–∞—è"></div>
        <div class="row"><label>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label><input id="s_from"></div>
        <div class="row"><label>–ü—Ä–∏–±—ã—Ç–∏–µ</label><input id="s_to"></div>
        <div class="row"><label>–î–ª–∏–Ω–∞ (–∫–º)</label><input id="s_len" type="number" inputmode="decimal" placeholder="0"></div>
        <div class="row">
          <button id="s_save_btn" class="btn primary" onclick="sectionSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn" onclick="sectionCancel()">–û—Ç–º–µ–Ω–∞</button>
        </div>
        <div class="small" id="s_hint" style="opacity:.7"></div>
      </div>
      <div id="sectionList"></div>
    </div>
  </section>
<!-- PART 2/6 END --><!-- PART 3/6 START: MORE, SETTINGS, PROFILE, TABS -->
  <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ -->
  <section id="v-more" class="view">
    <div class="card">
      <b>–ü–æ–ª–Ω—ã–π –æ—Ç–¥—ã—Ö –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–µ–∑–¥–∫–µ</b>
      <div id="restResult" style="margin-top:8px"></div>
      <div class="row" style="gap:8px;margin-top:10px">
        <button class="btn primary" onclick="calcFullRest()">–ü–æ—Å—á–∏—Ç–∞—Ç—å</button>
        <button class="btn" onclick="closeFullRest()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <div class="card">
      <b>–†–ñ–î –∑–∞—Ä–ø–ª–∞—Ç–∞</b>
      <div id="salaryBox" style="margin-top:8px"></div>
      <div class="row" style="gap:8px;margin-top:10px">
        <button class="btn primary" onclick="renderSalary()">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        <button class="btn" onclick="hideSalary()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <div class="card">
      <b>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ–µ–∑–¥–æ–∫</b>
      <div id="calendarBox" style="margin-top:8px"></div>
      <div class="row" style="gap:8px;margin-top:10px">
        <button class="btn primary" onclick="showCalendar()">–û—Ç–∫—Ä—ã—Ç—å</button>
        <button class="btn" onclick="hideCalendar()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <div class="card">
      <b>–¢–∞—Ä–∏—Ñ –∏ –Ω–∞–¥–±–∞–≤–∫–∏</b>
      <div class="row"><label>‚ÇΩ/—á–∞—Å (—Å—Ç–∞–≤–∫–∞)</label><input id="tar_base" type="number" inputmode="decimal" placeholder="358.46"></div>
      <div class="row"><label>–†–∞–π–æ–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç, %</label><input id="tar_rc" type="number" inputmode="decimal" placeholder="20"></div>
      <div class="row"><label>–°–µ–≤–µ—Ä–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç, %</label><input id="tar_north" type="number" inputmode="decimal" placeholder="50"></div>
      <div class="row"><label>–ö–æ–º. —Ä–∞—Å—Ö–æ–¥—ã, ‚ÇΩ</label><input id="tar_fee" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><button class="btn primary" onclick="tarSave(true)">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ</button></div>
    </div>
  </section>

  <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <section id="v-settings" class="view">
    <div class="card">
      <b>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</b>
      <div class="row"><button class="btn" onclick="appUpdate()">–û–±–Ω–æ–≤–∏—Ç—å –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏</button></div>
      <div class="small" style="opacity:.8">–ù–∞–∂–º–∏—Ç–µ –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏. –î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç—Å—è.</div>
    </div>

    <div class="card">
      <b>–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</b>
      <div class="row">
        <label>–ü–æ—è—Å</label>
        <select id="tz_select" onchange="tzSave()"></select>
      </div>
      <div class="small" style="opacity:.8">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è ¬´–≤ –ø—É—Ç–∏¬ª, –Ω–æ—á–Ω—ã—Ö –∏ —Ä–∞—Å—á—ë—Ç–∞ –æ—Ç–¥—ã—Ö–∞.</div>
    </div>

    <div class="card">
      <b>–ö–æ–¥-–¥–æ—Å—Ç—É–ø –∫ –∑–∞—Ä–ø–ª–∞—Ç–µ</b>
      <div class="row"><input id="pin_code" type="password" placeholder="PIN"></div>
      <div class="row"><button class="btn primary" onclick="savePin()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å PIN</button></div>
    </div>

    <div class="card">
      <b>–¢–µ–º–∞</b>
      <div class="row">
        <select id="theme_select" onchange="setTheme(this.value)">
          <option value="dark">–¢—ë–º–Ω–∞—è</option>
          <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
        </select>
      </div>
      <div class="small" style="opacity:.8">–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
    </div>

    <div class="card small" style="opacity:.8">–í–µ—Ä—Å–∏—è Lite 2025.29A-PWA</div>
    <div class="small" style="opacity:.8;text-align:center">
      <a href="https://t.me/nikitagrigorev99" target="_blank" style="color:#e9eef5;text-decoration:underline">by Nikita Grigorev</a>
    </div>
  </section>

  <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
  <section id="v-profile" class="view">
    <div class="card">
      <b>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</b>
      <div class="row" style="align-items:flex-start">
        <label>–§–æ—Ç–æ</label>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <img id="pfAvatarBig" class="avatar big">
          <input id="pf_photo" type="file" accept="image/*" onchange="profilePhotoChanged(event)">
        </div>
      </div>
      <div class="row"><label>–ò–º—è</label><input id="pf_first" placeholder="–ò–≤–∞–Ω"></div>
      <div class="row"><label>–§–∞–º–∏–ª–∏—è</label><input id="pf_last" placeholder="–ò–≤–∞–Ω–æ–≤"></div>
      <div class="row"><label>–í–æ–∑—Ä–∞—Å—Ç</label><input id="pf_age" type="number" inputmode="numeric" placeholder="30"></div>
      <div class="row"><label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label><input id="pf_role" placeholder="–ú–∞—à–∏–Ω–∏—Å—Ç"></div>
      <div class="row"><label>–ú–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã</label><input id="pf_place" placeholder="–î–µ–ø–æ ..."></div>
      <div class="row"><label>–î–∞—Ç–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label><input id="pf_start" type="date" onchange="renderTenure()"></div>
      <div class="row"><label>–°—Ç–∞–∂</label><input id="pf_tenure" type="text" readonly></div>

      <div class="hr"></div>
      <b>–ó–∞–º–µ—Ç–∫–∏</b>
      <div class="row"><textarea id="pf_notes" placeholder="–õ–∏—á–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –ø–æ —Ä–∞–±–æ—Ç–µ..."></textarea></div>

      <div class="hr"></div>
      <b>–§–∞–π–ª—ã</b>
      <div class="row">
        <input id="fileInput" type="file" multiple onchange="addFilesToFolder(event)">
      </div>
      <div id="filesList"></div>

      <div class="row" style="gap:8px">
        <button class="btn primary" onclick="profileSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" onclick="goSettings()">–ù–∞–∑–∞–¥</button>
      </div>
    </div>
  </section>
</main>

<nav class="tabbar">
  <button class="active" data-tab="dashboard" onclick="nav(this)"><span class="ico">üè†</span>–ì–ª–∞–≤–Ω–∞—è</button>
  <button data-tab="sections" onclick="nav(this)"><span class="ico">üó∫Ô∏è</span>–£—á–∞—Å—Ç–∫–∏</button>
  <button data-tab="more" onclick="nav(this)"><span class="ico">‚ûï</span>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</button>
  <button data-tab="settings" onclick="nav(this)"><span class="ico">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  <button data-tab="profile" onclick="nav(this)"><span class="ico">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</button>
</nav>
<!-- PART 3/6 END --><!-- PART 4/6 START: SCRIPT ‚Äî HELPERS, THEME, PIN, TZ, NAV, TARIFFS, SECTIONS -->
<script>
/* ========= helpers ========= */
function $(s){return document.querySelector(s)}
function $all(s){return Array.from(document.querySelectorAll(s))}
function S(k,v){if(arguments.length===2){localStorage.setItem(k,JSON.stringify(v));return v}try{let r=localStorage.getItem(k);return r?JSON.parse(r):null}catch(e){return null}}
function toNum(v){let n=Number(v);return isNaN(n)?0:n}
function plural(n, one, few, many){ n=Math.abs(n)%100; let n1=n%10; if(n>10 && n<20) return many; if(n1>1 && n1<5) return few; if(n1==1) return one; return many; }
function fmtM(min){if(min==null)return '‚Äî';let h=Math.floor(min/60),m=min%60;return h+'—á '+String(m).padStart(2,'0')+'–º'}
function fmtHMWords(min){
  if(min==null || min===0) return '0 –º–∏–Ω—É—Ç';
  const h=Math.floor(min/60), m=min%60;
  const hs = h>0 ? (h+' '+plural(h,'—á–∞—Å','—á–∞—Å–∞','—á–∞—Å–æ–≤')) : '';
  const ms = m>0 ? (m+' '+plural(m,'–º–∏–Ω—É—Ç–∞','–º–∏–Ω—É—Ç—ã','–º–∏–Ω—É—Ç')) : '';
  return (hs+' '+ms).trim();
}
/* ‚ÇΩ —Ñ–æ—Ä–º–∞—Ç ‚Äî FIX */
const RUR = new Intl.NumberFormat('ru-RU', {style:'currency',currency:'RUB',maximumFractionDigits:0});

/* ========= Network pill ========= */
function updateNetPill(){
  const el = $('#netStatus');
  if(!el) return;
  const on = navigator.onLine;
  el.textContent = on ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ—Ñ–ª–∞–π–Ω';
  el.classList.toggle('on', on);
  el.classList.toggle('off', !on);
}
window.addEventListener('online', updateNetPill);
window.addEventListener('offline', updateNetPill);

/* ========= Theme ========= */
function setTheme(val){
  S('theme', val);
  document.body.classList.toggle('theme-light', val==='light');
  const sel=$('#theme_select'); if(sel) sel.value=val;
}

/* ========= PIN –¥–ª—è ¬´–†–ñ–î –∑–∞—Ä–ø–ª–∞—Ç–∞¬ª ========= */
function savePin(){
  const pin = ($('#pin_code').value||'').trim();
  S('pin', pin);
  alert('PIN —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
}
function checkPinBefore(action){
  const need = (S('pin')||'').trim();
  if(!need){ action(); return; }
  const inp = prompt('–í–≤–µ–¥–∏—Ç–µ PIN –¥–ª—è –¥–æ—Å—Ç—É–ø–∞:');
  if(inp===need) action();
  else alert('–ù–µ–≤–µ—Ä–Ω—ã–π PIN');
}

/* ========= Timezone ========= */
function tzList(){
  const vals=['AUTO','UTC-12:00','UTC-11:00','UTC-10:00','UTC-09:30','UTC-09:00','UTC-08:00','UTC-07:00','UTC-06:00',
    'UTC-05:00','UTC-04:30','UTC-04:00','UTC-03:30','UTC-03:00','UTC-02:00','UTC-01:00','UTC+00:00',
    'UTC+01:00','UTC+02:00','UTC+03:00','UTC+03:30','UTC+04:00','UTC+04:30','UTC+05:00','UTC+05:30',
    'UTC+05:45','UTC+06:00','UTC+06:30','UTC+07:00','UTC+08:00','UTC+08:45','UTC+09:00','UTC+09:30',
    'UTC+10:00','UTC+10:30','UTC+11:00','UTC+12:00','UTC+12:45','UTC+13:00','UTC+14:00'];
  return vals;
}
function parseUtcLabelToOffsetMin(label){
  if(label==='AUTO') return null;
  const m = label.match(/UTC([+-])(\d{1,2}):(\d{2})/);
  if(!m) return 0;
  const sign = m[1]==='-'?-1:1;
  const hh = Number(m[2])||0, mm = Number(m[3])||0;
  return sign*(hh*60+mm);
}
function getSelectedTzOffsetMin(){ const pref=S('tz_pref'); if(!pref || pref.mode==='AUTO'){ return -new Date().getTimezoneOffset(); } return pref.offsetMin||0; }
function tzPopulateSelect(){
  const sel=$('#tz_select'); if(!sel) return;
  sel.innerHTML='';
  tzList().forEach(lb=>{ const opt=document.createElement('option'); opt.value=lb; opt.textContent = lb==='AUTO'?'–ê–≤—Ç–æ (—Å–∏—Å—Ç–µ–º–Ω—ã–π)':lb; sel.appendChild(opt); });
  const pref=S('tz_pref'); sel.value = pref? (pref.mode==='AUTO'?'AUTO':(pref.label||'AUTO')) : 'AUTO';
}
function tzSave(){ const label=$('#tz_select').value; if(label==='AUTO'){ S('tz_pref',{mode:'AUTO'}); } else { S('tz_pref',{mode:'FIX',label,offsetMin:parseUtcLabelToOffsetMin(label)}); } updateLiveTimers(true); }

/* ========= Navigation ========= */
function nav(btn){
  $all('.tabbar button').forEach(x=>x.classList.remove('active'));
  btn.classList.add('active');
  let v=btn.getAttribute('data-tab');
  $all('.view').forEach(x=>x.classList.remove('active'));
  $('#v-'+v).classList.add('active');
}
function goSettings(){ $all('.tabbar button').forEach(b=>b.classList.remove('active')); document.querySelector('.tabbar button[data-tab="settings"]').classList.add('active'); $all('.view').forEach(v=>v.classList.remove('active')); $('#v-settings').classList.add('active'); }

/* ========= Tariffs (–≤ ¬´–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ¬ª) ========= */
function getTar(){return S('tar')||{base:358.46,rc:20,north:50,fee:0,norm:176}}
function tarSave(goHome){
  let t=getTar();
  if($('#tar_base')) t.base=toNum($('#tar_base').value)||t.base;
  if($('#tar_rc')) t.rc=toNum($('#tar_rc').value)||0;
  if($('#tar_north')) t.north=toNum($('#tar_north').value)||0;
  if($('#tar_fee')) t.fee=toNum($('#tar_fee').value)||0;
  if($('#tar_norm')) t.norm=toNum($('#tar_norm').value)||t.norm;
  S('tar',t); updateDash(); renderTrips();
  if(goHome){ $all('.tabbar button').forEach(b=>b.classList.remove('active')); document.querySelector('.tabbar button[data-tab="dashboard"]').classList.add('active'); $all('.view').forEach(v=>v.classList.remove('active')); $('#v-dashboard').classList.add('active'); }
}
function loadTar(){
  let t=getTar();
  if($('#tar_base')) $('#tar_base').value=t.base;
  if($('#tar_rc')) $('#tar_rc').value=t.rc;
  if($('#tar_north')) $('#tar_north').value=t.north;
  if($('#tar_fee')) $('#tar_fee').value=t.fee;
  if($('#tar_norm')) $('#tar_norm').value=t.norm;
}

/* ========= Sections ========= */
function getSecs(){return S('secs')||[]} function setSecs(a){S('secs',a)}
let editingSectionId=null;
function titleForSection(s){ let t=(s.name&&s.name.trim())?s.name.trim():((s.frm||'').trim()+' ‚Äî '+(s.to||'').trim()); t=t.replace(/\s+/g,' ').trim(); return t||'‚Äî'; }
function sectionOpen(){ editingSectionId=null; $('#sectionForm').style.display='block'; $('#s_name').value=''; $('#s_from').value=''; $('#s_to').value=''; $('#s_len').value=''; $('#s_save_btn').textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'; $('#s_hint').textContent='–ù–æ–≤—ã–π —É—á–∞—Å—Ç–æ–∫'; }
function sectionCancel(){ $('#sectionForm').style.display='none'; editingSectionId=null; }
function sectionEdit(id){ let s=(getSecs()||[]).find(x=>x.id===id); if(!s) return; editingSectionId=id; $('#sectionForm').style.display='block'; $('#s_name').value=s.name||''; $('#s_from').value=s.frm||''; $('#s_to').value=s.to||''; $('#s_len').value=(s.len!=null?s.len:''); $('#s_save_btn').textContent='–û–±–Ω–æ–≤–∏—Ç—å'; $('#s_hint').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—á–∞—Å—Ç–∫–∞'; }
function sectionSave(){ let name=($('#s_name').value||'').trim(), frm=($('#s_from').value||'').trim(), to=($('#s_to').value||'').trim(), len=toNum($('#s_len').value); let arr=getSecs();
  if(editingSectionId){ let ix=arr.findIndex(x=>x.id===editingSectionId); if(ix>=0){ arr[ix]={id:editingSectionId,name,frm,to,len}; setSecs(arr);} editingSectionId=null; }
  else{ arr.push({id:Date.now(),name,frm,to,len}); setSecs(arr); }
  $('#sectionForm').style.display='none'; renderSecs(); buildRouteOptions(); }
function sectionDel(id, ev){ if(ev) ev.stopPropagation(); if(!confirm('–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–æ–∫?')) return; setSecs(getSecs().filter(x=>x.id!==id)); renderSecs(); buildRouteOptions(); }
function renderSecs(){ let box=$('#sectionList'); if(!box) return; box.innerHTML=''; let a=getSecs();
  if(!a.length){ let d=document.createElement('div'); d.className='small'; d.style.opacity=.7; d.textContent='–ù–µ—Ç —É—á–∞—Å—Ç–∫–æ–≤'; box.appendChild(d); }
  a.forEach(s=>{ let title=titleForSection(s), info=(s.frm||'‚Äî')+' ‚Üí '+(s.to||'‚Äî')+(s.len?(' ‚Ä¢ '+s.len+' –∫–º'):'');
    let r=document.createElement('div'); r.className='row tap'; r.setAttribute('onclick','sectionEdit('+s.id+')');
    r.innerHTML='<div style="flex:1"><b>'+title+'</b><div class="small" style="opacity:.7">'+info+'</div></div>'
               +'<div class="actions"><button class="btn" onclick="event.stopPropagation(); sectionEdit('+s.id+')">‚úé</button>'
               +'<button class="btn" onclick="sectionDel('+s.id+', event)">üóë</button></div>';
    box.appendChild(r);
  });
}

/* ========= Routes datalist & helpers ========= */
function getRoutesCache(){return S('routes_cache')||[]} function setRoutesCache(a){S('routes_cache',a)}
function buildRouteOptions(){
  let dl=$('#routeList'); if(!dl) return; dl.innerHTML=''; let seen=new Set();
  getSecs().forEach(s=>{let title=titleForSection(s); if(title && !seen.has(title)){ seen.add(title); let o=document.createElement('option'); o.value=title; dl.appendChild(o); }});
  (getRoutesCache()).forEach(r=>{let t=(r||'').trim(); if(t && !seen.has(t)){ seen.add(t); let o=document.createElement('option'); o.value=t; dl.appendChild(o); }});
  (getTrips()).forEach(t=>{ [t.route1,t.route2,t.route].forEach(r=>{ let rr=(r||'').trim(); if(rr && !seen.has(rr)){ seen.add(rr); let o=document.createElement('option'); o.value=rr; dl.appendChild(o); }}) });
}
function invertRoute(r){
  if(!r) return '';
  const parts = r.split('‚Äî').map(x=>x.trim());
  if(parts.length===2) return parts[1]+' ‚Äî '+parts[0];
  const dash = r.indexOf('-')>=0 ? '-' : '‚Äî';
  const alt = r.split(dash).map(x=>x.trim());
  if(alt.length===2) return alt[1]+' ‚Äî '+alt[0];
  return r<!-- === CONTINUE: after calcFullRest() === -->

/* ========= Auto-invert route2 on focus ========= */
function invertRoute(r){
  if(!r) return '';
  const parts = r.split('‚Äî').map(x=>x.trim());
  if(parts.length===2) return parts[1]+' ‚Äî '+parts[0];
  const dash = r.indexOf('-')>=0 ? '-' : '‚Äî';
  const alt = r.split(dash).map(x=>x.trim());
  if(alt.length===2) return alt[1]+' ‚Äî '+alt[0];
  return r;
}
function setupAutoInvert(){
  const r1 = $('#t_route1'), r2 = $('#t_route2');
  if(r1 && r2){
    r2.addEventListener('focus', ()=>{
      const base = (r1.value||'').trim();
      if(base && !r2.value){ r2.value = invertRoute(base); }
    });
  }
}

/* ========= Profile: data ========= */
function getProfile(){
  return S('profile') || {first:'',last:'',age:'',role:'',place:'',start:'',photo:'',notes:''};
}
function setProfile(p){ S('profile',p); }

function renderTenure(){
  const start = $('#pf_start')?.value;
  if(!start){ if($('#pf_tenure')) $('#pf_tenure').value=''; return; }
  const a = new Date(start+'T00:00:00');
  const b = new Date();
  let years = b.getFullYear()-a.getFullYear();
  let months = b.getMonth()-a.getMonth();
  let days = b.getDate()-a.getDate();
  if(days<0){ months--; }
  if(months<0){ years--; months+=12; }
  if($('#pf_tenure')) $('#pf_tenure').value = `${years} ${plural(years,'–≥–æ–¥','–≥–æ–¥–∞','–ª–µ—Ç')} ${months} ${plural(months,'–º–µ—Å—è—Ü','–º–µ—Å—è—Ü–∞','–º–µ—Å—è—Ü–µ–≤')}`;
}

function profilePhotoChanged(e){
  const f=e.target.files?.[0]; if(!f) return;
  const rd=new FileReader();
  rd.onload=()=>{ if($('#pfAvatarBig')) $('#pfAvatarBig').src=rd.result; };
  rd.readAsDataURL(f);
}

function profileSave(){
  const p=getProfile();
  if($('#pf_first')) p.first=$('#pf_first').value||'';
  if($('#pf_last'))  p.last=$('#pf_last').value||'';
  if($('#pf_age'))   p.age=$('#pf_age').value||'';
  if($('#pf_role'))  p.role=$('#pf_role').value||'';
  if($('#pf_place')) p.place=$('#pf_place').value||'';
  if($('#pf_start')) p.start=$('#pf_start').value||'';
  if($('#pf_notes')) p.notes=$('#pf_notes').value||'';
  const img=$('#pfAvatarBig'); if(img && img.src) p.photo=img.src;
  setProfile(p);
  alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
  goSettings();
}

/* ========= Profile: files (simple, no folders) ========= */
function getProfileFiles(){ return S('pf_files') || []; }
function setProfileFiles(list){ S('pf_files', list); }

function addFilesToFolder(e){
  const files = Array.from(e.target.files||[]);
  if(!files.length) return;
  const list = getProfileFiles();
  let pending = files.length;
  files.forEach(f=>{
    const rd=new FileReader();
    rd.onload=()=>{
      list.push({
        id: Date.now()+Math.random(),
        name: f.name,
        size: f.size,
        type: f.type||'file',
        dataUrl: rd.result,
        addedAt: Date.now()
      });
      pending--;
      if(pending===0){
        setProfileFiles(list);
        renderFilesList();
        e.target.value='';
      }
    };
    rd.readAsDataURL(f);
  });
}

function renderFilesList(){
  const box = $('#filesList'); if(!box) return;
  const list = getProfileFiles().slice().sort((a,b)=>a.name.localeCompare(b.name));
  if(!list.length){ box.innerHTML='<div class="small" style="opacity:.7">–ù–µ—Ç —Ñ–∞–π–ª–æ–≤</div>'; return; }
  box.innerHTML='';
  list.forEach(f=>{
    const row=document.createElement('div');
    row.className='file-item';
    row.innerHTML = `
      <div>
        <div><b>${f.name}</b></div>
        <div class="small" style="opacity:.7">${f.type||'file'} ‚Ä¢ ${(f.size/1024).toFixed(1)} –ö–ë</div>
      </div>
      <div>
        <a class="btn" style="margin-right:6px" href="${f.dataUrl}" download="${f.name}">–°–∫–∞—á–∞—Ç—å</a>
        <button class="btn" onclick="deleteProfileFile(${f.id})">üóë</button>
      </div>`;
    box.appendChild(row);
  });
}
function deleteProfileFile(id){
  let list=getProfileFiles().filter(x=>x.id!==id);
  setProfileFiles(list);
  renderFilesList();
}

/* ========= INIT ========= */
function init(){
  // –¢–µ–º–∞
  const theme = S('theme') || 'dark';
  setTheme(theme);

  // –°–µ—Ç—å
  updateNetPill();

  // –¢–∞—Ä–∏—Ñ—ã (—ç–ª–µ–º–µ–Ω—Ç—ã –µ—Å—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω–æ–º –∏ –≤ ¬´–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ¬ª)
  try{ loadTar(); }catch(_){}

  // TZ
  tzPopulateSelect();

  // –£—á–∞—Å—Ç–∫–∏/–º–∞—Ä—à—Ä—É—Ç—ã
  try{ renderSecs(); buildRouteOptions(); }catch(_){}

  // –ü–æ–µ–∑–¥–∫–∏/–¥–∞—à–±–æ—Ä–¥
  try{ renderTrips(); updateDash(); }catch(_){}

  // –¢–∞–π–º–µ—Ä—ã ¬´–≤ –ø—É—Ç–∏¬ª
  setInterval(updateLiveTimers, 30000);

  // –ê–≤—Ç–æ-–∏–Ω–≤–µ—Ä—Å–∏—è –º–∞—Ä—à—Ä—É—Ç–∞2 –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ
  setupAutoInvert();

  // –ü–µ—Ä–µ—Å—á—ë—Ç –ø—Ä–∏ –≤–≤–æ–¥–µ –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–ª–µ–π
  ['t_date','t_date2','t_start1','t_end1','t_start2','t_end2'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('input', recalcDuration);
  });

  // –ü—Ä–æ—Ñ–∏–ª—å (—Ä–µ–Ω–¥–µ—Ä —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º —ç–∫—Ä–∞–Ω–µ)
  if($('#filesList')) renderFilesList();
}
document.addEventListener('DOMContentLoaded', init);/* ========= PWA: SW + –∫–Ω–æ–ø–∫–∞ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª ========= */
(function(){
  const usp = new URLSearchParams(location.search);
  if (usp.get('no-sw') === '1') {
    if ('serviceWorker' in navigator) { navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister())); }
    if (window.caches) caches.keys().then(ks => ks.forEach(k => caches.delete(k)));
    console.log('SW disabled by ?no-sw=1');
    return;
  }

  window.appUpdate = async function(){
    try{
      if (!('serviceWorker' in navigator)) { location.reload(); return; }
      const reg = await navigator.serviceWorker.getRegistration();
      if (!reg) { location.reload(); return; }
      if (reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'}); else await reg.update();
      let reloaded=false;
      navigator.serviceWorker.addEventListener('controllerchange', ()=>{ if(!reloaded){reloaded=true; location.replace(location.pathname+'?cb='+Date.now());}});
      setTimeout(()=>{ if(!reloaded) location.replace(location.pathname+'?cb='+Date.now()); }, 1000);
    }catch(e){ location.reload(); }
  };

  window.addEventListener('load', function(){
    updateNetPill();
    if (!('serviceWorker' in navigator)) return;
    const scope = location.pathname.replace(/\/[^\/]*$/, '/') || '/';
    navigator.serviceWorker.register('sw.js', { scope }).then(reg => {
      const btn = document.getElementById('appRefresh');
      function showRefresh(){ if(btn) btn.style.display=''; }
      if (reg.waiting) showRefresh();
      reg.addEventListener('updatefound', ()=>{
        const nw = reg.installing; if(!nw) return;
        nw.addEventListener('statechange', ()=>{ if (nw.state==='installed' && navigator.serviceWorker.controller) showRefresh(); });
      });
      navigator.serviceWorker.addEventListener('controllerchange', ()=>{ if(btn) btn.style.display='none'; });
    }).catch(err => console.warn('SW register failed', err));
  });
})();
