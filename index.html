<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>–ë–ª–æ–∫–Ω–æ—Ç –ú–∞—à–∏–Ω–∏—Å—Ç–∞ ¬∑ Lite v2025.25</title>
<meta name="theme-color" content="#d32f2f">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180x180.png?v=202525">
<link rel="apple-touch-icon" sizes="167x167" href="apple-touch-icon-167x167.png?v=202525">
<link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon-152x152.png?v=202525">
<link rel="apple-touch-icon" href="apple-touch-icon.png?v=202525">
<style>
:root{ --red:#d32f2f; --bg:#0f1420; --card:#161d2a; --line:#243246; --muted:#8aa0b6; --text:#e9eef5; }
*{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html,body{ height:100%; margin:0; }
body{ background:var(--bg); color:var(--text); font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
header.appbar{ position:sticky; top:0; z-index:3; background:var(--red); color:#fff; padding:12px 14px; display:flex; align-items:center; gap:10px; }
.appbar .title{ font-weight:700; font-size:18px; }
.appbar .muted{ opacity:.9; font-size:12px; }
.container{ padding:12px; padding-bottom:90px; }
.card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; margin-bottom:10px; }
.grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.row{ display:flex; gap:8px; align-items:center; margin:8px 0; }
.row label{ width:42%; color:var(--muted); font-size:14px; }
.row input, .row select, .row textarea{ flex:1; background:#0e1622; border:1px solid var(--line); color:var(--text); padding:10px; border-radius:12px; font-size:16px; }
.row textarea{ min-height:90px; resize:vertical; }
.btn{ background:#1b2738; color:var(--text); border:1px solid var(--line); padding:10px 14px; border-radius:12px; font-size:15px; }
.btn.primary{ background:#ffffff; color:#d32f2f; border-color:#fff; }
.btn.ghost{ background:transparent; border-color:var(--line); }
.small{ font-size:12px; }
.muted{ color:#f8f8f8; opacity:.8; }
.progress{ height:10px; border-radius:999px; background:#0f2035; overflow:hidden; border:1px solid var(--line); }
.progress>div{ height:100%; background:#d32f2f; width:0%; }
.view{ display:none; }
.view.active{ display:block; }
.tabbar{ position:fixed; left:0; right:0; bottom:0; height:72px; background:#121828; border-top:1px solid var(--line); display:flex; z-index:3; }
.tabbar button{ flex:1; background:transparent; border:none; color:#8aa0b6; font-size:12px; padding:6px 0; }
.tabbar button.active{ color:#fff; }
.tabbar .ico{ display:block; font-size:18px; margin-bottom:4px; }
.segs{ display:flex; gap:6px; background:#0e1622; border:1px solid var(--line); border-radius:12px; padding:4px; }
.segs button{ flex:1; border:none; padding:8px 10px; background:transparent; color:#8aa0b6; border-radius:8px; }
.segs button.active{ background:#1a2435; color:#fff; }
.trip{ display:grid; grid-template-columns:1fr auto auto; align-items:center; gap:8px; padding:8px 0; border-bottom:1px solid #233246; }
.trip:last-child{ border-bottom:0; }
.section{ display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #233246; gap:8px; }
.kv{ display:grid; grid-template-columns:1fr auto; gap:8px 12px; align-items:center; }
hr.sep{ border:0; border-top:1px solid var(--line); margin:8px 0; }
.right{ text-align:right; }
.badge{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--line); color:#fff; font-size:12px; }
table{ width:100%; border-collapse:collapse; }
td,th{ border-bottom:1px solid #233246; padding:6px 4px; text-align:left; }
th{ color:#a9bacd; font-weight:600; }
a.link{ color:#8ecaff; text-decoration:none; }
</style>
</head>
<body>
<header class="appbar">
  <div class="title">–ë–ª–æ–∫–Ω–æ—Ç –ú–∞—à–∏–Ω–∏—Å—Ç–∞</div>
  <div class="muted">Lite v2025.25</div>
</header>
<main class="container">
  <!-- –ì–ª–∞–≤–Ω–∞—è -->
  <section id="v-dashboard" class="view active">
    <div class="card">
      <div style="display:flex;justify-content:space-between"><b>–ú–µ—Å—è—á–Ω–∞—è –Ω–æ—Ä–º–∞</b><b id="mwNorm">‚Äî</b></div>
      <div class="progress" style="margin-top:6px"><div id="mwBar"></div></div>
      <div class="row"><label>–ë–∞–∑–∞ –Ω–æ—Ä–º—ã</label>
        <select id="normBasis"><option value="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –¥–Ω–∏</option><option value="working">–†–∞–±–æ—á–∏–µ –¥–Ω–∏ (–ü–Ω‚Äì–ü—Ç)</option></select>
      </div>
      <div class="row"><label>–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ</label><div id="mwWorked" class="small">‚Äî</div></div>
      <div class="row"><label>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</label><div id="mwPercent" class="small">‚Äî</div></div>
      <div class="row"><label>–û—Å—Ç–∞–ª–æ—Å—å/–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞</label><div id="mwRemain" class="small">‚Äî</div></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>–ü–æ–µ–∑–¥–∫–∏</b>
        <div>
          <button id="addTripOpen" class="btn primary">+ –î–æ–±–∞–≤–∏—Ç—å</button>
          <button id="exportTripsCsv" class="btn ghost">CSV</button>
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∏ –ü–æ –¥–Ω—è–º/–ü–æ –º–µ—Å—è—Ü–∞–º -->
      <div class="segs" style="margin-top:8px">
        <button id="segDays" class="active">–ü–æ –¥–Ω—è–º</button>
        <button id="segMonths">–ü–æ –º–µ—Å—è—Ü–∞–º</button>
      </div>

      <!-- –§–æ—Ä–º–∞ –ø–æ–µ–∑–¥–∫–∏ -->
      <div id="tripForm" class="card" style="display:none; margin-top:10px">
        <div class="grid2">
          <div class="row"><label>–î–∞—Ç–∞</label><input id="t_date" type="date"></div>
          <div class="row"><label>‚Ññ –ø–æ–µ–∑–¥–∞</label><input id="t_train" placeholder="‚Ññ"></div>
          <div class="row"><label>–Ø–≤–∫–∞</label><input id="t_start" type="time"></div>
          <div class="row"><label>–û–∫–æ–Ω—á–∞–Ω–∏–µ</label><input id="t_end" type="time"></div>
          <div class="row"><label>–õ–æ–∫–æ–º–æ—Ç–∏–≤</label><input id="t_loco" placeholder="–≠–ü1–ú‚Äëxxx / 2–¢–≠116‚Äëxxx"></div>
          <div class="row"><label>–°—Ç–æ—è–Ω–∫–∏ (–º–∏–Ω)</label><input id="t_stops" type="number" inputmode="numeric" placeholder="0"></div>
        </div>
        <div class="row"><label>–ú–∞—Ä—à—Ä—É—Ç</label><input id="t_route" placeholder="–ú–∞–ª–æ—à—É–π–∫–∞ ‚Äî –û–±–æ–∑–µ—Ä—Å–∫–∞—è"></div>
        <div class="row"><label>–ß–∞—Å—ã (–∏—Ç–æ–≥)</label><input id="t_hours" type="number" inputmode="decimal" step="0.1" placeholder="8"></div>
        <div class="row"><label>–ó–∞–º–µ—Ç–∫–∏</label><textarea id="t_notes" placeholder="–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, –ø—Ä–æ—Å—Ç–æ–∏‚Ä¶"></textarea></div>

        <hr class="sep">
        <div><b>–ü–µ—Ä–µ–≥–æ–Ω—ã</b> <button id="segAdd" class="btn ghost">+ –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≥–æ–Ω</button></div>
        <table id="segTable" style="margin-top:6px">
          <thead><tr><th>–£—á–∞—Å—Ç–æ–∫/–ø–µ—Ä–µ–≥–æ–Ω</th><th>–ú–∏–Ω</th><th>–ö–º</th><th></th></tr></thead>
          <tbody></tbody>
        </table>

        <div class="row"><button id="t_save" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button id="t_cancel" class="btn ghost">–û—Ç–º–µ–Ω–∞</button></div>
      </div>

      <!-- –°–ø–∏—Å–∫–∏ -->
      <div id="daysList" style="margin-top:8px"></div>
      <div id="monthsList" style="margin-top:8px; display:none"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>–ò—Ç–æ–≥ –ø–æ –º–µ—Å—è—Ü—É</b>
        <div>
          <button id="exportMonthsCsv" class="btn ghost">CSV</button>
          <button id="printMonth" class="btn ghost">PDF</button>
        </div>
      </div>
      <div class="kv">
        <div>–ß–∞—Å—ã</div><div class="right"><b id="sumHours">‚Äî</b></div>
        <div>–ü–æ–µ–∑–¥–æ–∫</div><div class="right"><b id="sumTrips">‚Äî</b></div>
        <div>–û–∫–ª–∞–¥ (–±–µ–∑ –Ω–∞–¥–±–∞–≤–æ–∫)</div><div class="right"><b id="sumBase">‚Äî</b></div>
        <div>–ù–∞–¥–±–∞–≤–∫–∏ (+%)</div><div class="right"><b id="sumAddons">‚Äî</b></div>
        <div>–ö–æ–º. —Ä–∞—Å—Ö–æ–¥—ã</div><div class="right"><b id="sumComm">‚Äî</b></div>
        <div><b>–ò—Ç–æ–≥–æ</b></div><div class="right"><b id="sumTotal" class="badge">‚Äî</b></div>
      </div>
    </div>
  </section>

  <!-- –£—á–∞—Å—Ç–∫–∏ -->
  <section id="v-sections" class="view">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>–£—á–∞—Å—Ç–∫–∏</b><button id="addSectionBtn" class="btn">–ù–æ–≤—ã–π —É—á–∞—Å—Ç–æ–∫</button>
      </div>
      <div id="sectionForm" class="card" style="display:none; margin-top:8px">
        <div class="row"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="s_name"></div>
        <div class="row"><label>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label><input id="s_from"></div>
        <div class="row"><label>–ü—Ä–∏–±—ã—Ç–∏–µ</label><input id="s_to"></div>
        <div class="row"><label>–î–ª–∏–Ω–∞ (–∫–º)</label><input id="s_len" type="number" inputmode="decimal"></div>
        <div class="row"><button id="s_save" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button id="s_cancel" class="btn ghost">–û—Ç–º–µ–Ω–∞</button></div>
      </div>
      <div id="sectionList"></div>
    </div>
  </section>

  <!-- –¢–∞—Ä–∏—Ñ—ã –∏ –ø—Ä–æ—Ñ–∏–ª–∏ -->
  <section id="v-tariffs" class="view">
    <div class="card">
      <b>–¢–∞—Ä–∏—Ñ—ã –∏ –Ω–∞–¥–±–∞–≤–∫–∏</b>
      <div class="grid2">
        <div class="row"><label>–¢–∞—Ä–∏—Ñ (‚ÇΩ/—á)</label><input id="tar_base" type="number" inputmode="decimal" placeholder="358.46"></div>
        <div class="row"><label>–ù–æ—Ä–º–∞ /–º–µ—Å (—á)</label><input id="tar_norm" type="number" inputmode="decimal" placeholder="176"></div>
        <div class="row"><label>–†–∞–π–æ–Ω–Ω—ã–π %</label><input id="tar_region" type="number" inputmode="decimal" placeholder="20"></div>
        <div class="row"><label>–°–µ–≤–µ—Ä–Ω—ã–π %</label><input id="tar_north" type="number" inputmode="decimal" placeholder="50"></div>
        <div class="row"><label>–ö–ª–∞—Å—Å %</label><input id="tar_class" type="number" inputmode="decimal" placeholder="0"></div>
        <div class="row"><label>–ó–æ–Ω–∞–ª—å–Ω–∞—è %</label><input id="tar_zone" type="number" inputmode="decimal" placeholder="0"></div>
        <div class="row"><label>–ë–ê–ú %</label><input id="tar_bam" type="number" inputmode="decimal" placeholder="0"></div>
        <div class="row"><label>–ö–æ–º.—Ä–∞—Å—Ö–æ–¥—ã /–ø–æ–µ–∑–¥–∫—É (‚ÇΩ)</label><input id="tar_comm" type="number" inputmode="decimal" placeholder="0"></div>
      </div>
      <div class="row">
        <button id="tar_save" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <select id="profileSelect" style="flex:1"></select>
        <button id="profileSave" class="btn ghost">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—Ñ–∏–ª—å</button>
        <button id="profileDel" class="btn ghost">–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
      </div>
      <div class="small" style="opacity:.8">–ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç —Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞–±–æ—Ä—ã –Ω–∞–¥–±–∞–≤–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ —Ä–∞–∑–Ω—ã–º –¥–µ–ø–æ/—É—á–∞—Å—Ç–∫–∞–º) –∏ –±—ã—Å—Ç—Ä–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è.</div>
    </div>
  </section>

  <!-- –°–ø—Ä–∞–≤–∫–∞ -->
  <section id="v-refs" class="view">
    <div class="card">
      <b>–®–ø–∞—Ä–≥–∞–ª–∫–∏</b>
      <div class="row"><textarea id="refText" placeholder="–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ –∑–∞–º–µ—Ç–∫–∏‚Ä¶"></textarea></div>
      <div class="row"><button id="ref_save" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    </div>
  </section>

  <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <section id="v-settings" class="view">
    <div class="card">
      <b>–ë—ç–∫–∞–ø</b>
      <div class="row"><button id="backupBtn" class="btn">–°–∫–∞—á–∞—Ç—å JSON</button></div>
      <div class="row"><input id="restoreFile" type="file" accept="application/json"></div>
      <div class="small" style="opacity:.8">–í–µ—Ä—Å–∏—è Lite single‚Äëfile 2025.25</div>
    </div>
  </section>
</main>

<!-- –¢–∞–±–±–∞—Ä -->
<nav class="tabbar">
  <button class="active" data-tab="dashboard"><span class="ico">üè†</span>–ì–ª–∞–≤–Ω–∞—è</button>
  <button data-tab="sections"><span class="ico">üó∫Ô∏è</span>–£—á–∞—Å—Ç–∫–∏</button>
  <button data-tab="tariffs"><span class="ico">üí≥</span>–¢–∞—Ä–∏—Ñ—ã</button>
  <button data-tab="refs"><span class="ico">üìí</span>–°–ø—Ä–∞–≤–∫–∞</button>
  <button data-tab="settings"><span class="ico">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</nav>

<script>
(function(){
  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  function S(k,val){ if(arguments.length===2){ localStorage.setItem(k, JSON.stringify(val)); return val; }
    const raw = localStorage.getItem(k); try{ return raw? JSON.parse(raw): null; }catch(e){ return null; } }
  function fmtTime(min){ const h=Math.floor(min/60), m=min%60; return h+'—á '+String(m).padStart(2,'0')+'–º'; }
  function toMinutes(hhmm){ if(!hhmm) return 0; const [h,m]=hhmm.split(':').map(x=>Number(x)||0); return h*60+m; }
  function csvEscape(v){ if(v==null) return ''; const s=String(v).replaceAll('"','""'); return /[",\n]/.test(s)? '"'+s+'"' : s; }

  // –ù–∞–≤–∏–≥–∞—Ü–∏—è
  $$('.tabbar button').forEach(b=> b.addEventListener('click', ()=>{
    $$('.tabbar button').forEach(x=>x.classList.remove('active')); b.classList.add('active');
    const v=b.getAttribute('data-tab'); $$('.view').forEach(x=>x.classList.remove('active')); $('#v-'+v).classList.add('active');
  }));

  // –¢–∞—Ä–∏—Ñ—ã –∏ –ø—Ä–æ—Ñ–∏–ª–∏
  function getTariffs(){ return S('tariffs_sf') || { base:358.46, norm:176, region:20, north:50, klass:0, zone:0, bam:0, comm:0 }; }
  function setTariffs(t){ S('tariffs_sf', t); }
  function loadTariffsToForm(){
    const t = getTariffs();
    $('#tar_base').value=t.base; $('#tar_norm').value=t.norm; $('#tar_region').value=t.region||0; $('#tar_north').value=t.north||0;
    $('#tar_class').value=t.klass||0; $('#tar_zone').value=t.zone||0; $('#tar_bam').value=t.bam||0; $('#tar_comm').value=t.comm||0;
  }
  function saveTariffsFromForm(){
    const t = {
      base: Number($('#tar_base').value)||0, norm: Number($('#tar_norm').value)||0,
      region: Number($('#tar_region').value)||0, north: Number($('#tar_north').value)||0,
      klass: Number($('#tar_class').value)||0, zone: Number($('#tar_zone').value)||0,
      bam: Number($('#tar_bam').value)||0, comm: Number($('#tar_comm').value)||0
    };
    setTariffs(t); updateDashboard(); renderMonths(); updateTotals();
  }
  $('#tar_save').addEventListener('click', saveTariffsFromForm);

  function loadProfiles(){
    const list = S('profiles_sf')||[];
    const sel = $('#profileSelect'); sel.innerHTML='';
    if(!list.length){ const opt=document.createElement('option'); opt.value=''; opt.textContent='‚Äî –ø—Ä–æ—Ñ–∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç ‚Äî'; sel.appendChild(opt); return; }
    list.forEach(p=>{ const opt=document.createElement('option'); opt.value=p.name; opt.textContent=p.name; sel.appendChild(opt); });
  }
  $('#profileSave').addEventListener('click', ()=>{
    const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–∞–¥–±–∞–≤–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–°–µ–≤–µ—Ä 50%¬ª):','');
    if(!name) return;
    const list = S('profiles_sf')||[];
    const t = getTariffs();
    const existing = list.findIndex(x=>x.name===name);
    const rec = { name, t };
    if(existing>=0) list[existing]=rec; else list.push(rec);
    S('profiles_sf', list); loadProfiles();
    alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
  });
  $('#profileDel').addEventListener('click', ()=>{
    const sel = $('#profileSelect'); const name = sel.value; if(!name) return;
    const list = (S('profiles_sf')||[]).filter(x=>x.name!==name); S('profiles_sf', list); loadProfiles();
  });
  $('#profileSelect').addEventListener('change', ()=>{
    const name = $('#profileSelect').value; if(!name) return;
    const p = (S('profiles_sf')||[]).find(x=>x.name===name); if(!p) return;
    setTariffs(p.t); loadTariffsToForm(); updateDashboard(); renderMonths(); updateTotals();
  });

  // –°–ø—Ä–∞–≤–∫–∞
  $('#refText').value = S('refs_sf') || '';
  $('#ref_save').addEventListener('click', ()=> S('refs_sf', $('#refText').value));

  // –ü–æ–µ–∑–¥–∫–∏
  function getTrips(){ return S('trips_sf')||[]; }
  function setTrips(a){ S('trips_sf', a); }

  let editId = null;
  function renderTripsByDays(){
    const list = $('#daysList'); list.innerHTML='';
    const arr = getTrips().slice().sort((a,b)=> (a.date||'').localeCompare(b.date));
    if(!arr.length){ const d=document.createElement('div'); d.className='small'; d.style.opacity=.7; d.textContent='–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫'; list.appendChild(d); }
    arr.forEach(t=>{
      const row = document.createElement('div'); row.className='trip';
      const meta = [t.train?'‚Ññ'+t.train:'', t.loco||''].filter(Boolean).join(' ¬∑ ');
      const kms = (t.km_total||0) ? (' ¬∑ '+t.km_total+' –∫–º') : '';
      row.innerHTML = '<div><div><b>'+ (t.date||'‚Äî') +'</b> ‚Ä¢ '+ (t.route||'‚Äî') +'</div><div class="small" style="opacity:.7">'+meta+kms+'</div></div>'
        + '<div>'+ (t.hours||0) +' —á</div>'
        + '<div><button class="btn ghost" data-edit="'+(t.id||'')+'">‚úé</button> <button class="btn ghost" data-del="'+(t.id||'')+'">üóë</button></div>';
      list.appendChild(row);
    });
    // bind
    list.querySelectorAll('[data-edit]').forEach(b=> b.addEventListener('click', ()=>{
      const id = Number(b.getAttribute('data-edit'));
      const t = getTrips().find(x=> x.id===id);
      if(!t) return;
      editId = id;
      $('#tripForm').style.display='block';
      $('#t_date').value = t.date || new Date().toISOString().slice(0,10);
      $('#t_route').value = t.route || '';
      $('#t_train').value = t.train || '';
      $('#t_loco').value = t.loco || '';
      $('#t_start').value = t.start || '';
      $('#t_end').value = t.end || '';
      $('#t_stops').value = t.stops || 0;
      $('#t_hours').value = t.hours || 0;
      $('#t_notes').value = t.notes || '';
      // segments
      const tbody = $('#segTable tbody'); tbody.innerHTML='';
      (t.segs||[]).forEach(s=> addSegRow(s.name||'', s.min||0, s.km||0));
    }));
    list.querySelectorAll('[data-del]').forEach(b=> b.addEventListener('click', ()=>{
      const id = Number(b.getAttribute('data-del'));
      const arr = getTrips().filter(x=> x.id!==id);
      setTrips(arr); renderTripsByDays(); updateDashboard(); renderMonths(); updateTotals();
    }));
  }

  function renderMonths(){
    const root = $('#monthsList'); root.innerHTML='';
    const arr = getTrips();
    if(!arr.length){ const d=document.createElement('div'); d.className='small'; d.style.opacity=.7; d.textContent='–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'; root.appendChild(d); return; }
    const base = Number(getTariffs().base)||0;
    // group by YYYY-MM
    const map = {};
    arr.forEach(t=>{
      const ym = (t.date||'').slice(0,7) || '‚Äî';
      if(!map[ym]) map[ym] = { hours:0, count:0, trips:[] };
      map[ym].hours += Number(t.hours)||0;
      map[ym].count += 1;
      map[ym].trips.push(t);
    });
    const months = Object.keys(map).sort();
    months.forEach(m=>{
      const hours = map[m].hours;
      const pay = Math.round(hours * base);
      const div = document.createElement('div'); div.className='card';
      div.innerHTML = '<div class="section"><div><b>'+m+'</b> ‚Ä¢ '+map[m].count+' —Ä–µ–π—Å(–∞)</div><div>'+hours.toFixed(1)+' —á ¬∑ ~'+pay.toLocaleString('ru-RU')+' ‚ÇΩ</div></div>';
      const inner = document.createElement('div'); inner.style.display='none';
      // build trips table inside
      const tbl = document.createElement('table');
      tbl.innerHTML = '<thead><tr><th>–î–∞—Ç–∞</th><th>–ú–∞—Ä—à—Ä—É—Ç</th><th>‚Ññ</th><th>–õ–æ–∫–æ</th><th>–ß–∞—Å—ã</th><th>–ö–º</th></tr></thead><tbody></tbody>';
      const tb = tbl.querySelector('tbody');
      map[m].trips.sort((a,b)=> (a.date||'').localeCompare(b.date)).forEach(t=>{
        const tr = document.createElement('tr');
        tr.innerHTML = '<td>'+ (t.date||'') +'</td><td>'+ (t.route||'') +'</td><td>'+ (t.train||'') +'</td><td>'+ (t.loco||'') +'</td><td>'+ (t.hours||0) +'</td><td>'+ (t.km_total||0) +'</td>';
        tb.appendChild(tr);
      });
      inner.appendChild(tbl);
      div.appendChild(inner);
      div.addEventListener('click', ()=>{
        inner.style.display = inner.style.display==='none' ? 'block' : 'none';
      });
      root.appendChild(div);
    });
  }

  function updateTotals(){
    const arr = getTrips();
    const t = getTariffs();
    const hours = arr.reduce((a,x)=> a+(Number(x.hours)||0), 0);
    const trips = arr.length;
    const basePay = hours * (Number(t.base)||0);
    const addonFactor = 1 + (Number(t.region)||0 + Number(t.north)||0 + Number(t.klass)||0 + Number(t.zone)||0 + Number(t.bam)||0)/100;
    const withAddons = basePay * addonFactor;
    const comm = (Number(t.comm)||0) * trips;
    const total = Math.round(withAddons + comm);
    $('#sumHours').textContent = hours.toFixed(1)+' —á';
    $('#sumTrips').textContent = String(trips);
    $('#sumBase').textContent = Math.round(basePay).toLocaleString('ru-RU')+' ‚ÇΩ';
    $('#sumAddons').textContent = Math.round(withAddons - basePay).toLocaleString('ru-RU')+' ‚ÇΩ';
    $('#sumComm').textContent = Math.round(comm).toLocaleString('ru-RU')+' ‚ÇΩ';
    $('#sumTotal').textContent = total.toLocaleString('ru-RU')+' ‚ÇΩ';
  }

  // –°–µ–≥–º–µ–Ω—Ç—ã (–ø–µ—Ä–µ–≥–æ–Ω—ã)
  function addSegRow(name='', minutes=0, km=0){
    const tb = $('#segTable tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = '<td><input class="segName" placeholder="–£—á–∞—Å—Ç–æ–∫/–ø–µ—Ä–µ–≥–æ–Ω" value="'+(name||'')+'"></td>' +
                   '<td><input class="segMin" type="number" inputmode="numeric" value="'+(minutes||0)+'"></td>' +
                   '<td><input class="segKm" type="number" inputmode="decimal" value="'+(km||0)+'"></td>' +
                   '<td><button class="btn ghost segDel">‚úñ</button></td>';
    tb.appendChild(tr);
    tr.querySelector('.segDel').addEventListener('click', ()=> tr.remove());
  }
  $('#segAdd').addEventListener('click', ()=> addSegRow());

  // –≠–∫—Å–ø–æ—Ä—Ç CSV
  function exportTripsCsv(){
    const arr = getTrips();
    const head = ['–î–∞—Ç–∞','–ú–∞—Ä—à—Ä—É—Ç','‚Ññ –ø–æ–µ–∑–¥–∞','–õ–æ–∫–æ–º–æ—Ç–∏–≤','–Ø–≤–∫–∞','–û–∫–æ–Ω—á–∞–Ω–∏–µ','–°—Ç–æ—è–Ω–∫–∏ (–º–∏–Ω)','–ß–∞—Å—ã','–ö–º –≤—Å–µ–≥–æ','–ó–∞–º–µ—Ç–∫–∏'];
    const rows = [head];
    arr.forEach(t=>{
      const line = [t.date||'', t.route||'', t.train||'', t.loco||'', t.start||'', t.end||'', t.stops||0, t.hours||0, t.km_total||0, (t.notes||'').replaceAll('\n',' ')];
      rows.push(line);
    });
    const csv = rows.map(r=> r.map(csvEscape).join(';')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'trips.csv'; a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 500);
  }
  $('#exportTripsCsv').addEventListener('click', exportTripsCsv);

  function exportMonthsCsv(){
    const arr = getTrips();
    // group by month
    const map = {};
    arr.forEach(t=>{
      const ym = (t.date||'').slice(0,7) || '‚Äî';
      if(!map[ym]) map[ym] = { hours:0, count:0 };
      map[ym].hours += Number(t.hours)||0;
      map[ym].count += 1;
    });
    const head = ['–ú–µ—Å—è—Ü','–ü–æ–µ–∑–¥–æ–∫','–ß–∞—Å—ã'];
    const rows = [head];
    Object.keys(map).sort().forEach(m=> rows.push([m, map[m].count, map[m].hours.toFixed(1)]));
    const csv = rows.map(r=> r.map(csvEscape).join(';')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'months.csv'; a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 500);
  }
  $('#exportMonthsCsv').addEventListener('click', exportMonthsCsv);

  // –ü–µ—á–∞—Ç—å PDF —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ (—á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–∏–∞–ª–æ–≥ –ø–µ—á–∞—Ç–∏)
  function printCurrentMonth(){
    const arr = getTrips();
    if(!arr.length){ alert('–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫'); return; }
    const ym = (new Date().toISOString().slice(0,7));
    const trips = arr.filter(t=> (t.date||'').slice(0,7)===ym).sort((a,b)=> (a.date||'').localeCompare(b.date));
    const t = getTariffs();
    let html = '<html><head><meta charset="utf-8"><title>–û—Ç—á—ë—Ç '+ym+'</title></head><body style="font-family:Segoe UI,system-ui,sans-serif">';
    html += '<h2>–û—Ç—á—ë—Ç –∑–∞ '+ym+'</h2>';
    html += '<table border="1" cellspacing="0" cellpadding="6"><tr><th>–î–∞—Ç–∞</th><th>–ú–∞—Ä—à—Ä—É—Ç</th><th>‚Ññ</th><th>–õ–æ–∫–æ</th><th>–ß–∞—Å—ã</th><th>–ö–º</th><th>–ó–∞–º–µ—Ç–∫–∏</th></tr>';
    let hours=0, km=0;
    trips.forEach(x=>{ hours += Number(x.hours)||0; km += Number(x.km_total)||0;
      html += '<tr><td>'+ (x.date||'') +'</td><td>'+ (x.route||'') +'</td><td>'+ (x.train||'') +'</td><td>'+ (x.loco||'') +'</td><td>'+ (x.hours||0) +'</td><td>'+ (x.km_total||0) +'</td><td>'+ (x.notes||'').replaceAll('<','&lt;') +'</td></tr>'; });
    const basePay = hours * (Number(t.base)||0);
    const addonFactor = 1 + (Number(t.region)||0 + Number(t.north)||0 + Number(t.klass)||0 + Number(t.zone)||0 + Number(t.bam)||0)/100;
    const comm = (Number(t.comm)||0) * trips.length;
    const total = Math.round(basePay * addonFactor + comm);
    html += '</table><p><b>–ò—Ç–æ–≥–æ:</b> —á–∞—Å–æ–≤ '+hours.toFixed(1)+', –∫–º '+km.toFixed(1)+', –≤—ã–ø–ª–∞—Ç ~ '+ total.toLocaleString('ru-RU') +' ‚ÇΩ</p>';
    html += '<script>window.onload=function(){window.print();}</script></body></html>';
    const w = window.open('about:blank','_blank'); if(!w){ alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –¥–ª—è –ø–µ—á–∞—Ç–∏.'); return; }
    w.document.open(); w.document.write(html); w.document.close();
  }
  $('#printMonth').addEventListener('click', printCurrentMonth);

  // –°–µ–≥–º–µ–Ω—Ç—ã —Å–≤—è–∑–∞–Ω—ã —Å —Å—É–º–º–æ–π –∫–º/–º–∏–Ω
  function collectSegs(){
    const rows = Array.from(document.querySelectorAll('#segTable tbody tr'));
    let segs = []; let km_total=0;
    rows.forEach(r=>{
      const name = r.querySelector('.segName').value.trim();
      const min = Number(r.querySelector('.segMin').value)||0;
      const km = Number(r.querySelector('.segKm').value)||0;
      segs.push({name, min, km});
      km_total += km;
    });
    return {segs, km_total};
  }

  // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–ø–∏—Å–∫–æ–≤ –ü–æ –¥–Ω—è–º/–ü–æ –º–µ—Å—è—Ü–∞–º
  $('#segDays').addEventListener('click', ()=>{
    $('#segDays').classList.add('active'); $('#segMonths').classList.remove('active');
    $('#daysList').style.display='block'; $('#monthsList').style.display='none';
  });
  $('#segMonths').addEventListener('click', ()=>{
    $('#segMonths').classList.add('active'); $('#segDays').classList.remove('active');
    $('#daysList').style.display='none'; $('#monthsList').style.display='block';
  });

  // –§–æ—Ä–º–∞ –ø–æ–µ–∑–¥–∫–∏
  function recalcHours(){
    const st = toMinutes($('#t_start').value);
    const en = toMinutes($('#t_end').value);
    let span = en - st; if (span < 0) span += 24*60; // —á–µ—Ä–µ–∑ –ø–æ–ª–Ω–æ—á—å
    const stops = Number($('#t_stops').value)||0;
    const totalMin = Math.max(0, span + stops);
    $('#t_hours').value = (totalMin/60).toFixed(1);
  }
  ['t_start','t_end','t_stops'].forEach(id=>{
    document.getElementById(id).addEventListener('change', recalcHours);
    document.getElementById(id).addEventListener('input', recalcHours);
  });

  $('#addTripOpen').addEventListener('click', ()=>{
    editId = null;
    $('#tripForm').style.display='block';
    $('#t_date').value = new Date().toISOString().slice(0,10);
    $('#t_route').value = '';
    $('#t_train').value = '';
    $('#t_loco').value = '';
    $('#t_start').value = '08:00';
    $('#t_end').value = '17:00';
    $('#t_stops').value = '0';
    $('#t_notes').value = '';
    // clear segs
    $('#segTable tbody').innerHTML='';
    recalcHours();
  });
  $('#t_cancel').addEventListener('click', ()=> $('#tripForm').style.display='none');
  $('#t_save').addEventListener('click', ()=>{
    const {segs, km_total} = collectSegs();
    const rec = {
      id: editId || Date.now(),
      date: $('#t_date').value || new Date().toISOString().slice(0,10),
      route: $('#t_route').value.trim(),
      train: $('#t_train').value.trim(),
      loco: $('#t_loco').value.trim(),
      start: $('#t_start').value,
      end: $('#t_end').value,
      stops: Number($('#t_stops').value)||0,
      hours: Number($('#t_hours').value)||0,
      notes: $('#t_notes').value.trim(),
      segs, km_total
    };
    const arr = getTrips();
    const i = arr.findIndex(x=> x.id===rec.id);
    if(i>=0) arr[i]=rec; else arr.push(rec);
    setTrips(arr);
    $('#tripForm').style.display='none';
    renderTripsByDays(); updateDashboard(); renderMonths(); updateTotals();
  });

  // –£—á–∞—Å—Ç–∫–∏
  function renderSections(){
    const list=$('#sectionList'); list.innerHTML='';
    const arr=S('sections_sf')||[];
    if(!arr.length){ const x=document.createElement('div'); x.className='small'; x.style.opacity=.7; x.textContent='–ù–µ—Ç —É—á–∞—Å—Ç–∫–æ–≤'; list.appendChild(x);}
    arr.forEach(s=>{
      const row=document.createElement('div'); row.className='section';
      row.innerHTML='<div><b>'+ (s.name||'‚Äî') +'</b><div class="small" style="opacity:.7">'+(s.from||'‚Äî')+' ‚Üí '+(s.to||'‚Äî')+' ‚Ä¢ '+(s.len||0)+' –∫–º</div></div>'
        +'<div><button class="btn ghost" data-edit="'+s.id+'">‚úé</button> <button class="btn ghost" data-del="'+s.id+'">üóë</button></div>';
      list.appendChild(row);
    });
    list.querySelectorAll('[data-edit]').forEach(btn=> btn.addEventListener('click', ()=>{
      const id=Number(btn.getAttribute('data-edit')); const s=(S('sections_sf')||[]).find(x=>x.id===id);
      if(!s) return;
      $('#sectionForm').style.display='block';
      $('#s_name').value=s.name||''; $('#s_from').value=s.from||''; $('#s_to').value=s.to||''; $('#s_len').value=s.len||'';
      $('#s_save').onclick=()=>{
        const arr=S('sections_sf')||[]; const ix=arr.findIndex(x=>x.id===id);
        arr[ix]={ id, name:$('#s_name').value.trim(), from:$('#s_from').value.trim(), to:$('#s_to').value.trim(), len:Number($('#s_len').value)||0 };
        S('sections_sf',arr); $('#sectionForm').style.display='none'; renderSections();
      };
    }));
    list.querySelectorAll('[data-del]').forEach(btn=> btn.addEventListener('click', ()=>{
      const id=Number(btn.getAttribute('data-del'));
      const arr=(S('sections_sf')||[]).filter(x=>x.id!==id); S('sections_sf',arr); renderSections();
    }));
  }
  $('#addSectionBtn').addEventListener('click', ()=>{
    $('#sectionForm').style.display='block';
    $('#s_name').value=''; $('#s_from').value=''; $('#s_to').value=''; $('#s_len').value='';
    $('#s_save').onclick=()=>{
      const arr=S('sections_sf')||[];
      arr.push({ id:Date.now(), name:$('#s_name').value.trim(), from:$('#s_from').value.trim(), to:$('#s_to').value.trim(), len:Number($('#s_len').value)||0 });
      S('sections_sf',arr); $('#sectionForm').style.display='none'; renderSections();
    };
  });
  $('#s_cancel').addEventListener('click', ()=> $('#sectionForm').style.display='none');

  // –î–∞—à–±–æ—Ä–¥
  function updateDashboard(){
    const t=getTariffs();
    const trips=getTrips();
    const workedMin=Math.round((trips.reduce((a,x)=>a+(Number(x.hours)||0),0))*60);
    const normMin=(Number(t.norm)||0)*60;
    const percent=normMin? Math.round(workedMin/normMin*100) : 0;
    const remain=normMin-workedMin;
    const now=new Date(); const y=now.getFullYear(), m=now.getMonth(); const daysInMonth=new Date(y,m+1,0).getDate();
    let elapsedDays=now.getDate();
    if(($('#normBasis').value||'calendar')==='working'){ elapsedDays=0; for(let d=1; d<=now.getDate(); d++){ const wd=new Date(y,m,d).getDay(); if(wd!==0&&wd!==6) elapsedDays++; } }
    const totalDays=$('#normBasis').value==='working'? (function(){ let c=0; for(let d=1; d<=daysInMonth; d++){ const wd=new Date(y,m,d).getDay(); if(wd!==0&&wd!==6) c++; } return c; })() : daysInMonth;
    const planHours=Math.round((Number(t.norm)||0)*(elapsedDays/totalDays));
    const planPercent=planHours? Math.round((workedMin/60)/planHours*100):0;
    $('#mwNorm').textContent=(t.norm||0)+' —á';
    $('#mwWorked').textContent=fmtTime(workedMin);
    $('#mwPercent').textContent=percent+'%';
    $('#mwRemain').textContent=remain>=0? ('–û—Å—Ç–∞–ª–æ—Å—å: '+fmtTime(remain)) : ('–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞: '+fmtTime(-remain));
    $('#mwBar').style.width=Math.min(percent,100)+'%';
  }

  function init(){
    loadTariffsToForm();
    loadProfiles();
    renderTripsByDays();
    renderMonths();
    renderSections();
    updateDashboard();
    updateTotals();
  }
  init();

  // –ë—ç–∫–∞–ø
  $('#backupBtn').addEventListener('click', ()=>{
    const data = {
      tariffs: getTariffs(),
      trips: getTrips(),
      sections: S('sections_sf')||[],
      refs: S('refs_sf')||'',
      profiles: S('profiles_sf')||[]
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'bm-backup.json'; a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 500);
  });
  $('#restoreFile').addEventListener('change', (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const rd = new FileReader();
    rd.onload = ()=>{
      try{
        const d = JSON.parse(rd.result);
        if(d.tariffs) setTariffs(d.tariffs);
        if(d.trips) setTrips(d.trips);
        if(d.sections) S('sections_sf', d.sections);
        if('refs' in d) S('refs_sf', d.refs);
        if(Array.isArray(d.profiles)) S('profiles_sf', d.profiles);
        init();
        alert('–ë—ç–∫–∞–ø –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
      }catch(err){ alert('–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞: '+err.message); }
    };
    rd.readAsText(file);
  });

  // –≠–∫—Å–ø–æ—Ä—Ç –º–µ—Å—è—Ü–æ–≤ CSV / –ü–µ—á–∞—Ç—å PDF
  $('#exportMonthsCsv').addEventListener('click', exportMonthsCsv);
  $('#printMonth').addEventListener('click', printCurrentMonth);

})();
</script>
</body>
</html>
