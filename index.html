<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>–ë–ª–æ–∫–Ω–æ—Ç –ú–∞—à–∏–Ω–∏—Å—Ç–∞ ¬∑ Lite v2025.25x6c</title>
<meta name="theme-color" content="#d32f2f">
<link rel="apple-touch-icon" href="apple-touch-icon.png?v=202525x6c">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180x180.png?v=202525x6c">
<link rel="apple-touch-icon" sizes="167x167" href="apple-touch-icon-167x167.png?v=202525x6c">
<link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon-152x152.png?v=202525x6c">
<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0}
:root{--red:#d32f2f;--bg:#0f1420;--card:#161d2a;--line:#243246;--mut:#8aa0b6;--txt:#e9eef5}
body{background:var(--bg);color:var(--txt);font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
header{position:sticky;top:0;background:var(--red);color:#fff;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;z-index:10}
h1{margin:0;font-size:18px}
.badge{font-size:12px;padding:2px 8px;border:1px solid rgba(255,255,255,.4);border-radius:999px}
.container{padding:12px 12px 84px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:10px}
.row{display:flex;gap:8px;align-items:center;margin:8px 0}
.row label{width:48%;color:var(--mut);font-size:14px}
.row input,.row select,.row textarea{flex:1;background:#0e1622;border:1px solid var(--line);color:#e9eef5;padding:10px;border-radius:10px;font-size:16px}
.row textarea{min-height:90px;resize:vertical}
.btn{background:#1b2738;color:#fff;border:1px solid var(--line);padding:10px 14px;border-radius:10px;font-size:15px}
.btn.primary{background:#fff;color:#d32f2f;border-color:#fff}
.small{font-size:12px}
.view{display:none}
.view.active{display:block}
.tabbar{position:fixed;left:0;right:0;bottom:0;height:70px;background:#121828;border-top:1px solid var(--line);display:flex}
.tabbar button{flex:1;background:transparent;border:none;color:#8aa0b6;font-size:12px;padding:6px 0}
.tabbar button.active{color:#fff}
.tabbar .ico{display:block;font-size:18px;margin-bottom:4px}
.progress{height:10px;border:1px solid var(--line);border-radius:999px;overflow:hidden;background:#0f2035}
.progress>div{height:100%;background:#d32f2f;width:0%}
.trip{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid #233246}
.trip:last-child{border-bottom:0}
.actions{display:flex;gap:6px}
.tap{cursor:pointer}
.money{white-space:nowrap}
table{width:100%;border-collapse:collapse}
th,td{padding:6px 4px;border-bottom:1px solid #233246;text-align:left}
th{color:#a9bacd}
</style>
</head>
<body>
<header>
  <h1>–ë–ª–æ–∫–Ω–æ—Ç –ú–∞—à–∏–Ω–∏—Å—Ç–∞</h1>
  <div class="badge">Lite v2025.25x6c</div>
</header>

<main class="container">
  <!-- –ì–ª–∞–≤–Ω–∞—è -->
  <section id="v-dashboard" class="view active">
    <div class="card">
      <div style="display:flex;justify-content:space-between"><b>–ú–µ—Å—è—á–Ω–∞—è –Ω–æ—Ä–º–∞</b><b id="mwNorm">‚Äî</b></div>
      <div class="progress" style="margin-top:6px"><div id="mwBar"></div></div>
      <div class="row"><label>–ù–æ—Ä–º–∞, —á/–º–µ—Å</label><input id="tar_norm" type="number" inputmode="decimal" placeholder="176" onchange="tarSave()" oninput="tarSave()"></div>
      <div class="row"><label>–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ</label><div id="mwWorked" class="small">‚Äî</div></div>
      <div class="row"><label>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</label><div id="mwPercent" class="small">‚Äî</div></div>
      <div class="row"><label>–û—Å—Ç–∞–ª–æ—Å—å/–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞</label><div id="mwRemain" class="small">‚Äî</div></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>–ü–æ–µ–∑–¥–∫–∏</b>
        <div>
          <button class="btn primary" onclick="addTripOpen()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn" onclick="exportTripsCsv()">CSV</button>
        </div>
      </div>

      <div id="tripForm" class="card" style="display:none;margin-top:10px">
        <div class="row"><label>–î–∞—Ç–∞</label><input id="t_date" type="date"></div>
        <div class="row"><label>–ú–∞—Ä—à—Ä—É—Ç</label>
          <input id="t_route" list="routeList" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞">
          <datalist id="routeList"></datalist>
        </div>
        <div class="row"><label>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label><input id="t_start" type="time" value="08:00" oninput="recalcDuration()" onchange="recalcDuration()"></div>
        <div class="row"><label>–ü—Ä–∏–±—ã—Ç–∏–µ</label><input id="t_end" type="time" value="17:00" oninput="recalcDuration()" onchange="recalcDuration()"></div>
        <div class="row"><label>–ß–∞—Å—ã (–∏—Ç–æ–≥)</label><input id="t_hours" type="number" inputmode="decimal" step="0.1" readonly></div>
        <div class="row"><label>–ó–∞–º–µ—Ç–∫–∏</label><textarea id="t_notes" placeholder="–ü—Ä–æ—Å—Ç–æ–∏, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏‚Ä¶"></textarea></div>

        <div class="row" style="justify-content:space-between;align-items:center">
          <b>–ü–µ—Ä–µ–≥–æ–Ω—ã</b>
          <button class="btn" onclick="segAdd()">+ –ü–µ—Ä–µ–≥–æ–Ω</button>
        </div>
        <table id="segTable">
          <thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ú–∏–Ω</th><th>–ö–º</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="row"><label>–ö–º –≤—Å–µ–≥–æ</label><input id="t_km" type="number" inputmode="decimal" readonly></div>

        <div class="row"><button class="btn primary" onclick="tripSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="btn" onclick="tripCancel()">–û—Ç–º–µ–Ω–∞</button></div>
      </div>

      <div id="daysList" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- –£—á–∞—Å—Ç–∫–∏ -->
  <section id="v-sections" class="view">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>–£—á–∞—Å—Ç–∫–∏</b><div class="actions"><button class="btn" onclick="sectionOpen()">–ù–æ–≤—ã–π —É—á–∞—Å—Ç–æ–∫</button></div>
      </div>

      <div id="sectionForm" class="card" style="display:none;margin-top:10px">
        <div class="row"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="s_name" placeholder="–ù–∞–ø—Ä.: –ú–∞–ª–æ—à—É–π–∫–∞ ‚Äî –û–±–æ–∑–µ—Ä—Å–∫–∞—è"></div>
        <div class="row"><label>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label><input id="s_from"></div>
        <div class="row"><label>–ü—Ä–∏–±—ã—Ç–∏–µ</label><input id="s_to"></div>
        <div class="row"><label>–î–ª–∏–Ω–∞ (–∫–º)</label><input id="s_len" type="number" inputmode="decimal" placeholder="0"></div>
        <div class="row">
          <button id="s_save_btn" class="btn primary" onclick="sectionSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn" onclick="sectionCancel()">–û—Ç–º–µ–Ω–∞</button>
        </div>
        <div class="small" id="s_hint" style="opacity:.7"></div>
      </div>

      <div id="sectionList"></div>
    </div>
  </section>

  <!-- –¢–∞—Ä–∏—Ñ—ã -->
  <section id="v-tariffs" class="view">
    <div class="card">
      <b>–¢–∞—Ä–∏—Ñ –∏ –Ω–∞–¥–±–∞–≤–∫–∏</b>
      <div class="row"><label>‚ÇΩ/—á–∞—Å (—Å—Ç–∞–≤–∫–∞)</label><input id="tar_base" type="number" inputmode="decimal" placeholder="358.46"></div>
      <div class="row"><label>–†–∞–π–æ–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç, %</label><input id="tar_rc" type="number" inputmode="decimal" placeholder="20"></div>
      <div class="row"><label>–°–µ–≤–µ—Ä–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç, %</label><input id="tar_north" type="number" inputmode="decimal" placeholder="50"></div>
      <div class="row"><label>–ù–∞–¥–±–∞–≤–∫–∞ –∑–∞ –∫–ª–∞—Å—Å, %</label><input id="tar_cls" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><label>–ó–æ–Ω–∞–ª—å–Ω–∞—è –Ω–∞–¥–±–∞–≤–∫–∞, %</label><input id="tar_zone" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><label>–ë–ê–ú-–Ω–∞–¥–±–∞–≤–∫–∞, %</label><input id="tar_bam" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><label>–ö–æ–º. —Ä–∞—Å—Ö–æ–¥—ã (–∑–∞ –ø–æ–µ–∑–¥–∫—É), ‚ÇΩ</label><input id="tar_fee" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="row"><button class="btn primary" onclick="tarSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ</button></div>
    </div>
  </section>

  <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <section id="v-settings" class="view">
    <div class="card">
      <b>–ë—ç–∫–∞–ø</b>
      <div class="row"><button class="btn" onclick="backup()">–°–∫–∞—á–∞—Ç—å JSON</button></div>
      <div class="row"><input id="restoreFile" type="file" accept="application/json" onchange="restoreFileChanged(event)"></div>
      <div class="small" style="opacity:.8">–í–µ—Ä—Å–∏—è Lite 2025.25x6c</div>
    </div>
  </section>
</main>

<nav class="tabbar">
  <button class="active" data-tab="dashboard" onclick="nav(this)"><span class="ico">üè†</span>–ì–ª–∞–≤–Ω–∞—è</button>
  <button data-tab="sections" onclick="nav(this)"><span class="ico">üó∫Ô∏è</span>–£—á–∞—Å—Ç–∫–∏</button>
  <button data-tab="tariffs" onclick="nav(this)"><span class="ico">üí≥</span>–¢–∞—Ä–∏—Ñ</button>
  <button data-tab="settings" onclick="nav(this)"><span class="ico">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</nav>

<script>
/* ========= helpers ========= */
function $(s){return document.querySelector(s)}
function $all(s){return Array.from(document.querySelectorAll(s))}
function S(k,v){if(arguments.length===2){localStorage.setItem(k,JSON.stringify(v));return v}try{let r=localStorage.getItem(k);return r?JSON.parse(r):null}catch(e){return null}}
function toNum(v){let n=Number(v);return isNaN(n)?0:n}
function fmtM(min){let h=Math.floor(min/60),m=min%60;return h+'—á '+String(m).padStart(2,'0')+'–º'}
function toMin(hhmm){if(!hhmm)return 0;let p=hhmm.split(':');return (Number(p[0])||0)*60+(Number(p[1])||0)}
const RUR = new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:0});

/* ========= navigation ========= */
function nav(btn){$all('.tabbar button').forEach(x=>x.classList.remove('active'));btn.classList.add('active');let v=btn.getAttribute('data-tab');$all('.view').forEach(x=>x.classList.remove('active'));$('#v-'+v).classList.add('active')}

/* ========= tariff ========= */
function getTar(){return S('tar')||{base:358.46,norm:176,rc:20,north:50,cls:0,zone:0,bam:0,fee:0}}
function tarSave(){
  let t=getTar();
  t.base=toNum($('#tar_base').value)||t.base;
  t.norm=toNum($('#tar_norm').value)||t.norm;
  t.rc=toNum($('#tar_rc').value)||0;
  t.north=toNum($('#tar_north').value)||0;
  t.cls=toNum($('#tar_cls').value)||0;
  t.zone=toNum($('#tar_zone').value)||0;
  t.bam=toNum($('#tar_bam').value)||0;
  t.fee=toNum($('#tar_fee').value)||0;
  S('tar',t); updateDash(); renderTrips();
}
function loadTar(){
  let t=getTar();
  $('#tar_base').value=t.base; $('#tar_norm').value=t.norm;
  $('#tar_rc').value=t.rc; $('#tar_north').value=t.north;
  $('#tar_cls').value=t.cls; $('#tar_zone').value=t.zone;
  $('#tar_bam').value=t.bam; $('#tar_fee').value=t.fee;
}

/* ========= money ========= */
function tripMoney(hours){
  let t=getTar();
  let pct = (t.rc+t.north+t.cls+t.zone+t.bam)/100;
  let gross = hours * t.base * (1+pct);
  let net = gross - (t.fee||0);
  return Math.max(0, Math.round(net));
}

/* ========= trips ========= */
function getTrips(){return S('trips')||[]} function setTrips(a){S('trips',a)}
function addTripOpen(){
  $('#tripForm').style.display='block';
  $('#t_date').value=new Date().toISOString().slice(0,10);
  $('#t_route').value=''; $('#t_start').value='08:00'; $('#t_end').value='17:00'; $('#t_hours').value='';
  $('#t_notes').value=''; $('#segTable tbody').innerHTML=''; $('#t_km').value='';
  buildRouteOptions(); recalcDuration();
}
function tripCancel(){$('#tripForm').style.display='none'}
function recalcDuration(){let st=toMin($('#t_start').value), en=toMin($('#t_end').value);let span=en-st; if(span<0) span+=24*60; $('#t_hours').value=isFinite(span)?(span/60).toFixed(1):''}

function segAdd(name='',min=0,km=0){
  let tb=$('#segTable tbody');let id=Date.now()+Math.floor(Math.random()*1000);
  let tr=document.createElement('tr');tr.setAttribute('data-i',id);
  tr.innerHTML='<td><input class="segN" value="'+name+'" placeholder="–ü–µ—Ä–µ–≥–æ–Ω"></td>'
    +'<td><input class="segM" type="number" inputmode="numeric" value="'+min+'"></td>'
    +'<td><input class="segK" type="number" inputmode="decimal" value="'+km+'" oninput="segRecalc()"></td>'
    +'<td><button class="btn" onclick="segDel('+id+')">‚úñ</button></td>';
  tb.appendChild(tr); segRecalc();
}
function segDel(id){let tr=$('#segTable tbody tr[data-i="'+id+'"]');if(tr)tr.remove();segRecalc()}
function segRecalc(){let sum=0; $all('#segTable tbody .segK').forEach(i=>{sum+=toNum(i.value)});$('#t_km').value=sum}
function collectSegs(){let arr=[],sumKm=0; $all('#segTable tbody tr').forEach(r=>{let n=(r.querySelector('.segN')||{}).value||'';let m=toNum((r.querySelector('.segM')||{}).value);let k=toNum((r.querySelector('.segK')||{}).value);arr.push({name:n,min:m,km:k});sumKm+=k}); return {segs:arr,km_total:sumKm}}

function tripSave(){
  let c=collectSegs(), route=($('#t_route').value||'').trim();
  let start=$('#t_start').value, end=$('#t_end').value, hours=toNum($('#t_hours').value);
  if(route){ let cache=getRoutesCache(); if(!cache.includes(route)){ cache.unshift(route); if(cache.length>50) cache.pop(); setRoutesCache(cache); } }
  let arr=getTrips();
  arr.push({id:Date.now(),date:$('#t_date').value,route,start,end,hours,km:c.km_total,notes:$('#t_notes').value.trim(),segs:c.segs});
  setTrips(arr); $('#tripForm').style.display='none'; renderTrips(); updateDash();
}
function tripDel(id){if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–µ–∑–¥–∫—É?'))return; setTrips(getTrips().filter(x=>x.id!==id));renderTrips();updateDash()}
function renderTrips(){
  let box=$('#daysList');box.innerHTML='';
  let arr=getTrips().slice().sort((a,b)=>(a.date||'').localeCompare(b.date));
  if(!arr.length){let d=document.createElement('div');d.className='small';d.style.opacity=.7;d.textContent='–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫';box.appendChild(d)}
  let totalMoney=0;
  arr.forEach(t=>{
    let h=toNum(t.hours); let m=tripMoney(h); totalMoney+=m;
    let meta=(t.start&&t.end?(' '+t.start+'‚Äì'+t.end):'')+(t.km?(' ¬∑ '+t.km+' –∫–º'):'')+(t.notes?(' ¬∑ '+t.notes):'');
    let row=document.createElement('div');row.className='trip';
    row.innerHTML='<div><b>'+t.date+'</b> ‚Ä¢ '+(t.route||'‚Äî')+'<div class="small" style="opacity:.7">'+meta+'</div></div>'
      +'<div>'+ h +' —á</div>'
      +'<div class="money">'+RUR.format(m)+'</div>'
      +'<div><button class="btn" onclick="tripDel('+t.id+')">üóë</button></div>';
    box.appendChild(row);
  });
  // –ò—Ç–æ–≥ –∑–∞ –º–µ—Å—è—Ü ‚Äî –º–∏–Ω–∏-—Å—Ç—Ä–æ–∫–∞
  if(arr.length){
    let sum=document.createElement('div'); sum.className='small'; sum.style.textAlign='right'; sum.style.marginTop='6px'; sum.style.opacity='.9';
    sum.textContent='–ò—Ç–æ–≥–æ –∑–∞ –º–µ—Å—è—Ü: '+RUR.format(totalMoney);
    box.appendChild(sum);
  }
}

/* ========= CSV ========= */
function csvEscape(v){if(v==null)return'';let s=String(v).replace(/"/g,'""');return /[",\n;]/.test(s)?('"'+s+'"'):s}
function exportTripsCsv(){
  let arr=getTrips();
  let head=['–î–∞—Ç–∞','–ú–∞—Ä—à—Ä—É—Ç','–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ','–ü—Ä–∏–±—ã—Ç–∏–µ','–ß–∞—Å—ã','–ö–º –≤—Å–µ–≥–æ','–ó–∞–º–µ—Ç–∫–∏','–î–µ–Ω—å–≥–∏'];
  let rows=[head];
  arr.forEach(t=>{
    rows.push([t.date||'',t.route||'',t.start||'',t.end||'',t.hours||0,t.km||0,(t.notes||'').replace(/\n/g,' '),tripMoney(toNum(t.hours))]);
  });
  let csv=rows.map(r=>r.map(csvEscape).join(';')).join('\n');
  let blob=new Blob([csv],{type:'text/csv;charset=utf-8'});let url=URL.createObjectURL(blob);
  let a=document.createElement('a');a.href=url;a.download='trips.csv';a.click();setTimeout(()=>URL.revokeObjectURL(url),500);
}

/* ========= sections (edit + confirm delete + tap to edit) ========= */
function getSecs(){return S('secs')||[]} function setSecs(a){S('secs',a)}
let editingSectionId=null;

function sectionOpen(){
  editingSectionId=null;
  $('#sectionForm').style.display='block';
  $('#s_name').value=''; $('#s_from').value=''; $('#s_to').value=''; $('#s_len').value='';
  $('#s_save_btn').textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'; $('#s_hint').textContent='–ù–æ–≤—ã–π —É—á–∞—Å—Ç–æ–∫';
}
function sectionCancel(){ $('#sectionForm').style.display='none'; editingSectionId=null; }
function sectionEdit(id){
  let s=(getSecs()||[]).find(x=>x.id===id); if(!s) return;
  editingSectionId=id;
  $('#sectionForm').style.display='block';
  $('#s_name').value=s.name||''; $('#s_from').value=s.frm||''; $('#s_to').value=s.to||''; $('#s_len').value=(s.len!=null?s.len:'');
  $('#s_save_btn').textContent='–û–±–Ω–æ–≤–∏—Ç—å'; $('#s_hint').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—á–∞—Å—Ç–∫–∞';
}
function sectionSave(){
  let name=($('#s_name').value||'').trim(), frm=($('#s_from').value||'').trim(), to=($('#s_to').value||'').trim(), len=toNum($('#s_len').value);
  let arr=getSecs();
  if(editingSectionId){ let ix=arr.findIndex(x=>x.id===editingSectionId); if(ix>=0){ arr[ix]={id:editingSectionId,name,frm,to,len}; setSecs(arr);} editingSectionId=null; }
  else{ arr.push({id:Date.now(),name,frm,to,len}); setSecs(arr); }
  $('#sectionForm').style.display='none'; renderSecs(); buildRouteOptions();
}
function sectionDel(id, ev){ if(ev) ev.stopPropagation(); if(!confirm('–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–æ–∫?')) return; setSecs(getSecs().filter(x=>x.id!==id)); renderSecs(); buildRouteOptions(); }
function titleForSection(s){ let t=(s.name&&s.name.trim())?s.name.trim():((s.frm||'').trim()+' ‚Äî '+(s.to||'').trim()); t=t.replace(/\s+/g,' ').trim(); return t||'‚Äî'; }
function renderSecs(){
  let box=$('#sectionList'); box.innerHTML='';
  let a=getSecs();
  if(!a.length){ let d=document.createElement('div'); d.className='small'; d.style.opacity=.7; d.textContent='–ù–µ—Ç —É—á–∞—Å—Ç–∫–æ–≤'; box.appendChild(d); }
  a.forEach(s=>{
    let title=titleForSection(s), info=(s.frm||'‚Äî')+' ‚Üí '+(s.to||'‚Äî')+(s.len?(' ‚Ä¢ '+s.len+' –∫–º'):'');
    let r=document.createElement('div'); r.className='row tap'; r.setAttribute('onclick','sectionEdit('+s.id+')');
    r.innerHTML='<div style="flex:1"><b>'+title+'</b><div class="small" style="opacity:.7">'+info+'</div></div>'
               +'<div class="actions"><button class="btn" onclick="event.stopPropagation(); sectionEdit('+s.id+')">‚úé</button>'
               +'<button class="btn" onclick="sectionDel('+s.id+', event)">üóë</button></div>';
    box.appendChild(r);
  });
}

/* ========= routes (datalist) ========= */
function getRoutesCache(){return S('routes_cache')||[]} function setRoutesCache(a){S('routes_cache',a)}
function buildRouteOptions(){
  let dl=$('#routeList'); dl.innerHTML=''; let seen=new Set();
  getSecs().forEach(s=>{let title=titleForSection(s); if(title && !seen.has(title)){ seen.add(title); let o=document.createElement('option'); o.value=title; dl.appendChild(o); }});
  (getRoutesCache()).forEach(r=>{let t=(r||'').trim(); if(t && !seen.has(t)){ seen.add(t); let o=document.createElement('option'); o.value=t; dl.appendChild(o); }});
  (getTrips()).forEach(t=>{let route=(t.route||'').trim(); if(route && !seen.has(route)){ seen.add(route); let o=document.createElement('option'); o.value=route; dl.appendChild(o); }});
}

/* ========= dashboard & backup ========= */
function updateDash(){
  let t=getTar(), mins=Math.round((getTrips().reduce((a,x)=>a+toNum(x.hours),0))*60);
  let norm=t.norm*60, pct=norm?Math.round(mins/norm*100):0, rem=norm-mins;
  $('#mwNorm').textContent=t.norm+' —á';
  $('#mwWorked').textContent=fmtM(mins);
  $('#mwPercent').textContent=pct+'%';
  $('#mwRemain').textContent=rem>=0?('–û—Å—Ç–∞–ª–æ—Å—å: '+fmtM(rem)):('–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞: '+fmtM(-rem));
  $('#mwBar').style.width=Math.min(pct,100)+'%';
}
function backup(){let data={tar:getTar(),trips:getTrips(),secs:getSecs(),routes:getRoutesCache()};let blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});let url=URL.createObjectURL(blob);let a=document.createElement('a');a.href=url;a.download='bm-backup.json';a.click();setTimeout(()=>URL.revokeObjectURL(url),500)}
function restoreFileChanged(e){let f=e.target.files[0];if(!f)return;let rd=new FileReader();rd.onload=()=>{try{let d=JSON.parse(rd.result);if(d.tar)S('tar',d.tar);if(d.trips)S('trips',d.trips);if(d.secs)S('secs',d.secs);if(d.routes)S('routes_cache',d.routes);init();alert('–ì–æ—Ç–æ–≤–æ')}catch(err){alert('–û—à–∏–±–∫–∞: '+err.message)}};rd.readAsText(f)}

/* ========= init ========= */
function init(){loadTar();renderTrips();renderSecs();buildRouteOptions();updateDash()}
init();
</script>
</body>
</html>
